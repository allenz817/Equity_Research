<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Profile and Valuation Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    },
                }
            }
        }
        
        // Function to display welcome message in chat view
        function showWelcomeMessage() {
            // Check if we're likely in the Poe chat interface
            if (window.innerWidth < 600 || window.innerHeight < 400) {
                const welcomeEl = document.getElementById('welcomeMessage');
                if (welcomeEl) welcomeEl.style.display = 'block';
            }
        }
        
        // Run when DOM is loaded
        document.addEventListener('DOMContentLoaded', showWelcomeMessage);
    </script>
</head>
<body class="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-200">
    <!-- Welcome message for chat view -->
    <div id="welcomeMessage" style="display: none;" class="p-4 m-4 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-800 rounded-lg shadow-md">
        <h2 class="text-xl font-bold text-blue-800 dark:text-blue-200 mb-2">ðŸ“Š Financial Analysis App</h2>
        
        <p class="text-blue-700 dark:text-blue-300 mb-3">
            This app allows you to analyze company financials and create valuation models. For the best experience, please open this app in the browser.
        </p>
        
        <h3 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Key Features:</h3>
        <ul class="list-disc list-inside text-blue-700 dark:text-blue-300 mb-3 space-y-1">
            <li>View income statements, balance sheets, and cash flows for 30+ major companies</li>
            <li>Real-time financial data retrieval using Claude or Gemini models</li>
            <li>Interactive DCF valuation model with customizable inputs</li>
            <li>Export to Excel with all formulas preserved</li>
            <li>Visual charts and analyst consensus data</li>
        </ul>
        
        <div class="flex justify-center mt-3">
            <a href="#" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 inline-flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                Open in Browser
            </a>
        </div>
    </div>
    <div class="container mx-auto px-4 py-6">
        <header class="mb-3">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Company Profile and Valuation Analysis</h1>
        </header>
        


        <div class="mb-6">
            <div class="flex flex-wrap gap-2 items-center">
                <div class="flex-grow">
                    <div class="relative">
                        <input type="text" id="stockCodeInput" placeholder="Enter stock ticker (e.g., AAPL, MSFT, 0700.HK, BP.L)" 
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                            <div class="text-xs text-gray-500 dark:text-gray-400">(Demo Mode)</div>
                        </div>
                    </div>
                </div>
                <button id="fetchStockBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                    <span>View Financials</span>
                </button>
                <button id="fetchCurrentInfoBtn" class="px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50 hidden">
                    <span>Real Time Summary</span>
                </button>
            </div>
            
            <!-- Current Stock Info Section -->
            <div id="currentStockInfo" class="mt-4 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4 shadow-sm hidden">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Current Stock Information</h3>
                <div id="currentStockInfoLoading" class="flex items-center justify-center py-6">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                    <span class="ml-3 text-gray-600 dark:text-gray-400">Fetching current stock data...</span>
                </div>
                <div id="currentStockInfoContent" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Share Price Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <div class="flex justify-between">
                                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Share Price</h4>
                                <span id="priceChange" class="text-sm font-semibold"></span>
                            </div>
                            <div class="mt-1 flex items-baseline">
                                <span id="currentPrice" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                                <span id="priceCurrency" class="ml-1 text-sm text-gray-500 dark:text-gray-400"></span>
                            </div>
                        </div>
                        
                        <!-- Market Cap Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Market Cap</h4>
                            <div class="mt-1">
                                <span id="marketCap" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                        
                        <!-- P/E Ratio Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">P/E Ratio</h4>
                            <div class="mt-1">
                                <span id="peRatio" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                        
                        <!-- Revenue (TTM) Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Revenue (TTM)</h4>
                            <div class="mt-1">
                                <span id="revenueTTM" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                        
                        <!-- Net Profit (TTM) Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Net Profit (TTM)</h4>
                            <div class="mt-1">
                                <span id="netProfitTTM" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                        
                        <!-- Trading Volume Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Trading Volume</h4>
                            <div class="mt-1">
                                <span id="tradingVolume" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <!-- Additional Metrics Table -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Key Metrics</h4>
                            <table class="w-full text-sm">
                                <tbody>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">52-Week Range</td>
                                        <td id="fiftyTwoWeekRange" class="py-2 text-right font-medium text-gray-900 dark:text-white"></td>
                                    </tr>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">Dividend Yield</td>
                                        <td id="dividendYield" class="py-2 text-right font-medium text-gray-900 dark:text-white"></td>
                                    </tr>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">EPS (TTM)</td>
                                        <td id="epsTTM" class="py-2 text-right font-medium text-gray-900 dark:text-white"></td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 text-gray-600 dark:text-gray-400">Beta</td>
                                        <td id="beta" class="py-2 text-right font-medium text-gray-900 dark:text-white"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Recent Performance Table -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Performance</h4>
                            <table class="w-full text-sm">
                                <tbody>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">1 Month Return</td>
                                        <td id="oneMonthReturn" class="py-2 text-right font-medium"></td>
                                    </tr>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">3 Month Return</td>
                                        <td id="threeMonthReturn" class="py-2 text-right font-medium"></td>
                                    </tr>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">YTD Return</td>
                                        <td id="ytdReturn" class="py-2 text-right font-medium"></td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 text-gray-600 dark:text-gray-400">1 Year Return</td>
                                        <td id="oneYearReturn" class="py-2 text-right font-medium"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                        <p id="dataTimestamp" class="italic"></p>
                    </div>
                </div>
            </div>
            <div id="stockList" class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
                <span class="font-medium">Quick select:</span> 
                <div class="mt-1 flex flex-wrap gap-1">
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">AAPL</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">MSFT</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">AMZN</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">GOOGL</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">META</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">TSLA</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">NVDA</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">JNJ</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">JPM</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">V</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">PG</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">0700.HK</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">9988.HK</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">1299.HK</button>
                    <button class="stock-quick-btn px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">BP.L</button>
                </div>
            </div>
            <div id="stockInfo" class="mt-2 text-gray-700 dark:text-gray-300 hidden">
                Showing financial data for <span id="currentStock" class="font-semibold"></span>
            </div>
            <div id="loadingIndicator" class="mt-4 hidden">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                    <span class="ml-2 text-gray-600 dark:text-gray-400">Loading financial data...</span>
                </div>
            </div>
            <div id="errorMessage" class="mt-2 text-red-600 dark:text-red-400 hidden"></div>
            
            <!-- Chat-like message area for user feedback -->
            <div id="chatMessages" class="mt-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Messages</h3>
                    <button id="clearMessages" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        Clear all
                    </button>
                </div>
                <div id="messagesContainer" class="max-h-40 overflow-y-auto space-y-2"></div>
            </div>
            
            <!-- Company Description Section -->
            <div id="companyDescription" class="mt-4 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4 shadow-sm hidden">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Company Overview</h3>
                <p id="descriptionText" class="text-gray-600 dark:text-gray-400 text-sm md:text-base"></p>
                <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 text-sm">Sector:</span>
                        <span id="companySector" class="ml-2 text-gray-700 dark:text-gray-300"></span>
                    </div>
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 text-sm">Industry:</span>
                        <span id="companyIndustry" class="ml-2 text-gray-700 dark:text-gray-300"></span>
                    </div>
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 text-sm">Founded:</span>
                        <span id="companyFounded" class="ml-2 text-gray-700 dark:text-gray-300"></span>
                    </div>
                    <div>
                        <span class="text-gray-500 dark:text-gray-400 text-sm">Headquarters:</span>
                        <span id="companyHQ" class="ml-2 text-gray-700 dark:text-gray-300"></span>
                    </div>
                </div>
                
                <!-- Comparable Companies Section -->
                <div id="comparableCompanies" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Comparable Companies</h4>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">Companies in the same industry that are commonly compared:</p>
                    <div id="comparablesList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                        <!-- Comparable companies will be added dynamically -->
                    </div>
                    <div id="comparablesLoading" class="hidden mt-2">
                        <div class="flex items-center text-gray-500 dark:text-gray-400 text-sm">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"></div>
                            <span>Loading comparable companies...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="financeContent" class="hidden">
            <div class="mb-6 flex flex-wrap gap-2 items-center justify-between">
                <div class="flex space-x-2 mb-4 md:mb-0 flex-wrap">
                    <button id="incomeBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 active mb-2 sm:mb-0">Income Statement</button>
                    <button id="balanceBtn" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 mb-2 sm:mb-0">Balance Sheet</button>
                    <button id="cashFlowBtn" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 mb-2 sm:mb-0">Cash Flow</button>
                    <button id="valuationBtn" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 mb-2 sm:mb-0">Valuation Model</button>
                    <button id="consensusBtn" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 mb-2 sm:mb-0">Analyst Consensus</button>
                </div>
                <div>
                    <button id="exportExcel" class="px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export to Excel (Beta)
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <div id="incomeStatement" class="statement active">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Income Statement</h2>
                            <p id="yearRangeText" class="text-gray-600 dark:text-gray-400">(2021-2024)</p>
                            <p id="currencyUnit" class="text-gray-600 dark:text-gray-400">All figures in Millions ($000s)</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="incomeTableBtn" class="px-3 py-1 bg-primary text-white text-sm rounded-md font-medium hover:bg-opacity-90 focus:outline-none">Table View</button>
                            <button id="incomeChartBtn" class="px-3 py-1 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 text-sm rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none">Chart View</button>
                        </div>
                    </div>
                    
                    <div id="incomeTableView" class="block">
                        <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Item</th>
                                    <th id="income-year-1" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2024</th>
                                    <th id="income-year-2" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2023</th>
                                    <th id="income-year-3" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2022</th>
                                    <th id="income-year-4" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2021</th>
                                </tr>
                            </thead>
                            <tbody id="incomeStatementBody">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                        <p id="incomeDataSource" class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic hidden">Data source: Financial information retrieved via AI models from publicly available sources including SEC filings, annual reports, and financial databases. May vary from official filings.</p>
                    </div>
                    
                    <div id="incomeChartView" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Revenue & Income Metrics:</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded-md">
                                    <input type="checkbox" class="income-chart-primary" value="Revenue" checked class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Revenue (Bar)</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="income-chart-primary" value="Gross Profit" class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Gross Profit</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="income-chart-primary" value="Operating Income" class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Operating Income</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="income-chart-primary" value="Net Income" class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Income</span>
                                </label>
                            </div>
                            
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 mt-3">Margin Metrics (Secondary Axis):</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center bg-green-100 dark:bg-green-900 px-2 py-1 rounded-md">
                                    <input type="checkbox" class="income-chart-secondary" value="Net Profit Margin" checked class="form-checkbox h-4 w-4 text-green-600">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Profit Margin (Line)</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="income-chart-secondary" value="Operating Margin" class="form-checkbox h-4 w-4 text-green-600">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Operating Margin</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="income-chart-secondary" value="Gross Margin" class="form-checkbox h-4 w-4 text-green-600">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Gross Margin</span>
                                </label>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-300 dark:border-gray-700">
                            <canvas id="incomeChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <div id="balanceSheet" class="statement hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Balance Sheet</h2>
                            <p id="yearRangeText" class="text-gray-600 dark:text-gray-400">(2021-2024)</p>
                            <p id="currencyUnit" class="text-gray-600 dark:text-gray-400">All figures in Millions ($000s)</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="balanceTableBtn" class="px-3 py-1 bg-primary text-white text-sm rounded-md font-medium hover:bg-opacity-90 focus:outline-none">Table View</button>
                            <button id="balanceChartBtn" class="px-3 py-1 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 text-sm rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none">Chart View</button>
                        </div>
                    </div>
                    
                    <div id="balanceTableView" class="block">
                        <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Item</th>
                                    <th id="balance-year-1" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2024</th>
                                    <th id="balance-year-2" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2023</th>
                                    <th id="balance-year-3" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2022</th>
                                    <th id="balance-year-4" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2021</th>
                                </tr>
                            </thead>
                            <tbody id="balanceSheetBody">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                        <p id="balanceDataSource" class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic hidden">Data source: Financial information retrieved via AI models from publicly available sources including SEC filings, annual reports, and financial databases. May vary from official filings.</p>
                    </div>
                    
                    <div id="balanceChartView" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Metrics to Display:</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="balance-chart-metric" value="Total Assets" checked class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Total Assets</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="balance-chart-metric" value="Total Current Assets" checked class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Current Assets</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="balance-chart-metric" value="Total Liabilities" checked class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Total Liabilities</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="balance-chart-metric" value="Total Equity" checked class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Total Equity</span>
                                </label>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-300 dark:border-gray-700">
                            <canvas id="balanceChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <div id="cashFlow" class="statement hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Cash Flow Statement</h2>
                            <p id="yearRangeText" class="text-gray-600 dark:text-gray-400">(2021-2024)</p>
                            <p id="currencyUnit" class="text-gray-600 dark:text-gray-400">All figures in Millions ($000s)</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="cashFlowTableBtn" class="px-3 py-1 bg-primary text-white text-sm rounded-md font-medium hover:bg-opacity-90 focus:outline-none">Table View</button>
                            <button id="cashFlowChartBtn" class="px-3 py-1 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 text-sm rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none">Chart View</button>
                        </div>
                    </div>
                    
                    <div id="cashFlowTableView" class="block">
                        <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Item</th>
                                    <th id="cashflow-year-1" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2024</th>
                                    <th id="cashflow-year-2" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2023</th>
                                    <th id="cashflow-year-3" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2022</th>
                                    <th id="cashflow-year-4" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2021</th>
                                </tr>
                            </thead>
                            <tbody id="cashFlowBody">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                        <p id="cashFlowDataSource" class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic hidden">Data source: Financial information retrieved via AI models from publicly available sources including SEC filings, annual reports, and financial databases. May vary from official filings.</p>
                    </div>
                    
                    <div id="cashFlowChartView" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Metrics to Display:</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="cashflow-chart-metric" value="Net Cash from Operations" checked class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Cash from Operations</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="cashflow-chart-metric" value="Net Cash from Investing" checked class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Cash from Investing</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="cashflow-chart-metric" value="Net Cash from Financing" checked class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Cash from Financing</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="cashflow-chart-metric" value="Net Change in Cash" checked class="form-checkbox h-4 w-4 text-primary">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Change in Cash</span>
                                </label>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-300 dark:border-gray-700">
                            <canvas id="cashFlowChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Valuation Model Section -->
                <div id="valuationModel" class="statement hidden">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-white">DCF Valuation Model</h2>
                        <p id="yearRangeText" class="text-gray-600 dark:text-gray-400">(2021-2024)</p>
                        <p id="currencyUnit" class="text-gray-600 dark:text-gray-400 mb-4">All figures in Millions ($000s)</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Inputs Section -->
                        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 p-4 rounded-md">
                            <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Model Inputs</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Forecast Period (Years)</label>
                                    <input type="number" id="forecastPeriod" value="5" min="1" max="10" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                            
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Revenue Growth Rate (%)</label>
                                    <input type="number" id="revenueGrowthRate" value="5" min="-50" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Operating Margin (%)</label>
                                    <input type="number" id="operatingMargin" value="20" min="-50" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tax Rate (%)</label>
                                    <input type="number" id="taxRate" value="25" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Capital Expenditure (% of Revenue)</label>
                                    <input type="number" id="capexRate" value="5" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Working Capital (% of Revenue)</label>
                                    <input type="number" id="wcRate" value="10" min="-50" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Terminal Growth Rate (%)</label>
                                    <input type="number" id="terminalGrowthRate" value="2" min="-5" max="15" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Discount Rate (WACC) (%)</label>
                                    <input type="number" id="discountRate" value="10" min="1" max="30" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">EV/EBITDA Multiple (Terminal)</label>
                                    <input type="number" id="evMultiple" value="12" min="1" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <button id="calculateValuation" class="mt-4 px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 w-full">
                                    Calculate Valuation
                                </button>
                            </div>
                        </div>
                        
                        <!-- Results Section -->
                        <div>
                            <!-- Company Info -->
                            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 p-4 rounded-md mb-6">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Company Information</h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Shares Outstanding</span>
                                            <span id="sharesInfo" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Net Debt</span>
                                            <span id="debtInfo" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Valuation Results -->
                            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 p-4 rounded-md mb-6">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Valuation Results</h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Enterprise Value (DCF)</span>
                                            <span id="enterpriseValueDCF" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Enterprise Value (Multiple)</span>
                                            <span id="enterpriseValueMultiple" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Equity Value (DCF)</span>
                                            <span id="equityValueDCF" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Equity Value (Multiple)</span>
                                            <span id="equityValueMultiple" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Share Price (DCF)</span>
                                            <span id="sharePriceDCF" class="font-bold text-lg text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2">
                                            <span class="text-gray-700 dark:text-gray-300">Share Price (Multiple)</span>
                                            <span id="sharePriceMultiple" class="font-bold text-lg text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Key Metrics -->
                            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 p-4 rounded-md">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Historical Metrics</h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Revenue CAGR (3 Year)</span>
                                            <span id="revenueCagr" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Average Operating Margin</span>
                                            <span id="avgOperatingMargin" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Average CapEx % of Revenue</span>
                                            <span id="avgCapex" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2">
                                            <span class="text-gray-700 dark:text-gray-300">Effective Tax Rate</span>
                                            <span id="effectiveTaxRate" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cash Flow Projections -->
                    <div class="mt-6">
                        <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Cash Flow Projections</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                                <thead>
                                    <tr class="bg-gray-100 dark:bg-gray-700">
                                        <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Item</th>
                                        <th id="proj-year-0" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Historical</th>
                                        <th id="proj-year-1" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 1</th>
                                        <th id="proj-year-2" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 2</th>
                                        <th id="proj-year-3" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 3</th>
                                        <th id="proj-year-4" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 4</th>
                                        <th id="proj-year-5" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 5</th>
                                        <th id="proj-terminal" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Terminal</th>
                                    </tr>
                                </thead>
                                <tbody id="projectionBody">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="analystConsensusTab" class="statement hidden">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Analyst Consensus</h2>
                    
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600 dark:text-gray-400">Analyst Estimates</span>
                        <span id="consensusDate" class="text-gray-600 dark:text-gray-400"></span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                        <!-- Price Target Section -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-3 rounded-md">
                            <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Price Target</h5>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Average</span>
                                <span id="priceTargetAvg" class="font-semibold"></span>
                            </div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Low</span>
                                <span id="priceTargetLow" class=""></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">High</span>
                                <span id="priceTargetHigh" class=""></span>
                            </div>
                        </div>
                        
                        <!-- Recommendations Section -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-3 rounded-md">
                            <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Recommendations</h5>
                            <div class="h-16 relative mb-2" id="recommendationChart">
                                <!-- Bar chart will be added here -->
                            </div>
                            <div class="grid grid-cols-3 text-center text-xs">
                                <div>
                                    <span class="text-green-600 dark:text-green-400 font-semibold" id="buyCount"></span>
                                    <p class="text-gray-600 dark:text-gray-400">Buy</p>
                                </div>
                                <div>
                                    <span class="text-yellow-600 dark:text-yellow-400 font-semibold" id="holdCount"></span>
                                    <p class="text-gray-600 dark:text-gray-400">Hold</p>
                                </div>
                                <div>
                                    <span class="text-red-600 dark:text-red-400 font-semibold" id="sellCount"></span>
                                    <p class="text-gray-600 dark:text-gray-400">Sell</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Earnings Estimates Section -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-3 rounded-md">
                            <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Earnings Estimates</h5>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Next Quarter</span>
                                <span id="earningsNextQuarter" class=""></span>
                            </div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Current Year</span>
                                <span id="earningsCurrentYear" class=""></span>
                            </div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Next Year</span>
                                <span id="earningsNextYear" class=""></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Growth</span>
                                <span id="earningsGrowth" class="font-semibold"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="dataSourcesSection" class="mb-4">
                <p id="dataSourcesNote" class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic">
                    Data sources: Financial information retrieved via AI models from publicly available sources including SEC filings, annual reports, and financial databases. Users are encouraged to cross-check with official company filings for investment decisions.
                </p>
                
                <details class="text-xs mt-1">
                    <summary class="cursor-pointer text-primary font-medium hover:underline">View source URLs</summary>
                    <div id="sourceUrlsContainer" class="mt-2 p-2 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded">
                        <p class="text-gray-500 dark:text-gray-400 italic mb-1">Sources cited by AI models:</p>
                        <ul id="sourceUrlsList" class="list-disc ml-4 text-gray-600 dark:text-gray-300 space-y-1">
                            <li class="text-gray-400 dark:text-gray-500 italic">No source URLs available yet. Sources will appear here when real-time data is fetched.</li>
                        </ul>
                    </div>
                </details>
            </div>
            
            <div id="implementationNote" class="mt-8 bg-blue-50 dark:bg-blue-900 p-4 rounded-md">
                <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-2">Implementation Note</h3>
                <p class="text-blue-700 dark:text-blue-300 mb-2">
                    This financial analysis app combines preloaded data for 30+ major stocks with real-time data retrieval using AI models (Claude-3.7-Sonnet, Gemini Pro, and Gemini Flash). The DCF valuation model generates dynamic projections with Excel-exportable formulas.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div class="bg-blue-100 dark:bg-blue-800 p-3 rounded-md">
                        <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-1">Key Features</h4>
                        <ul class="list-disc ml-5 text-blue-700 dark:text-blue-300 text-sm space-y-1">
                            <li>Real-time financial data retrieval for any ticker</li>
                            <li>Dynamic DCF valuation model with customizable inputs</li>
                            <li>Interactive charts for visualizing financial metrics</li>
                            <li>Analyst consensus and company profile data</li>
                            <li>Excel export with linked formulas for offline analysis</li>
                        </ul>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-800 p-3 rounded-md">
                        <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-1">Data Sources</h4>
                        <ul class="list-disc ml-5 text-blue-700 dark:text-blue-300 text-sm space-y-1">
                            <li>Preloaded data for 30+ US and global stocks</li>
                            <li>Claude-3.7-Sonnet for comprehensive financial analysis</li>
                            <li>Gemini-2.5-Pro-Exp with web search for real-time accuracy</li>
                            <li>Gemini-2.5-Flash-Preview for faster, lower-cost responses</li>
                        </ul>
                    </div>
                </div>
                <p class="mt-3 text-blue-700 dark:text-blue-300 text-sm">
                    <span class="font-medium">Alternative API Implementation:</span> For production applications, consider dedicated financial APIs like Financial Modeling Prep, Alpha Vantage, Yahoo Finance API, or Polygon.io for more reliable, high-throughput data access.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Set up dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Function to fetch current stock info
        async function fetchCurrentStockInfo(ticker) {
            if (!window.Poe) {
                throw new Error("Poe API is not available. This feature requires running on Poe.com");
            }
            
            // Show the current stock info section and loading state
            const currentStockInfo = document.getElementById('currentStockInfo');
            const loadingIndicator = document.getElementById('currentStockInfoLoading');
            const contentSection = document.getElementById('currentStockInfoContent');
            
            currentStockInfo.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            contentSection.classList.add('hidden');
            
            try {
                // Create a handler for the response
                const handlerId = "currentStockInfoHandler";
                
                // Set up a promise that will resolve when we get the data
                const dataPromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.statusText || "Failed to fetch stock information"));
                        } else if (result.status === "complete") {
                            try {
                                // Get the response content
                                const content = result.responses[0].content;
                                
                                // Extract the JSON portion
                                let jsonMatch = content.match(/\{[\s\S]*\}/);
                                if (!jsonMatch) {
                                    reject(new Error("No valid JSON found in response"));
                                    return;
                                }
                                
                                // Parse the JSON
                                const data = JSON.parse(jsonMatch[0]);
                                resolve(data);
                            } catch (error) {
                                reject(new Error(`Failed to parse stock information: ${error.message}`));
                            }
                        }
                    });
                });
                
                // Build a prompt that asks for current stock information
                const prompt = `@Gemini-2.5-Pro-Exp Please provide the REAL-TIME current stock information for ${ticker}.

Please include:
- Current price and price change ($ and %)
- Market cap
- P/E ratio
- Latest revenue and net profit (trailing twelve months)
- Trading volume
- 52-week range
- Dividend yield (if applicable)
- EPS (TTM)
- Beta
- Recent performance (1M, 3M, YTD, 1Y returns)

Return the information AS JSON ONLY with the following structure:
{
  "ticker": "${ticker}",
  "name": "Full Company Name",
  "price": {
    "current": 123.45,
    "change": 1.23,
    "changePercent": 0.5,
    "currency": "$"
  },
  "marketCap": "123.45B",
  "peRatio": 20.5,
  "revenue": "50.2B",
  "netIncome": "10.5B",
  "tradingVolume": "5.2M",
  "fiftyTwoWeekRange": "100.00 - 150.00",
  "dividendYield": "2.5%",
  "eps": 6.02,
  "beta": 1.15,
  "returns": {
    "oneMonth": 2.5,
    "threeMonth": 5.2,
    "ytd": 10.5,
    "oneYear": 15.3
  },
  "timestamp": "2024-06-25 10:30 EST"
}

If any data is not available, include the field with "N/A" as the value. No explanations or markdown, JUST the JSON.`;
                
                // Send the request
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    stream: false, 
                    openChat: false
                });
                
                // Wait for and get the stock info
                const stockInfo = await dataPromise;
                
                // Update the UI with the stock info
                updateCurrentStockInfo(stockInfo);
                
                displayMessage(`Successfully loaded current stock information for ${ticker}`, "success");
                
                return stockInfo;
            } catch (error) {
                // Hide loading indicator and show error
                loadingIndicator.classList.add('hidden');
                contentSection.classList.add('hidden');
                
                // Display error message
                displayMessage(`Error: Failed to fetch current stock information for ${ticker}. ${error.message}`, "error");
                
                throw error;
            }
        }
        
        // Function to update the UI with current stock info
        function updateCurrentStockInfo(data) {
            // Hide loading indicator
            document.getElementById('currentStockInfoLoading').classList.add('hidden');
            
            // Show content section
            const contentSection = document.getElementById('currentStockInfoContent');
            contentSection.classList.remove('hidden');
            
            // Update price info
            document.getElementById('currentPrice').textContent = data.price.current;
            document.getElementById('priceCurrency').textContent = data.price.currency;
            
            const priceChangeEl = document.getElementById('priceChange');
            if (data.price.change !== "N/A") {
                const isPositive = data.price.change >= 0;
                priceChangeEl.textContent = `${isPositive ? '+' : ''}${data.price.change} (${isPositive ? '+' : ''}${data.price.changePercent}%)`;
                priceChangeEl.className = `text-sm font-semibold ${isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`;
            } else {
                priceChangeEl.textContent = 'N/A';
                priceChangeEl.className = 'text-sm font-semibold text-gray-500 dark:text-gray-400';
            }
            
            // Update key metrics
            document.getElementById('marketCap').textContent = data.marketCap;
            document.getElementById('peRatio').textContent = data.peRatio;
            document.getElementById('revenueTTM').textContent = data.revenue;
            document.getElementById('netProfitTTM').textContent = data.netIncome;
            document.getElementById('tradingVolume').textContent = data.tradingVolume;
            
            // Update additional metrics
            document.getElementById('fiftyTwoWeekRange').textContent = data.fiftyTwoWeekRange;
            document.getElementById('dividendYield').textContent = data.dividendYield;
            document.getElementById('epsTTM').textContent = data.eps;
            document.getElementById('beta').textContent = data.beta;
            
            // Update returns with color coding
            updateReturnValue('oneMonthReturn', data.returns.oneMonth);
            updateReturnValue('threeMonthReturn', data.returns.threeMonth);
            updateReturnValue('ytdReturn', data.returns.ytd);
            updateReturnValue('oneYearReturn', data.returns.oneYear);
            
            // Update timestamp
            document.getElementById('dataTimestamp').textContent = `Data as of: ${data.timestamp}`;
        }
        
        // Helper function to update return values with color coding
        function updateReturnValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (value === "N/A") {
                element.textContent = "N/A";
                element.className = "py-2 text-right font-medium text-gray-500 dark:text-gray-400";
                return;
            }
            
            const numValue = parseFloat(value);
            const isPositive = numValue >= 0;
            element.textContent = `${isPositive ? '+' : ''}${numValue}%`;
            element.className = `py-2 text-right font-medium ${isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`;
        }

        // Function to show or hide the chat messages section
        function toggleChatMessages(show) {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                if (show) {
                    chatMessages.classList.remove('hidden');
                } else {
                    chatMessages.classList.add('hidden');
                }
            }
        }
        
        // Function to add a message to the chat UI
        function displayMessage(message, type = 'info') {
            toggleChatMessages(true);
            const messagesContainer = document.getElementById('messagesContainer');
            
            const messageElement = document.createElement('div');
            messageElement.className = `mb-2 p-2 rounded ${type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' : 
                type === 'success' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 
                'bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200'}`;
            
            // Use marked.js to render Markdown content if available
            if (typeof marked !== 'undefined') {
                messageElement.innerHTML = marked.parse(message);
            } else {
                messageElement.textContent = message;
            }
            
            messagesContainer.appendChild(messageElement);
            
            // Scroll to the bottom of the messages container
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Clear messages button functionality
        document.getElementById('clearMessages').addEventListener('click', function() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
        });
        
        // Setup Poe API for chat interactions
        function setupPoeApi() {
            if (window.Poe) {
                // Register a handler for chat messages
                window.Poe.registerHandler("financialDataHandler", (result, context) => {
                    if (result.status === "error") {
                        displayMessage("Error: " + (result.statusText || "Failed to process request"), "error");
                    } else if (result.status === "incomplete") {
                        // For streaming responses, we could show progress here
                    } else if (result.status === "complete") {
                        if (result.responses && result.responses.length > 0) {
                            const response = result.responses[0];
                            
                            // Process the response based on the command type
                            processResponse(response.content, context.command, context.params);
                        }
                    }
                });
                
                // Setup event handlers to listen for user messages from Poe
                window.Poe.onMessage(async (message) => {
                    // Only process text messages that start with recognized commands
                    if (message.text) {
                        const parsed = parseCommand(message.text);
                        
                        if (parsed.command === 'unknown') {
                            displayMessage(`Unknown command: "${message.text}". Type "help" to see available commands.`, 'error');
                        } else {
                            await sendChatCommand(parsed.command, parsed.params);
                        }
                    }
                });
                
                // Display startup message
                setTimeout(() => {
                    displayMessage('**Welcome to the Financial Analysis App**\n\nYou can analyze stocks by typing commands in the chat:\n\nâ€¢ `analyze AAPL` - Get an AI analysis of a stock\nâ€¢ `compare MSFT GOOGL` - Compare multiple stocks\nâ€¢ `help` - Show all commands', 'info');
                }, 1000);
            }
        }
        
        // Function to show or hide the chat messages section
        function toggleChatMessages(show) {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                if (show) {
                    chatMessages.classList.remove('hidden');
                } else {
                    chatMessages.classList.add('hidden');
                }
            }
        }
        
        // Function to add a message to the chat UI
        function displayMessage(message, type = 'info') {
            toggleChatMessages(true);
            const messagesContainer = document.getElementById('messagesContainer');
            
            const messageElement = document.createElement('div');
            messageElement.className = `mb-2 p-2 rounded ${type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' : 
                type === 'success' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 
                'bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200'}`;
            
            // Use marked.js to render Markdown content if available
            if (typeof marked !== 'undefined') {
                messageElement.innerHTML = marked.parse(message);
            } else {
                messageElement.textContent = message;
            }
            
            messagesContainer.appendChild(messageElement);
            
            // Scroll to the bottom of the messages container
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Process the responses from the Poe API
        function processResponse(content, command, params) {
            // Try to parse the content as JSON if it contains structured data
            try {
                // Check if content appears to be JSON (starts with { or [)
                if ((content.trim().startsWith('{') || content.trim().startsWith('[')) && 
                    (content.trim().endsWith('}') || content.trim().endsWith(']'))) {
                    const jsonData = JSON.parse(content);
                    // Handle different types of data based on command
                    if (command === 'analyze') {
                        displayMessage(`### Analysis for ${params.ticker}\n\n${jsonData.summary || 'No summary available.'}`, 'info');
                        if (jsonData.recommendation) {
                            displayMessage(`**Recommendation:** ${jsonData.recommendation}`, 'success');
                        }
                    } else if (command === 'compare') {
                        displayMessage(`### Comparison of ${params.tickers.join(' vs ')}\n\n${jsonData.comparison || 'No comparison available.'}`, 'info');
                    }
                    return;
                }
            } catch (e) {
                // Not valid JSON, continue with normal text processing
            }
            
            // For non-JSON responses, display as formatted text
            if (command === 'analyze') {
                displayMessage(`### Analysis for ${params.ticker}\n\n${content}`, 'info');
            } else if (command === 'compare') {
                displayMessage(`### Comparison Results\n\n${content}`, 'info');
            } else if (command === 'help') {
                displayMessage(`### Help Information\n\n${content}`, 'info');
            } else {
                // Default case for other commands
                displayMessage(content, 'info');
            }
        }
        
        // Function to parse commands from user messages
        function parseCommand(message) {
            // Normalize message
            const normalizedMessage = message.trim().toLowerCase();
            
            // Parse "analyze TICKER" command
            const analyzeMatch = normalizedMessage.match(/^analyze\s+([a-zA-Z0-9\.]+)$/i);
            if (analyzeMatch) {
                const ticker = analyzeMatch[1].toUpperCase();
                return { command: 'analyze', params: { ticker } };
            }
            
            // Parse "compare TICKER1 TICKER2..." command
            const compareMatch = normalizedMessage.match(/^compare\s+([a-zA-Z0-9\.\s]+)$/i);
            if (compareMatch) {
                const tickersText = compareMatch[1].trim();
                const tickers = tickersText.split(/\s+/).map(t => t.toUpperCase());
                return { command: 'compare', params: { tickers } };
            }
            
            // Parse "help" command
            if (normalizedMessage === 'help') {
                return { command: 'help' };
            }
            
            // If no command pattern matched
            return { command: 'unknown' };
        }
        
        // Function to handle sending commands to the Poe API
        async function sendChatCommand(command, params) {
            try {
                // Show loading state
                displayMessage(`Processing your ${command} request...`, 'info');
                
                let prompt;
                if (command === 'analyze') {
                    // Update the UI with the stock data first
                    if (stockData[params.ticker]) {
                        await fetchStockData(params.ticker);
                        displayMessage(`Showing financial data for ${params.ticker}`);
                    }
                    
                    // Generate a stock analysis prompt
                    prompt = `@Claude-3.7-Sonnet Provide a brief, structured financial analysis of ${params.ticker} including:
1. Recent financial performance
2. Key metrics and valuation
3. Market position and competitors
4. Key risks and opportunities
5. An overall investment recommendation (buy/hold/sell)

Format as Markdown with concise bullet points. Provide ONLY raw JSON at the end with: {"summary": "text", "recommendation": "text"}`;
                } 
                else if (command === 'compare') {
                    // Show loading indicator
                    const tickers = params.tickers.join(' vs ');
                    displayMessage(`Comparing ${tickers}...`);
                    
                    // Generate a comparison prompt
                    prompt = `@Claude-3.7-Sonnet Compare these stocks: ${params.tickers.join(', ')}. 
Include these sections:
1. Market position and business model comparison
2. Financial performance comparison (revenue growth, margins, EPS growth)
3. Valuation comparison (P/E, P/S, PEG ratio)
4. Key strengths and weaknesses
5. Investment outlook

Format as Markdown with concise bullet points. Keep your analysis concise but insightful.`;
                } 
                else if (command === 'help') {
                    displayMessage(`
### Stock Analysis App Commands

Here are the commands you can use in this app:

* **analyze [TICKER]** - Get an AI analysis of a specific stock
* **compare [TICKER1] [TICKER2] [...]** - Compare multiple stocks (up to 5)
* **help** - Show this help message

Examples:
- \`analyze AAPL\`
- \`compare MSFT GOOGL AMZN\`

You can also use the app's interface to visualize financial data and valuation models.
                    `, 'info');
                    return;
                }
                else {
                    displayMessage(`Unknown command: ${command}. Type "help" to see available commands.`, 'error');
                    return;
                }
                
                if (!window.Poe) {
                    displayMessage("Poe API is not available. Please try again on Poe.com", 'error');
                    return;
                }
                
                // Send the request to Poe
                await window.Poe.sendUserMessage(prompt, {
                    handler: "financialDataHandler",
                    stream: true,
                    openChat: false,
                    handlerContext: { command, params }
                });
            } catch (err) {
                if (err.errorType === 'USER_REJECTED_CONFIRMATION') {
                    displayMessage("You rejected the confirmation prompt. The analysis can't be loaded.", 'error');
                } else {
                    displayMessage(`Error: ${err.message || 'Unknown error occurred'}`, 'error');
                }
            }
        }
        
        // Financial data structure to hold the processed data
        let currentFinancialData = {
            name: '',
            fiscalYearEnd: '',
            currencyUnit: 'Millions',
            currencySymbol: '$', 
            years: [],
            incomeStatement: {},
            balanceSheet: {},
            cashFlow: {},
            sharesOutstanding: 0,
            netDebt: 0
        };
        
        // Define income statement structure for consistent display order
        const incomeStatementStructure = [
            { label: 'Revenue', isSection: false, isTotal: false, cssClass: '' },
            { label: 'Cost of Revenue', isSection: false, isTotal: false, cssClass: '', isNegative: true },
            { label: 'Gross Profit', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Operating Expenses', isSection: false, isTotal: false, cssClass: '', isNegative: true },
            { label: 'R&D Expenses', isSection: false, isTotal: false, cssClass: '', isNegative: true },
            { label: 'Operating Income', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Other Income', isSection: false, isTotal: false, cssClass: '' },
            { label: 'Tax Expense', isSection: false, isTotal: false, cssClass: '', isNegative: true },
            { label: 'Net Income', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' }
        ];
        
        // Define balance sheet structure
        const balanceSheetStructure = [
            { label: 'Assets', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Cash & Equivalents', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Accounts Receivable', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Inventory', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Current Assets', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Property & Equipment', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Intangible Assets', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Assets', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' },
            { label: 'Liabilities & Equity', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Accounts Payable', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Short-term Debt', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Current Liabilities', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Long-term Debt', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Liabilities', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Common Stock', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Retained Earnings', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Equity', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Total Liabilities & Equity', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' }
        ];
        
        // Define cash flow structure
        const cashFlowStructure = [
            { label: 'Operating Activities', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Net Income', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Depreciation & Amortization', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Changes in Working Capital', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Net Cash from Operations', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Investing Activities', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Capital Expenditures', isSection: false, isTotal: false, cssClass: 'pl-6', isNegative: true },
            { label: 'Acquisitions', isSection: false, isTotal: false, cssClass: 'pl-6', isNegative: true },
            { label: 'Net Cash from Investing', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750', isNegative: true },
            { label: 'Financing Activities', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Debt Issuance (Repayment)', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Dividends Paid', isSection: false, isTotal: false, cssClass: 'pl-6', isNegative: true },
            { label: 'Net Cash from Financing', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Net Change in Cash', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' },
            { label: 'Beginning Cash Balance', isSection: false, isTotal: false, cssClass: '' },
            { label: 'Ending Cash Balance', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' }
        ];
        
        // Define DCF model projection structure
        const projectionStructure = [
            { label: 'Revenue', isSection: false, isTotal: false, cssClass: 'font-medium', formula: 'prev_value * (1 + growth_rate)' },
            { label: 'Operating Income', isSection: false, isTotal: false, cssClass: '', formula: 'revenue * operating_margin' },
            { label: 'Tax', isSection: false, isTotal: false, cssClass: '', isNegative: true, formula: 'operating_income * tax_rate' },
            { label: 'NOPAT', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750', formula: 'operating_income - tax' },
            { label: 'Depreciation & Amortization', isSection: false, isTotal: false, cssClass: '', formula: 'revenue * depreciation_rate' },
            { label: 'Capital Expenditures', isSection: false, isTotal: false, cssClass: '', isNegative: true, formula: 'revenue * capex_rate' },
            { label: 'Change in Working Capital', isSection: false, isTotal: false, cssClass: '', isNegative: true, formula: '(revenue - prev_revenue) * wc_rate' },
            { label: 'Free Cash Flow', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold', formula: 'NOPAT + depreciation - capex - change_in_wc' },
            { label: 'Discount Factor', isSection: false, isTotal: false, cssClass: '', formula: '1 / (1 + wacc)^year' },
            { label: 'Present Value of FCF', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold', formula: 'fcf * discount_factor' }
        ];
        
        // Sample financial data for different stocks with metadata for fiscal year end and currency unit
        // Including major stocks from US and Hong Kong markets
        const stockData = {
            'AAPL': {
                name: 'Apple Inc.',
                fiscalYearEnd: "Sep 30", // Apple's fiscal year ends in September
                currencyUnit: "Millions", // Apple reports in millions
                currencySymbol: "$",
                years: [2024, 2023, 2022, 2021],
                sharesOutstanding: 15406.53, // In millions
                description: "Apple Inc. designs, manufactures, and markets smartphones, personal computers, tablets, wearables, and accessories worldwide. The company offers iPhone, Mac, iPad, and wearables, home, and accessories. It also provides AppleCare support and cloud services, and operates various platforms, including the App Store.",
                sector: "Technology",
                industry: "Consumer Electronics",
                founded: "1976",
                headquarters: "Cupertino, California, USA",
                incomeStatement: {
                    'Revenue': ['$397,732', '$383,293', '$394,328', '$365,817'],
                    'Cost of Revenue': ['($225,685)', '($215,449)', '($222,693)', '($212,981)'],
                    'Gross Profit': ['$172,047', '$167,844', '$171,635', '$152,836'],
                    'Operating Expenses': ['($57,672)', '($54,483)', '($50,766)', '($43,887)'],
                    'R&D Expenses': ['($30,426)', '($29,915)', '($26,251)', '($22,615)'],
                    'Operating Income': ['$114,375', '$114,301', '$119,437', '$108,949'],
                    'Other Income': ['$1,635', '$245', '$394', '$258'],
                    'Tax Expense': ['($16,213)', '($17,648)', '($19,300)', '($14,527)'],
                    'Net Income': ['$99,797', '$96,995', '$99,803', '$94,680']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$37,825', '$34,002', '$29,965', '$23,646'],
                    'Accounts Receivable': ['$38,456', '$32,748', '$30,545', '$28,184'],
                    'Inventory': ['$6,784', '$8,905', '$7,825', '$4,946'],
                    'Total Current Assets': ['$110,735', '$89,356', '$81,989', '$67,425'],
                    'Property & Equipment': ['$58,643', '$53,041', '$46,725', '$42,117'],
                    'Intangible Assets': ['$1,197', '$1,298', '$1,147', '$1,049'],
                    'Total Assets': ['$368,725', '$359,745', '$355,982', '$352,755'],
                    'Accounts Payable': ['$59,135', '$61,933', '$62,611', '$64,115'],
                    'Short-term Debt': ['$8,237', '$10,259', '$13,386', '$11,128'],
                    'Total Current Liabilities': ['$120,845', '$125,278', '$127,032', '$125,481'],
                    'Long-term Debt': ['$89,756', '$90,223', '$95,281', '$109,106'],
                    'Total Liabilities': ['$264,563', '$269,813', '$274,948', '$287,912'],
                    'Common Stock': ['$65,789', '$64,916', '$64,790', '$64,849'],
                    'Retained Earnings': ['$38,373', '$25,016', '$16,244', '$5,000'],
                    'Total Equity': ['$104,162', '$89,932', '$81,034', '$64,843'],
                    'Total Liabilities & Equity': ['$368,725', '$359,745', '$355,982', '$352,755']
                },
                cashFlow: {
                    'Net Income': ['$99,797', '$96,995', '$99,803', '$94,680'],
                    'Depreciation & Amortization': ['$13,632', '$12,734', '$11,922', '$11,284'],
                    'Changes in Working Capital': ['($4,576)', '($3,425)', '($1,160)', '$4,477'],
                    'Net Cash from Operations': ['$108,853', '$113,766', '$109,088', '$122,151'],
                    'Capital Expenditures': ['($13,985)', '($13,285)', '($10,731)', '($11,085)'],
                    'Acquisitions': ['($2,176)', '($1,837)', '($723)', '($1,452)'],
                    'Net Cash from Investing': ['($16,161)', '($19,280)', '($8,317)', '($14,545)'],
                    'Debt Issuance (Repayment)': ['($2,489)', '($3,772)', '($13,593)', '($9,543)'],
                    'Dividends Paid': ['($15,768)', '($15,119)', '($15,252)', '($14,841)'],
                    'Net Cash from Financing': ['($72,135)', '($89,535)', '($96,009)', '($110,294)'],
                    'Net Change in Cash': ['$20,557', '$4,951', '$4,762', '($2,688)'],
                    'Beginning Cash Balance': ['$34,002', '$29,965', '$25,203', '$35,929'],
                    'Ending Cash Balance': ['$54,559', '$34,916', '$29,965', '$33,241']
                }
            },
            'MSFT': {
                name: 'Microsoft Corporation',
                fiscalYearEnd: "Jun 30", // Microsoft's fiscal year ends in June
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2024, 2023, 2022, 2021],
                sharesOutstanding: 7431.51, // In millions
                description: "Microsoft Corporation develops, licenses, and supports software, services, devices, and solutions worldwide. The company operates through three segments: Productivity and Business Processes, Intelligent Cloud, and More Personal Computing. It offers Microsoft 365, Office, Windows, and Azure cloud services.",
                sector: "Technology",
                industry: "Softwareâ€”Infrastructure",
                founded: "1975",
                headquarters: "Redmond, Washington, USA",
                incomeStatement: {
                    'Revenue': ['$263,725', '$233,176', '$211,915', '$198,270'],
                    'Cost of Revenue': ['($76,845)', '($72,826)', '($65,334)', '($62,820)'],
                    'Gross Profit': ['$186,880', '$160,350', '$146,581', '$135,450'],
                    'Operating Expenses': ['($65,365)', '($60,339)', '($56,742)', '($53,334)'],
                    'R&D Expenses': ['($35,327)', '($30,114)', '($27,195)', '($24,512)'],
                    'Operating Income': ['$121,515', '$99,263', '$88,523', '$83,383'],
                    'Other Income': ['$1,234', '$893', '$417', '$1,186'],
                    'Tax Expense': ['($16,897)', '($13,231)', '($11,779)', '($10,978)'],
                    'Net Income': ['$105,852', '$86,799', '$76,886', '$72,738']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$27,634', '$9,467', '$14,385', '$13,931'],
                    'Accounts Receivable': ['$49,734', '$45,286', '$41,427', '$44,261'],
                    'Inventory': ['$4,897', '$4,613', '$4,169', '$3,742'],
                    'Total Current Assets': ['$201,463', '$180,956', '$167,886', '$169,680'],
                    'Property & Equipment': ['$115,937', '$99,961', '$87,854', '$73,715'],
                    'Intangible Assets': ['$9,412', '$10,063', '$11,175', '$11,297'],
                    'Total Assets': ['$516,827', '$467,175', '$417,211', '$364,840'],
                    'Accounts Payable': ['$21,873', '$20,175', '$19,000', '$18,237'],
                    'Short-term Debt': ['$10,825', '$11,473', '$5,247', '$2,749'],
                    'Total Current Liabilities': ['$127,344', '$116,154', '$106,582', '$96,571'],
                    'Long-term Debt': ['$69,578', '$69,280', '$67,775', '$47,032'],
                    'Total Liabilities': ['$253,764', '$238,763', '$222,830', '$192,633'],
                    'Common Stock': ['$97,048', '$95,494', '$91,889', '$86,939'],
                    'Retained Earnings': ['$166,015', '$132,918', '$102,492', '$85,268'],
                    'Total Equity': ['$263,063', '$228,412', '$194,381', '$172,207'],
                    'Total Liabilities & Equity': ['$516,827', '$467,175', '$417,211', '$364,840']
                },
                cashFlow: {
                    'Net Income': ['$105,852', '$86,799', '$76,886', '$72,738'],
                    'Depreciation & Amortization': ['$19,863', '$17,862', '$15,932', '$14,460'],
                    'Changes in Working Capital': ['($3,745)', '($6,179)', '($4,621)', '($4,940)'],
                    'Net Cash from Operations': ['$121,970', '$99,412', '$87,445', '$89,035'],
                    'Capital Expenditures': ['($36,874)', '($30,086)', '($26,974)', '($23,886)'],
                    'Acquisitions': ['($11,532)', '($12,015)', '($22,131)', '($20,702)'],
                    'Net Cash from Investing': ['($48,406)', '($42,289)', '($40,139)', '($40,484)'],
                    'Debt Issuance (Repayment)': ['($350)', '$1,305', '$20,326', '$1,189'],
                    'Dividends Paid': ['($23,486)', '($21,532)', '($19,552)', '($18,135)'],
                    'Net Cash from Financing': ['($55,047)', '($60,905)', '($40,636)', '($51,340)'],
                    'Net Change in Cash': ['$18,517', '($3,782)', '$6,670', '($2,789)'],
                    'Beginning Cash Balance': ['$9,467', '$13,249', '$6,579', '$9,368'],
                    'Ending Cash Balance': ['$27,984', '$9,467', '$13,249', '$6,579']
                }
            },
            'AMZN': {
                name: 'Amazon.com Inc.',
                fiscalYearEnd: "Dec 31", // Amazon's fiscal year aligns with calendar year
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2024, 2023, 2022, 2021],
                sharesOutstanding: 10429.13, // In millions
                description: "Amazon.com, Inc. operates as an online retailer, manufacturer of electronic devices, and provider of cloud computing services. The company operates through three segments: North America, International, and AWS. Its products include merchandise and content purchased for resale, and products offered by third-party sellers.",
                sector: "Consumer Cyclical",
                industry: "Internet Retail",
                founded: "1994",
                headquarters: "Seattle, Washington, USA",
                incomeStatement: {
                    'Revenue': ['$637,959', '$574,783', '$513,983', '$469,822'],
                    'Cost of Revenue': ['($356,528)', '($319,461)', '($288,531)', '($272,344)'],
                    'Gross Profit': ['$281,431', '$255,322', '$225,452', '$197,478'],
                    'Operating Expenses': ['($229,115)', '($207,781)', '($185,691)', '($167,733)'],
                    'R&D Expenses': ['($101,556)', '($91,523)', '($82,273)', '($73,137)'],
                    'Operating Income': ['$52,316', '$48,052', '$36,916', '$24,879'],
                    'Other Income': ['$1,624', '($2,748)', '($2,175)', '($1,568)'],
                    'Tax Expense': ['($12,166)', '($11,172)', '($8,965)', '($4,791)'],
                    'Net Income': ['$41,774', '$37,523', '$30,425', '$21,413']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$87,228', '$73,557', '$54,253', '$36,220'],
                    'Accounts Receivable': ['$45,359', '$39,183', '$35,604', '$32,302'],
                    'Inventory': ['$37,807', '$36,144', '$34,427', '$32,640'],
                    'Total Current Assets': ['$195,561', '$173,635', '$146,791', '$133,876'],
                    'Property & Equipment': ['$227,344', '$209,242', '$186,715', '$160,281'],
                    'Intangible Assets': ['$8,322', '$8,572', '$8,629', '$8,673'],
                    'Total Assets': ['$497,810', '$450,672', '$410,770', '$369,960'],
                    'Accounts Payable': ['$102,003', '$92,855', '$84,525', '$79,600'],
                    'Short-term Debt': ['$6,584', '$5,752', '$3,896', '$1,491'],
                    'Total Current Liabilities': ['$176,538', '$164,793', '$149,146', '$142,266'],
                    'Long-term Debt': ['$62,946', '$64,191', '$64,923', '$67,651'],
                    'Total Liabilities': ['$326,587', '$302,921', '$292,754', '$282,304'],
                    'Common Stock': ['$70,354', '$64,382', '$59,823', '$55,434'],
                    'Retained Earnings': ['$100,869', '$83,369', '$58,193', '$32,222'],
                    'Total Equity': ['$171,223', '$147,751', '$118,016', '$87,656'],
                    'Total Liabilities & Equity': ['$497,810', '$450,672', '$410,770', '$369,960']
                },
                cashFlow: {
                    'Net Income': ['$41,774', '$37,523', '$30,425', '$21,413'],
                    'Depreciation & Amortization': ['$52,448', '$46,282', '$43,967', '$41,921'],
                    'Changes in Working Capital': ['$5,189', '($5,186)', '($7,249)', '($6,335)'],
                    'Net Cash from Operations': ['$99,411', '$87,923', '$71,723', '$64,761'],
                    'Capital Expenditures': ['($59,876)', '($53,485)', '($58,321)', '($61,053)'],
                    'Acquisitions': ['($3,248)', '($4,198)', '($1,307)', '($8,316)'],
                    'Net Cash from Investing': ['($63,124)', '($47,936)', '($55,729)', '($58,154)'],
                    'Debt Issuance (Repayment)': ['($411)', '($1,242)', '($2,918)', '$12,367'],
                    'Dividends Paid': ['$0', '$0', '$0', '$0'],
                    'Net Cash from Financing': ['($22,616)', '($13,283)', '$8,157', '($12,010)'],
                    'Net Change in Cash': ['$13,671', '$26,704', '$24,151', '($5,403)'],
                    'Beginning Cash Balance': ['$73,557', '$60,870', '$36,719', '$42,122'],
                    'Ending Cash Balance': ['$87,228', '$87,574', '$60,870', '$36,719']
                }
            },
            'GOOGL': {
                name: 'Alphabet Inc.',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2024, 2023, 2022, 2021],
                sharesOutstanding: 12338.89, // In millions
                description: "Alphabet Inc. is the parent company of Google and several former Google subsidiaries. It operates through Google Services, Google Cloud, and Other Bets segments. Google Services includes products and services such as Google Search, Gmail, Maps, Play, Android, Chrome, hardware, and YouTube.",
                sector: "Communication Services",
                industry: "Internet Content & Information",
                founded: "1998 (as Google)",
                headquarters: "Mountain View, California, USA",
                incomeStatement: {
                    'Revenue': ['$350,018', '$307,394', '$282,836', '$257,637'],
                    'Cost of Revenue': ['($153,008)', '($133,503)', '($126,203)', '($110,939)'],
                    'Gross Profit': ['$197,010', '$173,891', '$156,633', '$146,698'],
                    'Operating Expenses': ['($113,506)', '($102,799)', '($97,016)', '($79,712)'],
                    'R&D Expenses': ['($50,854)', '($47,517)', '($41,158)', '($31,562)'],
                    'Operating Income': ['$83,504', '$71,092', '$59,617', '$66,986'],
                    'Other Income': ['$5,451', '$3,118', '($2,045)', '$12,020'],
                    'Tax Expense': ['($14,033)', '($13,856)', '($9,942)', '($14,701)'],
                    'Net Income': ['$74,922', '$60,354', '$47,630', '$64,305']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$26,581', '$24,519', '$21,879', '$20,945'],
                    'Accounts Receivable': ['$36,009', '$37,898', '$31,807', '$31,254'],
                    'Inventory': ['$2,827', '$2,479', '$2,120', '$1,170'],
                    'Total Current Assets': ['$176,297', '$179,347', '$164,795', '$188,143'],
                    'Property & Equipment': ['$118,429', '$115,965', '$111,024', '$97,599'],
                    'Intangible Assets': ['$1,592', '$1,826', '$2,319', '$2,706'],
                    'Total Assets': ['$397,587', '$394,751', '$364,801', '$359,268'],
                    'Accounts Payable': ['$5,900', '$8,261', '$7,221', '$5,616'],
                    'Short-term Debt': ['$0', '$0', '$0', '$0'],
                    'Total Current Liabilities': ['$69,783', '$69,621', '$64,636', '$56,156'],
                    'Long-term Debt': ['$13,201', '$13,194', '$14,701', '$14,817'],
                    'Total Liabilities': ['$121,889', '$122,675', '$109,808', '$97,432'],
                    'Common Stock': ['$65,259', '$64,199', '$61,777', '$58,512'],
                    'Retained Earnings': ['$210,439', '$207,877', '$193,216', '$163,401'],
                    'Total Equity': ['$275,698', '$272,076', '$254,993', '$251,635'],
                    'Total Liabilities & Equity': ['$397,587', '$394,751', '$364,801', '$349,067']
                },
                cashFlow: {
                    'Net Income': ['$74,922', '$60,354', '$47,630', '$64,305'],
                    'Depreciation & Amortization': ['$34,125', '$30,277', '$28,295', '$25,515'],
                    'Changes in Working Capital': ['($15,244)', '($2,857)', '$3,172', '($4,465)'],
                    'Net Cash from Operations': ['$93,803', '$87,774', '$79,097', '$85,355'],
                    'Capital Expenditures': ['($39,547)', '($32,317)', '($31,485)', '($21,552)'],
                    'Acquisitions': ['($9,756)', '($13,037)', '($4,113)', '($3,616)'],
                    'Net Cash from Investing': ['($49,303)', '($45,354)', '($35,598)', '($25,168)'],
                    'Debt Issuance (Repayment)': ['$28', '($1,507)', '($116)', '($114)'],
                    'Dividends Paid': ['($42,466)', '($38,294)', '($37,125)', '($31,091)'],
                    'Net Cash from Financing': ['($42,438)', '($39,801)', '($37,241)', '($31,205)'],
                    'Net Change in Cash': ['$2,062', '$2,619', '$6,258', '$28,982'],
                    'Beginning Cash Balance': ['$24,519', '$21,879', '$15,621', '$4,339'],
                    'Ending Cash Balance': ['$26,581', '$24,498', '$21,879', '$33,321']
                }
            },
            'META': {
                name: 'Meta Platforms, Inc.',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2024, 2023, 2022, 2021],
                sharesOutstanding: 2560.23, // In millions
                description: "Meta Platforms, Inc. develops products that enable people to connect and share through mobile devices, personal computers, virtual reality headsets, and in-home devices. Its family of apps includes Facebook, Instagram, WhatsApp, and Messenger. The company is also investing heavily in the metaverse and AI.",
                sector: "Communication Services",
                industry: "Internet Content & Information",
                founded: "2004 (as Facebook)",
                headquarters: "Menlo Park, California, USA",
                incomeStatement: {
                    'Revenue': ['$163,535', '$134,902', '$116,609', '$117,929'],
                    'Cost of Revenue': ['($36,832)', '($30,276)', '($27,892)', '($22,649)'],
                    'Gross Profit': ['$126,703', '$104,626', '$88,717', '$95,280'],
                    'Operating Expenses': ['($70,789)', '($66,175)', '($74,495)', '($59,601)'],
                    'R&D Expenses': ['($40,621)', '($37,735)', '($35,338)', '($24,655)'],
                    'Operating Income': ['$55,914', '$38,451', '$14,222', '$35,679'],
                    'Other Income': ['$2,311', '$1,841', '($125)', '$531'],
                    'Tax Expense': ['($9,102)', '($5,852)', '($5,619)', '($7,639)'],
                    'Net Income': ['$49,123', '$34,440', '$8,478', '$28,571']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$14,245', '$8,942', '$14,681', '$10,060'],
                    'Accounts Receivable': ['$16,551', '$16,748', '$12,763', '$14,039'],
                    'Inventory': ['$0', '$0', '$0', '$0'],
                    'Total Current Assets': ['$73,957', '$69,683', '$63,522', '$64,793'],
                    'Property & Equipment': ['$86,795', '$79,483', '$69,663', '$57,809'],
                    'Intangible Assets': ['$806', '$894', '$1,127', '$740'],
                    'Total Assets': ['$209,759', '$198,356', '$166,000', '$165,987'],
                    'Accounts Payable': ['$834', '$1,178', '$5,552', '$4,083'],
                    'Short-term Debt': ['$0', '$0', '$0', '$0'],
                    'Total Current Liabilities': ['$22,037', '$21,606', '$19,592', '$21,381'],
                    'Long-term Debt': ['$18,444', '$18,387', '$9,923', '$10,572'],
                    'Total Liabilities': ['$59,272', '$55,649', '$44,819', '$47,277'],
                    'Common Stock': ['$45,050', '$45,050', '$45,193', '$45,000'],
                    'Retained Earnings': ['$105,437', '$97,657', '$75,988', '$73,710'],
                    'Total Equity': ['$150,487', '$142,707', '$121,181', '$118,710'],
                    'Total Liabilities & Equity': ['$209,759', '$198,356', '$166,000', '$165,987']
                },
                cashFlow: {
                    'Net Income': ['$49,123', '$34,440', '$8,478', '$28,571'],
                    'Depreciation & Amortization': ['$14,258', '$12,490', '$9,081', '$7,968'],
                    'Changes in Working Capital': ['($11,276)', '($8,120)', '($2,525)', '$1,681'],
                    'Net Cash from Operations': ['$52,105', '$38,810', '$15,034', '$38,220'],
                    'Capital Expenditures': ['($38,745)', '($30,243)', '($32,040)', '($19,236)'],
                    'Acquisitions': ['($1,257)', '($193)', '($1,317)', '($851)'],
                    'Net Cash from Investing': ['($40,002)', '($30,436)', '($33,357)', '($20,087)'],
                    'Debt Issuance (Repayment)': ['$57', '$8,464', '($650)', '($805)'],
                    'Dividends Paid': ['($6,857)', '($12,817)', '($6,520)', '($4,511)'],
                    'Net Cash from Financing': ['($6,800)', '($4,353)', '($7,170)', '($5,316)'],
                    'Net Change in Cash': ['$5,303', '$4,021', '($25,493)', '$12,817'],
                    'Beginning Cash Balance': ['$8,942', '$4,921', '$40,174', '$27,357'],
                    'Ending Cash Balance': ['$14,245', '$8,942', '$14,681', '$40,174']
                }
            },
            'TSLA': {
                name: 'Tesla, Inc.',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2024, 2023, 2022, 2021],
                sharesOutstanding: 3189.33, // In millions
                description: "Tesla, Inc. designs, develops, manufactures, and sells electric vehicles, energy generation and storage systems. The company operates through Automotive, Energy Generation and Storage segments. Tesla also provides vehicle service centers, Supercharger stations, and self-driving capability.",
                sector: "Consumer Cyclical",
                industry: "Auto Manufacturers",
                founded: "2003",
                headquarters: "Austin, Texas, USA",
                incomeStatement: {
                    'Revenue': ['$95,875', '$96,773', '$81,462', '$53,823'],
                    'Cost of Revenue': ['($75,294)', '($77,473)', '($60,339)', '($40,228)'],
                    'Gross Profit': ['$20,581', '$19,300', '$21,123', '$13,595'],
                    'Operating Expenses': ['($10,891)', '($10,273)', '($7,560)', '($5,144)'],
                    'R&D Expenses': ['($3,834)', '($3,453)', '($3,075)', '($2,593)'],
                    'Operating Income': ['$9,690', '$9,027', '$13,563', '$8,451'],
                    'Other Income': ['$385', '$87', '$151', '$109'],
                    'Tax Expense': ['($1,357)', '($1,225)', '($1,132)', '($699)'],
                    'Net Income': ['$8,718', '$7,889', '$12,582', '$7,861']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$26,057', '$29,091', '$22,159', '$18,144'],
                    'Accounts Receivable': ['$5,470', '$5,538', '$4,023', '$2,851'],
                    'Inventory': ['$10,407', '$14,054', '$12,756', '$6,618'],
                    'Total Current Assets': ['$49,226', '$54,691', '$43,901', '$31,098'],
                    'Property & Equipment': ['$41,881', '$42,335', '$36,147', '$23,861'],
                    'Intangible Assets': ['$198', '$227', '$284', '$344'],
                    'Total Assets': ['$111,446', '$113,332', '$93,633', '$62,132'],
                    'Accounts Payable': ['$10,239', '$11,862', '$11,146', '$8,452'],
                    'Short-term Debt': ['$2,933', '$2,932', '$1,317', '$1,586'],
                    'Total Current Liabilities': ['$25,334', '$27,308', '$24,669', '$18,126'],
                    'Long-term Debt': ['$2,805', '$2,952', '$2,672', '$5,245'],
                    'Total Liabilities': ['$35,358', '$37,319', '$30,510', '$26,941'],
                    'Common Stock': ['$0', '$0', '$0', '$0'],
                    'Retained Earnings': ['$26,725', '$26,467', '$18,578', '$5,996'],
                    'Total Equity': ['$76,088', '$76,013', '$63,123', '$35,191'],
                    'Total Liabilities & Equity': ['$111,446', '$113,332', '$93,633', '$62,132']
                },
                cashFlow: {
                    'Net Income': ['$8,718', '$7,889', '$12,582', '$7,861'],
                    'Depreciation & Amortization': ['$4,572', '$4,572', '$3,707', '$2,914'],
                    'Changes in Working Capital': ['($1,547)', '$1,681', '($5,005)', '$2,452'],
                    'Net Cash from Operations': ['$11,743', '$13,265', '$14,724', '$11,497'],
                    'Capital Expenditures': ['($8,543)', '($8,875)', '($7,158)', '($6,514)'],
                    'Acquisitions': ['($234)', '($114)', '($76)', '($43)'],
                    'Net Cash from Investing': ['($8,777)', '($6,169)', '($9,061)', '($6,852)'],
                    'Debt Issuance (Repayment)': ['($146)', '$1,773', '($2,930)', '($1,622)'],
                    'Dividends Paid': ['$0', '$0', '$0', '$0'],
                    'Net Cash from Financing': ['($5,000)', '($318)', '($2,518)', '$7,419'],
                    'Net Change in Cash': ['($2,034)', '$6,778', '$3,145', '$12,064'],
                    'Beginning Cash Balance': ['$29,091', '$22,185', '$19,040', '$6,976'],
                    'Ending Cash Balance': ['$27,057', '$28,963', '$22,185', '$19,040']
                }
            },
            'NVDA': {
                name: 'NVIDIA Corporation',
                fiscalYearEnd: "Jan 31", // NVIDIA's fiscal year ends in January
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2024, 2023, 2022, 2021],
                sharesOutstanding: 2462.00, // In millions
                description: "NVIDIA Corporation designs, develops, and markets graphics processing units (GPUs) and related software. The company operates through two segments: Graphics and Compute & Networking. It provides GPU products for gaming, professional visualization, data center, and automotive markets.",
                sector: "Technology",
                industry: "Semiconductors",
                founded: "1993",
                headquarters: "Santa Clara, California, USA",
                incomeStatement: {
                    'Revenue': ['$118,517', '$60,922', '$26,974', '$26,914'],
                    'Cost of Revenue': ['($32,159)', '($17,532)', '($10,663)', '($9,670)'],
                    'Gross Profit': ['$86,358', '$43,390', '$16,311', '$17,244'],
                    'Operating Expenses': ['($18,037)', '($10,109)', '($9,328)', '($7,434)'],
                    'R&D Expenses': ['($11,074)', '($6,540)', '($6,325)', '($5,268)'],
                    'Operating Income': ['$68,321', '$33,281', '$6,983', '$9,810'],
                    'Other Income': ['$4,721', '$1,178', '$124', '($106)'],
                    'Tax Expense': ['($8,946)', '($3,936)', '($634)', '($648)'],
                    'Net Income': ['$64,096', '$29,759', '$6,206', '$9,752']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$28,839', '$24,268', '$10,042', '$21,208'],
                    'Accounts Receivable': ['$13,904', '$11,392', '$3,827', '$4,650'],
                    'Inventory': ['$5,367', '$5,282', '$5,159', '$2,605'],
                    'Total Current Assets': ['$56,339', '$45,773', '$22,945', '$32,322'],
                    'Property & Equipment': ['$6,063', '$3,544', '$3,044', '$2,778'],
                    'Intangible Assets': ['$952', '$1,121', '$1,646', '$2,339'],
                    'Total Assets': ['$78,363', '$65,120', '$36,112', '$44,187'],
                    'Accounts Payable': ['$3,350', '$3,147', '$1,193', '$1,783'],
                    'Short-term Debt': ['$1,747', '$1,745', '$1,250', '$1,250'],
                    'Total Current Liabilities': ['$12,841', '$10,279', '$5,428', '$6,652'],
                    'Long-term Debt': ['$9,726', '$9,730', '$9,703', '$10,946'],
                    'Total Liabilities': ['$28,345', '$23,303', '$17,669', '$19,487'],
                    'Common Stock': ['$16,021', '$15,801', '$12,446', '$11,672'],
                    'Retained Earnings': ['$33,997', '$26,016', '$5,997', '$13,028'],
                    'Total Equity': ['$50,018', '$41,817', '$18,443', '$24,700'],
                    'Total Liabilities & Equity': ['$78,363', '$65,120', '$36,112', '$44,187']
                },
                cashFlow: {
                    'Net Income': ['$64,096', '$29,759', '$6,206', '$9,752'],
                    'Depreciation & Amortization': ['$3,245', '$824', '$1,186', '$1,174'],
                    'Changes in Working Capital': ['($8,253)', '($6,010)', '($1,136)', '($663)'],
                    'Net Cash from Operations': ['$59,088', '$26,894', '$8,821', '$9,108'],
                    'Capital Expenditures': ['($10,247)', '($948)', '($780)', '($976)'],
                    'Acquisitions': ['($15,500)', '$0', '$0', '($263)'],
                    'Net Cash from Investing': ['($25,747)', '($5,493)', '($3,354)', '($9,830)'],
                    'Debt Issuance (Repayment)': ['($2)', '$0', '$0', '($1,000)'],
                    'Dividends Paid': ['($8,768)', '($247)', '($398)', '($399)'],
                    'Net Cash from Financing': ['($8,770)', '($6,951)', '($16,649)', '($9,321)'],
                    'Net Change in Cash': ['$4,571', '$14,450', '($11,182)', '($10,043)'],
                    'Beginning Cash Balance': ['$24,268', '$9,818', '$21,000', '$31,043'],
                    'Ending Cash Balance': ['$28,839', '$24,268', '$9,818', '$21,000']
                }
            },
            'JNJ': {
                name: 'Johnson & Johnson',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2024, 2023, 2022, 2021],
                sharesOutstanding: 2405.27, // In millions
                description: "Johnson & Johnson is a healthcare conglomerate that researches, develops, manufactures, and sells various healthcare products. The company operates through three segments: Consumer Health, Pharmaceutical, and Medical Devices. Its well-known brands include Band-Aid, Tylenol, and Neutrogena.",
                sector: "Healthcare",
                industry: "Drug Manufacturersâ€”General",
                founded: "1886",
                headquarters: "New Brunswick, New Jersey, USA",
                incomeStatement: {
                    'Revenue': ['$21,375', '$85,160', '$83,166', '$82,584'],
                    'Cost of Revenue': ['($7,217)', '($28,557)', '($28,829)', '($27,698)'],
                    'Gross Profit': ['$14,158', '$56,603', '$54,337', '$54,886'],
                    'Operating Expenses': ['($8,835)', '($34,987)', '($35,293)', '($28,691)'],
                    'R&D Expenses': ['($3,542)', '($14,596)', '($14,604)', '($14,714)'],
                    'Operating Income': ['$5,323', '$21,616', '$19,044', '$26,195'],
                    'Other Income': ['($36)', '($1,018)', '($531)', '$826'],
                    'Tax Expense': ['($922)', '($1,870)', '($1,924)', '($2,876)'],
                    'Net Income': ['$4,465', '$17,941', '$16,589', '$20,878']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$21,823', '$19,080', '$23,807', '$17,886'],
                    'Accounts Receivable': ['$16,087', '$15,871', '$15,876', '$17,839'],
                    'Inventory': ['$12,159', '$11,294', '$10,992', '$9,514'],
                    'Total Current Assets': ['$54,644', '$51,489', '$55,217', '$51,027'],
                    'Property & Equipment': ['$18,775', '$18,823', '$19,764', '$19,151'],
                    'Intangible Assets': ['$79,654', '$81,591', '$86,565', '$88,891'],
                    'Total Assets': ['$174,297', '$171,962', '$178,379', '$175,143'],
                    'Accounts Payable': ['$9,992', '$9,794', '$10,246', '$11,575'],
                    'Short-term Debt': ['$3,851', '$4,943', '$2,203', '$7,176'],
                    'Total Current Liabilities': ['$37,842', '$37,435', '$33,766', '$42,311'],
                    'Long-term Debt': ['$27,943', '$28,749', '$29,808', '$30,253'],
                    'Total Liabilities': ['$96,522', '$95,944', '$92,963', '$97,598'],
                    'Common Stock': ['$3,120', '$3,120', '$3,120', '$3,120'],
                    'Retained Earnings': ['$119,681', '$117,847', '$109,051', '$106,483'],
                    'Total Equity': ['$77,775', '$76,018', '$85,416', '$77,545'],
                    'Total Liabilities & Equity': ['$174,297', '$171,962', '$178,379', '$175,143']
                },
                cashFlow: {
                    'Net Income': ['$4,465', '$17,941', '$16,589', '$20,878'],
                    'Depreciation & Amortization': ['$1,824', '$7,444', '$7,665', '$7,438'],
                    'Changes in Working Capital': ['($1,217)', '($2,122)', '($1,881)', '$1,170'],
                    'Net Cash from Operations': ['$4,982', '$22,218', '$22,536', '$24,026'],
                    'Capital Expenditures': ['($833)', '($3,698)', '($3,948)', '($3,762)'],
                    'Acquisitions': ['($121)', '($628)', '($954)', '($981)'],
                    'Net Cash from Investing': ['$1,026', '$664', '($1,571)', '($5,497)'],
                    'Debt Issuance (Repayment)': ['($1,898)', '$1,681', '($5,418)', '($1,120)'],
                    'Dividends Paid': ['($2,631)', '($11,745)', '($11,621)', '($11,032)'],
                    'Net Cash from Financing': ['($3,265)', '($27,609)', '($15,044)', '($13,680)'],
                    'Net Change in Cash': ['$2,743', '($4,727)', '$5,921', '$4,849'],
                    'Beginning Cash Balance': ['$19,080', '$23,807', '$17,886', '$13,037'],
                    'Ending Cash Balance': ['$21,823', '$19,080', '$23,807', '$17,886']
                }
            },
            '0700.HK': {
                name: 'Tencent Holdings Ltd.',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "Â¥",  // RMB (Chinese Yuan)
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 9490.89, // In millions
                description: "Tencent Holdings Ltd. is a Chinese multinational technology and entertainment conglomerate. It offers products and services including social networks (WeChat), online games, payment systems, streaming media, and cloud services. It is one of the largest gaming companies worldwide.",
                sector: "Communication Services",
                industry: "Internet Content & Information",
                founded: "1998",
                headquarters: "Shenzhen, China",
                incomeStatement: {
                    'Revenue': ['Â¥609,495', 'Â¥554,552', 'Â¥560,118', 'Â¥482,064'],
                    'Cost of Revenue': ['(Â¥325,457)', '(Â¥307,599)', '(Â¥314,174)', '(Â¥260,532)'],
                    'Gross Profit': ['Â¥284,038', 'Â¥246,953', 'Â¥245,944', 'Â¥221,532'],
                    'Operating Expenses': ['(Â¥120,156)', '(Â¥115,715)', '(Â¥99,852)', '(Â¥85,096)'],
                    'R&D Expenses': ['(Â¥57,621)', '(Â¥51,854)', '(Â¥43,682)', '(Â¥38,972)'],
                    'Operating Income': ['Â¥163,882', 'Â¥131,238', 'Â¥146,092', 'Â¥136,436'],
                    'Other Income': ['Â¥10,716', 'Â¥4,842', 'Â¥89,036', 'Â¥6,141'],
                    'Tax Expense': ['(Â¥30,189)', '(Â¥18,529)', '(Â¥25,394)', '(Â¥19,897)'],
                    'Net Income': ['Â¥115,651', 'Â¥101,874', 'Â¥159,847', 'Â¥122,742']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['Â¥310,188', 'Â¥261,138', 'Â¥223,089', 'Â¥167,966'],
                    'Accounts Receivable': ['Â¥58,342', 'Â¥58,351', 'Â¥58,469', 'Â¥43,980'],
                    'Inventory': ['Â¥1,053', 'Â¥1,049', 'Â¥835', 'Â¥814'],
                    'Total Current Assets': ['Â¥414,604', 'Â¥362,181', 'Â¥325,555', 'Â¥253,968'],
                    'Property & Equipment': ['Â¥74,254', 'Â¥56,662', 'Â¥50,453', 'Â¥42,731'],
                    'Intangible Assets': ['Â¥54,798', 'Â¥56,532', 'Â¥50,042', 'Â¥29,906'],
                    'Total Assets': ['Â¥1,323,758', 'Â¥1,218,934', 'Â¥1,120,224', 'Â¥806,299'],
                    'Accounts Payable': ['Â¥133,185', 'Â¥127,080', 'Â¥124,850', 'Â¥94,030'],
                    'Short-term Debt': ['Â¥23,924', 'Â¥25,855', 'Â¥19,692', 'Â¥14,242'],
                    'Total Current Liabilities': ['Â¥316,810', 'Â¥298,063', 'Â¥293,119', 'Â¥229,001'],
                    'Long-term Debt': ['Â¥152,126', 'Â¥174,761', 'Â¥187,180', 'Â¥112,145'],
                    'Total Liabilities': ['Â¥559,626', 'Â¥552,179', 'Â¥561,270', 'Â¥410,846'],
                    'Common Stock': ['Â¥-', 'Â¥-', 'Â¥-', 'Â¥-'],
                    'Retained Earnings': ['Â¥665,873', 'Â¥576,019', 'Â¥481,885', 'Â¥332,451'],
                    'Total Equity': ['Â¥764,132', 'Â¥666,755', 'Â¥558,954', 'Â¥395,453'],
                    'Total Liabilities & Equity': ['Â¥1,323,758', 'Â¥1,218,934', 'Â¥1,120,224', 'Â¥806,299']
                },
                cashFlow: {
                    'Net Income': ['Â¥115,651', 'Â¥101,874', 'Â¥159,847', 'Â¥122,742'],
                    'Depreciation & Amortization': ['Â¥37,512', 'Â¥33,087', 'Â¥27,518', 'Â¥27,927'],
                    'Changes in Working Capital': ['Â¥28,559', 'Â¥6,398', '(Â¥13,917)', 'Â¥24,393'],
                    'Net Cash from Operations': ['Â¥224,438', 'Â¥169,517', 'Â¥172,663', 'Â¥183,158'],
                    'Capital Expenditures': ['(Â¥30,397)', '(Â¥27,731)', '(Â¥26,931)', '(Â¥34,070)'],
                    'Acquisitions': ['(Â¥17,262)', '(Â¥16,785)', '(Â¥129,744)', '(Â¥21,346)'],
                    'Net Cash from Investing': ['(Â¥108,981)', '(Â¥83,687)', '(Â¥215,605)', '(Â¥128,819)'],
                    'Debt Issuance (Repayment)': ['(Â¥31,456)', '(Â¥19,263)', 'Â¥64,237', 'Â¥11,963'],
                    'Dividends Paid': ['(Â¥25,799)', '(Â¥12,675)', '(Â¥11,904)', '(Â¥10,339)'],
                    'Net Cash from Financing': ['(Â¥57,255)', '(Â¥31,938)', 'Â¥35,986', 'Â¥13,577'],
                    'Net Change in Cash': ['Â¥58,202', 'Â¥53,892', '(Â¥6,956)', 'Â¥67,916'],
                    'Beginning Cash Balance': ['Â¥261,138', 'Â¥223,089', 'Â¥230,045', 'Â¥162,129'],
                    'Ending Cash Balance': ['Â¥319,340', 'Â¥276,981', 'Â¥223,089', 'Â¥230,045']
                }
            },
            '9988.HK': {
                name: 'Alibaba Group Holding Limited',
                fiscalYearEnd: "Mar 31",
                currencyUnit: "Millions",
                currencySymbol: "Â¥",  // RMB (Chinese Yuan)
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 20226.11, // In millions
                description: "Alibaba Group Holding Limited is a Chinese multinational technology company specializing in e-commerce, retail, internet, and technology. It provides consumer-to-consumer, business-to-consumer, and business-to-business sales services via web portals, as well as electronic payment services and cloud computing.",
                sector: "Consumer Cyclical",
                industry: "Internet Retail",
                founded: "1999",
                headquarters: "Hangzhou, China",
                incomeStatement: {
                    'Revenue': ['Â¥868,687', 'Â¥853,062', 'Â¥717,289', 'Â¥509,711'],
                    'Cost of Revenue': ['(Â¥518,612)', '(Â¥517,071)', '(Â¥421,205)', '(Â¥282,367)'],
                    'Gross Profit': ['Â¥350,075', 'Â¥335,991', 'Â¥296,084', 'Â¥227,344'],
                    'Operating Expenses': ['(Â¥279,551)', '(Â¥232,267)', '(Â¥206,738)', '(Â¥149,286)'],
                    'R&D Expenses': ['(Â¥63,042)', '(Â¥55,465)', '(Â¥57,236)', '(Â¥43,080)'],
                    'Operating Income': ['Â¥70,524', 'Â¥103,724', 'Â¥89,346', 'Â¥78,058'],
                    'Other Income': ['Â¥11,111', '(Â¥17,844)', 'Â¥72,416', 'Â¥26,867'],
                    'Tax Expense': ['(Â¥24,024)', '(Â¥26,815)', '(Â¥29,278)', '(Â¥20,562)'],
                    'Net Income': ['Â¥47,079', 'Â¥62,001', 'Â¥143,284', 'Â¥81,764']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['Â¥280,071', 'Â¥189,257', 'Â¥321,262', 'Â¥330,503'],
                    'Accounts Receivable': ['Â¥21,696', 'Â¥23,703', 'Â¥22,137', 'Â¥13,017'],
                    'Inventory': ['Â¥24,631', 'Â¥26,064', 'Â¥27,858', 'Â¥26,948'],
                    'Total Current Assets': ['Â¥398,362', 'Â¥330,125', 'Â¥479,944', 'Â¥467,887'],
                    'Property & Equipment': ['Â¥215,312', 'Â¥171,806', 'Â¥152,548', 'Â¥108,440'],
                    'Intangible Assets': ['Â¥43,456', 'Â¥45,231', 'Â¥50,471', 'Â¥60,115'],
                    'Total Assets': ['Â¥1,010,836', 'Â¥893,396', 'Â¥1,055,120', 'Â¥996,050'],
                    'Accounts Payable': ['Â¥186,246', 'Â¥149,767', 'Â¥131,618', 'Â¥110,863'],
                    'Short-term Debt': ['Â¥39,081', 'Â¥24,571', 'Â¥12,476', 'Â¥15,271'],
                    'Total Current Liabilities': ['Â¥303,409', 'Â¥251,434', 'Â¥247,344', 'Â¥240,944'],
                    'Long-term Debt': ['Â¥93,613', 'Â¥95,852', 'Â¥117,779', 'Â¥156,676'],
                    'Total Liabilities': ['Â¥447,124', 'Â¥396,990', 'Â¥420,854', 'Â¥442,158'],
                    'Common Stock': ['Â¥1', 'Â¥1', 'Â¥1', 'Â¥1'],
                    'Retained Earnings': ['Â¥383,358', 'Â¥333,108', 'Â¥264,372', 'Â¥126,642'],
                    'Total Equity': ['Â¥563,712', 'Â¥496,406', 'Â¥634,266', 'Â¥553,892'],
                    'Total Liabilities & Equity': ['Â¥1,010,836', 'Â¥893,396', 'Â¥1,055,120', 'Â¥996,050']
                },
                cashFlow: {
                    'Net Income': ['Â¥47,079', 'Â¥62,001', 'Â¥143,284', 'Â¥81,764'],
                    'Depreciation & Amortization': ['Â¥33,740', 'Â¥30,327', 'Â¥26,389', 'Â¥22,154'],
                    'Changes in Working Capital': ['Â¥36,479', 'Â¥18,016', 'Â¥20,940', 'Â¥40,944'],
                    'Net Cash from Operations': ['Â¥160,040', 'Â¥142,759', 'Â¥231,786', 'Â¥180,907'],
                    'Capital Expenditures': ['(Â¥78,283)', '(Â¥45,088)', '(Â¥41,450)', '(Â¥31,622)'],
                    'Acquisitions': ['(Â¥4,779)', '(Â¥34,347)', '(Â¥13,555)', '(Â¥19,002)'],
                    'Net Cash from Investing': ['(Â¥104,237)', '(Â¥135,640)', '(Â¥231,276)', '(Â¥135,908)'],
                    'Debt Issuance (Repayment)': ['Â¥13,127', '(Â¥9,832)', '(Â¥42,196)', 'Â¥53,032'],
                    'Dividends Paid': ['$0', '$0', '$0', '$0'],
                    'Net Cash from Financing': ['Â¥14,845', '(Â¥132,580)', '(Â¥18,104)', 'Â¥54,037'],
                    'Net Change in Cash': ['Â¥70,648', '(Â¥125,461)', '(Â¥17,594)', 'Â¥99,036'],
                    'Beginning Cash Balance': ['Â¥189,257', 'Â¥321,262', 'Â¥330,503', 'Â¥231,467'],
                    'Ending Cash Balance': ['Â¥259,905', 'Â¥195,801', 'Â¥312,909', 'Â¥330,503']
                }
            },
            '1299.HK': {
                name: 'AIA Group Limited',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "$",  // USD
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 11835.36, // In millions
                description: "AIA Group Limited is one of the largest independent, publicly listed pan-Asian life insurance groups. It offers insurance and financial services products across 18 markets in Asia-Pacific, with a focus on life insurance, health and wellness, and savings products.",
                sector: "Financial Services",
                industry: "Insuranceâ€”Life",
                founded: "1919",
                headquarters: "Hong Kong",
                incomeStatement: {
                    'Revenue': ['$38,382', '$35,346', '$39,089', '$35,780'],
                    'Cost of Revenue': ['($25,812)', '($24,283)', '($27,914)', '($27,234)'],
                    'Gross Profit': ['$12,570', '$11,063', '$11,175', '$8,546'],
                    'Operating Expenses': ['($3,867)', '($3,567)', '($4,058)', '($3,667)'],
                    'R&D Expenses': ['$0', '$0', '$0', '$0'],
                    'Operating Income': ['$8,703', '$7,496', '$7,117', '$4,879'],
                    'Other Income': ['$0', '$0', '$0', '$0'],
                    'Tax Expense': ['($1,451)', '($1,234)', '($1,368)', '($1,127)'],
                    'Net Income': ['$7,252', '$6,262', '$5,749', '$3,752']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$5,493', '$4,581', '$5,404', '$5,619'],
                    'Accounts Receivable': ['$4,214', '$3,902', '$3,711', '$3,573'],
                    'Inventory': ['$0', '$0', '$0', '$0'],
                    'Total Current Assets': ['$256,907', '$253,346', '$260,508', '$234,128'],
                    'Property & Equipment': ['$2,834', '$2,746', '$2,914', '$2,981'],
                    'Intangible Assets': ['$14,577', '$14,585', '$14,747', '$14,487'],
                    'Total Assets': ['$284,532', '$280,893', '$297,957', '$269,533'],
                    'Accounts Payable': ['$5,871', '$5,639', '$5,782', '$4,685'],
                    'Short-term Debt': ['$0', '$0', '$0', '$0'],
                    'Total Current Liabilities': ['$11,847', '$11,293', '$11,889', '$10,073'],
                    'Long-term Debt': ['$10,497', '$8,658', '$9,588', '$8,559'],
                    'Total Liabilities': ['$209,334', '$206,798', '$217,213', '$202,149'],
                    'Common Stock': ['$13,958', '$13,958', '$13,958', '$13,958'],
                    'Retained Earnings': ['$59,736', '$55,651', '$52,594', '$47,386'],
                    'Total Equity': ['$75,198', '$74,095', '$80,744', '$67,384'],
                    'Total Liabilities & Equity': ['$284,532', '$280,893', '$297,957', '$269,533']
                },
                cashFlow: {
                    'Net Income': ['$7,252', '$6,262', '$5,749', '$3,752'],
                    'Depreciation & Amortization': ['$532', '$508', '$540', '$530'],
                    'Changes in Working Capital': ['$11,624', '($1,837)', '$1,856', '$14,373'],
                    'Net Cash from Operations': ['$10,097', '$8,323', '$9,934', '$8,375'],
                    'Capital Expenditures': ['($363)', '($337)', '($451)', '($491)'],
                    'Acquisitions': ['($0)', '($0)', '($0)', '($0)'],
                    'Net Cash from Investing': ['($8,301)', '($7,146)', '($8,286)', '($4,953)'],
                    'Debt Issuance (Repayment)': ['$1,849', '($924)', '$1,025', '($1,157)'],
                    'Dividends Paid': ['($2,371)', '($2,222)', '($2,147)', '($1,997)'],
                    'Net Cash from Financing': ['($2,442)', '($2,097)', '($2,066)', '($2,722)'],
                    'Net Change in Cash': ['($646)', '($920)', '($418)', '$700'],
                    'Beginning Cash Balance': ['$4,581', '$5,404', '$5,619', '$4,926'],
                    'Ending Cash Balance': ['$3,935', '$4,484', '$5,201', '$5,626']
                }
            },
            'V': {
                name: 'Visa Inc.',
                fiscalYearEnd: "Sep 30",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 2015.32, // In millions
                description: "Visa Inc. is a global payments technology company that connects consumers, businesses, banks, and governments in more than 200 countries. The company's processing network, VisaNet, enables fast, secure, and reliable electronic payments and offers products like credit, debit, and prepaid cards.",
                sector: "Financial Services",
                industry: "Credit Services",
                founded: "1958",
                headquarters: "San Francisco, California, USA",
                incomeStatement: {
                    'Revenue': ['$32,648', '$29,310', '$24,105', '$21,846'],
                    'Cost of Revenue': ['($5,907)', '($5,038)', '($4,101)', '($3,917)'],
                    'Gross Profit': ['$26,741', '$24,272', '$20,004', '$17,929'],
                    'Operating Expenses': ['($6,729)', '($6,129)', '($5,245)', '($6,064)'],
                    'R&D Expenses': ['($1,753)', '($1,652)', '($1,451)', '($1,403)'],
                    'Operating Income': ['$20,012', '$18,143', '$14,759', '$11,865'],
                    'Other Income': ['$507', '($518)', '($208)', '($291)'],
                    'Tax Expense': ['($3,865)', '($3,573)', '($3,252)', '($2,924)'],
                    'Net Income': ['$16,729', '$14,957', '$12,311', '$10,866']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$16,285', '$15,689', '$16,487', '$16,289'],
                    'Accounts Receivable': ['$2,566', '$2,412', '$1,968', '$1,708'],
                    'Inventory': ['$0', '$0', '$0', '$0'],
                    'Total Current Assets': ['$24,148', '$21,564', '$22,125', '$20,536'],
                    'Property & Equipment': ['$3,227', '$3,126', '$2,715', '$2,737'],
                    'Intangible Assets': ['$26,364', '$27,331', '$28,379', '$26,592'],
                    'Total Assets': ['$85,886', '$83,241', '$81,461', '$75,489'],
                    'Accounts Payable': ['$982', '$953', '$266', '$328'],
                    'Short-term Debt': ['$3,008', '$999', '$999', '$2,999'],
                    'Total Current Liabilities': ['$19,276', '$16,630', '$14,787', '$13,680'],
                    'Long-term Debt': ['$17,023', '$20,019', '$20,971', '$21,932'],
                    'Total Liabilities': ['$42,967', '$44,262', '$42,529', '$40,730'],
                    'Common Stock': ['$18,476', '$18,135', '$17,758', '$16,721'],
                    'Retained Earnings': ['$24,443', '$20,844', '$21,204', '$18,898'],
                    'Total Equity': ['$42,919', '$38,979', '$38,932', '$34,759'],
                    'Total Liabilities & Equity': ['$85,886', '$83,241', '$81,461', '$75,489']
                },
                cashFlow: {
                    'Net Income': ['$16,729', '$14,957', '$12,311', '$10,866'],
                    'Depreciation & Amortization': ['$883', '$834', '$804', '$767'],
                    'Changes in Working Capital': ['$2,316', '$1,593', '$742', '($563)'],
                    'Net Cash from Operations': ['$18,958', '$17,561', '$13,963', '$10,440'],
                    'Capital Expenditures': ['($846)', '($790)', '($729)', '($736)'],
                    'Acquisitions': ['($250)', '($721)', '($2,655)', '($77)'],
                    'Net Cash from Investing': ['($768)', '($1,598)', '($3,267)', '($801)'],
                    'Debt Issuance (Repayment)': ['($1,000)', '($1,000)', '($3,000)', '$2,939'],
                    'Dividends Paid': ['($3,651)', '($3,202)', '($2,798)', '($2,664)'],
                    'Net Cash from Financing': ['($16,977)', '($16,776)', '($11,306)', '($10,811)'],
                    'Net Change in Cash': ['$1,213', '($813)', '($610)', '($1,172)'],
                    'Beginning Cash Balance': ['$15,689', '$16,487', '$16,289', '$8,838'],
                    'Ending Cash Balance': ['$16,902', '$15,674', '$15,679', '$7,666']
                }
            },
            'PG': {
                name: 'The Procter & Gamble Company',
                fiscalYearEnd: "Jun 30",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 2358.92, // In millions
                description: "The Procter & Gamble Company is an American multinational consumer goods corporation headquartered in Cincinnati, Ohio. The company specializes in a wide range of personal care, hygiene, and cleaning products. Its brands include Tide, Pampers, Gillette, and Crest.",
                sector: "Consumer Defensive",
                industry: "Household & Personal Products",
                founded: "1837",
                headquarters: "Cincinnati, Ohio, USA",
                incomeStatement: {
                    'Revenue': ['$82,006', '$80,187', '$76,118', '$70,950'],
                    'Cost of Revenue': ['($42,532)', '($42,157)', '($37,108)', '($34,786)'],
                    'Gross Profit': ['$39,474', '$38,030', '$39,010', '$36,164'],
                    'Operating Expenses': ['($23,213)', '($22,546)', '($22,151)', '($21,164)'],
                    'R&D Expenses': ['($1,865)', '($1,821)', '($1,991)', '($1,795)'],
                    'Operating Income': ['$16,261', '$15,484', '$16,859', '$15,000'],
                    'Other Income': ['($953)', '($602)', '($346)', '($688)'],
                    'Tax Expense': ['($3,088)', '($3,169)', '($3,263)', '($2,731)'],
                    'Net Income': ['$14,742', '$14,742', '$14,306', '$13,027']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$8,508', '$7,214', '$10,288', '$16,181'],
                    'Accounts Receivable': ['$5,274', '$4,922', '$4,725', '$4,178'],
                    'Inventory': ['$6,766', '$7,055', '$5,937', '$5,498'],
                    'Total Current Assets': ['$22,339', '$20,935', '$22,900', '$28,193'],
                    'Property & Equipment': ['$21,625', '$21,195', '$21,686', '$21,252'],
                    'Intangible Assets': ['$47,308', '$45,204', '$48,479', '$47,682'],
                    'Total Assets': ['$116,281', '$111,553', '$119,268', '$120,700'],
                    'Accounts Payable': ['$13,691', '$13,916', '$13,720', '$12,071'],
                    'Short-term Debt': ['$13,277', '$8,645', '$8,269', '$11,183'],
                    'Total Current Liabilities': ['$36,607', '$31,639', '$31,232', '$33,027'],
                    'Long-term Debt': ['$19,518', '$23,045', '$23,099', '$23,951'],
                    'Total Liabilities': ['$77,175', '$75,658', '$76,650', '$78,803'],
                    'Common Stock': ['$4,263', '$4,009', '$4,009', '$4,009'],
                    'Retained Earnings': ['$103,454', '$99,815', '$97,787', '$90,872'],
                    'Total Equity': ['$39,106', '$35,895', '$46,194', '$47,516'],
                    'Total Liabilities & Equity': ['$116,281', '$111,553', '$119,268', '$120,700']
                },
                cashFlow: {
                    'Net Income': ['$14,742', '$14,742', '$14,306', '$13,027'],
                    'Depreciation & Amortization': ['$3,068', '$3,186', '$3,116', '$3,013'],
                    'Changes in Working Capital': ['($1,343)', '($2,079)', '($1,243)', '$1,646'],
                    'Net Cash from Operations': ['$16,771', '$16,447', '$18,371', '$17,405'],
                    'Capital Expenditures': ['($3,494)', '($3,156)', '($2,787)', '($3,073)'],
                    'Acquisitions': ['($1,271)', '($58)', '($34)', '($58)'],
                    'Net Cash from Investing': ['($4,765)', '($3,371)', '($2,629)', '($3,023)'],
                    'Debt Issuance (Repayment)': ['$1,032', '$337', '($3,621)', '$1,436'],
                    'Dividends Paid': ['($9,036)', '($8,766)', '($8,310)', '($7,789)'],
                    'Net Cash from Financing': ['($10,712)', '($16,089)', '($21,538)', '($15,814)'],
                    'Net Change in Cash': ['$1,294', '($3,013)', '($5,796)', '($1,432)'],
                    'Beginning Cash Balance': ['$7,214', '$10,288', '$16,181', '$4,239'],
                    'Ending Cash Balance': ['$8,508', '$7,275', '$10,385', '$2,807']
                }
            },
            'WMT': {
                name: 'Walmart Inc.',
                fiscalYearEnd: "Jan 31",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2024, 2023, 2022, 2021],
                sharesOutstanding: 2682.83, // In millions
                description: "Walmart Inc. is an American multinational retail corporation that operates a chain of hypermarkets, discount department stores, and grocery stores. Walmart is the world's largest company by revenue and has retail stores and e-commerce operations across 24 countries.",
                sector: "Consumer Defensive",
                industry: "Discount Stores",
                founded: "1962",
                headquarters: "Bentonville, Arkansas, USA",
                incomeStatement: {
                    'Revenue': ['$648,125', '$611,289', '$572,754', '$559,151'],
                    'Cost of Revenue': ['($483,128)', '($457,035)', '($429,000)', '($420,315)'],
                    'Gross Profit': ['$164,997', '$154,254', '$143,754', '$138,836'],
                    'Operating Expenses': ['($135,872)', '($132,006)', '($123,802)', '($119,983)'],
                    'R&D Expenses': ['($0)', '($0)', '($0)', '($0)'],
                    'Operating Income': ['$29,125', '$22,248', '$19,952', '$22,548'],
                    'Other Income': ['($3,158)', '($2,462)', '($1,884)', '($2,375)'],
                    'Tax Expense': ['($6,350)', '($4,756)', '($4,507)', '($6,858)'],
                    'Net Income': ['$15,522', '$11,680', '$13,673', '$13,510']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$17,860', '$12,224', '$14,760', '$17,741'],
                    'Accounts Receivable': ['$9,128', '$8,468', '$8,280', '$6,516'],
                    'Inventory': ['$56,787', '$57,549', '$56,511', '$44,949'],
                    'Total Current Assets': ['$92,174', '$85,565', '$87,116', '$77,860'],
                    'Property & Equipment': ['$99,317', '$95,041', '$94,515', '$92,201'],
                    'Intangible Assets': ['$20,022', '$19,592', '$19,823', '$11,098'],
                    'Total Assets': ['$258,573', '$243,175', '$244,860', '$252,496'],
                    'Accounts Payable': ['$55,079', '$55,887', '$55,261', '$49,141'],
                    'Short-term Debt': ['$7,068', '$5,182', '$2,803', '$3,115'],
                    'Total Current Liabilities': ['$93,978', '$91,416', '$87,379', '$81,392'],
                    'Long-term Debt': ['$43,278', '$38,296', '$36,245', '$41,194'],
                    'Total Liabilities': ['$174,414', '$163,472', '$158,793', '$154,943'],
                    'Common Stock': ['$283', '$283', '$283', '$282'],
                    'Retained Earnings': ['$94,033', '$89,091', '$91,671', '$88,763'],
                    'Total Equity': ['$84,159', '$79,703', '$86,067', '$97,553'],
                    'Total Liabilities & Equity': ['$258,573', '$243,175', '$244,860', '$252,496']
                },
                cashFlow: {
                    'Net Income': ['$15,522', '$11,680', '$13,673', '$13,510'],
                    'Depreciation & Amortization': ['$11,277', '$11,387', '$11,219', '$11,152'],
                    'Changes in Working Capital': ['$3,186', '$3,824', '$5,081', '$7,243'],
                    'Net Cash from Operations': ['$30,246', '$24,438', '$32,130', '$36,074'],
                    'Capital Expenditures': ['($13,315)', '($13,141)', '($13,106)', '($10,264)'],
                    'Acquisitions': ['($1,602)', '($392)', '($1,643)', '($180)'],
                    'Net Cash from Investing': ['($14,917)', '($13,921)', '($14,938)', '($10,071)'],
                    'Debt Issuance (Repayment)': ['$6,868', '$4,430', '($5,261)', '($5,382)'],
                    'Dividends Paid': ['($6,415)', '($6,128)', '($6,152)', '($6,116)'],
                    'Net Cash from Financing': ['($9,693)', '($13,053)', '($20,016)', '($16,117)'],
                    'Net Change in Cash': ['$5,636', '($2,536)', '($2,824)', '$9,886'],
                    'Beginning Cash Balance': ['$12,224', '$14,760', '$17,741', '$9,465'],
                    'Ending Cash Balance': ['$17,860', '$12,224', '$14,917', '$19,351']
                }
            },
            'DIS': {
                name: 'The Walt Disney Company',
                fiscalYearEnd: "Sep 30",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 1828.09, // In millions
                description: "The Walt Disney Company is a global entertainment company operating in four business segments: Entertainment, Sports, Experiences, and International. The company owns film studios including Disney, Pixar, Marvel, and Lucasfilm, theme parks worldwide, streaming services (Disney+, Hulu, ESPN+), and television networks including ABC and ESPN.",
                sector: "Communication Services",
                industry: "Entertainment",
                founded: "1923",
                headquarters: "Burbank, California, USA",
                incomeStatement: {
                    'Revenue': ['$88,898', '$83,747', '$67,418', '$65,388'],
                    'Cost of Revenue': ['($53,636)', '($51,535)', '($43,271)', '($42,223)'],
                    'Gross Profit': ['$35,262', '$32,212', '$24,147', '$23,165'],
                    'Operating Expenses': ['($23,761)', '($20,583)', '($18,513)', '($17,021)'],
                    'R&D Expenses': ['($3,153)', '($3,036)', '($2,819)', '($2,750)'],
                    'Operating Income': ['$11,501', '$11,629', '$5,634', '$6,144'],
                    'Other Income': ['($1,187)', '($1,076)', '($902)', '($1,491)'],
                    'Tax Expense': ['($2,628)', '($2,432)', '($590)', '($699)'],
                    'Net Income': ['$7,186', '$5,308', '$3,031', '($2,864)']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$8,481', '$11,590', '$15,959', '$17,954'],
                    'Accounts Receivable': ['$14,581', '$13,788', '$13,367', '$12,708'],
                    'Inventory': ['$3,241', '$3,028', '$1,331', '$1,583'],
                    'Total Current Assets': ['$28,369', '$30,658', '$33,839', '$35,251'],
                    'Property & Equipment': ['$33,994', '$32,357', '$31,873', '$31,782'],
                    'Intangible Assets': ['$58,131', '$58,874', '$60,092', '$62,292'],
                    'Total Assets': ['$200,753', '$203,635', '$203,609', '$201,549'],
                    'Accounts Payable': ['$10,972', '$10,499', '$9,122', '$8,920'],
                    'Short-term Debt': ['$3,093', '$5,349', '$5,566', '$5,711'],
                    'Total Current Liabilities': ['$30,246', '$33,125', '$31,654', '$26,628'],
                    'Long-term Debt': ['$41,743', '$45,138', '$48,540', '$52,917'],
                    'Total Liabilities': ['$98,927', '$104,621', '$105,687', '$113,582'],
                    'Common Stock': ['$59,021', '$58,471', '$57,204', '$54,497'],
                    'Retained Earnings': ['$43,013', '$40,018', '$45,490', '$40,429'],
                    'Total Equity': ['$101,826', '$99,014', '$97,922', '$87,967'],
                    'Total Liabilities & Equity': ['$200,753', '$203,635', '$203,609', '$201,549']
                },
                cashFlow: {
                    'Net Income': ['$7,186', '$5,308', '$3,031', '($2,864)'],
                    'Depreciation & Amortization': ['$5,513', '$5,207', '$5,111', '$4,981'],
                    'Changes in Working Capital': ['($1,287)', '($1,175)', '($975)', '($613)'],
                    'Net Cash from Operations': ['$10,894', '$5,999', '$5,566', '$7,616'],
                    'Capital Expenditures': ['($5,339)', '($4,943)', '($3,578)', '($4,022)'],
                    'Acquisitions': ['($523)', '($212)', '($125)', '($38)'],
                    'Net Cash from Investing': ['($5,862)', '($5,155)', '($3,780)', '($3,850)'],
                    'Debt Issuance (Repayment)': ['($5,826)', '($3,425)', '($3,653)', '$16,926'],
                    'Dividends Paid': ['($1,567)', '$0', '$0', '($2,895)'],
                    'Net Cash from Financing': ['($7,393)', '($4,652)', '($4,271)', '$8,480'],
                    'Net Change in Cash': ['($2,361)', '($3,808)', '($2,485)', '$12,246'],
                    'Beginning Cash Balance': ['$11,590', '$15,959', '$17,954', '$5,418'],
                    'Ending Cash Balance': ['$9,229', '$12,151', '$15,469', '$17,664']
                }
            },
            'NFLX': {
                name: 'Netflix, Inc.',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 442.31, // In millions
                description: "Netflix, Inc. is an American subscription streaming service and production company. It offers a library of films, television series and games through distribution deals and its own productions. Netflix has expanded into film and television production, and distributes original content through its online platform.",
                sector: "Communication Services",
                industry: "Entertainment",
                founded: "1997",
                headquarters: "Los Gatos, California, USA",
                incomeStatement: {
                    'Revenue': ['$33,724', '$31,615', '$29,698', '$24,996'],
                    'Cost of Revenue': ['($19,232)', '($19,327)', '($17,332)', '($15,276)'],
                    'Gross Profit': ['$14,492', '$12,288', '$12,366', '$9,720'],
                    'Operating Expenses': ['($5,954)', '($6,033)', '($5,770)', '($4,824)'],
                    'R&D Expenses': ['($3,535)', '($3,471)', '($2,943)', '($2,467)'],
                    'Operating Income': ['$8,538', '$6,525', '$6,195', '$4,585'],
                    'Other Income': ['$934', '($756)', '($599)', '($767)'],
                    'Tax Expense': ['($1,866)', '($772)', '($723)', '($362)'],
                    'Net Income': ['$7,606', '$4,997', '$5,116', '$2,761']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$7,085', '$6,058', '$6,028', '$8,205'],
                    'Accounts Receivable': ['$1,995', '$2,186', '$1,530', '$1,142'],
                    'Inventory': ['$0', '$0', '$0', '$0'],
                    'Total Current Assets': ['$10,843', '$9,825', '$9,009', '$9,762'],
                    'Property & Equipment': ['$1,668', '$1,296', '$1,286', '$960'],
                    'Intangible Assets': ['$1,146', '$1,163', '$1,149', '$1,884'],
                    'Total Assets': ['$67,975', '$66,263', '$44,585', '$39,280'],
                    'Accounts Payable': ['$3,532', '$3,633', '$2,752', '$2,275'],
                    'Short-term Debt': ['$1,499', '$1,023', '$699', '$499'],
                    'Total Current Liabilities': ['$10,446', '$10,099', '$7,658', '$7,806'],
                    'Long-term Debt': ['$14,832', '$14,319', '$14,693', '$16,308'],
                    'Total Liabilities': ['$30,586', '$29,148', '$27,508', '$28,215'],
                    'Common Stock': ['$3,702', '$3,447', '$3,813', '$2,901'],
                    'Retained Earnings': ['$33,687', '$33,668', '$13,264', '$8,164'],
                    'Total Equity': ['$37,389', '$37,115', '$17,077', '$11,065'],
                    'Total Liabilities & Equity': ['$67,975', '$66,263', '$44,585', '$39,280']
                },
                cashFlow: {
                    'Net Income': ['$7,606', '$4,997', '$5,116', '$2,761'],
                    'Depreciation & Amortization': ['$2,347', '$2,034', '$1,645', '$1,137'],
                    'Changes in Working Capital': ['$1,184', '$1,572', '$392', '$1,222'],
                    'Net Cash from Operations': ['$11,137', '$8,603', '$7,153', '$5,120'],
                    'Capital Expenditures': ['($622)', '($372)', '($522)', '($498)'],
                    'Acquisitions': ['($151)', '($246)', '($901)', '($575)'],
                    'Net Cash from Investing': ['($773)', '($618)', '($1,517)', '($1,073)'],
                    'Debt Issuance (Repayment)': ['$989', '($50)', '($1,415)', '$1,001'],
                    'Dividends Paid': ['$0', '$0', '$0', '$0'],
                    'Net Cash from Financing': ['($9,337)', '($7,955)', '($6,813)', '($2,408)'],
                    'Net Change in Cash': ['$1,027', '$30', '($1,177)', '$1,639'],
                    'Beginning Cash Balance': ['$6,058', '$6,028', '$8,205', '$5,018'],
                    'Ending Cash Balance': ['$7,085', '$6,058', '$7,028', '$6,657']
                }
            },
            'KO': {
                name: 'The Coca-Cola Company',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 4333.08, // In millions
                description: "The Coca-Cola Company is an American multinational beverage corporation that manufactures, retails, and markets nonalcoholic beverage concentrates and syrups. Its flagship product is Coca-Cola, but it owns over 200 brands of beverages worldwide.",
                sector: "Consumer Defensive",
                industry: "Beveragesâ€”Non-Alcoholic",
                founded: "1892",
                headquarters: "Atlanta, Georgia, USA",
                incomeStatement: {
                    'Revenue': ['$45,754', '$43,004', '$38,655', '$33,014'],
                    'Cost of Revenue': ['($18,625)', '($17,882)', '($15,357)', '($13,433)'],
                    'Gross Profit': ['$27,129', '$25,122', '$23,298', '$19,581'],
                    'Operating Expenses': ['($14,411)', '($13,922)', '($12,144)', '($11,001)'],
                    'R&D Expenses': ['($659)', '($628)', '($618)', '($640)'],
                    'Operating Income': ['$12,718', '$11,200', '$11,154', '$8,997'],
                    'Other Income': ['($1,285)', '($1,532)', '($1,542)', '($1,437)'],
                    'Tax Expense': ['($2,447)', '($2,115)', '($2,621)', '($1,981)'],
                    'Net Income': ['$10,705', '$9,542', '$9,771', '$7,747']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$17,148', '$11,193', '$9,684', '$6,795'],
                    'Accounts Receivable': ['$4,613', '$3,640', '$3,512', '$3,144'],
                    'Inventory': ['$3,919', '$3,858', '$3,407', '$3,266'],
                    'Total Current Assets': ['$29,303', '$21,674', '$19,527', '$19,642'],
                    'Property & Equipment': ['$9,892', '$9,868', '$10,629', '$10,777'],
                    'Intangible Assets': ['$29,393', '$29,293', '$29,920', '$33,601'],
                    'Total Assets': ['$92,808', '$92,368', '$94,781', '$87,296'],
                    'Accounts Payable': ['$13,341', '$13,763', '$13,803', '$11,145'],
                    'Short-term Debt': ['$5,671', '$4,393', '$3,307', '$5,139'],
                    'Total Current Liabilities': ['$24,631', '$22,921', '$21,467', '$18,568'],
                    'Long-term Debt': ['$33,354', '$35,982', '$38,116', '$40,125'],
                    'Total Liabilities': ['$76,001', '$75,483', '$78,372', '$72,924'],
                    'Common Stock': ['$1,760', '$1,760', '$1,760', '$1,760'],
                    'Retained Earnings': ['$72,409', '$69,870', '$69,094', '$66,555'],
                    'Total Equity': ['$16,807', '$16,885', '$21,981', '$19,889'],
                    'Total Liabilities & Equity': ['$92,808', '$92,368', '$94,781', '$87,296']
                },
                cashFlow: {
                    'Net Income': ['$10,705', '$9,542', '$9,771', '$7,747'],
                    'Depreciation & Amortization': ['$1,193', '$1,291', '$1,452', '$1,536'],
                    'Changes in Working Capital': ['$2,008', '$1,603', '$2,117', '($981)'],
                    'Net Cash from Operations': ['$13,207', '$11,018', '$12,625', '$9,844'],
                    'Capital Expenditures': ['($1,622)', '($1,484)', '($1,367)', '($1,177)'],
                    'Acquisitions': ['($1,173)', '($44)', '($4,154)', '($1,052)'],
                    'Net Cash from Investing': ['($2,795)', '($1,528)', '($5,521)', '($2,229)'],
                    'Debt Issuance (Repayment)': ['($1,350)', '($1,048)', '($4,841)', '$5,016'],
                    'Dividends Paid': ['($8,018)', '($7,596)', '($7,252)', '($6,991)'],
                    'Net Cash from Financing': ['($4,457)', '($7,981)', '($4,215)', '($8,156)'],
                    'Net Change in Cash': ['$5,955', '$1,509', '$2,889', '($541)'],
                    'Beginning Cash Balance': ['$11,193', '$9,684', '$6,795', '$6,480'],
                    'Ending Cash Balance': ['$17,148', '$11,193', '$9,684', '$5,939']
                }
            },
            'JPM': {
                name: 'JPMorgan Chase & Co.',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "$",
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 2894.15, // In millions
                description: "JPMorgan Chase & Co. is an American multinational investment bank and financial services holding company. It is one of the largest banking institutions in the United States and offers a wide range of financial services including investment banking, asset management, private banking, treasury services, and commercial banking.",
                sector: "Financial Services",
                industry: "Banksâ€”Diversified",
                founded: "1799 (as The Manhattan Company)",
                headquarters: "New York City, New York, USA",
                incomeStatement: {
                    'Revenue': ['$154,792', '$128,695', '$121,649', '$119,543'],
                    'Cost of Revenue': ['($60,391)', '($46,229)', '($37,469)', '($41,916)'],
                    'Gross Profit': ['$94,401', '$82,466', '$84,180', '$77,627'],
                    'Operating Expenses': ['($39,593)', '($37,560)', '($34,359)', '($31,142)'],
                    'R&D Expenses': ['($12,873)', '($12,471)', '($12,011)', '($11,056)'],
                    'Operating Income': ['$54,808', '$44,906', '$49,821', '$46,485'],
                    'Other Income': ['$1,979', '$1,392', '$1,243', '($1,687)'],
                    'Tax Expense': ['($12,008)', '($9,928)', '($11,228)', '($9,515)'],
                    'Net Income': ['$49,552', '$37,676', '$48,334', '$29,131']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['$465,924', '$548,609', '$740,834', '$527,609'],
                    'Accounts Receivable': ['$198,287', '$215,973', '$181,463', '$170,576'],
                    'Inventory': ['$247,895', '$204,653', '$226,632', '$207,955'],
                    'Total Current Assets': ['$3,120,471', '$3,009,959', '$3,352,123', '$2,996,093'],
                    'Property & Equipment': ['$28,956', '$27,845', '$27,070', '$26,813'],
                    'Intangible Assets': ['$9,238', '$8,885', '$9,047', '$9,305'],
                    'Total Assets': ['$3,879,024', '$3,664,968', '$3,743,567', '$3,386,071'],
                    'Accounts Payable': ['$273,208', '$251,948', '$278,137', '$245,222'],
                    'Short-term Debt': ['$204,328', '$222,838', '$175,206', '$181,342'],
                    'Total Current Liabilities': ['$2,128,936', '$2,020,764', '$2,238,536', '$2,034,245'],
                    'Long-term Debt': ['$419,167', '$432,892', '$301,138', '$281,685'],
                    'Total Liabilities': ['$3,527,675', '$3,330,183', '$3,397,037', '$3,074,754'],
                    'Common Stock': ['$4,105', '$4,105', '$4,105', '$4,105'],
                    'Retained Earnings': ['$301,471', '$272,571', '$254,812', '$236,990'],
                    'Total Equity': ['$351,349', '$334,785', '$346,530', '$311,317'],
                    'Total Liabilities & Equity': ['$3,879,024', '$3,664,968', '$3,743,567', '$3,386,071']
                },
                cashFlow: {
                    'Net Income': ['$49,552', '$37,676', '$48,334', '$29,131'],
                    'Depreciation & Amortization': ['$9,583', '$8,764', '$8,247', '$8,614'],
                    'Changes in Working Capital': ['$15,642', '($26,513)', '$169,392', '$117,572'],
                    'Net Cash from Operations': ['$96,301', '$29,343', '$102,563', '$76,522'],
                    'Capital Expenditures': ['($5,387)', '($4,970)', '($3,757)', '($3,395)'],
                    'Acquisitions': ['($855)', '($1,805)', '($3,157)', '($394)'],
                    'Net Cash from Investing': ['($119,752)', '$28,590', '($68,383)', '($13,570)'],
                    'Debt Issuance (Repayment)': ['($31,771)', '$178,686', '($6,194)', '$56,917'],
                    'Dividends Paid': ['($15,073)', '($13,085)', '($12,858)', '($12,690)'],
                    'Net Cash from Financing': ['($59,234)', '$250,074', '$202,004', '$151,518'],
                    'Net Change in Cash': ['($82,685)', '$308,007', '$236,184', '$214,470'],
                    'Beginning Cash Balance': ['$548,609', '$740,834', '$504,650', '$290,180'],
                    'Ending Cash Balance': ['$465,924', '$1,048,841', '$740,834', '$504,650']
                }
            },
            'BP.L': {
                name: 'BP plc',
                fiscalYearEnd: "Dec 31",
                currencyUnit: "Millions",
                currencySymbol: "Â£",  // GBP (British Pound)
                years: [2023, 2022, 2021, 2020],
                sharesOutstanding: 17145.67, // In millions
                description: "BP plc is a British multinational oil and gas company headquartered in London. It is one of the world's seven oil and gas 'supermajors' and is vertically integrated in exploration, production, refining, distribution, trading, and power generation. The company is increasing its investment in renewable energy and low-carbon technologies.",
                sector: "Energy",
                industry: "Oil & Gas Integrated",
                founded: "1909",
                headquarters: "London, United Kingdom",
                incomeStatement: {
                    'Revenue': ['Â£173,805', 'Â£205,116', 'Â£126,973', 'Â£105,944'],
                    'Cost of Revenue': ['(Â£130,921)', '(Â£158,979)', '(Â£91,617)', '(Â£83,946)'],
                    'Gross Profit': ['Â£42,884', 'Â£46,137', 'Â£35,356', 'Â£21,998'],
                    'Operating Expenses': ['(Â£14,895)', '(Â£17,634)', '(Â£18,632)', '(Â£22,494)'],
                    'R&D Expenses': ['(Â£218)', '(Â£204)', '(Â£193)', '(Â£189)'],
                    'Operating Income': ['Â£27,989', 'Â£28,503', 'Â£16,724', '(Â£685)'],
                    'Other Income': ['(Â£1,223)', '(Â£3,686)', '(Â£1,798)', '(Â£1,068)'],
                    'Tax Expense': ['(Â£7,988)', '(Â£9,907)', '(Â£4,241)', 'Â£1,745'],
                    'Net Income': ['Â£18,778', 'Â£14,910', 'Â£10,685', '(Â£20,305)']
                },
                balanceSheet: {
                    'Cash & Equivalents': ['Â£21,781', 'Â£22,213', 'Â£21,212', 'Â£20,417'],
                    'Accounts Receivable': ['Â£11,933', 'Â£13,873', 'Â£12,212', 'Â£11,985'],
                    'Inventory': ['Â£15,583', 'Â£17,684', 'Â£15,576', 'Â£12,592'],
                    'Total Current Assets': ['Â£52,252', 'Â£56,729', 'Â£52,022', 'Â£46,986'],
                    'Property & Equipment': ['Â£91,526', 'Â£92,701', 'Â£93,842', 'Â£97,272'],
                    'Intangible Assets': ['Â£6,155', 'Â£6,173', 'Â£6,252', 'Â£6,453'],
                    'Total Assets': ['Â£162,891', 'Â£170,366', 'Â£166,386', 'Â£164,494'],
                    'Accounts Payable': ['Â£10,920', 'Â£12,950', 'Â£12,115', 'Â£11,472'],
                    'Short-term Debt': ['Â£3,997', 'Â£4,901', 'Â£4,308', 'Â£4,822'],
                    'Total Current Liabilities': ['Â£37,825', 'Â£42,573', 'Â£40,316', 'Â£38,214'],
                    'Long-term Debt': ['Â£34,328', 'Â£36,197', 'Â£39,261', 'Â£41,572'],
                    'Total Liabilities': ['Â£95,334', 'Â£100,883', 'Â£97,631', 'Â£96,560'],
                    'Common Stock': ['Â£4,931', 'Â£4,932', 'Â£4,930', 'Â£5,383'],
                    'Retained Earnings': ['Â£42,844', 'Â£45,062', 'Â£45,492', 'Â£43,115'],
                    'Total Equity': ['Â£67,557', 'Â£69,483', 'Â£68,755', 'Â£67,934'],
                    'Total Liabilities & Equity': ['Â£162,891', 'Â£170,366', 'Â£166,386', 'Â£164,494']
                },
                cashFlow: {
                    'Net Income': ['Â£18,778', 'Â£14,910', 'Â£10,685', '(Â£20,305)'],
                    'Depreciation & Amortization': ['Â£10,993', 'Â£10,429', 'Â£11,442', 'Â£12,785'],
                    'Changes in Working Capital': ['(Â£2,812)', 'Â£1,043', '(Â£3,792)', '(Â£1,843)'],
                    'Net Cash from Operations': ['Â£25,431', 'Â£28,365', 'Â£20,256', 'Â£12,162'],
                    'Capital Expenditures': ['(Â£8,915)', '(Â£12,057)', '(Â£7,779)', '(Â£9,878)'],
                    'Acquisitions': ['(Â£176)', '(Â£2,036)', '(Â£1,320)', '(Â£2,145)'],
                    'Net Cash from Investing': ['(Â£9,091)', '(Â£14,093)', '(Â£9,099)', '(Â£12,198)'],
                    'Debt Issuance (Repayment)': ['(Â£1,806)', '(Â£2,773)', '(Â£3,608)', 'Â£2,394'],
                    'Dividends Paid': ['(Â£4,394)', '(Â£5,784)', '(Â£4,304)', '(Â£6,340)'],
                    'Net Cash from Financing': ['(Â£15,339)', '(Â£14,704)', '(Â£11,975)', '(Â£3,946)'],
                    'Net Change in Cash': ['Â£1,001', '(Â£432)', '(Â£818)', '(Â£3,982)'],
                    'Beginning Cash Balance': ['Â£21,212', 'Â£22,213', 'Â£22,030', 'Â£26,012'],
                    'Ending Cash Balance': ['Â£22,213', 'Â£21,781', 'Â£21,212', 'Â£22,030']
                }
            }
        };
        
        // Utility function to parse financial numbers from string to actual value
        function parseFinancialNumber(valueStr) {
            if (!valueStr || valueStr === '-') return 0;
            
            // Remove currency symbol, commas, and handle parentheses for negative values
            const isNegative = valueStr.includes('(');
            let numStr = valueStr.replace(/[^0-9.-]/g, '');
            
            // Convert to number
            let value = parseFloat(numStr);
            
            // Apply negative sign if needed
            if (isNegative) value = -value;
            
            return value;
        }
        
        // Utility function to format financial numbers
        function formatFinancialNumber(value, isNegative = false, currencySymbol = '$') {
            if (value === undefined || value === null) return '-';
            
            // Convert to number if it's a string
            const numValue = typeof value === 'string' ? parseFloat(value) : value;
            
            // Determine if the value is negative or if we need to force negative format
            const effectiveIsNegative = numValue < 0 || isNegative;
            
            // Ensure we have a positive number to format
            const absValue = Math.abs(numValue);
            
            // Format with commas for thousands
            const formattedNumber = absValue.toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            // Return with currency symbol and proper negative formatting
            return effectiveIsNegative ? 
                `(${currencySymbol}${formattedNumber})` : 
                `${currencySymbol}${formattedNumber}`;
        }
        
        // Function to calculate compound annual growth rate (CAGR)
        function calculateCAGR(startValue, endValue, years) {
            // Handle edge cases
            if (startValue <= 0 || years === 0) return 0;
            
            // Formula: (endValue / startValue) ^ (1 / years) - 1
            return Math.pow(endValue / startValue, 1 / years) - 1;
        }
        
        // Function to update the table headers with years and fiscal year end
        function updateTableHeaders(data) {
            const yearEnd = data.fiscalYearEnd;
            const years = data.years;
            
            // Income statement headers
            for (let i = 0; i < Math.min(years.length, 4); i++) {
                const element = document.getElementById(`income-year-${i+1}`);
                if (element) {
                    element.textContent = `${yearEnd}, ${years[i]}`;
                }
            }
            
            // Balance sheet headers
            for (let i = 0; i < Math.min(years.length, 4); i++) {
                const element = document.getElementById(`balance-year-${i+1}`);
                if (element) {
                    element.textContent = `${yearEnd}, ${years[i]}`;
                }
            }
            
            // Cash flow headers
            for (let i = 0; i < Math.min(years.length, 4); i++) {
                const element = document.getElementById(`cashflow-year-${i+1}`);
                if (element) {
                    element.textContent = `${yearEnd}, ${years[i]}`;
                }
            }
            
            // Update year range in header
            if (years.length > 0) {
                const lastIndex = Math.min(years.length - 1, 3);
                document.getElementById('yearRangeText').textContent = `(${years[lastIndex]}-${years[0]})`;
            }
            
            // Update currency unit in header - Make it more dynamic
            // Format unit display correctly based on currencyUnit
            let unitDisplay = '';
            if (data.currencyUnit.toLowerCase() === 'millions') {
                unitDisplay = '(000,000s)';
            } else if (data.currencyUnit.toLowerCase() === 'billions') {
                unitDisplay = '(000,000,000s)';
            } else if (data.currencyUnit.toLowerCase() === 'thousands') {
                unitDisplay = '(000s)';
            } else {
                unitDisplay = `(${data.currencyUnit})`;
            }

            // Update all currency unit elements
            const currencyUnitElements = document.querySelectorAll('#currencyUnit');
            currencyUnitElements.forEach(element => {
                element.textContent = `All figures in ${data.currencyUnit} ${data.currencySymbol}${unitDisplay}`;
            });
            
            // Set projection years based on the most recent year
            if (years.length > 0) {
                const baseYear = years[0];
                const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 5;
                
                // Update historical year
                document.getElementById('proj-year-0').textContent = `${yearEnd}, ${baseYear}`;
                
                // Update projection years
                for (let i = 1; i <= forecastPeriod; i++) {
                    const projYear = document.getElementById(`proj-year-${i}`);
                    if (projYear) {
                        projYear.textContent = `${yearEnd}, ${baseYear + i}`;
                    }
                }
                
                // Update terminal year
                document.getElementById('proj-terminal').textContent = `Terminal`;
            }
        }
        
        // Function to populate tables with financial data
        function populateTables(data) {
            // Populate income statement
            const incomeBody = document.getElementById('incomeStatementBody');
            incomeBody.innerHTML = '';
            
            incomeStatementStructure.forEach(item => {
                const row = document.createElement('tr');
                row.className = `border-t border-gray-300 dark:border-gray-700 ${item.cssClass}`;
                
                if (item.isSection && item.colspan) {
                    // Section header row with colspan
                    const cell = document.createElement('td');
                    cell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200 font-medium';
                    cell.colSpan = 5; // Updated to accommodate 4 years
                    cell.textContent = item.label;
                    row.appendChild(cell);
                } else {
                    // Regular row
                    const labelCell = document.createElement('td');
                    labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 font-medium ${item.isTotal ? 'py-3' : ''}`;
                    labelCell.textContent = item.label;
                    row.appendChild(labelCell);
                    
                    // Add up to 4 years of data
                    for (let i = 0; i < 4; i++) {
                        const valueCell = document.createElement('td');
                        valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                        
                        const values = data.incomeStatement[item.label];
                        valueCell.textContent = values && values[i] ? values[i] : '-';
                        
                        row.appendChild(valueCell);
                    }
                }
                
                incomeBody.appendChild(row);
            });
            
            // Populate balance sheet
            const balanceBody = document.getElementById('balanceSheetBody');
            balanceBody.innerHTML = '';
            
            balanceSheetStructure.forEach(item => {
                const row = document.createElement('tr');
                row.className = `border-t border-gray-300 dark:border-gray-700 ${item.cssClass}`;
                
                if (item.isSection && item.colspan) {
                    // Section header row with colspan
                    const cell = document.createElement('td');
                    cell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200 font-medium';
                    cell.colSpan = 5; // Updated to accommodate 4 years
                    cell.textContent = item.label;
                    row.appendChild(cell);
                } else {
                    // Regular row
                    const labelCell = document.createElement('td');
                    labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                    labelCell.textContent = item.label;
                    row.appendChild(labelCell);
                    
                    // Add up to 4 years of data
                    for (let i = 0; i < 4; i++) {
                        const valueCell = document.createElement('td');
                        valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                        
                        const values = data.balanceSheet[item.label];
                        valueCell.textContent = values && values[i] ? values[i] : '-';
                        
                        row.appendChild(valueCell);
                    }
                }
                
                balanceBody.appendChild(row);
            });
            
            // Populate cash flow
            const cashFlowBody = document.getElementById('cashFlowBody');
            cashFlowBody.innerHTML = '';
            
            cashFlowStructure.forEach(item => {
                const row = document.createElement('tr');
                row.className = `border-t border-gray-300 dark:border-gray-700 ${item.cssClass}`;
                
                if (item.isSection && item.colspan) {
                    // Section header row with colspan
                    const cell = document.createElement('td');
                    cell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200 font-medium';
                    cell.colSpan = 5; // Updated to accommodate 4 years
                    cell.textContent = item.label;
                    row.appendChild(cell);
                } else {
                    // Regular row
                    const labelCell = document.createElement('td');
                    labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                    labelCell.textContent = item.label;
                    row.appendChild(labelCell);
                    
                    // Add up to 4 years of data
                    for (let i = 0; i < 4; i++) {
                        const valueCell = document.createElement('td');
                        valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                        
                        const values = data.cashFlow[item.label];
                        valueCell.textContent = values && values[i] ? values[i] : '-';
                        
                        row.appendChild(valueCell);
                    }
                }
                
                cashFlowBody.appendChild(row);
            });
            
            // Update shares outstanding and net debt information
            updateCompanyInfo(data);
        }
        
        // Update shares outstanding and net debt info
        function updateCompanyInfo(data) {
            // Update shares outstanding
            document.getElementById('sharesInfo').textContent = 
                data.sharesOutstanding 
                    ? formatFinancialNumber(data.sharesOutstanding, false, data.currencySymbol) + ' million'
                    : '-';
            
            // Calculate and update net debt
            const shortTermDebt = parseFinancialNumber(data.balanceSheet['Short-term Debt'][0]);
            const longTermDebt = parseFinancialNumber(data.balanceSheet['Long-term Debt'][0]);
            const cash = parseFinancialNumber(data.balanceSheet['Cash & Equivalents'][0]);
            const netDebt = shortTermDebt + longTermDebt - cash;
            
            document.getElementById('debtInfo').textContent = 
                formatFinancialNumber(netDebt, netDebt > 0, data.currencySymbol) + ' million';
            
            // Store these values for DCF calculations
            data.netDebt = netDebt;
        }
        
        // Calculate and display historical metrics
        function displayHistoricalMetrics(data) {
            // Calculate revenue CAGR
            let revenueValues = [];
            for (let i = 0; i < data.incomeStatement['Revenue'].length; i++) {
                revenueValues.push(parseFinancialNumber(data.incomeStatement['Revenue'][i]));
            }
            
            let cagr = 0;
            if (revenueValues.length >= 2) {
                const years = Math.min(revenueValues.length - 1, 3);
                cagr = calculateCAGR(revenueValues[years], revenueValues[0], years);
            }
            document.getElementById('revenueCagr').textContent = (cagr * 100).toFixed(2) + '%';
            
            // Calculate average operating margin
            let opMargins = [];
            for (let i = 0; i < data.incomeStatement['Operating Income'].length; i++) {
                const opIncome = parseFinancialNumber(data.incomeStatement['Operating Income'][i]);
                const revenue = parseFinancialNumber(data.incomeStatement['Revenue'][i]);
                if (revenue !== 0) {
                    opMargins.push(opIncome / revenue);
                }
            }
            
            const avgOpMargin = opMargins.reduce((sum, margin) => sum + margin, 0) / opMargins.length;
            document.getElementById('avgOperatingMargin').textContent = (avgOpMargin * 100).toFixed(2) + '%';
            
            // Calculate average CapEx as % of revenue
            let capexRatios = [];
            for (let i = 0; i < data.cashFlow['Capital Expenditures'].length; i++) {
                const capex = Math.abs(parseFinancialNumber(data.cashFlow['Capital Expenditures'][i]));
                const revenue = parseFinancialNumber(data.incomeStatement['Revenue'][i]);
                if (revenue !== 0) {
                    capexRatios.push(capex / revenue);
                }
            }
            
            const avgCapex = capexRatios.reduce((sum, ratio) => sum + ratio, 0) / capexRatios.length;
            document.getElementById('avgCapex').textContent = (avgCapex * 100).toFixed(2) + '%';
            
            // Calculate effective tax rate
            let taxRates = [];
            for (let i = 0; i < data.incomeStatement['Tax Expense'].length; i++) {
                const taxExpense = Math.abs(parseFinancialNumber(data.incomeStatement['Tax Expense'][i]));
                const opIncome = parseFinancialNumber(data.incomeStatement['Operating Income'][i]);
                if (opIncome > 0) {
                    taxRates.push(taxExpense / opIncome);
                }
            }
            
            const avgTaxRate = taxRates.length > 0 
                ? taxRates.reduce((sum, rate) => sum + rate, 0) / taxRates.length
                : 0.25; // Default to 25% if we can't calculate
                
            document.getElementById('effectiveTaxRate').textContent = (avgTaxRate * 100).toFixed(2) + '%';
            
            // Update input field values based on historical metrics
            document.getElementById('revenueGrowthRate').value = (cagr * 100).toFixed(1);
            document.getElementById('operatingMargin').value = (avgOpMargin * 100).toFixed(1);
            document.getElementById('taxRate').value = (avgTaxRate * 100).toFixed(1);
            document.getElementById('capexRate').value = (avgCapex * 100).toFixed(1);
        }
        
        // Function to calculate DCF valuation with properly linked formulas
        function calculateValuation() {
            const data = currentFinancialData;
            if (!data || !data.name) {
                alert('Please fetch financial data first before calculating valuation.');
                return;
            }
            
            // Get user inputs
            const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 5;
            const revenueGrowthRate = parseFloat(document.getElementById('revenueGrowthRate').value) / 100 || 0.05;
            const operatingMargin = parseFloat(document.getElementById('operatingMargin').value) / 100 || 0.2;
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100 || 0.25;
            const capexRate = parseFloat(document.getElementById('capexRate').value) / 100 || 0.05;
            const wcRate = parseFloat(document.getElementById('wcRate').value) / 100 || 0.1;
            const terminalGrowthRate = parseFloat(document.getElementById('terminalGrowthRate').value) / 100 || 0.02;
            const discountRate = parseFloat(document.getElementById('discountRate').value) / 100 || 0.1;
            const evMultiple = parseFloat(document.getElementById('evMultiple').value) || 12;
            
            // Get company info from financial data
            const sharesOutstanding = data.sharesOutstanding;
            const netDebt = data.netDebt;
            
            // Get most recent revenue as starting point (directly from financial statements)
            const baseRevenue = parseFinancialNumber(data.incomeStatement['Revenue'][0]);
            
            // Get historical depreciation as % of revenue
            let depreciationRate = 0.05; // Default
            if (data.cashFlow['Depreciation & Amortization'] && data.cashFlow['Depreciation & Amortization'][0] !== '-') {
                const lastDepreciation = parseFinancialNumber(data.cashFlow['Depreciation & Amortization'][0]);
                depreciationRate = lastDepreciation / baseRevenue;
            }
            
            // Prepare projection table
            const projectionBody = document.getElementById('projectionBody');
            projectionBody.innerHTML = '';
            
            // Build cash flow projections - Instead of calculating values directly, we'll 
            // build a structure with formulas that can be used both for displaying and Excel export
            
            // Revenue row - with growth formula explicitly linked
            const revenueRow = {
                label: 'Revenue',
                values: [baseRevenue],
                formulas: [],
                cssClass: 'font-medium'
            };
            
            // For each projected year, revenue grows by the growth rate
            for (let year = 1; year <= forecastPeriod; year++) {
                // This is the formula: Previous year's revenue * (1 + growth rate)
                const formula = `${revenueRow.values[year-1]} * (1 + ${revenueGrowthRate})`;
                const value = revenueRow.values[year-1] * (1 + revenueGrowthRate);
                revenueRow.values.push(value);
                revenueRow.formulas.push(formula);
            }
            
            // Terminal revenue (with growth formula)
            const terminalFormula = `${revenueRow.values[forecastPeriod]} * (1 + ${terminalGrowthRate})`;
            const terminalRevenue = revenueRow.values[forecastPeriod] * (1 + terminalGrowthRate);
            revenueRow.formulas.push(terminalFormula);
            
            // Operating Income - formula based on revenue * operating margin
            const opIncomeRow = {
                label: 'Operating Income',
                values: [parseFinancialNumber(data.incomeStatement['Operating Income'][0])],
                formulas: [],
                cssClass: ''
            };
            
            for (let year = 1; year <= forecastPeriod; year++) {
                // Formula: Revenue * Operating Margin
                const formula = `${revenueRow.values[year]} * ${operatingMargin}`;
                const value = revenueRow.values[year] * operatingMargin;
                opIncomeRow.values.push(value);
                opIncomeRow.formulas.push(formula);
            }
            
            // Terminal operating income
            const terminalOpIncomeFormula = `${terminalRevenue} * ${operatingMargin}`;
            const terminalOpIncome = terminalRevenue * operatingMargin;
            opIncomeRow.formulas.push(terminalOpIncomeFormula);
            
            // Tax row - formula based on operating income * tax rate
            const taxRow = {
                label: 'Tax',
                values: [parseFinancialNumber(data.incomeStatement['Tax Expense'][0])],
                formulas: [],
                cssClass: '',
                isNegative: true
            };
            
            for (let year = 1; year <= forecastPeriod; year++) {
                // Formula: Operating Income * Tax Rate
                const formula = `${opIncomeRow.values[year]} * ${taxRate}`;
                const value = opIncomeRow.values[year] * taxRate;
                taxRow.values.push(value);
                taxRow.formulas.push(formula);
            }
            
            // Terminal tax
            const terminalTaxFormula = `${terminalOpIncome} * ${taxRate}`;
            const terminalTax = terminalOpIncome * taxRate;
            taxRow.formulas.push(terminalTaxFormula);
            
            // NOPAT (Net Operating Profit After Tax) - formula based on Operating Income - Tax
            const nopatRow = {
                label: 'NOPAT',
                values: [opIncomeRow.values[0] + taxRow.values[0]], // Using + since tax is already stored as negative
                formulas: [],
                cssClass: 'bg-gray-50 dark:bg-gray-750',
                isTotal: true
            };
            
            for (let year = 1; year <= forecastPeriod; year++) {
                // Formula: Operating Income - Tax
                const formula = `${opIncomeRow.values[year]} - ${taxRow.values[year]}`;
                const value = opIncomeRow.values[year] - taxRow.values[year];
                nopatRow.values.push(value);
                nopatRow.formulas.push(formula);
            }
            
            // Terminal NOPAT
            const terminalNopatFormula = `${terminalOpIncome} - ${terminalTax}`;
            const terminalNopat = terminalOpIncome - terminalTax;
            nopatRow.formulas.push(terminalNopatFormula);
            
            // Depreciation row - formula based on revenue * depreciation rate
            const depRow = {
                label: 'Depreciation & Amortization',
                values: [parseFinancialNumber(data.cashFlow['Depreciation & Amortization'][0])],
                formulas: [],
                cssClass: ''
            };
            
            for (let year = 1; year <= forecastPeriod; year++) {
                // Formula: Revenue * Depreciation Rate
                const formula = `${revenueRow.values[year]} * ${depreciationRate}`;
                const value = revenueRow.values[year] * depreciationRate;
                depRow.values.push(value);
                depRow.formulas.push(formula);
            }
            
            // Terminal depreciation
            const terminalDepFormula = `${terminalRevenue} * ${depreciationRate}`;
            const terminalDep = terminalRevenue * depreciationRate;
            depRow.formulas.push(terminalDepFormula);
            
            // Capital Expenditures - formula based on revenue * capex rate
            const capexRow = {
                label: 'Capital Expenditures',
                values: [parseFinancialNumber(data.cashFlow['Capital Expenditures'][0])],
                formulas: [],
                cssClass: '',
                isNegative: true
            };
            
            for (let year = 1; year <= forecastPeriod; year++) {
                // Formula: Revenue * Capex Rate (negative)
                const formula = `${revenueRow.values[year]} * ${capexRate} * -1`;
                const value = revenueRow.values[year] * capexRate * -1;
                capexRow.values.push(value);
                capexRow.formulas.push(formula);
            }
            
            // Terminal capex
            const terminalCapexFormula = `${terminalRevenue} * ${capexRate} * -1`;
            const terminalCapex = terminalRevenue * capexRate * -1;
            capexRow.formulas.push(terminalCapexFormula);
            
            // Working Capital Changes - formula based on revenue change * wc rate
            const wcRow = {
                label: 'Change in Working Capital',
                values: [parseFinancialNumber(data.cashFlow['Changes in Working Capital'][0])],
                formulas: [],
                cssClass: '',
                isNegative: true
            };
            
            for (let year = 1; year <= forecastPeriod; year++) {
                // Formula: (Revenue - Previous Revenue) * WC Rate (negative)
                const formula = `(${revenueRow.values[year]} - ${revenueRow.values[year-1]}) * ${wcRate} * -1`;
                const value = (revenueRow.values[year] - revenueRow.values[year-1]) * wcRate * -1;
                wcRow.values.push(value);
                wcRow.formulas.push(formula);
            }
            
            // Terminal working capital
            const terminalWcFormula = `(${terminalRevenue} - ${revenueRow.values[forecastPeriod]}) * ${wcRate} * -1`;
            const terminalWc = (terminalRevenue - revenueRow.values[forecastPeriod]) * wcRate * -1;
            wcRow.formulas.push(terminalWcFormula);
            
            // Free Cash Flow - formula: NOPAT + Depreciation + Capex + Working Capital Change
            const fcfRow = {
                label: 'Free Cash Flow',
                values: [nopatRow.values[0] + depRow.values[0] + capexRow.values[0] + wcRow.values[0]],
                formulas: [],
                cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold',
                isTotal: true
            };
            
            for (let year = 1; year <= forecastPeriod; year++) {
                // Formula: NOPAT + Depreciation + Capex + Working Capital Change
                const formula = `${nopatRow.values[year]} + ${depRow.values[year]} + ${capexRow.values[year]} + ${wcRow.values[year]}`;
                const value = nopatRow.values[year] + depRow.values[year] + capexRow.values[year] + wcRow.values[year];
                fcfRow.values.push(value);
                fcfRow.formulas.push(formula);
            }
            
            // Terminal FCF
            const terminalFcfFormula = `${terminalNopat} + ${terminalDep} + ${terminalCapex} + ${terminalWc}`;
            const terminalFcf = terminalNopat + terminalDep + terminalCapex + terminalWc;
            fcfRow.formulas.push(terminalFcfFormula);
            
            // Discount Factor - formula: 1 / (1 + discount rate)^year
            const dfRow = {
                label: 'Discount Factor',
                values: [1], // Current year is not discounted
                formulas: [],
                cssClass: '',
                isPercentage: true
            };
            
            for (let year = 1; year <= forecastPeriod; year++) {
                // Formula: 1 / (1 + Discount Rate)^year
                const formula = `1 / Math.pow(1 + ${discountRate}, ${year})`;
                const value = 1 / Math.pow(1 + discountRate, year);
                dfRow.values.push(value);
                dfRow.formulas.push(formula);
            }
            
            // Terminal discount factor (same as last year)
            const terminalDfFormula = `1 / Math.pow(1 + ${discountRate}, ${forecastPeriod})`;
            const terminalDf = 1 / Math.pow(1 + discountRate, forecastPeriod);
            dfRow.formulas.push(terminalDfFormula);
            
            // Present Value - formula: FCF * Discount Factor
            const pvRow = {
                label: 'Present Value of FCF',
                values: [0], // Not applicable for current year
                formulas: [],
                cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold',
                isTotal: true
            };
            
            let sumPV = 0;
            for (let year = 1; year <= forecastPeriod; year++) {
                // Formula: FCF * Discount Factor
                const formula = `${fcfRow.values[year]} * ${dfRow.values[year]}`;
                const value = fcfRow.values[year] * dfRow.values[year];
                pvRow.values.push(value);
                pvRow.formulas.push(formula);
                sumPV += value;
            }
            
            // Calculate terminal value using Gordon Growth Model
            const terminalValue = terminalFcf / (discountRate - terminalGrowthRate);
            const terminalValueFormula = `${terminalFcf} / (${discountRate} - ${terminalGrowthRate})`;
            
            // Calculate present value of terminal value
            const discountedTerminalValue = terminalValue * terminalDf;
            const discountedTerminalFormula = `${terminalValue} * ${terminalDf}`;
            pvRow.values.push(discountedTerminalValue);
            pvRow.formulas.push(discountedTerminalFormula);
            
            sumPV += discountedTerminalValue;
            
            // Calculate enterprise value
            const enterpriseValueDCF = sumPV;
            
            // Calculate enterprise value using multiple method
            const finalYearEBITDA = opIncomeRow.values[forecastPeriod] + depRow.values[forecastPeriod];
            const terminalValueMultiple = finalYearEBITDA * evMultiple;
            const discountedTerminalValueMultiple = terminalValueMultiple * dfRow.values[forecastPeriod];
            const enterpriseValueMultiple = sumPV - discountedTerminalValue + discountedTerminalValueMultiple;
            
            // Calculate equity value
            const equityValueDCF = enterpriseValueDCF - netDebt;
            const equityValueMultiple = enterpriseValueMultiple - netDebt;
            
            // Calculate share price
            const sharePriceDCF = equityValueDCF / sharesOutstanding;
            const sharePriceMultiple = equityValueMultiple / sharesOutstanding;
            
            // Display results
            document.getElementById('enterpriseValueDCF').textContent = 
                formatFinancialNumber(enterpriseValueDCF, false, data.currencySymbol) + ' million';
            
            document.getElementById('enterpriseValueMultiple').textContent = 
                formatFinancialNumber(enterpriseValueMultiple, false, data.currencySymbol) + ' million';
                
            document.getElementById('equityValueDCF').textContent = 
                formatFinancialNumber(equityValueDCF, false, data.currencySymbol) + ' million';
                
            document.getElementById('equityValueMultiple').textContent = 
                formatFinancialNumber(equityValueMultiple, false, data.currencySymbol) + ' million';
                
            document.getElementById('sharePriceDCF').textContent = 
                data.currencySymbol + sharePriceDCF.toFixed(2);
                
            document.getElementById('sharePriceMultiple').textContent = 
                data.currencySymbol + sharePriceMultiple.toFixed(2);
            
            // Add all rows to the projection table
            addFormulaRow(revenueRow, data.currencySymbol);
            addFormulaRow(opIncomeRow, data.currencySymbol);
            addFormulaRow(taxRow, data.currencySymbol, true);
            addFormulaRow(nopatRow, data.currencySymbol, false, true);
            addFormulaRow(depRow, data.currencySymbol);
            addFormulaRow(capexRow, data.currencySymbol, true);
            addFormulaRow(wcRow, data.currencySymbol, true);
            addFormulaRow(fcfRow, data.currencySymbol, false, true);
            addFormulaRow(dfRow, '', false, false, true);
            addFormulaRow(pvRow, data.currencySymbol, false, true);
            
            // Add terminal value row
            const terminalRow = document.createElement('tr');
            terminalRow.className = 'border-t border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 font-bold';
            
            const terminalLabel = document.createElement('td');
            terminalLabel.className = 'py-3 px-4 text-gray-800 dark:text-gray-200';
            terminalLabel.textContent = 'Terminal Value';
            terminalRow.appendChild(terminalLabel);
            
            // Add empty cells for historical and projection years
            for (let i = 0; i < forecastPeriod + 1; i++) {
                const emptyCell = document.createElement('td');
                emptyCell.className = 'py-3 px-4 text-right text-gray-800 dark:text-gray-200';
                emptyCell.textContent = '-';
                emptyCell.dataset.formula = i === 0 ? '' : '';
                terminalRow.appendChild(emptyCell);
            }
            
            // Add terminal value in the last cell
            const terminalValueCell = document.createElement('td');
            terminalValueCell.className = 'py-3 px-4 text-right text-gray-800 dark:text-gray-200 font-bold';
            terminalValueCell.textContent = formatFinancialNumber(terminalValue, false, data.currencySymbol);
            terminalValueCell.dataset.formula = terminalValueFormula;
            terminalRow.appendChild(terminalValueCell);
            
            projectionBody.appendChild(terminalRow);
            
            // Add enterprise value row
            const evRow = document.createElement('tr');
            evRow.className = 'border-t border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 font-bold';
            
            const evLabel = document.createElement('td');
            evLabel.className = 'py-3 px-4 text-gray-800 dark:text-gray-200';
            evLabel.textContent = 'Enterprise Value';
            evRow.appendChild(evLabel);
            
            // Add empty cells for historical and projection years
            for (let i = 0; i < forecastPeriod + 1; i++) {
                const emptyCell = document.createElement('td');
                emptyCell.className = 'py-3 px-4 text-right text-gray-800 dark:text-gray-200';
                emptyCell.textContent = '-';
                emptyCell.dataset.formula = '';
                evRow.appendChild(emptyCell);
            }
            
            // Add enterprise value in the last cell
            const evCell = document.createElement('td');
            evCell.className = 'py-3 px-4 text-right text-gray-800 dark:text-gray-200 font-bold';
            evCell.textContent = formatFinancialNumber(enterpriseValueDCF, false, data.currencySymbol);
            evCell.dataset.formula = 'SUM(PV of FCF for all years including terminal value)';
            evRow.appendChild(evCell);
            
            projectionBody.appendChild(evRow);
            
            // Store the projection rows for Excel export
            data.projectionRows = {
                revenueRow, opIncomeRow, taxRow, nopatRow, depRow, capexRow, wcRow, fcfRow, dfRow, pvRow,
                terminalValue, terminalValueFormula, enterpriseValueDCF
            };
        }
        
        // Helper function to add a row with formulas to the projection table
        function addFormulaRow(rowData, currencySymbol, isNegative = false, isTotal = false, isPercentage = false) {
            const projectionBody = document.getElementById('projectionBody');
            
            const row = document.createElement('tr');
            row.className = `border-t border-gray-300 dark:border-gray-700 ${rowData.cssClass}`;
            
            const labelCell = document.createElement('td');
            labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 ${isTotal ? 'font-medium py-3' : ''}`;
            labelCell.textContent = rowData.label;
            row.appendChild(labelCell);
            
            // Add historical value first
            const historicalCell = document.createElement('td');
            historicalCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${isTotal ? 'font-medium py-3' : ''}`;
            if (isPercentage) {
                historicalCell.textContent = (rowData.values[0] * 100).toFixed(1) + '%';
            } else {
                historicalCell.textContent = formatFinancialNumber(rowData.values[0], 
                    rowData.isNegative || isNegative || rowData.values[0] < 0, currencySymbol);
            }
            historicalCell.dataset.value = rowData.values[0];
            row.appendChild(historicalCell);
            
            // Add projected values
            for (let i = 1; i < rowData.values.length; i++) {
                const valueCell = document.createElement('td');
                valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${isTotal ? 'font-medium py-3' : ''}`;
                
                if (isPercentage) {
                    valueCell.textContent = (rowData.values[i] * 100).toFixed(1) + '%';
                } else {
                    valueCell.textContent = formatFinancialNumber(rowData.values[i], 
                        rowData.isNegative || isNegative || rowData.values[i] < 0, currencySymbol);
                }
                
                // Store the formula and value as data attributes for Excel export
                valueCell.dataset.formula = rowData.formulas[i-1];
                valueCell.dataset.value = rowData.values[i];
                
                row.appendChild(valueCell);
            }
            
            projectionBody.appendChild(row);
        }
        
        // Revenue breakdown data for each company
        const revenueBreakdowns = {
            'AAPL': {
                year: 2023,
                segments: [
                    { name: 'iPhone', value: 200.58, color: '#007AFF', percent: 52 },
                    { name: 'Mac', value: 29.36, color: '#FF9500', percent: 8 },
                    { name: 'iPad', value: 28.30, color: '#FF2D55', percent: 7 },
                    { name: 'Wearables, Home and Accessories', value: 41.17, color: '#5AC8FA', percent: 11 },
                    { name: 'Services', value: 85.20, color: '#4CD964', percent: 22 }
                ]
            },
            'MSFT': {
                year: 2023,
                segments: [
                    { name: 'Productivity and Business Processes', value: 69.27, color: '#00A2ED', percent: 32 },
                    { name: 'Intelligent Cloud', value: 89.29, color: '#6B69D6', percent: 41 },
                    { name: 'More Personal Computing', value: 57.32, color: '#FFBA08', percent: 27 }
                ]
            },
            'AMZN': {
                year: 2023,
                segments: [
                    { name: 'Online Stores', value: 233.12, color: '#FF9900', percent: 41 },
                    { name: 'Physical Stores', value: 19.82, color: '#146EB4', percent: 3 },
                    { name: 'Third-party Seller Services', value: 117.74, color: '#FF6B6B', percent: 21 },
                    { name: 'Subscription Services', value: 37.87, color: '#1EE1B3', percent: 7 },
                    { name: 'AWS', value: 90.76, color: '#232F3E', percent: 16 },
                    { name: 'Advertising', value: 46.86, color: '#48A9A6', percent: 8 },
                    { name: 'Other', value: 10.12, color: '#8A9B9B', percent: 4 }
                ]
            },
            'GOOGL': {
                year: 2023,
                segments: [
                    { name: 'Google Search & other', value: 175.04, color: '#4285F4', percent: 57 },
                    { name: 'YouTube ads', value: 31.48, color: '#DB4437', percent: 10 },
                    { name: 'Google Network', value: 28.19, color: '#F4B400', percent: 9 },
                    { name: 'Google Cloud', value: 33.09, color: '#0F9D58', percent: 11 },
                    { name: 'Google Subscriptions, Platforms & Devices', value: 32.73, color: '#8A4AFF', percent: 11 },
                    { name: 'Other', value: 6.86, color: '#757575', percent: 2 }
                ]
            },
            'META': {
                year: 2023,
                segments: [
                    { name: 'Family of Apps Advertising', value: 126.72, color: '#1877F2', percent: 94 },
                    { name: 'Reality Labs', value: 2.22, color: '#00B5E2', percent: 2 },
                    { name: 'Other', value: 5.96, color: '#A4C2F4', percent: 4 }
                ]
            },
            'TSLA': {
                year: 2023,
                segments: [
                    { name: 'Automotive Sales', value: 71.46, color: '#E31937', percent: 74 },
                    { name: 'Automotive Leasing', value: 5.92, color: '#333333', percent: 6 },
                    { name: 'Energy Generation and Storage', value: 8.35, color: '#FFDD00', percent: 9 },
                    { name: 'Services and Other', value: 11.04, color: '#007BFF', percent: 11 }
                ]
            },
            'NVDA': {
                year: 2023,
                segments: [
                    { name: 'Data Center', value: 29.12, color: '#76B900', percent: 68 },
                    { name: 'Gaming', value: 10.27, color: '#FF6B00', percent: 24 },
                    { name: 'Professional Visualization', value: 1.42, color: '#00A0E9', percent: 3 },
                    { name: 'Automotive', value: 1.13, color: '#9471FF', percent: 3 },
                    { name: 'OEM and Other', value: 0.98, color: '#7D7D7D', percent: 2 }
                ]
            },
            'JNJ': {
                year: 2023,
                segments: [
                    { name: 'Pharmaceutical', value: 52.25, color: '#D2042D', percent: 53 },
                    { name: 'MedTech', value: 31.43, color: '#0067B1', percent: 32 },
                    { name: 'Consumer Health', value: 14.93, color: '#FFB612', percent: 15 }
                ]
            },
            'JPM': {
                year: 2023,
                segments: [
                    { name: 'Consumer & Community Banking', value: 58.82, color: '#00447C', percent: 38 },
                    { name: 'Corporate & Investment Bank', value: 59.59, color: '#419E88', percent: 39 },
                    { name: 'Commercial Banking', value: 12.38, color: '#C7B299', percent: 8 },
                    { name: 'Asset & Wealth Management', value: 18.25, color: '#9F1222', percent: 12 },
                    { name: 'Corporate', value: 5.75, color: '#5B5B5B', percent: 3 }
                ]
            },
            'V': {
                year: 2023,
                segments: [
                    { name: 'Service Revenues', value: 15.97, color: '#1A1F71', percent: 39 },
                    { name: 'Data Processing Revenues', value: 13.53, color: '#F7B600', percent: 33 },
                    { name: 'International Transaction Revenues', value: 9.50, color: '#00A3E0', percent: 23 },
                    { name: 'Other Revenues', value: 1.94, color: '#6C7378', percent: 5 }
                ]
            },
            'PG': {
                year: 2023,
                segments: [
                    { name: 'Beauty', value: 15.58, color: '#0037B5', percent: 19 },
                    { name: 'Grooming', value: 7.06, color: '#6A78D1', percent: 9 },
                    { name: 'Health Care', value: 11.24, color: '#00A552', percent: 14 },
                    { name: 'Fabric & Home Care', value: 27.88, color: '#E2231A', percent: 34 },
                    { name: 'Baby, Feminine & Family Care', value: 20.24, color: '#FF8300', percent: 24 }
                ]
            },
            'WMT': {
                year: 2023,
                segments: [
                    { name: 'Walmart U.S.', value: 431.97, color: '#0071CE', percent: 67 },
                    { name: 'Walmart International', value: 101.22, color: '#FFC220', percent: 16 },
                    { name: 'Sam\'s Club', value: 87.14, color: '#FF5C39', percent: 13 },
                    { name: 'Other', value: 28.96, color: '#77BC1F', percent: 4 }
                ]
            },
            'KO': {
                year: 2023,
                segments: [
                    { name: 'Europe, Middle East & Africa', value: 8.69, color: '#F40009', percent: 19 },
                    { name: 'Latin America', value: 5.49, color: '#FFD8D8', percent: 12 },
                    { name: 'North America', value: 17.89, color: '#000000', percent: 39 },
                    { name: 'Asia Pacific', value: 7.79, color: '#C6C6C6', percent: 17 },
                    { name: 'Global Ventures', value: 3.48, color: '#FFB2B2', percent: 8 },
                    { name: 'Bottling Investments', value: 2.42, color: '#7F0005', percent: 5 }
                ]
            },
            'DIS': {
                year: 2023,
                segments: [
                    { name: 'Entertainment', value: 39.32, color: '#FF2D55', percent: 44 },
                    { name: 'Sports', value: 17.51, color: '#007AFF', percent: 20 },
                    { name: 'Experiences', value: 29.13, color: '#4CD964', percent: 33 },
                    { name: 'International', value: 2.94, color: '#5856D6', percent: 3 }
                ]
            },
            'NFLX': {
                year: 2023,
                segments: [
                    { name: 'United States and Canada', value: 14.16, color: '#E50914', percent: 42 },
                    { name: 'Europe, Middle East and Africa', value: 11.48, color: '#221F1F', percent: 34 },
                    { name: 'Latin America', value: 4.47, color: '#F5F5F1', percent: 13 },
                    { name: 'Asia-Pacific', value: 3.62, color: '#B81D24', percent: 11 }
                ]
            }
        };
        
        // Function to update revenue breakdown visualization
        function updateRevenueBreakdown(symbol) {
            // Check if necessary elements exist
            const revenueBreakdownEl = document.getElementById('revenueBreakdown');
            const breakdownYearEl = document.getElementById('breakdownYear');
            const segmentChartEl = document.getElementById('segmentChart');
            const segmentLegendEl = document.getElementById('segmentLegend');
            
            // Exit if any required element doesn't exist
            if (!revenueBreakdownEl || !breakdownYearEl || !segmentChartEl || !segmentLegendEl) {
                console.warn('Revenue breakdown elements not found in DOM');
                return;
            }
            
            // Check if we have breakdown data for this company
            const breakdown = revenueBreakdowns[symbol];
            
            if (breakdown && breakdown.segments && breakdown.segments.length > 0) {
                // Update year display
                breakdownYearEl.textContent = breakdown.year;
                
                // Clear previous chart and legend
                segmentChartEl.innerHTML = '';
                segmentLegendEl.innerHTML = '';
                
                // Calculate total width (100%)
                let cumulativeWidth = 0;
                
                // Create segments in the chart
                breakdown.segments.forEach(segment => {
                    // Create segment div
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = 'absolute h-full';
                    segmentDiv.style.left = `${cumulativeWidth}%`;
                    segmentDiv.style.width = `${segment.percent}%`;
                    segmentDiv.style.backgroundColor = segment.color;
                    segmentDiv.style.transition = 'all 0.3s ease';
                    
                    // Add hover effect
                    segmentDiv.addEventListener('mouseenter', () => {
                        segmentDiv.style.opacity = '0.8';
                        segmentDiv.style.transform = 'translateY(-5px)';
                    });
                    
                    segmentDiv.addEventListener('mouseleave', () => {
                        segmentDiv.style.opacity = '1';
                        segmentDiv.style.transform = 'translateY(0)';
                    });
                    
                    // Add tooltip with value
                    const tooltip = document.createElement('div');
                    tooltip.className = 'absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-full bg-gray-800 text-white px-2 py-1 rounded text-xs opacity-0 pointer-events-none transition-opacity';
                    tooltip.style.whiteSpace = 'nowrap';
                    
                    // Safely get currency symbol
                    const currencySymbol = currentFinancialData && currentFinancialData.currencySymbol ? 
                        currentFinancialData.currencySymbol : '$';
                    
                    tooltip.textContent = `${segment.name}: ${currencySymbol}${segment.value.toLocaleString()} million (${segment.percent}%)`;
                    
                    segmentDiv.addEventListener('mouseenter', () => {
                        tooltip.classList.remove('opacity-0');
                        tooltip.classList.add('opacity-100');
                    });
                    
                    segmentDiv.addEventListener('mouseleave', () => {
                        tooltip.classList.remove('opacity-100');
                        tooltip.classList.add('opacity-0');
                    });
                    
                    segmentDiv.appendChild(tooltip);
                    segmentChartEl.appendChild(segmentDiv);
                    
                    // Update cumulative width
                    cumulativeWidth += segment.percent;
                    
                    // Create legend item
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center';
                    
                    const colorBox = document.createElement('div');
                    colorBox.className = 'w-3 h-3 mr-2 flex-shrink-0';
                    colorBox.style.backgroundColor = segment.color;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'text-gray-800 dark:text-gray-200 truncate';
                    nameSpan.textContent = `${segment.name} (${segment.percent}%)`;
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(nameSpan);
                    
                    // Add hover effect for legend items that highlights corresponding segment
                    legendItem.addEventListener('mouseenter', () => {
                        segmentDiv.style.opacity = '0.8';
                        segmentDiv.style.transform = 'translateY(-5px)';
                    });
                    
                    legendItem.addEventListener('mouseleave', () => {
                        segmentDiv.style.opacity = '1';
                        segmentDiv.style.transform = 'translateY(0)';
                    });
                    
                    segmentLegendEl.appendChild(legendItem);
                });
                
                // Show the revenue breakdown section
                revenueBreakdownEl.classList.remove('hidden');
            } else {
                // Hide the revenue breakdown section if no data is available
                revenueBreakdownEl.classList.add('hidden');
            }
        }
        
        // Function to update analyst consensus section
        function updateAnalystConsensus(symbol) {
            // Get elements
            const consensusTab = document.getElementById('analystConsensusTab');
            const consensusDate = document.getElementById('consensusDate');
            const priceTargetAvg = document.getElementById('priceTargetAvg');
            const priceTargetLow = document.getElementById('priceTargetLow');
            const priceTargetHigh = document.getElementById('priceTargetHigh');
            const buyCount = document.getElementById('buyCount');
            const holdCount = document.getElementById('holdCount');
            const sellCount = document.getElementById('sellCount');
            const earningsNextQuarter = document.getElementById('earningsNextQuarter');
            const earningsCurrentYear = document.getElementById('earningsCurrentYear');
            const earningsNextYear = document.getElementById('earningsNextYear');
            const earningsGrowth = document.getElementById('earningsGrowth');
            const recommendationChart = document.getElementById('recommendationChart');
            
            // Exit if any required element doesn't exist
            if (!consensusTab || !recommendationChart) {
                console.warn('Analyst consensus elements not found in DOM');
                return;
            }
            
            // Get consensus data for this symbol
            const consensus = analystConsensusData[symbol];
            
            // Check if we have data
            if (consensus) {
                // Update date
                if (consensusDate) consensusDate.textContent = 'As of ' + consensus.priceTarget.date;
                
                // Update price targets
                const currencySymbol = currentFinancialData.currencySymbol || '$';
                if (priceTargetAvg) priceTargetAvg.textContent = currencySymbol + consensus.priceTarget.average.toFixed(2);
                if (priceTargetLow) priceTargetLow.textContent = currencySymbol + consensus.priceTarget.low.toFixed(2);
                if (priceTargetHigh) priceTargetHigh.textContent = currencySymbol + consensus.priceTarget.high.toFixed(2);
                
                // Update recommendations
                if (buyCount) buyCount.textContent = consensus.recommendations.buy;
                if (holdCount) holdCount.textContent = consensus.recommendations.hold;
                if (sellCount) sellCount.textContent = consensus.recommendations.sell;
                
                // Update earnings estimates
                if (earningsNextQuarter) {
                    if (consensus.earningsEstimate.nextQuarter !== null) {
                        earningsNextQuarter.textContent = currencySymbol + consensus.earningsEstimate.nextQuarter.toFixed(2);
                    } else {
                        earningsNextQuarter.textContent = 'N/A';
                    }
                }
                
                if (earningsCurrentYear) earningsCurrentYear.textContent = currencySymbol + consensus.earningsEstimate.currentYear.toFixed(2);
                if (earningsNextYear) earningsNextYear.textContent = currencySymbol + consensus.earningsEstimate.nextYear.toFixed(2);
                
                // Format growth with color based on positive/negative
                if (earningsGrowth) {
                    const growthValue = consensus.earningsEstimate.growth;
                    const growthFormatted = growthValue.toFixed(1) + '%';
                    
                    if (growthValue > 0) {
                        earningsGrowth.textContent = '+' + growthFormatted;
                        earningsGrowth.className = 'font-semibold text-green-600 dark:text-green-400';
                    } else if (growthValue < 0) {
                        earningsGrowth.textContent = growthFormatted;
                        earningsGrowth.className = 'font-semibold text-red-600 dark:text-red-400';
                    } else {
                        earningsGrowth.textContent = growthFormatted;
                        earningsGrowth.className = 'font-semibold';
                    }
                }
                
                // Create recommendation chart
                recommendationChart.innerHTML = '';
                
                const totalRecs = consensus.recommendations.total;
                const buyPercent = (consensus.recommendations.buy / totalRecs) * 100;
                const holdPercent = (consensus.recommendations.hold / totalRecs) * 100;
                const sellPercent = (consensus.recommendations.sell / totalRecs) * 100;
                
                // Create buy bar
                if (buyPercent > 0) {
                    const buyBar = document.createElement('div');
                    buyBar.className = 'absolute h-full bg-green-500 dark:bg-green-600';
                    buyBar.style.width = buyPercent + '%';
                    buyBar.style.left = '0';
                    buyBar.title = consensus.recommendations.buy + ' Buy recommendations (' + buyPercent.toFixed(1) + '%)';
                    
                    recommendationChart.appendChild(buyBar);
                }
                
                // Create hold bar
                if (holdPercent > 0) {
                    const holdBar = document.createElement('div');
                    holdBar.className = 'absolute h-full bg-yellow-400 dark:bg-yellow-600';
                    holdBar.style.width = holdPercent + '%';
                    holdBar.style.left = buyPercent + '%';
                    holdBar.title = consensus.recommendations.hold + ' Hold recommendations (' + holdPercent.toFixed(1) + '%)';
                    
                    recommendationChart.appendChild(holdBar);
                }
                
                // Create sell bar
                if (sellPercent > 0) {
                    const sellBar = document.createElement('div');
                    sellBar.className = 'absolute h-full bg-red-500 dark:bg-red-600';
                    sellBar.style.width = sellPercent + '%';
                    sellBar.style.left = (buyPercent + holdPercent) + '%';
                    sellBar.title = consensus.recommendations.sell + ' Sell recommendations (' + sellPercent.toFixed(1) + '%)';
                    
                    recommendationChart.appendChild(sellBar);
                }
            }
        }
        
        // Main function to update the financial data displayed
        function updateFinancialData(data) {
            // Store current data for Excel export
            currentFinancialData = data;
            
            // Update table headers to show fiscal year end and years
            updateTableHeaders(data);
            
            // Populate tables with the data
            populateTables(data);
            
            // Update stock info display
            document.getElementById('currentStock').textContent = data.name;
            document.getElementById('stockInfo').classList.remove('hidden');
            
            // Update company description
            updateCompanyDescription(data);
            
            // Show financial content
            document.getElementById('financeContent').classList.remove('hidden');
            
            // Clear any previous error
            document.getElementById('errorMessage').classList.add('hidden');
            
            // Calculate and display historical metrics
            displayHistoricalMetrics(data);
            
            // Calculate initial valuation
            calculateValuation();
            
            // Get ticker symbol from the stock object
            const ticker = Object.keys(stockData).find(key => stockData[key].name === data.name) || '';
            
            // Update analyst consensus section
            updateAnalystConsensus(ticker);
        }
        
        // Function to update the company description section
        function updateCompanyDescription(data) {
            try {
                // Check if we have a description
                if (data.description) {
                    const descriptionTextEl = document.getElementById('descriptionText');
                    const companySectorEl = document.getElementById('companySector');
                    const companyIndustryEl = document.getElementById('companyIndustry');
                    const companyFoundedEl = document.getElementById('companyFounded');
                    const companyHQEl = document.getElementById('companyHQ');
                    const companyDescriptionEl = document.getElementById('companyDescription');
                    
                    // Exit if any required element doesn't exist
                    if (!descriptionTextEl || !companySectorEl || !companyIndustryEl || 
                        !companyFoundedEl || !companyHQEl || !companyDescriptionEl) {
                        console.warn('Company description elements not found in DOM');
                        return;
                    }
                    
                    // Update description text
                    descriptionTextEl.textContent = data.description;
                    
                    // Update sector, industry, founded date, and headquarters if available
                    companySectorEl.textContent = data.sector || 'N/A';
                    companyIndustryEl.textContent = data.industry || 'N/A';
                    companyFoundedEl.textContent = data.founded || 'N/A';
                    companyHQEl.textContent = data.headquarters || 'N/A';
                    
                    // Show the description section
                    companyDescriptionEl.classList.remove('hidden');
                    
                    // Add revenue breakdown section if it doesn't exist
                    if (!document.getElementById('revenueBreakdown')) {
                        const revenueBreakdownSection = document.createElement('div');
                        revenueBreakdownSection.id = 'revenueBreakdown';
                        revenueBreakdownSection.className = 'mt-4 pt-4 border-t border-gray-200 dark:border-gray-700';
                        
                        revenueBreakdownSection.innerHTML = `
                            <h4 class="font-semibold text-gray-800 dark:text-white mb-1">Revenue Breakdown</h4>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-600 dark:text-gray-400">By Segment (Latest Fiscal Year)</span>
                                <span id="breakdownYear" class="text-gray-600 dark:text-gray-400"></span>
                            </div>
                            <div id="segmentChart" class="relative h-20 mt-1">
                                <!-- Segments will be added here dynamically -->
                            </div>
                            <div id="segmentLegend" class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-1 text-xs">
                                <!-- Legends will be added here dynamically -->
                            </div>
                        `;
                        
                        companyDescriptionEl.appendChild(revenueBreakdownSection);
                    }
                    
                    // Update revenue breakdown if available
                    // Get ticker symbol from the stock object
                    const ticker = Object.keys(stockData).find(key => stockData[key].name === data.name) || '';
                    updateRevenueBreakdown(ticker);
                    
                    // Fetch and display comparable companies
                    fetchComparableCompanies(ticker);
                } else {
                    // Hide the description section if no description is available
                    const companyDescriptionEl = document.getElementById('companyDescription');
                    if (companyDescriptionEl) {
                        companyDescriptionEl.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error updating company description:', error);
            }
        }
        
        // Variable to store the chosen AI model
        let chosenModelInfo = {
            name: "@Claude-3.7-Sonnet", // Default model name
            displayName: "Claude" // Default display name
        };
        
        // Function to fetch comparable companies for a stock
        function fetchComparableCompanies(ticker) {
            const companiesList = document.getElementById('comparablesList');
            const loadingIndicator = document.getElementById('comparablesLoading');
            
            if (!companiesList || !loadingIndicator) {
                console.warn('Comparable companies elements not found');
                return;
            }
            
            // Clear previous data
            companiesList.innerHTML = '';
            
            // Show loading indicator
            loadingIndicator.classList.remove('hidden');
            
            // Define comparable companies mapping
            // This is a predefined mapping for the demo, in a real app this would come from an API
            const comparableCompanies = {
                'AAPL': ['MSFT', 'GOOGL', 'AMZN', 'META'],
                'MSFT': ['AAPL', 'GOOGL', 'AMZN', 'META'],
                'AMZN': ['GOOGL', 'META', 'MSFT', 'WMT'],
                'GOOGL': ['META', 'MSFT', 'AMZN', 'AAPL'],
                'META': ['GOOGL', 'MSFT', 'AMZN', 'NFLX'],
                'TSLA': ['F', 'GM', 'TM', 'RIVN'],
                'NVDA': ['AMD', 'INTC', 'TSM', 'MU'],
                'JNJ': ['PFE', 'MRK', 'ABBV', 'LLY'],
                'JPM': ['BAC', 'C', 'WFC', 'MS'],
                'V': ['MA', 'PYPL', 'AXP', 'SQ'],
                'PG': ['KO', 'PEP', 'CL', 'UL'],
                '0700.HK': ['9988.HK', 'BABA', 'META', 'NFLX'],
                '9988.HK': ['0700.HK', 'AMZN', 'WMT', 'JD'],
                '1299.HK': ['2318.HK', 'MET', 'PRU', 'AIG'],
                'BP.L': ['XOM', 'CVX', 'SHEL', 'TTE']
            };
            
            // Check if we have predefined comparables for this ticker
            if (comparableCompanies[ticker]) {
                // Add buttons for each comparable company
                comparableCompanies[ticker].forEach(comparable => {
                    // Create button for this comparable company
                    const button = document.createElement('button');
                    button.className = 'px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded text-sm font-medium transition-colors duration-150';
                    button.textContent = comparable;
                    
                    // Add click handler to load the comparable company's data
                    button.addEventListener('click', () => {
                        document.getElementById('stockCodeInput').value = comparable;
                        document.getElementById('fetchStockBtn').click();
                    });
                    
                    companiesList.appendChild(button);
                });
                
                loadingIndicator.classList.add('hidden');
            } else {
                // If we don't have predefined comparables, attempt to fetch them via AI
                if (window.Poe) {
                    fetchComparablesViaAI(ticker);
                } else {
                    // If Poe API is not available, display a message
                    loadingIndicator.classList.add('hidden');
                    
                    const message = document.createElement('div');
                    message.className = 'col-span-4 text-gray-500 dark:text-gray-400 text-sm';
                    message.textContent = 'No comparable companies data available for this stock.';
                    companiesList.appendChild(message);
                }
            }
        }
        
        // Function to fetch comparable companies using the same AI model that was used for financial data
        async function fetchComparablesViaAI(ticker) {
            const companiesList = document.getElementById('comparablesList');
            const loadingIndicator = document.getElementById('comparablesLoading');
            
            try {
                // Create a handler for the response
                const handlerId = "comparablesHandler";
                
                // Register a handler to process the response
                window.Poe.registerHandler(handlerId, (result) => {
                    if (result.status === "error") {
                        displayError("Error fetching comparable companies");
                        loadingIndicator.classList.add('hidden');
                    } else if (result.status === "complete") {
                        // Hide loading indicator
                        loadingIndicator.classList.add('hidden');
                        
                        try {
                            // Parse the response
                            const response = result.responses[0].content;
                            
                            // Extract JSON from the response
                            const jsonMatch = response.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const data = JSON.parse(jsonMatch[0]);
                                
                                if (data.comparables && data.comparables.length > 0) {
                                    data.comparables.forEach(comp => {
                                        // Create button for this comparable company
                                        const button = document.createElement('button');
                                        button.className = 'px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded text-sm font-medium transition-colors duration-150';
                                        button.textContent = comp.ticker;
                                        
                                        // Add click handler to load the comparable company's data
                                        button.addEventListener('click', () => {
                                            document.getElementById('stockCodeInput').value = comp.ticker;
                                            document.getElementById('fetchStockBtn').click();
                                        });
                                        
                                        // Add tooltip with company name
                                        if (comp.name) {
                                            button.title = comp.name;
                                        }
                                        
                                        companiesList.appendChild(button);
                                    });
                                } else {
                                    displayNoComparables();
                                }
                            } else {
                                // If we couldn't parse JSON, try to extract tickers directly
                                const tickerMatches = response.match(/[A-Z]{1,5}|[A-Z0-9]{4,6}\.[A-Z]{2}/g);
                                if (tickerMatches && tickerMatches.length > 0) {
                                    // Filter to unique tickers and limit to max 5
                                    const uniqueTickers = [...new Set(tickerMatches)].slice(0, 5);
                                    
                                    uniqueTickers.forEach(comp => {
                                        // Skip the current ticker
                                        if (comp === ticker) return;
                                        
                                        // Create button for this comparable company
                                        const button = document.createElement('button');
                                        button.className = 'px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded text-sm font-medium transition-colors duration-150';
                                        button.textContent = comp;
                                        
                                        // Add click handler to load the comparable company's data
                                        button.addEventListener('click', () => {
                                            document.getElementById('stockCodeInput').value = comp;
                                            document.getElementById('fetchStockBtn').click();
                                        });
                                        
                                        companiesList.appendChild(button);
                                    });
                                } else {
                                    displayNoComparables();
                                }
                            }
                        } catch (error) {
                            console.error("Error processing comparable companies response:", error);
                            displayNoComparables();
                        }
                    }
                });
                
                // Construct the prompt using the same model that was chosen for financial data
                const prompt = `${chosenModelInfo.name} What are 3-5 comparable companies (competitors in the same industry) for ${ticker}? Please respond ONLY with JSON in the following format (no other text):
{
  "ticker": "${ticker}",
  "comparables": [
    {"ticker": "ABC", "name": "ABC Company"},
    {"ticker": "XYZ", "name": "XYZ Corporation"}
  ]
}
For a stock like AAPL, comparable companies might be MSFT, GOOGL, etc.`;
                
                displayMessage(`Using ${chosenModelInfo.displayName} to find comparable companies for ${ticker}...`, "info");
                
                // Send the request using the same model that was chosen for financial data
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    stream: false,
                    openChat: false
                });
                
            } catch (error) {
                console.error("Error fetching comparable companies:", error);
                loadingIndicator.classList.add('hidden');
                displayNoComparables();
            }
            
            function displayNoComparables() {
                const message = document.createElement('div');
                message.className = 'col-span-4 text-gray-500 dark:text-gray-400 text-sm';
                message.textContent = 'No comparable companies data available for this stock.';
                companiesList.appendChild(message);
            }
            
            function displayError(errorMsg) {
                const message = document.createElement('div');
                message.className = 'col-span-4 text-red-500 dark:text-red-400 text-sm';
                message.textContent = errorMsg;
                companiesList.appendChild(message);
            }
        }
        
        // Fetch stock data (from our demo dataset)
        async function fetchStockData(symbol) {
            try {
                // Show loading indicator
                document.getElementById('loadingIndicator').classList.remove('hidden');
                
                // Hide error message if it was previously shown
                document.getElementById('errorMessage').classList.add('hidden');
                
                // Check if we have preloaded data for this stock
                if (stockData[symbol]) {
                    // Add slight delay for more natural UI
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Update UI with the processed data
                    updateFinancialData(stockData[symbol]);
                    displayMessage(`Showing pre-loaded financial data for ${symbol}`, "info");
                    
                    // Show the "Real Time Summary" button after financial data is loaded
                    document.getElementById('fetchCurrentInfoBtn').classList.remove('hidden');
                    
                    return stockData[symbol];
                } else {
                    // We don't have preloaded data, so let's fetch it from Yahoo Finance via Claude
                    displayMessage(`Fetching real-time financial data for ${symbol}...`, "info");
                    
                    // Call our function to fetch data via Poe API
                    const financialData = await fetchRealTimeFinancialData(symbol);
                    
                    // Update UI with the fetched data
                    updateFinancialData(financialData);
                    displayMessage(`Successfully loaded financial data for ${symbol}`, "success");
                    
                    // Show the "Real Time Summary" button after financial data is loaded
                    document.getElementById('fetchCurrentInfoBtn').classList.remove('hidden');
                    
                    return financialData;
                }
            } catch (error) {
                console.error('Error fetching financial data:', error);
                
                // Show error message
                const errorMsg = document.getElementById('errorMessage');
                errorMsg.textContent = `Error: ${error.message || 'Failed to load financial data'}`;
                errorMsg.classList.remove('hidden');
                
                // Also show in chat
                displayMessage(`Error: Failed to load financial data for ${symbol}. ${error.message}`, "error");
                
                // Hide finance content if there was an error
                document.getElementById('financeContent').classList.add('hidden');
                
                // Hide the stock info
                document.getElementById('stockInfo').classList.add('hidden');
                
                throw error;
            } finally {
                // Hide loading indicator
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }
        
        // Function to fetch financial data via Claude or Gemini models
        async function fetchRealTimeFinancialData(ticker) {
            if (!window.Poe) {
                throw new Error("Poe API is not available. This feature requires running on Poe.com");
            }
            
            // Let user choose which model to use
            const modelChoice = await confirmModelChoice(ticker);
            
            if (modelChoice === 'claude') {
                return fetchFinancialDataViaModel(ticker, "@Claude-3.7-Sonnet", "Claude");
            } else if (modelChoice === 'gemini-pro') {
                return fetchFinancialDataViaModel(ticker, "@Gemini-2.5-Pro-Exp", "Gemini Pro");
            } else {
                return fetchFinancialDataViaModel(ticker, "@Gemini-2.5-Flash-Preview", "Gemini Flash");
            }
        }
        
        // Function to extract URLs from a text
        function extractUrls(text) {
            // This regex looks for URLs that begin with http:// or https://
            const urlRegex = /https?:\/\/[^\s)]+/g;
            const matches = text.match(urlRegex);
            
            // Deduplicate URLs and ensure the array is properly initialized
            return matches ? [...new Set(matches)] : [];
        }
        
        // Function to update the source URLs section
        function updateSourceUrls(urls) {
            if (!urls || urls.length === 0) return;
            
            const sourceUrlsList = document.getElementById('sourceUrlsList');
            if (!sourceUrlsList) return;
            
            // Clear the "no sources available" message if present
            if (sourceUrlsList.innerHTML.includes('No source URLs available yet')) {
                sourceUrlsList.innerHTML = '';
            }
            
            // Add each URL as a clickable link
            urls.forEach(url => {
                // Check if this URL is already in the list
                if (!sourceUrlsList.innerHTML.includes(url)) {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = url;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.className = 'text-primary hover:underline break-all';
                    link.textContent = url;
                    li.appendChild(link);
                    sourceUrlsList.appendChild(li);
                }
            });
        }
        
        // Function to ask user which model to use
        async function confirmModelChoice(ticker) {
            return new Promise((resolve) => {
                const confirmDialog = document.createElement('div');
                confirmDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                confirmDialog.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md mx-4 shadow-xl">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Choose Data Source</h3>
                        <p class="text-gray-700 dark:text-gray-300 mb-4">
                            No preloaded data found for ${ticker}. Choose a model to retrieve data:
                        </p>
                        <div class="mb-4 space-y-4">
                            <div class="bg-yellow-50 dark:bg-yellow-900 p-3 rounded-md mb-3">
                                <p class="text-yellow-800 dark:text-yellow-200 text-sm">
                                    <strong>Important:</strong> You'll see an authorization prompt for a certain number of points when using these models. The actual points used will vary depending on the model, with Gemini-2.5-Flash-Preview using significantly fewer points.
                                </p>
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-md mb-3">
                                <p class="text-blue-800 dark:text-blue-200 text-sm">
                                    <strong>Note:</strong> Data retrieval may take up to one minute to complete depending on the model and data availability.
                                </p>
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-md">
                                <p class="text-blue-800 dark:text-blue-200 text-sm">
                                    <strong>Note:</strong> The app uses AI models to retrieve data from publicly available information,
                                    which may not be consistent across all sources.
                                </p>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-750 border border-gray-200 dark:border-gray-700 rounded-md">
                                <div>
                                    <p class="font-medium">Claude-3.7-Sonnet</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Comprehensive financial data</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-750 border border-gray-200 dark:border-gray-700 rounded-md">
                                <div>
                                    <p class="font-medium">Gemini-2.5-Pro-Exp</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Web search enabled for accurate real-time data</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-750 border border-gray-200 dark:border-gray-700 rounded-md">
                                <div>
                                    <p class="font-medium">Gemini-2.5-Flash-Preview</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Faster response times (~5x lower point cost)</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button id="useClaudeBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90">
                                Use Claude
                            </button>
                            <button id="useGeminiProBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md font-medium hover:bg-indigo-700">
                                Use Gemini Pro
                            </button>
                            <button id="useGeminiFlashBtn" class="px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700">
                                Use Gemini Flash
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(confirmDialog);
                
                document.getElementById('useClaudeBtn').addEventListener('click', () => {
                    document.body.removeChild(confirmDialog);
                    resolve('claude');
                });
                
                document.getElementById('useGeminiProBtn').addEventListener('click', () => {
                    document.body.removeChild(confirmDialog);
                    resolve('gemini-pro');
                });
                
                document.getElementById('useGeminiFlashBtn').addEventListener('click', () => {
                    document.body.removeChild(confirmDialog);
                    resolve('gemini-flash');
                });
            });
        }
        
        // Unified function to fetch data from any Poe model
        async function fetchFinancialDataViaModel(ticker, modelName, modelDisplayName) {
            displayMessage(`Using ${modelDisplayName} to retrieve historical financial data for ${ticker}`, "info");
            
            // Build a prompt that asks the model to retrieve actual historical financial data
            const prompt = `${modelName} I need you to retrieve ACTUAL HISTORICAL financial data for ${ticker} from your knowledge of public financial information. DO NOT fabricate or estimate data.

IMPORTANT INSTRUCTIONS:
1. Search your knowledge for real historical financial data from sources like Yahoo Finance, company annual reports, SEC filings, etc.
2. Provide ONLY FACTUAL data that you're confident about from the most recent 4 complete fiscal years (including 2024 if available)
3. For any data point you're unsure about, use "N/A" rather than guessing
4. If minimal reliable data exists for this ticker, clearly state that in your JSON under the "dataLimitations" field
5. Format all numbers consistently in millions with the appropriate currency symbol
6. Focus on accuracy over completeness - partial accurate data is better than complete made-up data
7. List all sources you used to retrieve the data (include URLs when available) within the "sources" array in the JSON

Output ONLY valid JSON without any explanations or markdown formatting. The exact structure should be:

{
  "name": "Full Company Name as listed on exchanges",
  "fiscalYearEnd": "Month Day (e.g., Dec 31)",
  "currencyUnit": "Millions",
  "currencySymbol": "$",
  "years": [2024, 2023, 2022, 2021],
  "sharesOutstanding": 123.45,
  "description": "Factual company description",
  "sector": "Actual classification sector",
  "industry": "Specific industry classification",
  "founded": "Actual founding year",
  "headquarters": "City, Country",
  "dataLimitations": "Any limitations about the data provided (if applicable)",
  "sources": ["https://finance.yahoo.com/quote/AAPL", "Company's 2024 Annual Report", "Company SEC 10-K Filing"],
  "incomeStatement": {
    "Revenue": ["$1,234", "$1,111", "$999", "$888"],
    "Cost of Revenue": ["($700)", "($650)", "($600)", "($550)"],
    "Gross Profit": ["$534", "$461", "$399", "$338"],
    "Operating Expenses": ["($200)", "($180)", "($160)", "($145)"],
    "R&D Expenses": ["($50)", "($45)", "($40)", "($35)"],
    "Operating Income": ["$334", "$281", "$239", "$193"],
    "Other Income": ["$10", "$8", "$6", "($2)"],
    "Tax Expense": ["($70)", "($60)", "($50)", "($40)"],
    "Net Income": ["$274", "$229", "$195", "$151"]
  },
  "balanceSheet": {
    "Cash & Equivalents": ["$500", "$450", "$400", "$350"],
    "Accounts Receivable": ["$200", "$180", "$160", "$140"],
    "Inventory": ["$300", "$270", "$240", "$210"],
    "Total Current Assets": ["$1,000", "$900", "$800", "$700"],
    "Property & Equipment": ["$800", "$750", "$700", "$650"],
    "Intangible Assets": ["$200", "$190", "$180", "$170"],
    "Total Assets": ["$2,000", "$1,840", "$1,680", "$1,520"],
    "Accounts Payable": ["$150", "$135", "$120", "$105"],
    "Short-term Debt": ["$100", "$90", "$80", "$70"],
    "Total Current Liabilities": ["$250", "$225", "$200", "$175"],
    "Long-term Debt": ["$500", "$475", "$450", "$425"],
    "Total Liabilities": ["$750", "$700", "$650", "$600"],
    "Common Stock": ["$500", "$500", "$500", "$500"],
    "Retained Earnings": ["$750", "$640", "$530", "$420"],
    "Total Equity": ["$1,250", "$1,140", "$1,030", "$920"],
    "Total Liabilities & Equity": ["$2,000", "$1,840", "$1,680", "$1,520"]
  },
  "cashFlow": {
    "Net Income": ["$274", "$229", "$195", "$151"],
    "Depreciation & Amortization": ["$100", "$95", "$90", "$85"],
    "Changes in Working Capital": ["($20)", "($15)", "$10", "$5"],
    "Net Cash from Operations": ["$354", "$309", "$295", "$241"],
    "Capital Expenditures": ["($150)", "($140)", "($130)", "($120)"],
    "Acquisitions": ["($50)", "$0", "($30)", "$0"],
    "Net Cash from Investing": ["($200)", "($140)", "($160)", "($120)"],
    "Debt Issuance (Repayment)": ["$25", "$15", "$25", "$30"],
    "Dividends Paid": ["($80)", "($70)", "($60)", "($50)"],
    "Net Cash from Financing": ["($55)", "($55)", "($35)", "($20)"],
    "Net Change in Cash": ["$99", "$114", "$100", "$101"],
    "Beginning Cash Balance": ["$401", "$287", "$187", "$86"],
    "Ending Cash Balance": ["$500", "$401", "$287", "$187"]
  }
}

For any field where you lack confidence in the data or the data isn't available in your knowledge, use "N/A". Do not fabricate numbers.

Remember, I need ONLY the JSON with NO additional text before or after.`;
            
            // Create a handler for the response
            const handlerId = "financialDataFetchHandler";
            
            // Set up a promise that will resolve when we get the data
            const dataPromise = new Promise((resolve, reject) => {
                window.Poe.registerHandler(handlerId, (result, context) => {
                    if (result.status === "error") {
                        reject(new Error(result.statusText || "Failed to fetch financial data"));
                    } else if (result.status === "complete") {
                        try {
                            // Get the response content
                            const content = result.responses[0].content;
                            
                            // Extract source URLs from the full response
                            const urls = extractUrls(content);
                            
                            // Update the source URLs section
                            updateSourceUrls(urls);
                            
                            // Extract the JSON portion
                            let jsonMatch = content.match(/\{[\s\S]*\}/);
                            if (!jsonMatch) {
                                reject(new Error("No valid JSON found in response"));
                                return;
                            }
                            
                            // Parse the JSON
                            const data = JSON.parse(jsonMatch[0]);
                            
                            // If the JSON contains source URLs, add those too
                            if (data.sources && Array.isArray(data.sources)) {
                                const jsonUrls = extractUrls(data.sources.join(' '));
                                if (jsonUrls.length > 0) {
                                    updateSourceUrls(jsonUrls);
                                }
                            }
                            
                            resolve(data);
                        } catch (error) {
                            reject(new Error(`Failed to parse financial data: ${error.message}`));
                        }
                    }
                });
            });
            
            // Send the request to the chosen model
            try {
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    stream: false, 
                    openChat: false
                });
            } catch (error) {
                if (error.errorType === 'USER_REJECTED_CONFIRMATION') {
                    throw new Error("You rejected the confirmation prompt. External data can't be loaded.");
                } else {
                    throw new Error(`Error sending request: ${error.message}`);
                }
            }
            
            // Wait for and return the financial data
            return await dataPromise;
        }
        
        // Fetch and display stock data when the button is clicked
        document.getElementById('fetchStockBtn').addEventListener('click', async function() {
            const stockCode = document.getElementById('stockCodeInput').value.trim().toUpperCase();
            
            if (!stockCode) {
                alert('Please enter a stock code');
                return;
            }
            
            try {
                await fetchStockData(stockCode);
            } catch (error) {
                // Error is already handled in fetchStockData
                console.error('Failed to load data:', error);
            }
        });
        
        // Fetch and display current stock info when the button is clicked
        document.getElementById('fetchCurrentInfoBtn').addEventListener('click', async function() {
            const stockCode = document.getElementById('stockCodeInput').value.trim().toUpperCase();
            
            if (!stockCode) {
                alert('Please enter a stock code');
                return;
            }
            
            try {
                await fetchCurrentStockInfo(stockCode);
            } catch (error) {
                console.error('Failed to load current stock info:', error);
                displayMessage(`Error: Failed to load current stock information for ${stockCode}. ${error.message}`, "error");
            }
        });
        
        // Analyst consensus data for each stock
        const analystConsensusData = {
            'AAPL': {
                priceTarget: {
                    average: 219.14,
                    low: 125.00,
                    high: 250.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 26,
                    hold: 9,
                    sell: 1,
                    total: 36
                },
                earningsEstimate: {
                    nextQuarter: 1.56,
                    currentYear: 6.58,
                    nextYear: 7.23,
                    growth: 9.9
                }
            },
            'MSFT': {
                priceTarget: {
                    average: 455.93,
                    low: 232.00,
                    high: 610.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 41,
                    hold: 4,
                    sell: 1,
                    total: 46
                },
                earningsEstimate: {
                    nextQuarter: 2.94,
                    currentYear: 11.79,
                    nextYear: 13.52,
                    growth: 14.7
                }
            },
            'AMZN': {
                priceTarget: {
                    average: 215.11,
                    low: 143.00,
                    high: 240.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 47,
                    hold: 2,
                    sell: 0,
                    total: 49
                },
                earningsEstimate: {
                    nextQuarter: 1.12,
                    currentYear: 4.67,
                    nextYear: 6.34,
                    growth: 35.8
                }
            },
            'GOOGL': {
                priceTarget: {
                    average: 196.69,
                    low: 140.00,
                    high: 226.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 39,
                    hold: 6,
                    sell: 0,
                    total: 45
                },
                earningsEstimate: {
                    nextQuarter: 1.86,
                    currentYear: 7.52,
                    nextYear: 8.74,
                    growth: 16.2
                }
            },
            'META': {
                priceTarget: {
                    average: 527.62,
                    low: 300.00,
                    high: 600.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 45,
                    hold: 5,
                    sell: 1,
                    total: 51
                },
                earningsEstimate: {
                    nextQuarter: 4.84,
                    currentYear: 20.00,
                    nextYear: 23.91,
                    growth: 19.6
                }
            },
            'TSLA': {
                priceTarget: {
                    average: 189.94,
                    low: 23.53,
                    high: 310.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 14,
                    hold: 15,
                    sell: 9,
                    total: 38
                },
                earningsEstimate: {
                    nextQuarter: 0.58,
                    currentYear: 2.38,
                    nextYear: 3.07,
                    growth: 29.0
                }
            },
            'NVDA': {
                priceTarget: {
                    average: 139.58,
                    low: 100.00,
                    high: 175.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 40,
                    hold: 5,
                    sell: 1,
                    total: 46
                },
                earningsEstimate: {
                    nextQuarter: 0.62,
                    currentYear: 2.51,
                    nextYear: 3.14,
                    growth: 25.1
                }
            },
            'JNJ': {
                priceTarget: {
                    average: 175.59,
                    low: 155.00,
                    high: 215.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 8,
                    hold: 10,
                    sell: 0,
                    total: 18
                },
                earningsEstimate: {
                    nextQuarter: 2.71,
                    currentYear: 10.71,
                    nextYear: 11.08,
                    growth: 3.5
                }
            },
            'JPM': {
                priceTarget: {
                    average: 212.03,
                    low: 180.00,
                    high: 245.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 15,
                    hold: 7,
                    sell: 0,
                    total: 22
                },
                earningsEstimate: {
                    nextQuarter: 4.12,
                    currentYear: 16.54,
                    nextYear: 16.04,
                    growth: -3.0
                }
            },
            'V': {
                priceTarget: {
                    average: 301.71,
                    low: 265.00,
                    high: 336.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 27,
                    hold: 3,
                    sell: 0,
                    total: 30
                },
                earningsEstimate: {
                    nextQuarter: 2.45,
                    currentYear: 9.92,
                    nextYear: 11.27,
                    growth: 13.6
                }
            },
            'PG': {
                priceTarget: {
                    average: 177.20,
                    low: 160.00,
                    high: 190.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 13,
                    hold: 12,
                    sell: 0,
                    total: 25
                },
                earningsEstimate: {
                    nextQuarter: 1.56,
                    currentYear: 6.52,
                    nextYear: 7.02,
                    growth: 7.7
                }
            },
            '0700.HK': {
                priceTarget: {
                    average: 325.00,
                    low: 200.00,
                    high: 474.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 40,
                    hold: 5,
                    sell: 0,
                    total: 45
                },
                earningsEstimate: {
                    nextQuarter: 4.42,
                    currentYear: 17.85,
                    nextYear: 20.75,
                    growth: 16.2
                }
            },
            '9988.HK': {
                priceTarget: {
                    average: 78.54,
                    low: 50.00,
                    high: 120.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 36,
                    hold: 8,
                    sell: 2,
                    total: 46
                },
                earningsEstimate: {
                    nextQuarter: 2.14,
                    currentYear: 8.88,
                    nextYear: 10.14,
                    growth: 14.2
                }
            },
            '1299.HK': {
                priceTarget: {
                    average: 73.50,
                    low: 62.00,
                    high: 88.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 16,
                    hold: 1,
                    sell: 0,
                    total: 17
                },
                earningsEstimate: {
                    nextQuarter: null,
                    currentYear: 6.12,
                    nextYear: 6.75,
                    growth: 10.3
                }
            },
            'BP.L': {
                priceTarget: {
                    average: 574.38,
                    low: 475.00,
                    high: 700.00,
                    date: 'June 2024'
                },
                recommendations: {
                    buy: 11,
                    hold: 7,
                    sell: 0,
                    total: 18
                },
                earningsEstimate: {
                    nextQuarter: null,
                    currentYear: 0.71,
                    nextYear: 0.76,
                    growth: 7.0
                }
            }
        };
        
        // Stock quick select buttons
        document.querySelectorAll('.stock-quick-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.getElementById('stockCodeInput').value = this.textContent;
                document.getElementById('fetchStockBtn').click();
            });
        });
        
        // Allow enter key to trigger search
        document.getElementById('stockCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('fetchStockBtn').click();
            }
        });
        
        // Trigger valuation calculation when inputs change
        document.getElementById('calculateValuation').addEventListener('click', function() {
            calculateValuation();
        });
        
        // Initialize financial charts functionality
        initializeCharts();
        
        // Toggle functionality for charts
        document.getElementById('incomeTableBtn').addEventListener('click', function() {
            toggleView('income');
        });
        
        document.getElementById('incomeChartBtn').addEventListener('click', function() {
            toggleView('income', 'chart');
        });
        
        document.getElementById('balanceTableBtn').addEventListener('click', function() {
            toggleView('balance');
        });
        
        document.getElementById('balanceChartBtn').addEventListener('click', function() {
            toggleView('balance', 'chart');
        });
        
        document.getElementById('cashFlowTableBtn').addEventListener('click', function() {
            toggleView('cashFlow');
        });
        
        document.getElementById('cashFlowChartBtn').addEventListener('click', function() {
            toggleView('cashFlow', 'chart');
        });
        
        // Function to toggle between table and chart views
        function toggleView(statementType, view = 'table') {
            // Table elements
            const tableViewId = `${statementType}TableView`;
            const tableBtn = document.getElementById(`${statementType}TableBtn`);
            
            // Chart elements
            const chartViewId = `${statementType}ChartView`;
            const chartBtn = document.getElementById(`${statementType}ChartBtn`);
            
            if (view === 'table') {
                // Show table, hide chart
                document.getElementById(tableViewId).classList.remove('hidden');
                document.getElementById(tableViewId).classList.add('block');
                document.getElementById(chartViewId).classList.add('hidden');
                
                // Highlight table button
                tableBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                tableBtn.classList.add('bg-primary', 'text-white');
                
                // Un-highlight chart button
                chartBtn.classList.remove('bg-primary', 'text-white');
                chartBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            } else {
                // Show chart, hide table
                document.getElementById(chartViewId).classList.remove('hidden');
                document.getElementById(tableViewId).classList.remove('block');
                document.getElementById(tableViewId).classList.add('hidden');
                
                // Highlight chart button
                chartBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                chartBtn.classList.add('bg-primary', 'text-white');
                
                // Un-highlight table button
                tableBtn.classList.remove('bg-primary', 'text-white');
                tableBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                
                // Update chart
                updateChart(statementType);
            }
        }
        
        // Function to initialize Chart.js functionality
        function initializeCharts() {
            // Create chart instances and store them
            window.charts = {
                income: null,
                balance: null,
                cashFlow: null
            };
            
            // Add event listeners for checkboxes to update charts
            document.querySelectorAll('.income-chart-primary, .income-chart-secondary').forEach(checkbox => {
                checkbox.addEventListener('change', () => updateChart('income'));
            });
            
            document.querySelectorAll('.balance-chart-metric').forEach(checkbox => {
                checkbox.addEventListener('change', () => updateChart('balance'));
            });
            
            document.querySelectorAll('.cashflow-chart-metric').forEach(checkbox => {
                checkbox.addEventListener('change', () => updateChart('cashFlow'));
            });
        }
        
        // Function to update chart based on statement type
        function updateChart(statementType) {
            // Early return for non-income statements (other statements remain unchanged)
            if (statementType !== 'income') {
                updateRegularChart(statementType);
                return;
            }
            
            // Income statement gets special treatment with mixed chart (bars + lines)
            const primaryMetrics = Array.from(document.querySelectorAll('.income-chart-primary:checked')).map(cb => cb.value);
            const secondaryMetrics = Array.from(document.querySelectorAll('.income-chart-secondary:checked')).map(cb => cb.value);
            
            if (primaryMetrics.length === 0 && secondaryMetrics.length === 0) return;
            
            // Get years from table headers
            const years = getYearsFromTable(statementType);
            if (years.length === 0) return;
            
            // Get data for each metric
            const data = currentFinancialData;
            const incomeData = data.incomeStatement;
            
            if (!incomeData) return;
            
            // Generate colors
            const primaryColorPool = ['#4C51BF', '#ED8936', '#38B2AC', '#3182CE'];
            const secondaryColorPool = ['#10B981', '#059669', '#047857', '#065F46'];
            
            const datasets = [];
            
            // Create datasets for primary metrics (bars)
            primaryMetrics.forEach((metric, index) => {
                const values = [];
                
                // Check if we have data for this metric
                if (incomeData[metric]) {
                    // Convert string values to numbers
                    for (let i = 0; i < Math.min(years.length, 4); i++) {
                        const value = parseFinancialNumber(incomeData[metric][i]);
                        values.push(value);
                    }
                    
                    // Add dataset
                    datasets.push({
                        label: metric,
                        data: values,
                        backgroundColor: primaryColorPool[index % primaryColorPool.length] + '80',
                        borderColor: primaryColorPool[index % primaryColorPool.length],
                        borderWidth: 1,
                        type: 'bar', // Use bar type
                        order: 1, // Put bars behind lines
                        yAxisID: 'y' // Use primary y-axis
                    });
                }
            });
            
            // Create datasets for secondary metrics (lines)
            secondaryMetrics.forEach((metric, index) => {
                const values = [];
                
                // Calculate values based on metric
                for (let i = 0; i < Math.min(years.length, 4); i++) {
                    let value = 0;
                    
                    if (metric === 'Net Profit Margin') {
                        const netIncome = parseFinancialNumber(incomeData['Net Income'][i]);
                        const revenue = parseFinancialNumber(incomeData['Revenue'][i]);
                        value = revenue !== 0 ? (netIncome / revenue) * 100 : 0; // as percentage
                    } else if (metric === 'Operating Margin') {
                        const opIncome = parseFinancialNumber(incomeData['Operating Income'][i]);
                        const revenue = parseFinancialNumber(incomeData['Revenue'][i]);
                        value = revenue !== 0 ? (opIncome / revenue) * 100 : 0; // as percentage
                    } else if (metric === 'Gross Margin') {
                        const grossProfit = parseFinancialNumber(incomeData['Gross Profit'][i]);
                        const revenue = parseFinancialNumber(incomeData['Revenue'][i]);
                        value = revenue !== 0 ? (grossProfit / revenue) * 100 : 0; // as percentage
                    }
                    
                    values.push(value);
                }
                
                // Add dataset
                datasets.push({
                    label: metric,
                    data: values,
                    backgroundColor: 'transparent',
                    borderColor: secondaryColorPool[index % secondaryColorPool.length],
                    borderWidth: 2,
                    type: 'line', // Use line type
                    tension: 0.1,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    order: 0, // Put lines in front of bars
                    yAxisID: 'y1', // Use secondary y-axis
                });
            });
            
            // Create or update chart
            const chartCanvas = document.getElementById(`${statementType}Chart`);
            if (!chartCanvas) return;
            
            // Get chart context
            const ctx = chartCanvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.charts[statementType]) {
                window.charts[statementType].destroy();
            }
            
            // Create new chart
            window.charts[statementType] = new Chart(ctx, {
                type: 'bar', // Default type (overridden by individual datasets)
                data: {
                    labels: years.map(y => y.toString().substr(-4)), // Show just the year
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                color: document.documentElement.classList.contains('dark') ? '#DDD' : '#555'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    
                                    // Apply formatting to the value based on axis
                                    if (context.parsed.y !== null) {
                                        if (context.dataset.yAxisID === 'y1') {
                                            // Format as percentage for secondary axis
                                            label += context.parsed.y.toFixed(1) + '%';
                                        } else {
                                            // Format as currency for primary axis
                                            label += formatFinancialNumber(context.parsed.y, false, data.currencySymbol);
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#AAA' : '#666'
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? '#333' : '#ddd'
                            }
                        },
                        y: {
                            position: 'left',
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#AAA' : '#666',
                                callback: function(value) {
                                    return formatFinancialNumber(value, false, data.currencySymbol);
                                }
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? '#333' : '#ddd'
                            },
                            title: {
                                display: true,
                                text: 'Values ' + data.currencySymbol + '(000s)',
                                color: document.documentElement.classList.contains('dark') ? '#AAA' : '#666'
                            }
                        },
                        y1: {
                            position: 'right',
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#AAA' : '#666',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            grid: {
                                // No grid lines for secondary axis
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Margin %',
                                color: document.documentElement.classList.contains('dark') ? '#AAA' : '#666'
                            }
                        }
                    }
                }
            });
        }
        
        // Function to update charts for other statement types
        function updateRegularChart(statementType) {
            // Get metrics
            const checkedMetrics = getCheckedMetrics(statementType);
            if (checkedMetrics.length === 0) return;
            
            // Get years from table headers
            const years = getYearsFromTable(statementType);
            if (years.length === 0) return;
            
            // Get data for each metric
            const datasets = [];
            const data = currentFinancialData;
            
            // Get data source based on statement type
            let dataSource;
            if (statementType === 'balance') {
                dataSource = data.balanceSheet;
            } else if (statementType === 'cashFlow') {
                dataSource = data.cashFlow;
            }
            
            if (!dataSource) return;
            
            // Generate random colors if needed
            const colorPool = [
                '#4C51BF', '#ED8936', '#38B2AC', '#3182CE', '#805AD5',
                '#DD6B20', '#D53F8C', '#2B6CB0', '#9B2C2C', '#2C7A7B'
            ];
            
            // Create dataset for each metric
            checkedMetrics.forEach((metric, index) => {
                const values = [];
                
                // Check if we have data for this metric
                if (dataSource[metric]) {
                    // Convert string values to numbers
                    for (let i = 0; i < Math.min(years.length, 4); i++) {
                        const value = parseFinancialNumber(dataSource[metric][i]);
                        values.push(value);
                    }
                    
                    // Add dataset
                    datasets.push({
                        label: metric,
                        data: values,
                        backgroundColor: colorPool[index % colorPool.length] + '40', // With transparency
                        borderColor: colorPool[index % colorPool.length],
                        borderWidth: 2,
                        tension: 0.1
                    });
                }
            });
            
            // Create or update chart
            const chartCanvas = document.getElementById(`${statementType}Chart`);
            if (!chartCanvas) return;
            
            // Get chart context
            const ctx = chartCanvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.charts[statementType]) {
                window.charts[statementType].destroy();
            }
            
            // Create new chart
            window.charts[statementType] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => y.toString().substr(-4)), // Show just the year
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                color: document.documentElement.classList.contains('dark') ? '#DDD' : '#555'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    
                                    // Apply formatting to the value
                                    if (context.parsed.y !== null) {
                                        label += formatFinancialNumber(context.parsed.y, false, data.currencySymbol);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#AAA' : '#666'
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? '#333' : '#ddd'
                            }
                        },
                        y: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#AAA' : '#666',
                                callback: function(value) {
                                    return formatFinancialNumber(value, false, data.currencySymbol);
                                }
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? '#333' : '#ddd'
                            }
                        }
                    }
                }
            });
        }
        
        // Helper function to get checked metrics
        function getCheckedMetrics(statementType) {
            const checkedMetrics = [];
            // Handle case sensitivity issue with cashFlow vs. cashflow
            const selector = statementType === 'cashFlow' 
                ? '.cashflow-chart-metric:checked' 
                : `.${statementType}-chart-metric:checked`;
                
            const checkboxes = document.querySelectorAll(selector);
            
            checkboxes.forEach(checkbox => {
                checkedMetrics.push(checkbox.value);
            });
            
            return checkedMetrics;
        }
        
        // Helper function to get years from table headers
        function getYearsFromTable(statementType) {
            const years = [];
            
            // Determine header IDs based on statement type
            const headerId = `${statementType === 'cashFlow' ? 'cashflow' : statementType}-year-`;
            
            // Get years from table headers
            for (let i = 1; i <= 4; i++) {
                const headerElement = document.getElementById(`${headerId}${i}`);
                if (headerElement) {
                    // Extract year from the header (typically in format "Month Day, YYYY")
                    const headerText = headerElement.textContent;
                    const yearMatch = headerText.match(/\b(20\d{2})\b/);
                    
                    if (yearMatch && yearMatch[1]) {
                        years.push(yearMatch[1]);
                    }
                }
            }
            
            return years;
        }
        
        // Export to Excel with DCF model
        document.getElementById('exportExcel').addEventListener('click', function() {
            exportToExcel(currentFinancialData);
        });
        
        // Improved Excel export with DCF valuation model
        function exportToExcel(data) {
            // Check if we have data to export
            if (!data || !data.name) {
                alert('No financial data to export. Please fetch data for a stock first.');
                return;
            }
            
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare each sheet
            const sheets = [
                { title: 'Income Statement', structure: incomeStatementStructure },
                { title: 'Balance Sheet', structure: balanceSheetStructure },
                { title: 'Cash Flow Statement', structure: cashFlowStructure },
                { title: 'DCF Valuation' } // Special sheet for valuation model
            ];
            
            // Process each regular financial statement
            for (let i = 0; i < 3; i++) {
                const sheetInfo = sheets[i];
                // Create the worksheet
                const ws = createFormattedWorksheet(sheetInfo.title, sheetInfo.structure, data);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, sheetInfo.title);
            }
            
            // Create DCF Valuation sheet with linked formulas
            const valuationWs = createValuationWorksheet(data);
            XLSX.utils.book_append_sheet(wb, valuationWs, 'DCF Valuation');
            
            // Generate Excel file and trigger download with company name
            const safeCompanyName = data.name.replace(/[^a-zA-Z0-9]/g, '_');
            let yearRange = 'Financial_Data';
            if (data.years && data.years.length > 1) {
                const lastIndex = Math.min(data.years.length - 1, 3);
                yearRange = `${data.years[lastIndex]}-${data.years[0]}`;
            }
            
            XLSX.writeFile(wb, `${safeCompanyName}_Valuation_${yearRange}.xlsx`);
        }
        
        // Create a formatted worksheet for financial statements
        function createFormattedWorksheet(title, structure, data) {
            // Create a 2D array for the worksheet data
            const wsData = [];
            
            // Add title row with company name
            wsData.push([`${title} - ${data.name}`]);
            
            // Add fiscal year end info
            wsData.push([`Fiscal Year Ending: ${data.fiscalYearEnd}`]);
            
            // Add currency info
            wsData.push([`All figures in ${data.currencyUnit} (${data.currencySymbol}000s)`]);
            
            // Add empty row
            wsData.push([]);
            
            // Create header row with years
            const headerRow = ['Item'];
            for (let i = 0; i < Math.min(data.years.length, 4); i++) {
                headerRow.push(`${data.fiscalYearEnd}, ${data.years[i]}`);
            }
            
            // Ensure we have 5 columns (Item + 4 years)
            while (headerRow.length < 5) {
                headerRow.push('Year');
            }
            
            wsData.push(headerRow);
            
            // Add data rows based on the structure
            structure.forEach(item => {
                let rowData = [];
                
                if (item.isSection && item.colspan) {
                    // Section header (push as regular row with empty cells)
                    rowData = [item.label];
                    
                    // Add empty cells for year columns
                    for (let i = 1; i < headerRow.length; i++) {
                        rowData.push('');
                    }
                } else {
                    rowData = [item.label];
                    
                    // Look up the data source based on which statement we're processing
                    let dataSource;
                    if (title === 'Income Statement') {
                        dataSource = data.incomeStatement;
                    } else if (title === 'Balance Sheet') {
                        dataSource = data.balanceSheet;
                    } else if (title === 'Cash Flow Statement') {
                        dataSource = data.cashFlow;
                    }
                    
                    // Get values for this row
                    const values = dataSource[item.label] || [];
                    
                    // Add values (or '-' if no value)
                    for (let i = 0; i < headerRow.length - 1; i++) {
                        rowData.push(values[i] || '-');
                    }
                }
                
                wsData.push(rowData);
            });
            
            // Create the worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            const colWidths = [];
            colWidths[0] = {wch: 30}; // First column wider for labels
            for (let i = 1; i <= headerRow.length; i++) {
                colWidths[i] = {wch: 15}; // Data columns
            }
            ws['!cols'] = colWidths;
            
            // Format title and info rows
            formatCell(ws, 0, 0, { bold: true, fontSize: 14 });
            formatCell(ws, 1, 0, { italic: true, fontSize: 12 });
            formatCell(ws, 2, 0, { italic: true, fontSize: 10 });
            
            // Format header row
            for (let c = 0; c < headerRow.length; c++) {
                formatCell(ws, 4, c, { 
                    bold: true, 
                    fill: 'D8D8D8',
                    border: { top: 'thin', bottom: 'thin', left: 'thin', right: 'thin' },
                    alignment: c === 0 ? 'left' : 'right'
                });
            }
            
            // Format data rows
            for (let r = 5; r < wsData.length; r++) {
                if (!wsData[r] || wsData[r].length === 0) continue;
                
                // Get the corresponding structure item
                const structureIndex = r - 5; // Adjust for header rows
                if (structureIndex < 0 || structureIndex >= structure.length) continue;
                
                const item = structure[structureIndex];
                
                // Format each cell in the row
                for (let c = 0; c < wsData[r].length; c++) {
                    let cellStyle = {
                        border: { top: 'thin', bottom: 'thin', left: 'thin', right: 'thin' },
                        alignment: c === 0 ? 'left' : 'right'
                    };
                    
                    // Apply special styling based on row type
                    if (item.isSection) {
                        cellStyle.bold = true;
                        cellStyle.fill = 'F0F0F0';
                    } else if (item.isTotal && item.cssClass.includes('bg-gray-100')) {
                        cellStyle.bold = true;
                        cellStyle.fill = 'E0E0E0';
                        cellStyle.border.bottom = 'double';
                    } else if (item.isTotal) {
                        cellStyle.bold = true;
                        cellStyle.fill = 'F8F8F8';
                    }
                    
                    // For numeric cells, convert to numbers and apply accounting format
                    if (c > 0) {
                        const cellValue = wsData[r][c];
                        if (cellValue && cellValue !== '-') {
                            // Parse the cell value which may have currency symbols and parentheses
                            try {
                                const currencySymbol = data.currencySymbol;
                                const isNegative = cellValue.includes('(');
                                
                                // Extract the numeric portion
                                let numericValue;
                                if (isNegative) {
                                    // Remove currency symbol, parentheses, and commas
                                    numericValue = cellValue.replace(/[^\d.]/g, '');
                                } else {
                                    // Remove currency symbol and commas
                                    numericValue = cellValue.replace(/[^\d.]/g, '');
                                }
                                
                                // Convert to number
                                const numberValue = parseFloat(numericValue);
                                
                                if (!isNaN(numberValue)) {
                                    // Set cell value and type
                                    const cellRef = XLSX.utils.encode_cell({r, c});
                                    ws[cellRef].v = isNegative ? -numberValue : numberValue;
                                    ws[cellRef].t = 'n';
                                    
                                    // Apply accounting format
                                    if (currencySymbol === 'Â¥') {
                                        cellStyle.numFmt = `_(Â¥* #,##0_);_(Â¥* (#,##0);_(Â¥* "-"_);_(@_)`;
                                    } else if (currencySymbol === 'Â£') {
                                        cellStyle.numFmt = `_(Â£* #,##0_);_(Â£* (#,##0);_(Â£* "-"_);_(@_)`;
                                    } else if (currencySymbol === 'â‚¬') {
                                        cellStyle.numFmt = `_(â‚¬* #,##0_);_(â‚¬* (#,##0);_(â‚¬* "-"_);_(@_)`;
                                    } else if (currencySymbol === 'HK$') {
                                        cellStyle.numFmt = `_(HK$* #,##0_);_(HK$* (#,##0);_(HK$* "-"_);_(@_)`;
                                    } else {
                                        cellStyle.numFmt = `_($* #,##0_);_($* (#,##0);_($* "-"_);_(@_)`;
                                    }
                                }
                            } catch (e) {
                                console.warn('Error converting cell value to number:', e);
                            }
                        }
                    }
                    
                    formatCell(ws, r, c, cellStyle);
                }
            }
            
            return ws;
        }
        
        // Create a DCF valuation model worksheet with linked formulas
        function createValuationWorksheet(data) {
            // If we don't have projection rows, calculate valuation first
            if (!data.projectionRows) {
                calculateValuation();
            }
            
            // Get inputs from the form
            const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 5;
            const revenueGrowthRate = parseFloat(document.getElementById('revenueGrowthRate').value) / 100 || 0.05;
            const operatingMargin = parseFloat(document.getElementById('operatingMargin').value) / 100 || 0.2;
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100 || 0.25;
            const capexRate = parseFloat(document.getElementById('capexRate').value) / 100 || 0.05;
            const wcRate = parseFloat(document.getElementById('wcRate').value) / 100 || 0.1;
            const terminalGrowthRate = parseFloat(document.getElementById('terminalGrowthRate').value) / 100 || 0.02;
            const discountRate = parseFloat(document.getElementById('discountRate').value) / 100 || 0.1;
            const evMultiple = parseFloat(document.getElementById('evMultiple').value) || 12;
            
            // Company information
            const sharesOutstanding = data.sharesOutstanding;
            const netDebt = data.netDebt;
            
            // Create a 2D array for the worksheet data
            const wsData = [];
            
            // Add title
            wsData.push([`DCF Valuation Model - ${data.name}`]);
            wsData.push([`All figures in ${data.currencyUnit} (${data.currencySymbol}000s)`]);
            wsData.push([]);
            
            // Add company info section
            wsData.push(['Company Information']);
            wsData.push(['Shares Outstanding (millions)', sharesOutstanding]);
            wsData.push(['Net Debt (millions)', netDebt]);
            wsData.push([]);
            
            // Add inputs section
            wsData.push(['Model Inputs']);
            wsData.push(['Forecast Period (Years)', forecastPeriod]);
            wsData.push(['Revenue Growth Rate', revenueGrowthRate]);
            wsData.push(['Operating Margin', operatingMargin]);
            wsData.push(['Tax Rate', taxRate]);
            wsData.push(['Capital Expenditure (% of Revenue)', capexRate]);
            wsData.push(['Working Capital (% of Revenue)', wcRate]);
            wsData.push(['Terminal Growth Rate', terminalGrowthRate]);
            wsData.push(['Discount Rate (WACC)', discountRate]);
            wsData.push(['EV/EBITDA Multiple', evMultiple]);
            wsData.push([]);
            
            // Add historical metrics section
            wsData.push(['Historical Metrics']);
            wsData.push(['Revenue CAGR (3 Year)', parseFloat(document.getElementById('revenueCagr').textContent) / 100]);
            wsData.push(['Average Operating Margin', parseFloat(document.getElementById('avgOperatingMargin').textContent) / 100]);
            wsData.push(['Average CapEx % of Revenue', parseFloat(document.getElementById('avgCapex').textContent) / 100]);
            wsData.push(['Effective Tax Rate', parseFloat(document.getElementById('effectiveTaxRate').textContent) / 100]);
            wsData.push([]);
            
            // Add historical data - directly linked to Income Statement sheet
            wsData.push(['Historical Financial Data']);
            wsData.push(['', ...data.years]);
            
            // Add historical revenue - reference to Income Statement sheet
            const incomeSheetName = 'Income Statement';
            const revenueCell = "B6"; // Assuming revenue is row 6, column B in Income Statement
            
            wsData.push(['Historical Revenue', 
                { f: `'${incomeSheetName}'!${revenueCell}` },
                { f: `'${incomeSheetName}'!C6` }, 
                { f: `'${incomeSheetName}'!D6` },
                { f: `'${incomeSheetName}'!E6` }
            ]);
            
            // Add historical operating income - reference to Income Statement sheet
            wsData.push(['Historical Operating Income', 
                { f: `'${incomeSheetName}'!B11` },
                { f: `'${incomeSheetName}'!C11` }, 
                { f: `'${incomeSheetName}'!D11` },
                { f: `'${incomeSheetName}'!E11` }
            ]);
            
            // Add historical tax expense - reference to Income Statement sheet
            wsData.push(['Historical Tax Expense', 
                { f: `'${incomeSheetName}'!B13` },
                { f: `'${incomeSheetName}'!C13` }, 
                { f: `'${incomeSheetName}'!D13` },
                { f: `'${incomeSheetName}'!E13` }
            ]);
            
            // Add historical depreciation - reference to Cash Flow sheet
            const cfSheetName = 'Cash Flow Statement';
            wsData.push(['Historical Depreciation', 
                { f: `'${cfSheetName}'!B8` },
                { f: `'${cfSheetName}'!C8` }, 
                { f: `'${cfSheetName}'!D8` },
                { f: `'${cfSheetName}'!E8` }
            ]);
            
            // Add historical capex - reference to Cash Flow sheet
            wsData.push(['Historical CapEx', 
                { f: `'${cfSheetName}'!B12` },
                { f: `'${cfSheetName}'!C12` }, 
                { f: `'${cfSheetName}'!D12` },
                { f: `'${cfSheetName}'!E12` }
            ]);
            
            // Add historical working capital change - reference to Cash Flow sheet
            wsData.push(['Historical Working Capital Change', 
                { f: `'${cfSheetName}'!B9` },
                { f: `'${cfSheetName}'!C9` }, 
                { f: `'${cfSheetName}'!D9` },
                { f: `'${cfSheetName}'!E9` }
            ]);
            
            wsData.push([]);
            
            // Add projections
            wsData.push(['Projections']);
            
            // Create headers for projection years
            const projectionHeaders = [''];
            const baseYear = data.years[0];
            for (let i = 0; i <= forecastPeriod; i++) {
                projectionHeaders.push(i === 0 ? `Historical (${baseYear})` : `Year ${i} (${baseYear + i})`);
            }
            projectionHeaders.push('Terminal');
            wsData.push(projectionHeaders);
            
            // Get the row where projections start, needed for Excel cell references
            const projectionsStart = wsData.length;
            
            // Add revenue row - with explicit formulas
            const revenueRow = ['Revenue'];
            
            // Add historical revenue value (directly from data)
            revenueRow.push(parseFinancialNumber(data.incomeStatement['Revenue'][0]));
            
            // Add projected revenues using Excel formulas
            for (let i = 1; i <= forecastPeriod; i++) {
                const cellRef = XLSX.utils.encode_cell({r: projectionsStart, c: i});
                const prevCellRef = XLSX.utils.encode_cell({r: projectionsStart, c: i});
                revenueRow.push({
                    f: `${prevCellRef}*(1+B10)` // Reference to growth rate in inputs section
                });
            }
            
            // Terminal revenue
            const lastRevCellRef = XLSX.utils.encode_cell({r: projectionsStart, c: forecastPeriod + 1});
            revenueRow.push({
                f: `${lastRevCellRef}*(1+B15)` // Reference to terminal growth rate
            });
            
            wsData.push(revenueRow);
            
            // Add operating income row - with explicit formulas
            const opIncomeRow = ['Operating Income'];
            
            // Add historical operating income
            opIncomeRow.push(parseFinancialNumber(data.incomeStatement['Operating Income'][0]));
            
            // Add projected operating incomes using Excel formulas
            for (let i = 1; i <= forecastPeriod + 1; i++) {
                const revCellRef = XLSX.utils.encode_cell({r: projectionsStart, c: i + 1});
                opIncomeRow.push({
                    f: `${revCellRef}*B11` // Reference to operating margin in inputs section
                });
            }
            
            wsData.push(opIncomeRow);
            
            // Add tax row - with explicit formulas
            const taxRow = ['Tax'];
            
            // Add historical tax
            taxRow.push(parseFinancialNumber(data.incomeStatement['Tax Expense'][0]));
            
            // Add projected taxes using Excel formulas
            for (let i = 1; i <= forecastPeriod + 1; i++) {
                const opIncomeCellRef = XLSX.utils.encode_cell({r: projectionsStart + 1, c: i + 1});
                taxRow.push({
                    f: `${opIncomeCellRef}*B12` // Reference to tax rate in inputs section
                });
            }
            
            wsData.push(taxRow);
            
            // Add NOPAT row - with explicit formulas
            const nopatRow = ['NOPAT'];
            
            // Add historical NOPAT (operating income - tax)
            const historicalOpIncome = parseFinancialNumber(data.incomeStatement['Operating Income'][0]);
            const historicalTax = parseFinancialNumber(data.incomeStatement['Tax Expense'][0]);
            nopatRow.push(historicalOpIncome - historicalTax);
            
            // Add projected NOPAT using Excel formulas
            for (let i = 1; i <= forecastPeriod + 1; i++) {
                const opIncomeCellRef = XLSX.utils.encode_cell({r: projectionsStart + 1, c: i + 1});
                const taxCellRef = XLSX.utils.encode_cell({r: projectionsStart + 2, c: i + 1});
                nopatRow.push({
                    f: `${opIncomeCellRef}-${taxCellRef}`
                });
            }
            
            wsData.push(nopatRow);
            
            // Add depreciation row - with explicit formulas
            const depRow = ['Depreciation & Amortization'];
            
            // Add historical depreciation
            depRow.push(parseFinancialNumber(data.cashFlow['Depreciation & Amortization'][0]));
            
            // Calculate depreciation rate
            const historicalRevenue = parseFinancialNumber(data.incomeStatement['Revenue'][0]);
            const historicalDep = parseFinancialNumber(data.cashFlow['Depreciation & Amortization'][0]);
            const depRate = historicalDep / historicalRevenue;
            
            // Add projected depreciation using Excel formulas
            for (let i = 1; i <= forecastPeriod + 1; i++) {
                const revCellRef = XLSX.utils.encode_cell({r: projectionsStart, c: i + 1});
                depRow.push({
                    f: `${revCellRef}*${depRate}` // Using calculated dep rate
                });
            }
            
            wsData.push(depRow);
            
            // Add capex row - with explicit formulas
            const capexRow = ['Capital Expenditures'];
            
            // Add historical capex
            capexRow.push(parseFinancialNumber(data.cashFlow['Capital Expenditures'][0]));
            
            // Add projected capex using Excel formulas
            for (let i = 1; i <= forecastPeriod + 1; i++) {
                const revCellRef = XLSX.utils.encode_cell({r: projectionsStart, c: i + 1});
                capexRow.push({
                    f: `${revCellRef}*B13*-1` // Reference to capex rate, multiply by -1 for cash outflow
                });
            }
            
            wsData.push(capexRow);
            
            // Add working capital change row - with explicit formulas
            const wcRow = ['Change in Working Capital'];
            
            // Add historical wc change
            wcRow.push(parseFinancialNumber(data.cashFlow['Changes in Working Capital'][0]));
            
            // Add projected wc changes using Excel formulas
            for (let i = 1; i <= forecastPeriod + 1; i++) {
                const revCellRef = XLSX.utils.encode_cell({r: projectionsStart, c: i + 1});
                const prevRevCellRef = XLSX.utils.encode_cell({r: projectionsStart, c: i});
                wcRow.push({
                    f: `(${revCellRef}-${prevRevCellRef})*B14*-1` // Reference to wc rate, multiply by -1 for cash outflow
                });
            }
            
            wsData.push(wcRow);
            
            // Add free cash flow row - with explicit formulas
            const fcfRow = ['Free Cash Flow'];
            
            // Add historical FCF
            const historicalNopat = historicalOpIncome + historicalTax; // Using + since tax is stored as negative
            const historicalCapex = parseFinancialNumber(data.cashFlow['Capital Expenditures'][0]);
            const historicalWc = parseFinancialNumber(data.cashFlow['Changes in Working Capital'][0]);
            fcfRow.push(historicalNopat + historicalDep + historicalCapex + historicalWc);
            
            // Add projected FCF using Excel formulas
            for (let i = 1; i <= forecastPeriod + 1; i++) {
                const nopatCellRef = XLSX.utils.encode_cell({r: projectionsStart + 3, c: i + 1});
                const depCellRef = XLSX.utils.encode_cell({r: projectionsStart + 4, c: i + 1});
                const capexCellRef = XLSX.utils.encode_cell({r: projectionsStart + 5, c: i + 1});
                const wcCellRef = XLSX.utils.encode_cell({r: projectionsStart + 6, c: i + 1});
                fcfRow.push({
                    f: `${nopatCellRef}+${depCellRef}+${capexCellRef}+${wcCellRef}`
                });
            }
            
            wsData.push(fcfRow);
            
            // Add discount factor row - with explicit formulas
            const dfRow = ['Discount Factor'];
            
            // Add historical discount factor (not applicable for historical year)
            dfRow.push(1);
            
            // Add projected discount factors using Excel formulas
            for (let i = 1; i <= forecastPeriod; i++) {
                dfRow.push({
                    f: `1/POWER(1+$B$16,${i})` // Reference to discount rate
                });
            }
            
            // Terminal discount factor (same as last year)
            dfRow.push({
                f: `1/POWER(1+$B$16,${forecastPeriod})` // Same as last year
            });
            
            wsData.push(dfRow);
            
            // Add present value row - with explicit formulas
            const pvRow = ['Present Value of FCF'];
            
            // Add historical PV (not applicable for historical year)
            pvRow.push(0);
            
            // Add projected PV using Excel formulas
            const pvStartRow = wsData.length;
            
            for (let i = 1; i <= forecastPeriod; i++) {
                const fcfCellRef = XLSX.utils.encode_cell({r: projectionsStart + 7, c: i + 1});
                const dfCellRef = XLSX.utils.encode_cell({r: projectionsStart + 8, c: i + 1});
                pvRow.push({
                    f: `${fcfCellRef}*${dfCellRef}`
                });
            }
            
            // Add terminal value calculation
            const terminalFcfCellRef = XLSX.utils.encode_cell({r: projectionsStart + 7, c: forecastPeriod + 2});
            const discountRateCellRef = 'B16'; // Reference to discount rate
            const terminalGrowthRateCellRef = 'B15'; // Reference to terminal growth rate
            
            const terminalValueFormula = `${terminalFcfCellRef}/(${discountRateCellRef}-${terminalGrowthRateCellRef})`;
            
            // Terminal value present value
            const terminalDfCellRef = XLSX.utils.encode_cell({r: projectionsStart + 8, c: forecastPeriod + 1});
            pvRow.push({
                f: `(${terminalValueFormula})*${terminalDfCellRef}`
            });
            
            wsData.push(pvRow);
            
            // Add terminal value row
            const terminalValueRow = ['Terminal Value'];
            
            // Add empty cells for historical and projection years
            for (let i = 0; i <= forecastPeriod; i++) {
                terminalValueRow.push('');
            }
            
            // Add terminal value in the last cell
            terminalValueRow.push({
                f: terminalValueFormula
            });
            
            wsData.push(terminalValueRow);
            
            // Add enterprise value row
            const evRow = ['Enterprise Value'];
            
            // Add empty cells for historical and projection years
            for (let i = 0; i <= forecastPeriod; i++) {
                evRow.push('');
            }
            
            // Add up all present values using SUM function
            let sumFormula = 'SUM(';
            for (let i = 1; i <= forecastPeriod + 1; i++) {
                const pvCellRef = XLSX.utils.encode_cell({r: pvStartRow, c: i + 1});
                sumFormula += `${pvCellRef},`;
            }
            sumFormula = sumFormula.slice(0, -1) + ')'; // Remove trailing comma and close parenthesis
            
            // Add enterprise value in the last cell
            evRow.push({
                f: sumFormula
            });
            
            wsData.push(evRow);
            
            // Add equity value row
            const equityValueRow = ['Equity Value'];
            
            // Add empty cells for historical and projection years
            for (let i = 0; i <= forecastPeriod; i++) {
                equityValueRow.push('');
            }
            
            // Add equity value in the last cell (enterprise value - net debt)
            // Fix circular reference by using a direct reference to the Enterprise Value cell (H47)
            const evCellRef = 'H47'; // Directly reference enterprise value cell
            const netDebtCellRef = 'B6'; // Reference to net debt
            
            equityValueRow.push({
                f: `${evCellRef}-${netDebtCellRef}`
            });
            
            wsData.push(equityValueRow);
            
            // Add share price row
            const sharePriceRow = ['Share Price'];
            
            // Add empty cells for historical and projection years
            for (let i = 0; i <= forecastPeriod; i++) {
                sharePriceRow.push('');
            }
            
            // Add share price in the last cell (equity value / shares outstanding)
            // Fix circular reference by using a direct reference to the Equity Value cell (H48)
            const equityValueCellRef = 'H48'; // Directly reference equity value cell
            const sharesCellRef = 'B5'; // Reference to shares outstanding
            
            sharePriceRow.push({
                f: `${equityValueCellRef}/${sharesCellRef}`
            });
            
            wsData.push(sharePriceRow);
            
            // Create the worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            const colWidths = [];
            colWidths[0] = {wch: 30}; // First column wider for labels
            for (let i = 1; i < projectionHeaders.length; i++) {
                colWidths[i] = {wch: 15}; // Data columns
            }
            ws['!cols'] = colWidths;
            
            // Format title
            formatCell(ws, 0, 0, { bold: true, fontSize: 14 });
            formatCell(ws, 1, 0, { italic: true, fontSize: 12 });
            
            // Format section headers
            formatCell(ws, 3, 0, { bold: true, fill: 'D8D8D8' });
            formatCell(ws, 7, 0, { bold: true, fill: 'D8D8D8' });
            formatCell(ws, 17, 0, { bold: true, fill: 'D8D8D8' });
            formatCell(ws, 25, 0, { bold: true, fill: 'D8D8D8' });
            formatCell(ws, 33, 0, { bold: true, fill: 'D8D8D8' });
            
            // Format input labels and values
            for (let i = 4; i <= 5; i++) {
                formatCell(ws, i, 0, { bold: true });
                formatCell(ws, i, 1, { alignment: 'right', numFmt: '#,##0.00' });
            }
            
            for (let i = 8; i <= 16; i++) {
                formatCell(ws, i, 0, { bold: true });
                
                // Format percentages
                if (i >= 9 && i <= 16) {
                    formatCell(ws, i, 1, { 
                        numFmt: '0.00%',
                        alignment: 'right'
                    });
                } else {
                    formatCell(ws, i, 1, { 
                        alignment: 'right',
                        numFmt: '#,##0.00'
                    });
                }
            }
            
            // Format historical metrics
            for (let i = 18; i <= 21; i++) {
                formatCell(ws, i, 0, { bold: true });
                formatCell(ws, i, 1, { 
                    numFmt: '0.00%',
                    alignment: 'right'
                });
            }
            
            // Format historical data headers
            for (let i = 0; i <= 4; i++) {
                formatCell(ws, 26, i, { 
                    bold: true,
                    fill: 'F0F0F0',
                    alignment: i === 0 ? 'left' : 'right'
                });
            }
            
            // Format historical data
            for (let r = 27; r <= 32; r++) {
                formatCell(ws, r, 0, { bold: true });
                
                for (let c = 1; c <= 4; c++) {
                    formatCell(ws, r, c, { 
                        numFmt: `_($* #,##0_);_($* (#,##0);_($* "-"_);_(@_)`,
                        alignment: 'right'
                    });
                }
            }
            
            // Format projection headers
            for (let i = 0; i < projectionHeaders.length; i++) {
                formatCell(ws, 34, i, { 
                    bold: true,
                    fill: 'F0F0F0',
                    alignment: i === 0 ? 'left' : 'right'
                });
            }
            
            // Format projection data
            for (let r = 35; r <= 45; r++) {
                formatCell(ws, r, 0, { bold: true });
                
                for (let c = 1; c <= projectionHeaders.length - 1; c++) {
                    // Apply percentage format to discount factor row
                    if (r === 43) {
                        formatCell(ws, r, c, { 
                            numFmt: '0.00%',
                            alignment: 'right'
                        });
                    } else {
                        formatCell(ws, r, c, { 
                            numFmt: `_($* #,##0_);_($* (#,##0);_($* "-"_);_(@_)`,
                            alignment: 'right'
                        });
                    }
                }
            }
            
            // Special formatting for terminal value and enterprise value section
            for (let r = 45; r <= 48; r++) {
                formatCell(ws, r, forecastPeriod + 2, { 
                    bold: true, 
                    fill: 'E0E0E0',
                    border: { top: 'thin', bottom: 'thin', left: 'thin', right: 'thin' },
                    alignment: 'right',
                    numFmt: `_($* #,##0_);_($* (#,##0);_($* "-"_);_(@_)`
                });
            }
            
            // Special formatting for share price
            formatCell(ws, 48, forecastPeriod + 2, {
                bold: true,
                fontSize: 12,
                numFmt: `_($* #,##0.00_);_($* (#,##0.00);_($* "-"??_);_(@_)`,
                fill: 'C0E0C0'
            });
            
            return ws;
        }
        
        // Helper function to format a cell
        function formatCell(ws, row, col, style) {
            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
            
            // Ensure the cell exists
            if (!ws[cellRef]) {
                ws[cellRef] = { v: '' };
            }
            
            // Initialize style object if not exists
            if (!ws[cellRef].s) ws[cellRef].s = {};
            
            // Apply styling
            if (style.bold) ws[cellRef].s.font = { ...(ws[cellRef].s.font || {}), bold: true };
            if (style.italic) ws[cellRef].s.font = { ...(ws[cellRef].s.font || {}), italic: true };
            if (style.fontSize) ws[cellRef].s.font = { ...(ws[cellRef].s.font || {}), sz: style.fontSize };
            
            if (style.fill) {
                ws[cellRef].s.fill = { fgColor: { rgb: style.fill } };
            }
            
            if (style.border) {
                ws[cellRef].s.border = {
                    top: { style: style.border.top || 'thin' },
                    bottom: { style: style.border.bottom || 'thin' },
                    left: { style: style.border.left || 'thin' },
                    right: { style: style.border.right || 'thin' }
                };
            }
            
            if (style.alignment) {
                ws[cellRef].s.alignment = { horizontal: style.alignment };
            }
            
            if (style.numFmt) {
                ws[cellRef].s.numFmt = style.numFmt;
            }
            
            // If there's a z property defining the format
            if (style.z) {
                ws[cellRef].z = style.z;
            }
        }

        // Tab switching functionality
        document.getElementById('incomeBtn').addEventListener('click', function() {
            switchTab('incomeStatement');
            setActiveButton(this);
        });
        
        document.getElementById('balanceBtn').addEventListener('click', function() {
            switchTab('balanceSheet');
            setActiveButton(this);
        });
        
        document.getElementById('cashFlowBtn').addEventListener('click', function() {
            switchTab('cashFlow');
            setActiveButton(this);
        });
        
        document.getElementById('valuationBtn').addEventListener('click', function() {
            switchTab('valuationModel');
            setActiveButton(this);
        });
        
        document.getElementById('consensusBtn').addEventListener('click', function() {
            switchTab('analystConsensusTab');
            setActiveButton(this);
        });
        
        function switchTab(tabId) {
            document.querySelectorAll('.statement').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
        }
        
        function setActiveButton(button) {
            // Remove active class from all buttons
            document.querySelectorAll('#incomeBtn, #balanceBtn, #cashFlowBtn, #valuationBtn, #consensusBtn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            });
            
            // Add active class to selected button
            button.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            button.classList.add('bg-primary', 'text-white');
        }
    </script>
</body>
</html>