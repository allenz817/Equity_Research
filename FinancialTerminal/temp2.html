<script>
    // ==============================================
    // GLOBAL CONFIGURATION AND DATA STRUCTURES
    // ==============================================
    // Global settings, data stores, and cache management

    // Global data storage
    let dataStore = {
        overview: null,
        financials: null,
        valuation: null,
        analyst: null,
        stock: null,
        industry: null,
        comparables: null,
        currentTicker: ''
    };

    // Cache management system
    const cacheManager = {
        CACHE_EXPIRATION: 30 * 60 * 1000,
        cache: {},
        
        set: function(key, data) {
            this.cache[key] = {
                timestamp: Date.now(),
                data: data
            };
        },
        
        get: function(key) {
            const cachedItem = this.cache[key];
            if (!cachedItem) return null;
            
            if (Date.now() - cachedItem.timestamp > this.CACHE_EXPIRATION) {
                delete this.cache[key];
                return null;
            }
            
            return cachedItem.data;
        },
        
        has: function(key) {
            return this.get(key) !== null;
        },
        
        clear: function() {
            this.cache = {};
        }
    };

    // Financial statement structures for consistent display order
    const incomeStatementStructure = [
        { label: 'Revenue', isSection: false, isTotal: false, cssClass: '' },
        { label: 'Cost of Revenue', isSection: false, isTotal: false, cssClass: '', isNegative: true },
        { label: 'Gross Profit', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
        { label: 'Sales, General and Administrative', isSection: false, isTotal: false, cssClass: '', isNegative: true },
        { label: 'Research and Development', isSection: false, isTotal: false, cssClass: '', isNegative: true },
        { label: 'Operating Expense, Total', isSection: false, isTotal: false, cssClass: '', isNegative: true },
        { label: 'Operating Income', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
        { label: 'Interest Expense', isSection: false, isTotal: false, cssClass: '', isNegative: true },
        { label: 'Other Income', isSection: false, isTotal: false, cssClass: '' },
        { label: 'Tax Expense', isSection: false, isTotal: false, cssClass: '', isNegative: true },
        { label: 'Net Income', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' }
    ];

    const balanceSheetStructure = [
        { label: 'Assets', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
        { label: 'Cash & Equivalents', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Accounts Receivable', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Inventory', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Total Current Assets', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
        { label: 'Property & Equipment', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Intangible Assets', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Total Assets', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' },
        { label: 'Liabilities & Equity', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
        { label: 'Accounts Payable', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Short-term Debt', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Total Current Liabilities', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
        { label: 'Long-term Debt', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Total Liabilities', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
        { label: 'Common Stock', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Retained Earnings', isSection: false, isTotal: false, cssClass: 'pl-6' },
        { label: 'Total Equity', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
        { label: 'Total Liabilities & Equity', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' }
    ];

    const cashFlowStructure = [
        { label: 'Net Income', isSection: false, isTotal: false, cssClass: '' },
        { label: 'Depreciation & Amortization', isSection: false, isTotal: false, cssClass: '' },
        { label: 'Changes in Working Capital', isSection: false, isTotal: false, cssClass: '' },
        { label: 'Cash Flow from Operating Activities', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
        { label: 'Capital Expenditures', isSection: false, isTotal: false, cssClass: '', isNegative: true },
        { label: 'Cash Flow from Investing Activities', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750', isNegative: true },
        { label: 'Debt Issuance (Repayment)', isSection: false, isTotal: false, cssClass: '' },
        { label: 'Dividends Paid', isSection: false, isTotal: false, cssClass: '', isNegative: true },
        { label: 'Cash Flow from Financing Activities', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
        { label: 'Net Change in Cash', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' }
    ];

    // Sample data definitions would go here (sampleData, sampleAnalystConsensus, sampleStockData)

    // ==============================================
    // UTILITY FUNCTIONS
    // ==============================================
    // General-purpose utilities used throughout the app

    // Function to display messages in the UI
    function displayMessage(message, type = 'info') {
        const messagesContainer = document.getElementById('messagesContainer');
        
        const messageElement = document.createElement('div');
        messageElement.className = `mb-2 p-2 rounded ${type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' : 
            type === 'success' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 
            'bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200'}`;
        
        if (typeof marked !== 'undefined') {
            messageElement.innerHTML = marked.parse(message);
        } else {
            messageElement.textContent = message;
        }
        
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Utility function to parse financial numbers
    function parseFinancialNumber(valueStr) {
        if (!valueStr || valueStr === '-') return 0;
        
        const isNegative = valueStr.includes('(');
        let numStr = valueStr.replace(/[^0-9.-]/g, '');
        
        let value = parseFloat(numStr);
        if (isNegative) value = -value;
        
        return value;
    }

    // Utility function to format financial numbers
    function formatFinancialNumber(value, isNegative = false, currencySymbol = '$') {
        if (value === undefined || value === null) return '-';
        
        const numValue = typeof value === 'string' ? parseFloat(value) : value;
        const effectiveIsNegative = numValue < 0 || isNegative;
        const absValue = Math.abs(numValue);
        
        const formattedNumber = absValue.toLocaleString(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
        
        return effectiveIsNegative ? 
            `(${currencySymbol}${formattedNumber})` : 
            `${currencySymbol}${formattedNumber}`;
    }

    // Extract URLs from text
    function extractUrls(text) {
        const urlRegex = /https?:\/\/[^\s)]+/g;
        const matches = text.match(urlRegex);
        return matches ? [...new Set(matches)] : [];
    }

    // Update source URLs section
    function updateSourceUrls(urls) {
        if (!urls || urls.length === 0) return;
        
        const sourceUrlsList = document.getElementById('sourceUrlsList');
        if (!sourceUrlsList) return;
        
        if (sourceUrlsList.innerHTML.includes('No source URLs available yet')) {
            sourceUrlsList.innerHTML = '';
        }
        
        urls.forEach(url => {
            if (!sourceUrlsList.innerHTML.includes(url)) {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.className = 'text-primary hover:underline break-all';
                link.textContent = url;
                li.appendChild(link);
                sourceUrlsList.appendChild(li);
            }
        });
    }

    // Function to get the selected AI model for each section
    function getSelectedModel(section) {
        const selector = document.getElementById(`${section}ModelSelect`);
        return selector ? selector.value : 'pro';
    }

    // Function to update all ticker inputs across pages
    function updateAllTickerInputs(ticker) {
        if (!ticker) return;
        
        dataStore.currentTicker = ticker;
        
        document.getElementById('overviewTickerInput').value = ticker;
        document.getElementById('stockTickerInput').value = ticker;
        document.getElementById('financialsTickerInput').value = ticker;
        document.getElementById('valuationTickerInput').value = ticker;
        document.getElementById('analystTickerInput').value = ticker;
        document.getElementById('industryTickerInput').value = ticker;
        document.getElementById('comparablesTickerInput').value = ticker;
    }

    // Add a visual cache indicator
    function addCacheIndicator(section, ticker) {
        const indicator = document.createElement('div');
        indicator.className = 'text-xs py-1 px-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-300 rounded-md inline-flex items-center';
        indicator.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span>Cached data</span>
        `;
        
        // Find the appropriate container based on section
        let container;
        switch(section) {
            case 'overview': container = document.getElementById('comparablesDate'); break;
            case 'financials': container = document.getElementById('dataSourcesNote'); break;
            case 'valuation': container = document.getElementById('valuationCurrencyUnit'); break;
            case 'analyst': container = document.getElementById('consensusDate'); break;
            case 'stock': container = document.getElementById('stockDataTimestamp'); break;
            case 'industry': container = document.getElementById('industryDataDate'); break;
            case 'comparables': container = document.getElementById('comparablesDate'); break;
            default: return;
        }
        
        if (container) {
            const existingIndicator = container.querySelector('.cache-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            indicator.classList.add('cache-indicator', 'ml-2');
            container.appendChild(indicator);
        }
    }

    // ==============================================
    // NAVIGATION & UI CONTROLS
    // ==============================================
    // Functions related to showing/hiding pages and UI behavior

    // Function to show a specific page and hide others
    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(page => {
            page.classList.add('hidden');
        });
        
        document.getElementById(pageId).classList.remove('hidden');
        
        document.querySelectorAll('nav button').forEach(button => {
            if (button.id === `nav-${pageId.split('-')[1]}`) {
                button.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                button.classList.add('bg-primary', 'text-white');
            } else {
                button.classList.remove('bg-primary', 'text-white');
                button.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            }
        });
    }

    // Function to toggle between table and chart views
    function toggleView(statementType, view = 'table') {
        const tableViewId = `${statementType}TableView`;
        const tableBtn = document.getElementById(`${statementType}TableBtn`);
        
        const chartViewId = `${statementType}ChartView`;
        const chartBtn = document.getElementById(`${statementType}ChartBtn`);
        
        if (view === 'table') {
            document.getElementById(tableViewId).classList.remove('hidden');
            document.getElementById(tableViewId).classList.add('block');
            document.getElementById(chartViewId).classList.add('hidden');
            
            tableBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            tableBtn.classList.add('bg-primary', 'text-white');
            
            chartBtn.classList.remove('bg-primary', 'text-white');
            chartBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
        } else {
            document.getElementById(chartViewId).classList.remove('hidden');
            document.getElementById(tableViewId).classList.remove('block');
            document.getElementById(tableViewId).classList.add('hidden');
            
            chartBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            chartBtn.classList.add('bg-primary', 'text-white');
            
            tableBtn.classList.remove('bg-primary', 'text-white');
            tableBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            
            if (window.updateChart) {
                window.updateChart(statementType);
            }
        }
    }

    // Function to switch between statement tabs (income, balance, cash flow)
    function switchTab(tabId) {
        document.querySelectorAll('.statement').forEach(tab => {
            tab.classList.add('hidden');
        });
        document.getElementById(tabId).classList.remove('hidden');
    }

    // Function to set active button styles
    function setActiveButton(button) {
        const allButtons = button.parentNode.querySelectorAll('button');
        allButtons.forEach(btn => {
            btn.classList.remove('bg-primary', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
        });
        
        button.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
        button.classList.add('bg-primary', 'text-white');
    }

    // ==============================================
    // FINANCIAL STATEMENTS PAGE
    // ==============================================
    // Functions for financial statements data retrieval and display

    // Function to fetch financial statements data
    async function fetchFinancialData(ticker) {
        // Check cache first
        const cacheKey = `financials_${ticker.toUpperCase()}`;
        const cachedData = cacheManager.get(cacheKey);
        
        if (cachedData) {
            console.log(`Loading financial data for ${ticker} from cache`);
            displayMessage(`Loading cached financial data for ${ticker}`, "info");

            dataStore.financials = cachedData;
            updateTableHeaders(cachedData);
            populateFinancialTables(cachedData);
            document.getElementById('financialContent').classList.remove('hidden');
            displayMessage("Successfully loaded financial data from cache", "success");
            addCacheIndicator('financials', ticker);
            return cachedData;
        }
        
        // If not in cache, proceed with data fetching
        document.getElementById('financialsLoadingIndicator').classList.remove('hidden');
        document.getElementById('financialContent').classList.add('hidden');
        
        // For AAPL, use demo data
        if (ticker.toUpperCase() === 'AAPL') {
            displayMessage("Using pre-loaded sample data for Apple Inc.", "info");
            
            dataStore.financials = sampleData;
            updateTableHeaders(sampleData);
            populateFinancialTables(sampleData);
            document.getElementById('financialsLoadingIndicator').classList.add('hidden');
            document.getElementById('financialContent').classList.remove('hidden');
            displayMessage("Successfully loaded financial data for Apple Inc.", "success");
            cacheManager.set(cacheKey, sampleData);
            return sampleData;
        }
        
        // For other tickers, get real data from AI model
        try {
            const modelType = getSelectedModel('financials');
            const modelName = modelType === 'pro' ? 'Gemini-2.5-Pro-Exp' : 'GPT-4o-Search';

            displayMessage(`Fetching financial data for ${ticker}... This may take up to one minute.`, "info");
            
            // Register handler for financial data
            const handlerId = `financials-${Date.now()}`;
            
            // Create a Promise for handling the response
            const responsePromise = new Promise((resolve, reject) => {
                window.Poe.registerHandler(handlerId, (result, context) => {
                    if (result.status === "error") {
                        reject(new Error(result.responses[0]?.statusText || "Error fetching financial statements"));
                        return;
                    }
                    
                    if (result.status === "complete") {
                        const response = result.responses[0];
                        try {
                            // Parse the JSON data from the model's response
                            const responseText = response.content;
                            let financialData;
                            
                            // Extract JSON data from the response
                            const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                              responseText.match(/```([\s\S]*?)```/);
                                              
                            if (jsonMatch && jsonMatch[1]) {
                                financialData = JSON.parse(jsonMatch[1]);
                            } else {
                                // Try to extract a JSON object without code blocks
                                const jsonPattern = /\{[\s\S]*\}/;
                                const match = responseText.match(jsonPattern);
                                if (match) {
                                    financialData = JSON.parse(match[0]);
                                } else {
                                    throw new Error("Unable to parse JSON data from response");
                                }
                            }
                            
                            // Parse any source URLs mentioned in the response
                            const sourceUrls = extractUrls(responseText);
                            if (sourceUrls.length > 0) {
                                financialData.sourceUrls = sourceUrls;
                                updateSourceUrls(sourceUrls);
                            }
                            
                            resolve(financialData);
                        } catch (error) {
                            console.error("Error parsing financial data:", error);
                            reject(new Error("Failed to parse financial data: " + error.message));
                        }
                    }
                });
            });
            
            // Construct prompt for AI to get financial statements
            const botName = modelType === 'pro' ? '@Gemini-2.5-Pro-Exp' : '@GPT-4o-Search';
            const prompt = `${botName} 
I need EXACT financial data for the company with the stock ticker ${ticker} in a specific JSON format. Please provide ONLY the JSON object with no additional text:

\`\`\`json
{
  "name": "Company name",
  "fiscalYearEnd": "Month Day",
  "currencyUnit": "Millions",
  "currencySymbol": "$",
  "years": [2024, 2023, 2022, 2021],
  "incomeStatement": {
    "Revenue": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Cost of Revenue": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Gross Profit": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Sales, General and Administrative": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Research and Development": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Operating Expense, Total": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Operating Income": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Interest Expense": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Other Income": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Tax Expense": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Net Income": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"]
  },
  "balanceSheet": {
    "Cash & Equivalents": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Accounts Receivable": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Inventory": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Current Assets": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Property & Equipment": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Intangible Assets": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Assets": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Accounts Payable": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Short-term Debt": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Current Liabilities": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Long-term Debt": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Liabilities": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Common Stock": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Retained Earnings": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Equity": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Liabilities & Equity": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"]
  },
  "cashFlow": {
    "Net Income": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Depreciation & Amortization": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Changes in Working Capital": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Cash Flow from Operating Activities": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Capital Expenditures": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Cash Flow from Investing Activities": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Debt Issuance (Repayment)": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Dividends Paid": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Cash Flow from Financing Activities": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Net Change in Cash": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"]
  },
  "sharesOutstanding": X.XX
}
\`\`\`

Please ensure all financial figures are formatted with $ and commas, with negative numbers in parentheses. The sharesOutstanding should be in millions (e.g., 15.5 means 15.5 million shares). Cite your sources if possible.`;
            
            // Send prompt to fetch financial statements
            await window.Poe.sendUserMessage(prompt, {
                handler: handlerId,
                openChat: false
            });
            
            // Wait for the response
            const financialData = await responsePromise;
            
            // Store in the data store
            dataStore.financials = financialData;
            
            // Update UI
            updateTableHeaders(financialData);
            populateFinancialTables(financialData);
            
            // Hide loading indicator
            document.getElementById('financialsLoadingIndicator').classList.add('hidden');
            
            // Show financial content
            document.getElementById('financialContent').classList.remove('hidden');
            
            // Show success message
            displayMessage(`Successfully loaded financial data for ${ticker}.`, "success");
            
            // Store in cache when data is received successfully
            cacheManager.set(cacheKey, financialData);

            return financialData;
        } catch (error) {
            // Hide loading indicator
            document.getElementById('financialsLoadingIndicator').classList.add('hidden');
            
            // Show error message
            displayMessage(`Error: Failed to load financial data. ${error.message}`, "error");
            
            throw error;
        }
    }

    // Function to update table headers with years and fiscal year end
    function updateTableHeaders(data) {
        const yearEnd = data.fiscalYearEnd;
        const years = data.years;
        
        // Update header cells for each financial statement
        for (let i = 0; i < Math.min(years.length, 4); i++) {
            ['income', 'balance', 'cashflow'].forEach(type => {
                const element = document.getElementById(`${type}-year-${i+1}`);
                if (element) {
                    element.textContent = `${yearEnd}, ${years[i]}`;
                }
            });
        }
        
        // Update year range in headers
        if (years.length > 0) {
            const lastIndex = Math.min(years.length - 1, 3);
            document.getElementById('incomeYearRange').textContent = `(${years[lastIndex]}-${years[0]})`;
            document.getElementById('balanceYearRange').textContent = `(${years[lastIndex]}-${years[0]})`;
            document.getElementById('cashflowYearRange').textContent = `(${years[lastIndex]}-${years[0]})`;
            
            if (document.getElementById('valuationYearRange')) {
                document.getElementById('valuationYearRange').textContent = `(${years[lastIndex]}-${years[0]})`;
            }
        }
        
        // Format unit display correctly based on currencyUnit
        let unitDisplay = '';
        if (data.currencyUnit.toLowerCase() === 'millions') {
            unitDisplay = '(000,000s)';
        } else if (data.currencyUnit.toLowerCase() === 'billions') {
            unitDisplay = '(000,000,000s)';
        } else if (data.currencyUnit.toLowerCase() === 'thousands') {
            unitDisplay = '(000s)';
        } else {
            unitDisplay = `(${data.currencyUnit})`;
        }

        // Update all currency unit elements
        const currencyUnitElements = [
            document.getElementById('incomeCurrencyUnit'),
            document.getElementById('balanceCurrencyUnit'),
            document.getElementById('cashflowCurrencyUnit')
        ];
        
        if (document.getElementById('valuationCurrencyUnit')) {
            currencyUnitElements.push(document.getElementById('valuationCurrencyUnit'));
        }
        
        currencyUnitElements.forEach(element => {
            if (element) {
                element.textContent = `All figures in ${data.currencyUnit} ${data.currencySymbol}${unitDisplay}`;
            }
        });
        
        // Set projection years based on the most recent year
        if (years.length > 0 && document.getElementById('proj-year-0')) {
            const baseYear = years[0];
            const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 5;
            
            // Update historical year
            document.getElementById('proj-year-0').textContent = `${yearEnd}, ${baseYear}`;
            
            // Update projection years
            for (let i = 1; i <= forecastPeriod; i++) {
                const projYear = document.getElementById(`proj-year-${i}`);
                if (projYear) {
                    projYear.textContent = `${yearEnd}, ${baseYear + i}`;
                }
            }
        }
    }

    // Function to populate tables with financial data
    function populateFinancialTables(data) {
        // Populate income statement
        const incomeBody = document.getElementById('incomeStatementBody');
        incomeBody.innerHTML = '';
        
        incomeStatementStructure.forEach(item => {
            const row = document.createElement('tr');
            row.className = `border-t border-gray-300 dark:border-gray-700 ${item.cssClass}`;
            
            if (item.isSection && item.colspan) {
                // Section header row with colspan
                const cell = document.createElement('td');
                cell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200 font-medium';
                cell.colSpan = 5; // Updated to accommodate 4 years
                cell.textContent = item.label;
                row.appendChild(cell);
            } else {
                // Regular row
                const labelCell = document.createElement('td');
                labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 font-medium ${item.isTotal ? 'py-3' : ''}`;
                labelCell.textContent = item.label;
                row.appendChild(labelCell);
                
                // Add up to 4 years of data
                for (let i = 0; i < Math.min(data.years.length, 4); i++) {
                    const valueCell = document.createElement('td');
                    valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                    
                    const values = data.incomeStatement[item.label];
                    valueCell.textContent = values && values[i] ? values[i] : '-';
                    
                    row.appendChild(valueCell);
                }
            }
            
            incomeBody.appendChild(row);
        });
        
        // Populate balance sheet
        const balanceBody = document.getElementById('balanceSheetBody');
        balanceBody.innerHTML = '';
        
        balanceSheetStructure.forEach(item => {
            const row = document.createElement('tr');
            row.className = `border-t border-gray-300 dark:border-gray-700 ${item.cssClass}`;
            
            if (item.isSection && item.colspan) {
                // Section header row with colspan
                const cell = document.createElement('td');
                cell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200 font-medium';
                cell.colSpan = 5; // Updated to accommodate 4 years
                cell.textContent = item.label;
                row.appendChild(cell);
            } else {
                // Regular row
                const labelCell = document.createElement('td');
                labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                labelCell.textContent = item.label;
                row.appendChild(labelCell);
                
                // Add up to 4 years of data
                for (let i = 0; i < Math.min(data.years.length, 4); i++) {
                    const valueCell = document.createElement('td');
                    valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                    
                    const values = data.balanceSheet[item.label];
                    valueCell.textContent = values && values[i] ? values[i] : '-';
                    
                    row.appendChild(valueCell);
                }
            }
            
            balanceBody.appendChild(row);
        });
        
        // Populate cash flow
        const cashFlowBody = document.getElementById('cashFlowBody');
        cashFlowBody.innerHTML = '';
        
        cashFlowStructure.forEach(item => {
            const row = document.createElement('tr');
            row.className = `border-t border-gray-300 dark:border-gray-700 ${item.cssClass}`;
            
            if (item.isSection && item.colspan) {
                // Section header row with colspan
                const cell = document.createElement('td');
                cell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200 font-medium';
                cell.colSpan = 5; // Updated to accommodate 4 years
                cell.textContent = item.label;
                row.appendChild(cell);
            } else {
                // Regular row
                const labelCell = document.createElement('td');
                labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                labelCell.textContent = item.label;
                row.appendChild(labelCell);
                
                // Add up to 4 years of data
                for (let i = 0; i < Math.min(data.years.length, 4); i++) {
                    const valueCell = document.createElement('td');
                    valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                    
                    const values = data.cashFlow[item.label];
                    valueCell.textContent = values && values[i] ? values[i] : '-';
                    
                    row.appendChild(valueCell);
                }
            }
            
            cashFlowBody.appendChild(row);
        });
        
        // Show data sources note
        const sourceNotes = document.querySelectorAll('#incomeDataSource, #balanceDataSource, #cashFlowDataSource');
        sourceNotes.forEach(note => note.classList.remove('hidden'));
    }

    // Rest of your code sections would continue here...
    // ==============================================
    // CHARTS AND VISUALIZATION
    // ==============================================

    // ==============================================
    // DATA FETCHING FUNCTIONS
    // ==============================================

    // ==============================================
    // ANALYSIS AND CALCULATIONS
    // ==============================================

    // ==============================================
    // EXPORT FUNCTIONS
    // ==============================================

    // ==============================================
    // EVENT LISTENERS AND INITIALIZATION
    // ==============================================
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize charts
        initializeCharts();
 
        // Add cache controls
        addCacheControls();
        
        // Add event listeners for navigation
        setupNavigationListeners();
        
        // Add event listeners for data fetching
        setupDataFetchingListeners();
        
        // Display welcome message
        displayWelcomeMessage();
    });

    // Function to initialize all the chart functionality
    function initializeCharts() {
        // Create chart instances and store them
        window.charts = {
            income: null,
            balance: null,
            cashFlow: null,
            segmentChart: null,
            regionChart: null
        };
        
        // Set up chart update function
        window.updateChart = function(chartType) {
            // Implementation details...
        };
        
        // Add event listeners for chart options
        setupChartOptionListeners();
    }

    // Function to display the welcome message
    function displayWelcomeMessage() {
        displayMessage("**Welcome to the Financial Analysis Suite**\n\nThis multi-page application allows you to analyze different aspects of a company:\n\n• **Company Overview** - Basic company information and revenue breakdown\n• **Financial Statements** - Income statement, balance sheet, and cash flow\n• **Valuation Model** - DCF valuation with adjustable parameters\n• **Analyst Consensus** - Ratings, price targets, and recommendations\n• **Stock Information** - Current price and performance metrics\n\nChoose a page from the navigation bar above and enter a stock ticker to begin, or use the 'AAPL Demo Mode' button on any page for a quick demonstration.", "info");
    }

    // Add cache controls to the UI
    function addCacheControls() {
        // Create a "Clear Cache" button in the header
        const header = document.querySelector('header');
        
        const cacheControlDiv = document.createElement('div');
        cacheControlDiv.className = 'flex justify-end items-center mb-2';
        
        const cacheClearBtn = document.createElement('button');
        cacheClearBtn.className = 'text-xs bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300';
        cacheClearBtn.textContent = 'Clear Data Cache';
        cacheClearBtn.title = 'Clear all cached financial data';
        cacheClearBtn.onclick = function() {
            cacheManager.clear();
            displayMessage("Data cache cleared. New data will be fetched on next request.", "info");
        };
        
        cacheControlDiv.appendChild(cacheClearBtn);
        header.appendChild(cacheControlDiv);
    }

    // Setup listeners for navigation buttons
    function setupNavigationListeners() {
        document.getElementById('nav-overview').addEventListener('click', () => showPage('page-overview'));
        document.getElementById('nav-financials').addEventListener('click', () => showPage('page-financials'));
        document.getElementById('nav-valuation').addEventListener('click', () => showPage('page-valuation'));
        document.getElementById('nav-analyst').addEventListener('click', () => showPage('page-analyst'));
        document.getElementById('nav-stock').addEventListener('click', () => showPage('page-stock'));
        document.getElementById('nav-industry').addEventListener('click', () => showPage('page-industry'));
        document.getElementById('nav-comparables').addEventListener('click', () => showPage('page-comparables'));
        
        // Clear messages button
        document.getElementById('clearMessages').addEventListener('click', function() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
        });
    }

    // Add all the event listeners for data fetching buttons
    function setupDataFetchingListeners() {
        // Company Overview page listeners
        document.getElementById('fetchOverviewBtn').addEventListener('click', function() {
            const ticker = document.getElementById('overviewTickerInput').value.trim();
            if (!ticker) {
                displayMessage("Please enter a stock ticker.", "error");
                return;
            }
            fetchCompanyOverview(ticker);
        });
        
        document.getElementById('overviewTickerInput').addEventListener('input', function() {
            updateAllTickerInputs(this.value.trim());
        });
        
        document.querySelector('.overview-quick-btn').addEventListener('click', function() {
            document.getElementById('overviewTickerInput').value = "AAPL";
            fetchCompanyOverview("AAPL");
        });
        
        // Financial Statements page listeners
        document.getElementById('fetchFinancialsBtn').addEventListener('click', function() {
            const ticker = document.getElementById('financialsTickerInput').value.trim();
            if (!ticker) {
                displayMessage("Please enter a stock ticker.", "error");
                return;
            }
            fetchFinancialData(ticker);
        });
        
        document.getElementById('financialsTickerInput').addEventListener('input', function() {
            updateAllTickerInputs(this.value.trim());
        });
        
        document.querySelector('.financials-quick-btn').addEventListener('click', function() {
            document.getElementById('financialsTickerInput').value = "AAPL";
            fetchFinancialData("AAPL");
        });
        
        // Similar event listeners for other pages...
    }

    // Add listeners for chart options
    function setupChartOptionListeners() {
        // Chart type toggle buttons
        document.getElementById('incomeTableBtn').addEventListener('click', () => toggleView('income', 'table'));
        document.getElementById('incomeChartBtn').addEventListener('click', () => toggleView('income', 'chart'));
        document.getElementById('balanceTableBtn').addEventListener('click', () => toggleView('balance', 'table'));
        document.getElementById('balanceChartBtn').addEventListener('click', () => toggleView('balance', 'chart'));
        document.getElementById('cashFlowTableBtn').addEventListener('click', () => toggleView('cashFlow', 'table'));
        document.getElementById('cashFlowChartBtn').addEventListener('click', () => toggleView('cashFlow', 'chart'));
        
        // Financial statement type tabs
        document.getElementById('incomeBtn').addEventListener('click', function() {
            switchTab('incomeStatement');
            setActiveButton(this);
        });
        
        document.getElementById('balanceBtn').addEventListener('click', function() {
            switchTab('balanceSheet');
            setActiveButton(this);
        });
        
        document.getElementById('cashFlowBtn').addEventListener('click', function() {
            switchTab('cashFlow');
            setActiveButton(this);
        });
        
        // Chart metric checkboxes
        document.querySelectorAll('.income-chart-primary, .income-chart-secondary').forEach(checkbox => {
            checkbox.addEventListener('change', () => window.updateChart('income'));
        });
        
        document.querySelectorAll('.balance-chart-metric').forEach(checkbox => {
            checkbox.addEventListener('change', () => window.updateChart('balance'));
        });
        
        document.querySelectorAll('.cashflow-chart-metric').forEach(checkbox => {
            checkbox.addEventListener('change', () => window.updateChart('cashFlow'));
        });
    }
</script>