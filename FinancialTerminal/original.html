<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Terminal Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
        
        // Set up dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</head>
<body class="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-200">
    <div class="container mx-auto px-4 py-6">
        <!-- App Header -->
        <header class="mb-4">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Financial Terminal Pro</h1>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Enhanced multi-page application with real-time data capabilities</p>
        </header>

        <!-- Messages Section (shared across pages) -->
        <div id="chatMessages" class="mb-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Messages</h3>
                <button id="clearMessages" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    Clear all
                </button>
            </div>
            <div id="messagesContainer" class="max-h-40 overflow-y-auto space-y-2"></div>
        </div>
        
        <!-- Navigation -->
        <nav class="flex flex-wrap gap-2 mb-6">
            <button id="nav-overview" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-colors">
                Company Overview
            </button>
            <button id="nav-industry" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 transition-colors">
                Industry Analysis
            </button>
                <button id="nav-comparables" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 transition-colors">
                Comparable Companies
            </button>
            <button id="nav-financials" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 transition-colors">
                Financial Statements
            </button>
            <button id="nav-valuation" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 transition-colors">
                Valuation Model
            </button>
            <button id="nav-stock" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 transition-colors">
                Stock Information
            </button>
            <button id="nav-analyst" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 transition-colors">
                Analyst Consensus
            </button>
        </nav>

        <!-- Page 1: Company Overview -->
        <div id="page-overview" class="page-content">
            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Company Overview</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Enter a company ticker to retrieve profile information, sector data, revenue breakdown, and comparable companies.</p>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2 items-center">
                        <div class="flex-grow">
                            <div class="relative">
                                <input type="text" id="overviewTickerInput" placeholder="Enter stock ticker (e.g., AAPL, MSFT, GOOGL)" 
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                    <div id="overviewDemoLabel" class="text-xs text-gray-500 dark:text-gray-400">(Enter a ticker)</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <select id="aiModelSelect" class="px-3 py-2 mr-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                <option value="flash">Gemini-2.5-Flash-Preview</option>
                                <option value="pro">Gemini-2.5-Pro-Exp</option>
                            </select>
                        </div>
                        <button id="fetchOverviewBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            <span>Fetch Company Overview</span>
                        </button>
                    </div>
                    
                    <div id="overviewList" class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
                        <div class="mt-1 flex flex-wrap gap-1">
                            <button class="overview-quick-btn px-3 py-1.5 text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 border border-blue-200 dark:border-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                AAPL Demo Mode
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="overviewLoadingIndicator" class="hidden py-20">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400 text-lg">Loading company data...</span>
                    </div>
                </div>

                <!-- Company Description Section -->
                <div id="companyDescription" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">Company Profile</h3>
                    <p id="descriptionText" class="text-gray-600 dark:text-gray-400 text-sm md:text-base mb-4"></p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
                        <div>
                            <span class="text-gray-500 dark:text-gray-400 text-sm">Sector:</span>
                            <span id="companySector" class="ml-2 text-gray-700 dark:text-gray-300"></span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400 text-sm">Industry:</span>
                            <span id="companyIndustry" class="ml-2 text-gray-700 dark:text-gray-300"></span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400 text-sm">Founded:</span>
                            <span id="companyFounded" class="ml-2 text-gray-700 dark:text-gray-300"></span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400 text-sm">Headquarters:</span>
                            <span id="companyHQ" class="ml-2 text-gray-700 dark:text-gray-300"></span>
                        </div>
                    </div>
                    
                    <!-- Revenue Breakdown Section -->
                    <div id="revenueBreakdown" class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Revenue Breakdown</h4>
                            <div class="flex space-x-2">
                                <button id="segmentViewBtn" class="px-2 py-1 bg-primary text-white text-xs rounded-md font-medium hover:bg-opacity-90 focus:outline-none">By Segment</button>
                                <button id="regionViewBtn" class="px-2 py-1 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 text-xs rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none">By Region</button>
                            </div>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">Distribution of revenue across different business segments and geographic regions:</p>
                        
                        <div id="segmentView" class="block">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Pie Chart and Table view side by side for larger screens -->
                                <div class="h-72 bg-white dark:bg-gray-800">
                                    <canvas id="segmentChart"></canvas>
                                </div>
                                <div class="overflow-auto">
                                    <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                                        <thead>
                                            <tr class="bg-gray-100 dark:bg-gray-700">
                                                <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Business Segment</th>
                                                <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Revenue ($M)</th>
                                                <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">% of Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="segmentTableBody">
                                            <!-- Will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div id="regionView" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Pie Chart and Table view side by side for larger screens -->
                                <div class="h-72 bg-white dark:bg-gray-800">
                                    <canvas id="regionChart"></canvas>
                                </div>
                                <div class="overflow-auto">
                                    <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                                        <thead>
                                            <tr class="bg-gray-100 dark:bg-gray-700">
                                                <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Geographic Region</th>
                                                <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Revenue ($M)</th>
                                                <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">% of Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="regionTableBody">
                                            <!-- Will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div id="revenueBreakdownLoading" class="hidden mt-2">
                            <div class="flex items-center justify-center py-6">
                                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary"></div>
                                <span class="ml-3 text-gray-600 dark:text-gray-400">Loading revenue breakdown...</span>
                            </div>
                        </div>
                        
                        <div id="revenueBreakdownNoData" class="hidden mt-2 p-3 bg-gray-50 dark:bg-gray-750 rounded-md">
                            <p class="text-center text-gray-600 dark:text-gray-400">No detailed revenue breakdown data available.</p>
                        </div>
                    </div>
                    
                    <!-- Comparable Companies Section -->
                    <div id="comparableCompanies" class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Comparable Companies</h4>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">Companies in the same industry that are commonly compared:</p>
                        <div id="comparablesList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                            <!-- Comparable companies will be added dynamically -->
                        </div>
                        <div id="comparablesLoading" class="hidden mt-2">
                            <div class="flex items-center text-gray-500 dark:text-gray-400 text-sm">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"></div>
                                <span>Loading comparable companies...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Stock Information -->
        <div id="page-stock" class="page-content hidden">
            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Real-Time Stock Information</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Get current stock price, performance metrics, and trading data for any ticker.</p>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2 items-center">
                        <div class="flex-grow">
                            <div class="relative">
                                <input type="text" id="stockTickerInput" placeholder="Enter stock ticker (e.g., AAPL, MSFT, GOOGL)" 
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                    <div id="stockDemoLabel" class="text-xs text-gray-500 dark:text-gray-400">(Enter a ticker)</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <select id="stockModelSelect" class="px-3 py-2 mr-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                <option value="flash">Gemini-2.5-Flash-Preview</option>
                                <option value="pro">Gemini-2.5-Pro-Exp</option>
                            </select>
                        </div>
                        <button id="fetchStockDataBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            <span>Fetch Stock Data</span>
                        </button>
                    </div>
                    
                    <div id="stockList" class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
                        <div class="mt-1 flex flex-wrap gap-1">
                            <button class="stock-quick-btn px-3 py-1.5 text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 border border-blue-200 dark:border-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                AAPL Demo Mode
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Loading indicator -->
                <div id="stockLoadingIndicator" class="hidden py-20">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400 text-lg">Loading stock data...</span>
                    </div>
                </div>

                <!-- Stock Information Content -->
                <div id="stockContent" class="hidden">
                    <div class="mb-4">
                        <h3 id="stockCompanyName" class="text-xl font-semibold text-gray-800 dark:text-white"></h3>
                        <div id="stockTicker" class="text-sm text-gray-600 dark:text-gray-400"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Share Price Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <div class="flex justify-between">
                                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Share Price</h4>
                                <span id="priceChange" class="text-sm font-semibold"></span>
                            </div>
                            <div class="mt-1 flex items-baseline">
                                <span id="currentPrice" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                                <span id="priceCurrency" class="ml-1 text-sm text-gray-500 dark:text-gray-400"></span>
                            </div>
                        </div>
                        
                        <!-- Market Cap Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Market Cap</h4>
                            <div class="mt-1">
                                <span id="marketCap" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                        
                        <!-- P/E Ratio Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">P/E Ratio</h4>
                            <div class="mt-1">
                                <span id="peRatio" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                        
                        <!-- Revenue (TTM) Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Revenue (TTM)</h4>
                            <div class="mt-1">
                                <span id="revenueTTM" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                        
                        <!-- Net Profit (TTM) Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Net Profit (TTM)</h4>
                            <div class="mt-1">
                                <span id="netProfitTTM" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                        
                        <!-- Trading Volume Card -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Trading Volume</h4>
                            <div class="mt-1">
                                <span id="tradingVolume" class="text-2xl font-bold text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <!-- Additional Metrics Table -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Key Metrics</h4>
                            <table class="w-full text-sm">
                                <tbody>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">52-Week Range</td>
                                        <td id="fiftyTwoWeekRange" class="py-2 text-right font-medium text-gray-900 dark:text-white"></td>
                                    </tr>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">Dividend Yield</td>
                                        <td id="dividendYield" class="py-2 text-right font-medium text-gray-900 dark:text-white"></td>
                                    </tr>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">EPS (TTM)</td>
                                        <td id="epsTTM" class="py-2 text-right font-medium text-gray-900 dark:text-white"></td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 text-gray-600 dark:text-gray-400">Beta</td>
                                        <td id="beta" class="py-2 text-right font-medium text-gray-900 dark:text-white"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Recent Performance Table -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-md">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Performance</h4>
                            <table class="w-full text-sm">
                                <tbody>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">1 Month Return</td>
                                        <td id="oneMonthReturn" class="py-2 text-right font-medium"></td>
                                    </tr>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">3 Month Return</td>
                                        <td id="threeMonthReturn" class="py-2 text-right font-medium"></td>
                                    </tr>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <td class="py-2 text-gray-600 dark:text-gray-400">YTD Return</td>
                                        <td id="ytdReturn" class="py-2 text-right font-medium"></td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 text-gray-600 dark:text-gray-400">1 Year Return</td>
                                        <td id="oneYearReturn" class="py-2 text-right font-medium"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                        <p id="stockDataTimestamp" class="italic"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Industry Analysis -->
        <div id="page-industry" class="page-content hidden">
            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Industry Analysis</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Analyze industry trends, market share, competitive positioning, and growth outlook.</p>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2 items-center">
                        <div class="flex-grow">
                            <div class="relative">
                                <input type="text" id="industryTickerInput" placeholder="Enter stock ticker (e.g., AAPL, MSFT, GOOGL)" 
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                    <div id="industryDemoLabel" class="text-xs text-gray-500 dark:text-gray-400">(Enter a ticker)</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <select id="industryModelSelect" class="px-3 py-2 mr-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                <option value="flash">Gemini-2.5-Flash-Preview</option>
                                <option value="pro">Gemini-2.5-Pro-Exp</option>
                            </select>
                        </div>
                        <button id="fetchIndustryBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            <span>Fetch Industry Data</span>
                        </button>
                    </div>
                    
                    <div id="industryList" class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
                        <div class="mt-1 flex flex-wrap gap-1">
                            <button class="industry-quick-btn px-3 py-1.5 text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 border border-blue-200 dark:border-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                AAPL Demo Mode
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="industryLoadingIndicator" class="hidden py-20">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400 text-lg">Loading industry data...</span>
                    </div>
                </div>

                <!-- Industry Analysis Content -->
                <div id="industryContent" class="hidden">
                    <div class="flex flex-wrap justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-white"><span id="industryCompanyName">Company</span></h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Industry: <span id="industryName" class="font-medium">Technology</span></p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Sector: <span id="sectorName" class="font-medium">Technology</span></p>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 text-right">
                            <p id="industryDataDate">Data as of: June 2024</p>
                        </div>
                    </div>

                    <!-- Industry Overview -->
                    <div class="bg-gray-50 dark:bg-gray-750 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Industry Overview</h4>
                        <div id="industryOverview" class="text-gray-700 dark:text-gray-300">
                            <!-- Industry overview will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Industry Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Market Share -->
                        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Market Share</h4>
                            <div class="h-72">
                                <canvas id="marketShareChart"></canvas>
                            </div>
                            <div class="mt-3 text-sm text-gray-600 dark:text-gray-400">
                                <p>Company's Market Position: <span id="marketPosition" class="font-medium">-</span></p>
                            </div>
                        </div>
                        
                        <!-- Growth Trends -->
                        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Growth Trends</h4>
                            <div class="h-72">
                                <canvas id="growthTrendsChart"></canvas>
                            </div>
                            <div class="mt-3 text-sm text-gray-600 dark:text-gray-400">
                                <p>Industry CAGR: <span id="industryCagr" class="font-medium">-</span></p>
                                <p>Company Growth vs Industry: <span id="growthComparison" class="font-medium">-</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Competitive Analysis -->
                    <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Competitive Analysis</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white dark:bg-gray-800">
                                <thead>
                                    <tr class="bg-gray-100 dark:bg-gray-700">
                                        <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Company</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Market Share</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Revenue Growth</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Operating Margin</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">P/E Ratio</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Market Cap</th>
                                    </tr>
                                </thead>
                                <tbody id="competitorsTableBody">
                                    <!-- Competitor data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Industry Trends -->
                    <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Key Industry Trends</h4>
                        <div id="industryTrends" class="space-y-4">
                            <!-- Industry trends will be inserted here -->
                        </div>
                    </div>

                    <!-- SWOT Analysis -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg p-4">
                            <h5 class="font-semibold text-green-800 dark:text-green-300 mb-2">Strengths</h5>
                            <ul id="strengthsList" class="list-disc pl-5 text-gray-700 dark:text-gray-300 space-y-1">
                                <!-- Strengths will be inserted here -->
                            </ul>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-4">
                            <h5 class="font-semibold text-red-800 dark:text-red-300 mb-2">Weaknesses</h5>
                            <ul id="weaknessesList" class="list-disc pl-5 text-gray-700 dark:text-gray-300 space-y-1">
                                <!-- Weaknesses will be inserted here -->
                            </ul>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                            <h5 class="font-semibold text-blue-800 dark:text-blue-300 mb-2">Opportunities</h5>
                            <ul id="opportunitiesList" class="list-disc pl-5 text-gray-700 dark:text-gray-300 space-y-1">
                                <!-- Opportunities will be inserted here -->
                            </ul>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                            <h5 class="font-semibold text-yellow-800 dark:text-yellow-300 mb-2">Threats</h5>
                            <ul id="threatsList" class="list-disc pl-5 text-gray-700 dark:text-gray-300 space-y-1">
                                <!-- Threats will be inserted here -->
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Sources Section -->
                <div class="mt-6 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Sources & References</h4>
                    <div id="industrySources" class="text-sm text-gray-600 dark:text-gray-400">
                        <p class="italic mb-2">Information and data provided by AI based on the following sources:</p>
                        <ul id="industrySourcesList" class="list-disc pl-5 space-y-1">
                            <li>No specific sources cited yet. The AI draws from multiple financial databases, market research reports, and publicly available information.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Page: Comparable Companies -->
        <div id="page-comparables" class="page-content hidden">
            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Comparable Companies Analysis</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Compare key financial metrics and valuation multiples across similar companies in the same sector.</p>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2 items-center">
                        <div class="flex-grow">
                            <div class="relative">
                                <input type="text" id="comparablesTickerInput" placeholder="Enter stock ticker (e.g., AAPL, MSFT, GOOGL)" 
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <select id="comparablesModelSelect" class="px-3 py-2 mr-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                <option value="pro">Gemini-2.5-Pro-Exp</option>
                                <option value="flash">Gemini-2.5-Flash-Preview</option>
                            </select>
                        </div>
                        <button id="fetchComparablesBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            <span>Fetch Comparable Companies</span>
                        </button>
                    </div>
                    
                    <div id="comparablesList" class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
                        <div class="mt-1 flex flex-wrap gap-1">
                            <button class="comparables-quick-btn px-3 py-1.5 text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 border border-blue-200 dark:border-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                AAPL Demo Mode
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="comparablesLoadingIndicator" class="hidden py-20">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400 text-lg">Loading comparable companies data...</span>
                    </div>
                </div>

                <!-- Comparable Companies Content -->
                <div id="comparablesContent" class="hidden">
                    <div class="mb-4">
                        <h3 id="comparablesCompanyName" class="text-xl font-semibold text-gray-800 dark:text-white"></h3>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                Industry: <span id="comparablesIndustry" class="font-medium"></span> | 
                                Sector: <span id="comparablesSector" class="font-medium"></span>
                            </p>
                            <p id="comparablesDate" class="text-sm text-gray-500 dark:text-gray-400">Data as of: </p>
                        </div>
                    </div>

                    <!-- Comparison Metrics Selector -->
                    <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-750 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Comparison Metrics</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="metric-pe" class="metric-checkbox mr-2" value="pe" checked>
                                <label for="metric-pe" class="text-sm text-gray-600 dark:text-gray-400">P/E Ratio</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="metric-ps" class="metric-checkbox mr-2" value="ps" checked>
                                <label for="metric-ps" class="text-sm text-gray-600 dark:text-gray-400">P/S Ratio</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="metric-pb" class="metric-checkbox mr-2" value="pb" checked>
                                <label for="metric-pb" class="text-sm text-gray-600 dark:text-gray-400">P/B Ratio</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="metric-evebitda" class="metric-checkbox mr-2" value="evebitda" checked>
                                <label for="metric-evebitda" class="text-sm text-gray-600 dark:text-gray-400">EV/EBITDA</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="metric-gpm" class="metric-checkbox mr-2" value="gpm" checked>
                                <label for="metric-gpm" class="text-sm text-gray-600 dark:text-gray-400">Gross Margin</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="metric-opm" class="metric-checkbox mr-2" value="opm" checked>
                                <label for="metric-opm" class="text-sm text-gray-600 dark:text-gray-400">Op. Margin</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="metric-npm" class="metric-checkbox mr-2" value="npm" checked>
                                <label for="metric-npm" class="text-sm text-gray-600 dark:text-gray-400">Net Margin</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="metric-roe" class="metric-checkbox mr-2" value="roe" checked>
                                <label for="metric-roe" class="text-sm text-gray-600 dark:text-gray-400">ROE</label>
                            </div>
                        </div>
                        <div class="text-right mt-2">
                            <button id="updateComparablesTable" class="px-2 py-1 text-xs bg-primary text-white rounded-md">Update Table</button>
                        </div>
                    </div>

                    <!-- Comparables Table -->
                    <div class="overflow-x-auto mb-6 border border-gray-300 dark:border-gray-700 rounded-lg">
                        <table class="min-w-full bg-white dark:bg-gray-800">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider sticky left-0 bg-gray-100 dark:bg-gray-700">Company</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Market Cap</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Revenue (TTM)</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Revenue Growth</th>
                                    <th class="metric-col pe py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">P/E</th>
                                    <th class="metric-col ps py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">P/S</th>
                                    <th class="metric-col pb py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">P/B</th>
                                    <th class="metric-col evebitda py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">EV/EBITDA</th>
                                    <th class="metric-col gpm py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Gross Margin</th>
                                    <th class="metric-col opm py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Op. Margin</th>
                                    <th class="metric-col npm py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Net Margin</th>
                                    <th class="metric-col roe py-3 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">ROE</th>
                                </tr>
                            </thead>
                            <tbody id="comparablesTableBody">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Valuation Multiples Visualization -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Valuation Multiples Chart -->
                        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Valuation Multiples</h4>
                            <div class="h-72">
                                <canvas id="valuationMultiplesChart"></canvas>
                            </div>
                        </div>

                        <!-- Profitability Metrics Chart -->
                        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Profitability Metrics</h4>
                            <div class="h-72">
                                <canvas id="profitabilityMetricsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Company Details Cards -->
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Company Details</h4>
                        <div id="companyDetailsCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Financial Statements -->
        <div id="page-financials" class="page-content hidden">
            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Financial Statements</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Retrieve detailed financial statements including income statement, balance sheet, and cash flow statement.</p>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2 items-center">
                        <div class="flex-grow">
                            <div class="relative">
                                <input type="text" id="financialsTickerInput" placeholder="Enter stock ticker (e.g., AAPL, MSFT, GOOGL)" 
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                    <div id="financialsDemoLabel" class="text-xs text-gray-500 dark:text-gray-400">(Enter a ticker)</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <select id="financialsModelSelect" class="px-3 py-2 mr-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                <option value="flash">Gemini-2.5-Flash-Preview</option>
                                <option value="pro">Gemini-2.5-Pro-Exp</option>
                            </select>
                        </div>
                        <button id="fetchFinancialsBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            <span>Fetch Financial Data</span>
                        </button>
                    </div>
                    
                    <div id="financialsList" class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
                        <div class="mt-1 flex flex-wrap gap-1">
                            <button class="financials-quick-btn px-3 py-1.5 text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 border border-blue-200 dark:border-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                AAPL Demo Mode
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="financialsLoadingIndicator" class="hidden py-20">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400 text-lg">Loading financial statements...</span>
                    </div>
                </div>

                <!-- Financial Statements Content -->
                <div id="financialContent" class="hidden">
                    <div class="mb-6 flex flex-wrap gap-2 items-center justify-between">
                        <div class="flex space-x-2 mb-4 md:mb-0 flex-wrap">
                            <button id="incomeBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 active mb-2 sm:mb-0">Income Statement</button>
                            <button id="balanceBtn" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 mb-2 sm:mb-0">Balance Sheet</button>
                            <button id="cashFlowBtn" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 mb-2 sm:mb-0">Cash Flow</button>
                        </div>
                        <div>
                            <button id="exportExcel" class="px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export to Excel
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <div id="incomeStatement" class="statement active">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Income Statement</h3>
                                    <p id="incomeYearRange" class="text-gray-600 dark:text-gray-400">(2021-2024)</p>
                                    <p id="incomeCurrencyUnit" class="text-gray-600 dark:text-gray-400">All figures in Millions ($000s)</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="incomeTableBtn" class="px-3 py-1 bg-primary text-white text-sm rounded-md font-medium hover:bg-opacity-90 focus:outline-none">Table View</button>
                                    <button id="incomeChartBtn" class="px-3 py-1 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 text-sm rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none">Chart View</button>
                                </div>
                            </div>
                            
                            <div id="incomeTableView" class="block">
                                <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                                    <thead>
                                        <tr class="bg-gray-100 dark:bg-gray-700">
                                            <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Item</th>
                                            <th id="income-year-1" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2024</th>
                                            <th id="income-year-2" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2023</th>
                                            <th id="income-year-3" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2022</th>
                                            <th id="income-year-4" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2021</th>
                                        </tr>
                                    </thead>
                                    <tbody id="incomeStatementBody">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                                <p id="incomeDataSource" class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic hidden">Data source: Financial information retrieved via AI models from publicly available sources including SEC filings, annual reports, and financial databases. May vary from official filings.</p>
                            </div>
                            
                            <div id="incomeChartView" class="hidden">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Revenue & Income Metrics:</label>
                                    <div class="flex flex-wrap gap-2">
                                        <label class="inline-flex items-center bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded-md">
                                            <input type="checkbox" class="income-chart-primary" value="Revenue" checked class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Revenue (Bar)</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="income-chart-primary" value="Gross Profit" class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Gross Profit</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="income-chart-primary" value="Operating Income" class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Operating Income</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="income-chart-primary" value="Net Income" class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Income</span>
                                        </label>
                                    </div>
                                    
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 mt-3">Margin Metrics (Secondary Axis):</label>
                                    <div class="flex flex-wrap gap-2">
                                        <label class="inline-flex items-center bg-green-100 dark:bg-green-900 px-2 py-1 rounded-md">
                                            <input type="checkbox" class="income-chart-secondary" value="Net Profit Margin" checked class="form-checkbox h-4 w-4 text-green-600">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Profit Margin (Line)</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="income-chart-secondary" value="Operating Margin" class="form-checkbox h-4 w-4 text-green-600">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Operating Margin</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="income-chart-secondary" value="Gross Margin" class="form-checkbox h-4 w-4 text-green-600">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Gross Margin</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-300 dark:border-gray-700">
                                    <canvas id="incomeChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>

                        <div id="balanceSheet" class="statement hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Balance Sheet</h3>
                                    <p id="balanceYearRange" class="text-gray-600 dark:text-gray-400">(2021-2024)</p>
                                    <p id="balanceCurrencyUnit" class="text-gray-600 dark:text-gray-400">All figures in Millions ($000s)</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="balanceTableBtn" class="px-3 py-1 bg-primary text-white text-sm rounded-md font-medium hover:bg-opacity-90 focus:outline-none">Table View</button>
                                    <button id="balanceChartBtn" class="px-3 py-1 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 text-sm rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none">Chart View</button>
                                </div>
                            </div>
                            
                            <div id="balanceTableView" class="block">
                                <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                                    <thead>
                                        <tr class="bg-gray-100 dark:bg-gray-700">
                                            <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Item</th>
                                            <th id="balance-year-1" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2024</th>
                                            <th id="balance-year-2" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2023</th>
                                            <th id="balance-year-3" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2022</th>
                                            <th id="balance-year-4" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2021</th>
                                        </tr>
                                    </thead>
                                    <tbody id="balanceSheetBody">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                                <p id="balanceDataSource" class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic hidden">Data source: Financial information retrieved via AI models from publicly available sources including SEC filings, annual reports, and financial databases. May vary from official filings.</p>
                            </div>
                            
                            <div id="balanceChartView" class="hidden">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Metrics to Display:</label>
                                    <div class="flex flex-wrap gap-2">
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="balance-chart-metric" value="Total Assets" checked class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Total Assets</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="balance-chart-metric" value="Total Current Assets" checked class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Current Assets</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="balance-chart-metric" value="Total Liabilities" checked class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Total Liabilities</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="balance-chart-metric" value="Total Equity" checked class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Total Equity</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-300 dark:border-gray-700">
                                    <canvas id="balanceChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>

                        <div id="cashFlow" class="statement hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Cash Flow Statement</h3>
                                    <p id="cashflowYearRange" class="text-gray-600 dark:text-gray-400">(2021-2024)</p>
                                    <p id="cashflowCurrencyUnit" class="text-gray-600 dark:text-gray-400">All figures in Millions ($000s)</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="cashFlowTableBtn" class="px-3 py-1 bg-primary text-white text-sm rounded-md font-medium hover:bg-opacity-90 focus:outline-none">Table View</button>
                                    <button id="cashFlowChartBtn" class="px-3 py-1 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 text-sm rounded-md font-medium hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none">Chart View</button>
                                </div>
                            </div>
                            
                            <div id="cashFlowTableView" class="block">
                                <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                                    <thead>
                                        <tr class="bg-gray-100 dark:bg-gray-700">
                                            <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Item</th>
                                            <th id="cashflow-year-1" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2024</th>
                                            <th id="cashflow-year-2" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2023</th>
                                            <th id="cashflow-year-3" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2022</th>
                                            <th id="cashflow-year-4" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">2021</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cashFlowBody">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                                <p id="cashFlowDataSource" class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic hidden">Data source: Financial information retrieved via AI models from publicly available sources including SEC filings, annual reports, and financial databases. May vary from official filings.</p>
                            </div>
                            
                            <div id="cashFlowChartView" class="hidden">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Metrics to Display:</label>
                                    <div class="flex flex-wrap gap-2">
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="cashflow-chart-metric" value="Net Cash from Operations" checked class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Cash from Operations</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="cashflow-chart-metric" value="Net Cash from Investing" checked class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Cash from Investing</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="cashflow-chart-metric" value="Net Cash from Financing" checked class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Cash from Financing</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="cashflow-chart-metric" value="Net Change in Cash" checked class="form-checkbox h-4 w-4 text-primary">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Net Change in Cash</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-300 dark:border-gray-700">
                                    <canvas id="cashFlowChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Analysis Section -->
                    <div id="aiAnalysisSection" class="mt-6 mb-4 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">AI Financial Analysis</h3>
                            <button id="analyzeFinancialsBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                                Analyze Financials
                            </button>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Use AI to analyze historical financial trends, identify key drivers of performance, and highlight important metrics.</p>
                        
                        <!-- Loading indicator for AI analysis -->
                        <div id="aiAnalysisLoading" class="hidden">
                            <div class="flex items-center justify-center py-6">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                                <span class="ml-3 text-gray-600 dark:text-gray-400">Analyzing financial data...</span>
                            </div>
                        </div>
                        
                        <!-- Collapsible analysis tabs -->
                        <div id="aiAnalysisResults" class="hidden space-y-4">
                            <div class="border border-gray-200 dark:border-gray-700 rounded-md overflow-hidden">
                                <button class="analysis-tab-btn w-full px-4 py-2 text-left bg-gray-100 dark:bg-gray-750 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium flex justify-between items-center" data-target="revenueTrendsContent">
                                    <span>Revenue & Growth Trends</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div id="revenueTrendsContent" class="p-4 bg-white dark:bg-gray-800 analysis-content">
                                    <div class="prose dark:prose-invert max-w-none text-sm" id="revenueTrendsText">
                                        <!-- Content will be populated by AI -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 dark:border-gray-700 rounded-md overflow-hidden">
                                <button class="analysis-tab-btn w-full px-4 py-2 text-left bg-gray-100 dark:bg-gray-750 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium flex justify-between items-center" data-target="profitabilityContent">
                                    <span>Profitability Analysis</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div id="profitabilityContent" class="p-4 bg-white dark:bg-gray-800 hidden analysis-content">
                                    <div class="prose dark:prose-invert max-w-none text-sm" id="profitabilityText">
                                        <!-- Content will be populated by AI -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 dark:border-gray-700 rounded-md overflow-hidden">
                                <button class="analysis-tab-btn w-full px-4 py-2 text-left bg-gray-100 dark:bg-gray-750 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium flex justify-between items-center" data-target="balanceSheetContent">
                                    <span>Balance Sheet Health</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div id="balanceSheetContent" class="p-4 bg-white dark:bg-gray-800 hidden analysis-content">
                                    <div class="prose dark:prose-invert max-w-none text-sm" id="balanceSheetText">
                                        <!-- Content will be populated by AI -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 dark:border-gray-700 rounded-md overflow-hidden">
                                <button class="analysis-tab-btn w-full px-4 py-2 text-left bg-gray-100 dark:bg-gray-750 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium flex justify-between items-center" data-target="cashFlowContent">
                                    <span>Cash Flow Analysis</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div id="cashFlowContent" class="p-4 bg-white dark:bg-gray-800 hidden analysis-content">
                                    <div class="prose dark:prose-invert max-w-none text-sm" id="cashFlowText">
                                        <!-- Content will be populated by AI -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 dark:border-gray-700 rounded-md overflow-hidden">
                                <button class="analysis-tab-btn w-full px-4 py-2 text-left bg-gray-100 dark:bg-gray-750 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium flex justify-between items-center" data-target="keyInsightsContent">
                                    <span>Key Insights & Recommendations</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div id="keyInsightsContent" class="p-4 bg-white dark:bg-gray-800 hidden analysis-content">
                                    <div class="prose dark:prose-invert max-w-none text-sm" id="keyInsightsText">
                                        <!-- Content will be populated by AI -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="dataSourcesSection" class="mt-4 mb-4">
                        <p id="dataSourcesNote" class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic">
                            Data sources: Financial information retrieved via AI models from publicly available sources including SEC filings, annual reports, and financial databases. Users are encouraged to cross-check with official company filings for investment decisions.
                        </p>
                        
                        <details class="text-xs mt-1">
                            <summary class="cursor-pointer text-primary font-medium hover:underline">View source URLs</summary>
                            <div id="sourceUrlsContainer" class="mt-2 p-2 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded">
                                <p class="text-gray-500 dark:text-gray-400 italic mb-1">Sources cited by AI models:</p>
                                <ul id="sourceUrlsList" class="list-disc ml-4 text-gray-600 dark:text-gray-300 space-y-1">
                                    <li class="text-gray-400 dark:text-gray-500 italic">No source URLs available yet. Sources will appear here when real-time data is fetched.</li>
                                </ul>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Valuation Model -->
        <div id="page-valuation" class="page-content hidden">
            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">DCF Valuation Model</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-2">Create a custom discounted cash flow valuation model with adjustable parameters.</p>
                <div class="p-3 mb-4 bg-yellow-50 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-md border border-yellow-200 dark:border-yellow-800">
                    <div class="flex">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span><strong>Note:</strong> Please first fetch Financial Statements data for the company you want to analyze. The valuation model relies on historical financial data to calculate metrics and make projections.</span>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2 items-center">
                        <div class="flex-grow">
                            <div class="relative">
                                <input type="text" id="valuationTickerInput" placeholder="Enter stock ticker (e.g., AAPL, MSFT, GOOGL)" 
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                    <div id="valuationDemoLabel" class="text-xs text-gray-500 dark:text-gray-400">(Enter a ticker)</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <select id="valuationModelSelect" class="px-3 py-2 mr-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                <option value="flash">Gemini-2.5-Flash-Preview</option>
                                <option value="pro">Gemini-2.5-Pro-Exp</option>
                            </select>
                        </div>
                        <button id="fetchValuationBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            <span>Fetch Company Data</span>
                        </button>
                    </div>
                    
                    <div id="valuationList" class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
                        <div class="mt-1 flex flex-wrap gap-1">
                            <button class="valuation-quick-btn px-3 py-1.5 text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 border border-blue-200 dark:border-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                AAPL Demo Mode
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="valuationLoadingIndicator" class="hidden py-20">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400 text-lg">Loading company data...</span>
                    </div>
                </div>

                <!-- Valuation Model Content -->
                <div id="valuationContent" class="hidden">
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-white">DCF Valuation Model</h3>
                            <p id="valuationYearRange" class="text-gray-600 dark:text-gray-400">(2021-2024)</p>
                            <p id="valuationCurrencyUnit" class="text-gray-600 dark:text-gray-400">All figures in Millions ($000s)</p>
                        </div>
                        <div>
                            <button id="exportValuationExcel" class="px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export to Excel
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Inputs Section -->
                        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 p-4 rounded-md">
                            <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Model Inputs</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Forecast Period (Years)</label>
                                    <input type="number" id="forecastPeriod" value="5" min="1" max="10" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                            
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Revenue Growth Rate (%)</label>
                                    <input type="number" id="revenueGrowthRate" value="5" min="-50" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Market Growth Rate (%)</label>
                                    <input type="number" id="marketGrowthRate" value="5" min="-10" max="20" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Operating Margin (%)</label>
                                    <input type="number" id="operatingMargin" value="20" min="-50" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tax Rate (%)</label>
                                    <input type="number" id="taxRate" value="25" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Capital Expenditure (% of Revenue)</label>
                                    <input type="number" id="capexRate" value="5" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Working Capital (% of Revenue)</label>
                                    <input type="number" id="wcRate" value="10" min="-50" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Terminal Growth Rate (%)</label>
                                    <input type="number" id="terminalGrowthRate" value="2" min="-5" max="15" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Discount Rate (WACC) (%)</label>
                                    <input type="number" id="discountRate" value="10" min="1" max="30" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">EV/EBITDA Multiple (Terminal)</label>
                                    <input type="number" id="evMultiple" value="12" min="1" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <button id="calculateValuation" class="mt-4 px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 w-full">
                                    Calculate Valuation
                                </button>
                            </div>
                        </div>
                        
                        <!-- Results Section -->
                        <div>
                            <!-- Company Info -->
                            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 p-4 rounded-md mb-6">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Company Information</h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Shares Outstanding</span>
                                            <span id="sharesInfo" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Net Debt</span>
                                            <span id="debtInfo" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Valuation Results -->
                            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 p-4 rounded-md mb-6">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Valuation Results</h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Enterprise Value (DCF)</span>
                                            <span id="enterpriseValueDCF" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Enterprise Value (Multiple)</span>
                                            <span id="enterpriseValueMultiple" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Equity Value (DCF)</span>
                                            <span id="equityValueDCF" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Equity Value (Multiple)</span>
                                            <span id="equityValueMultiple" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Share Price (DCF)</span>
                                            <span id="sharePriceDCF" class="font-bold text-lg text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2">
                                            <span class="text-gray-700 dark:text-gray-300">Share Price (Multiple)</span>
                                            <span id="sharePriceMultiple" class="font-bold text-lg text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Key Metrics -->
                            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 p-4 rounded-md">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Historical Metrics</h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Revenue CAGR (3 Year)</span>
                                            <span id="revenueCagr" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Average Operating Margin</span>
                                            <span id="avgOperatingMargin" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">Average CapEx % of Revenue</span>
                                            <span id="avgCapex" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2">
                                            <span class="text-gray-700 dark:text-gray-300">Effective Tax Rate</span>
                                            <span id="effectiveTaxRate" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cash Flow Projections -->
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Cash Flow Projections</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                                <thead>
                                    <tr class="bg-gray-100 dark:bg-gray-700">
                                        <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Item</th>
                                        <th id="proj-year-0" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Historical</th>
                                        <th id="proj-year-1" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 1</th>
                                        <th id="proj-year-2" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 2</th>
                                        <th id="proj-year-3" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 3</th>
                                        <th id="proj-year-4" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 4</th>
                                        <th id="proj-year-5" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 5</th>
                                        <th id="proj-terminal" class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Terminal</th>
                                    </tr>
                                </thead>
                                <tbody id="projectionBody">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                                <tfoot id="projectionSummary" class="bg-gray-100 dark:bg-gray-700 font-medium">
                                    <!-- Will be dynamically populated with Enterprise Value calculations -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Margin Metrics -->
                    <div class="mt-6">
                        <h3 class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">Margin & Growth Metrics</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                                <thead>
                                    <tr class="bg-gray-100 dark:bg-gray-700">
                                        <th class="py-2 px-4 text-left text-gray-700 dark:text-gray-300">Metric</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Historical</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 1</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 2</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 3</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 4</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Year 5</th>
                                        <th class="py-2 px-4 text-right text-gray-700 dark:text-gray-300">Terminal</th>
                                    </tr>
                                </thead>
                                <tbody id="marginMetricsBody">
                                    <!-- Will be populated dynamically with percentages and growth rates -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Analyst Consensus -->
        <div id="page-analyst" class="page-content hidden">
            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Analyst Consensus</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">View analyst ratings, price targets, and earnings estimates for a company.</p>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2 items-center">
                        <div class="flex-grow">
                            <div class="relative">
                                <input type="text" id="analystTickerInput" placeholder="Enter stock ticker (e.g., AAPL, MSFT, GOOGL)" 
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                    <div id="analystDemoLabel" class="text-xs text-gray-500 dark:text-gray-400">(Enter a ticker)</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <select id="analystModelSelect" class="px-3 py-2 mr-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                <option value="flash">Gemini-2.5-Flash-Preview</option>
                                <option value="pro">Gemini-2.5-Pro-Exp</option>
                            </select>
                        </div>
                        <button id="fetchAnalystBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            <span>Fetch Analyst Data</span>
                        </button>
                    </div>
                    
                    <div id="analystList" class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
                        <div class="mt-1 flex flex-wrap gap-1">
                            <button class="analyst-quick-btn px-3 py-1.5 text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 border border-blue-200 dark:border-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                AAPL Demo Mode
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Loading indicator -->
                <div id="analystLoadingIndicator" class="hidden py-20">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400 text-lg">Loading analyst consensus data...</span>
                    </div>
                </div>

                <!-- Analyst Consensus Content -->
                <div id="analystContent" class="hidden">
                    <div class="flex justify-between text-sm mb-3">
                        <span class="text-gray-600 dark:text-gray-400">Analyst Estimates for <span id="analystCompanyName" class="font-semibold"></span></span>
                        <span id="consensusDate" class="text-gray-600 dark:text-gray-400"></span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                        <!-- Price Target Section -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-3 rounded-md">
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Price Target</h4>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Average</span>
                                <span id="priceTargetAvg" class="font-semibold"></span>
                            </div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Low</span>
                                <span id="priceTargetLow" class=""></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">High</span>
                                <span id="priceTargetHigh" class=""></span>
                            </div>
                            <div class="mt-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                                <div class="text-xs text-gray-500 dark:text-gray-400">Upside: <span id="priceTargetUpside" class="font-medium"></span></div>
                            </div>
                        </div>
                        
                        <!-- Recommendations Section -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-3 rounded-md">
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Recommendations</h4>
                            <div class="h-16 relative mb-2" id="recommendationChart">
                                <div class="flex h-10 mt-2 items-end">
                                    <div id="buyBar" class="bg-green-500 dark:bg-green-600 rounded-t w-full" style="height: 0%"></div>
                                    <div id="holdBar" class="bg-yellow-400 dark:bg-yellow-600 rounded-t w-full mx-1" style="height: 0%"></div>
                                    <div id="sellBar" class="bg-red-500 dark:bg-red-600 rounded-t w-full" style="height: 0%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 text-center text-xs">
                                <div>
                                    <span class="text-green-600 dark:text-green-400 font-semibold" id="buyCount"></span>
                                    <p class="text-gray-600 dark:text-gray-400">Buy</p>
                                </div>
                                <div>
                                    <span class="text-yellow-600 dark:text-yellow-400 font-semibold" id="holdCount"></span>
                                    <p class="text-gray-600 dark:text-gray-400">Hold</p>
                                </div>
                                <div>
                                    <span class="text-red-600 dark:text-red-400 font-semibold" id="sellCount"></span>
                                    <p class="text-gray-600 dark:text-gray-400">Sell</p>
                                </div>
                            </div>
                            <div class="mt-2 text-center">
                                <div class="text-sm font-medium" id="consensusRating"></div>
                            </div>
                        </div>
                        
                        <!-- Earnings Estimates Section -->
                        <div class="bg-gray-50 dark:bg-gray-750 p-3 rounded-md">
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Earnings Estimates</h4>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Next Quarter</span>
                                <span id="earningsNextQuarter" class=""></span>
                            </div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Current Year</span>
                                <span id="earningsCurrentYear" class=""></span>
                            </div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Next Year</span>
                                <span id="earningsNextYear" class=""></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400 text-xs">Growth</span>
                                <span id="earningsGrowth" class="font-semibold"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="bg-gray-50 dark:bg-gray-750 p-3 rounded-md">
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Recent Analyst Actions</h4>
                            <div class="overflow-auto max-h-48">
                                <table class="min-w-full">
                                    <thead class="bg-gray-100 dark:bg-gray-700">
                                        <tr>
                                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-700 dark:text-gray-300">Date</th>
                                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-700 dark:text-gray-300">Firm</th>
                                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-700 dark:text-gray-300">Action</th>
                                            <th class="py-2 px-4 text-right text-xs font-medium text-gray-700 dark:text-gray-300">Price Target</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analystActionsBody">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="analystNoData" class="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-750 rounded-lg text-center">
                        <svg class="w-12 h-12 mx-auto text-gray-400 dark:text-gray-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-600 dark:text-gray-400 mb-2">No analyst consensus data available for this stock.</p>
                        <p class="text-sm text-gray-500 dark:text-gray-500">This may be because the stock has limited analyst coverage or is traded on an exchange with less data availability.</p>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        // Global data storage
        let dataStore = {
            overview: null,
            financials: null,
            valuation: null,
            analyst: null,
            stock: null,
            industry: null,
            comparables: null,
            currentTicker: '' // Store the current ticker across all pages
        };

        // Cache management system
        const cacheManager = {
            // Cache expiration time in milliseconds (30 minutes)
            CACHE_EXPIRATION: 30 * 60 * 1000,
            
            // Cache storage with timestamps
            cache: {},
            
            // Store data in cache with timestamp
            set: function(key, data) {
                this.cache[key] = {
                    timestamp: Date.now(),
                    data: data
                };
            },
            
            // Get data from cache if it exists and is not expired
            get: function(key) {
                const cachedItem = this.cache[key];
                if (!cachedItem) return null;
                
                // Check if cache is expired
                if (Date.now() - cachedItem.timestamp > this.CACHE_EXPIRATION) {
                    // Cache expired, remove it
                    delete this.cache[key];
                    return null;
                }
                
                return cachedItem.data;
            },
            
            // Check if data exists in cache and is not expired
            has: function(key) {
                return this.get(key) !== null;
            },
            
            // Clear all cached data
            clear: function() {
                this.cache = {};
            }
        };

        // Sample data for Apple to enable demo functionality
        const sampleData = {
            "name": "Apple Inc.",
            "fiscalYearEnd": "Sep 30",
            "currencyUnit": "Millions",
            "currencySymbol": "$",
            "years": [2023, 2022, 2021, 2020],
            "sharesOutstanding": 15634.28,
            "description": "Apple Inc. designs, manufactures, and markets smartphones, personal computers, tablets, wearables, and accessories worldwide. The company offers iPhone, iPad, Mac, Apple Watch, and accessories, as well as services such as the App Store, Apple Music, iCloud, and AppleCare.",
            "sector": "Technology",
            "industry": "Consumer Electronics",
            "founded": "1976",
            "headquarters": "Cupertino, California, USA",
            "retrievalDate": "2024-06-25",
            "sources": ["Apple Annual Report 2023", "Apple SEC 10-K Filing", "Yahoo Finance"],
            "comparableCompanies": [
                { "ticker": "MSFT", "name": "Microsoft Corporation" },
                { "ticker": "GOOGL", "name": "Alphabet Inc." },
                { "ticker": "AMZN", "name": "Amazon.com, Inc." },
                { "ticker": "SMCI", "name": "Samsung Electronics Co., Ltd." },
                { "ticker": "META", "name": "Meta Platforms, Inc." },
                { "ticker": "DELL", "name": "Dell Technologies Inc." },
                { "ticker": "HPQ", "name": "HP Inc." }
            ],
            "revenueBreakdown": {
                "segments": [
                    { "name": "iPhone", "revenue": 205499, "percentage": 53.6 },
                    { "name": "Mac", "revenue": 29357, "percentage": 7.7 },
                    { "name": "iPad", "revenue": 28305, "percentage": 7.4 },
                    { "name": "Wearables, Home and Accessories", "revenue": 41241, "percentage": 10.8 },
                    { "name": "Services", "revenue": 78129, "percentage": 20.4 }
                ],
                "regions": [
                    { "name": "Americas", "revenue": 164970, "percentage": 43.0 },
                    { "name": "Europe", "revenue": 93545, "percentage": 24.4 },
                    { "name": "Greater China", "revenue": 72559, "percentage": 18.9 },
                    { "name": "Japan", "revenue": 25939, "percentage": 6.8 },
                    { "name": "Rest of Asia Pacific", "revenue": 26280, "percentage": 6.9 }
                ]
            },
            "incomeStatement": {
                "Revenue": ["$383,293", "$394,328", "$365,817", "$274,515"],
                "Cost of Revenue": ["($215,013)", "($223,546)", "($212,981)", "($169,559)"],
                "Gross Profit": ["$168,280", "$170,782", "$152,836", "$104,956"],
                "Operating Expenses": ["($49,582)", "($48,188)", "($43,887)", "($38,668)"],
                "R&D Expenses": ["($29,915)", "($26,251)", "($21,914)", "($18,752)"],
                "Operating Income": ["$118,698", "$122,594", "$108,949", "$66,288"],
                "Other Income": ["$973", "$394", "$258", "$803"],
                "Tax Expense": ["($19,300)", "($19,300)", "($14,527)", "($9,680)"],
                "Net Income": ["$96,995", "$99,803", "$94,680", "$57,411"]
            },
            "balanceSheet": {
                "Cash & Equivalents": ["$29,965", "$23,646", "$34,940", "$38,016"],
                "Accounts Receivable": ["$30,494", "$28,184", "$26,278", "$16,120"],
                "Inventory": ["$6,331", "$4,946", "$6,580", "$4,061"],
                "Total Current Assets": ["$143,566", "$134,836", "$134,836", "$143,713"],
                "Property & Equipment": ["$43,715", "$42,117", "$39,440", "$36,766"],
                "Intangible Assets": ["$8,781", "$8,673", "$8,724", "$8,752"],
                "Total Assets": ["$352,583", "$352,755", "$351,002", "$323,888"],
                "Accounts Payable": ["$62,611", "$64,115", "$54,763", "$42,296"],
                "Short-term Debt": ["$15,807", "$11,128", "$9,613", "$13,769"],
                "Total Current Liabilities": ["$145,301", "$153,982", "$125,481", "$105,392"],
                "Long-term Debt": ["$95,281", "$98,959", "$109,106", "$98,667"],
                "Total Liabilities": ["$290,407", "$302,083", "$287,912", "$258,549"],
                "Common Stock": ["$63,484", "$64,849", "$57,365", "$50,779"],
                "Retained Earnings": ["($1,308)", "($14,177)", "$5,562", "$14,966"],
                "Total Equity": ["$62,176", "$50,672", "$63,090", "$65,339"],
                "Total Liabilities & Equity": ["$352,583", "$352,755", "$351,002", "$323,888"]
            },
            "cashFlow": {
                "Net Income": ["$96,995", "$99,803", "$94,680", "$57,411"],
                "Depreciation & Amortization": ["$11,862", "$11,104", "$11,284", "$11,056"],
                "Changes in Working Capital": ["($13,573)", "$19,690", "$10,066", "$4,232"],
                "Net Cash from Operations": ["$113,812", "$122,151", "$104,038", "$80,674"],
                "Capital Expenditures": ["($10,655)", "($10,708)", "($11,085)", "($7,309)"],
                "Acquisitions": ["($306)", "($306)", "($33)", "($1,524)"],
                "Net Cash from Investing": ["($11,900)", "($22,354)", "($14,545)", "($4,289)"],
                "Debt Issuance (Repayment)": ["($4,915)", "($9,543)", "$12,665", "$16,091"],
                "Dividends Paid": ["($14,758)", "($14,841)", "($14,467)", "($14,081)"],
                "Net Cash from Financing": ["($88,416)", "($110,749)", "($93,353)", "($86,820)"],
                "Net Change in Cash": ["$13,496", "($10,952)", "($3,860)", "($10,435)"],
                "Beginning Cash Balance": ["$16,469", "$27,421", "$31,281", "$41,716"],
                "Ending Cash Balance": ["$29,965", "$16,469", "$27,421", "$31,281"]
            }
        };
        
        // Sample analyst consensus data for Apple demo mode
        const sampleAnalystConsensus = {
            "ticker": "AAPL",
            "priceTarget": {
                "average": 212.75,
                "high": 250.00,
                "low": 165.00,
                "currency": "$",
                "date": "2024-06-25"
            },
            "recommendations": {
                "buy": 28,
                "hold": 12,
                "sell": 3,
                "total": 43,
                "rating": "Buy" 
            },
            "earningsEstimates": {
                "nextQuarter": "$1.42",
                "currentYear": "$6.58",
                "nextYear": "$7.35",
                "growthRate": "11.7%"
            },
            "analystActions": [
                {
                    "date": "2024-06-20",
                    "firm": "Morgan Stanley",
                    "action": "Maintained",
                    "rating": "Overweight",
                    "priceTarget": "$216"
                },
                {
                    "date": "2024-06-15",
                    "firm": "JPMorgan",
                    "action": "Maintained",
                    "rating": "Overweight",
                    "priceTarget": "$225"
                },
                {
                    "date": "2024-06-10",
                    "firm": "Goldman Sachs",
                    "action": "Upgraded",
                    "rating": "Buy",
                    "priceTarget": "$222"
                },
                {
                    "date": "2024-06-05",
                    "firm": "Wedbush",
                    "action": "Maintained",
                    "rating": "Outperform",
                    "priceTarget": "$250"
                },
                {
                    "date": "2024-05-25",
                    "firm": "Bank of America",
                    "action": "Maintained",
                    "rating": "Buy",
                    "priceTarget": "$230"
                }
            ]
        };

        // Sample stock data for Apple demo mode
        const sampleStockData = {
            "ticker": "AAPL",
            "name": "Apple Inc.",
            "price": {
                "current": 174.23,
                "change": 1.68,
                "changePercent": 0.97,
                "currency": "$"
            },
            "marketCap": "2.71T",
            "peRatio": 28.94,
            "revenue": "383.29B",
            "netIncome": "96.99B",
            "tradingVolume": "48.2M",
            "fiftyTwoWeekRange": "164.55 - 198.23",
            "dividendYield": "0.55%",
            "eps": 6.02,
            "beta": 1.28,
            "returns": {
                "oneMonth": 2.7,
                "threeMonth": -4.3,
                "ytd": -9.8,
                "oneYear": 7.6
            },
            "timestamp": "2024-07-10 14:30 EST"
        };

        // Define income statement structure for consistent display order
        const incomeStatementStructure = [
            { label: 'Revenue', isSection: false, isTotal: false, cssClass: '' },
            { label: 'Cost of Revenue', isSection: false, isTotal: false, cssClass: '', isNegative: true },
            { label: 'Gross Profit', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Operating Expenses', isSection: false, isTotal: false, cssClass: '', isNegative: true },
            { label: 'R&D Expenses', isSection: false, isTotal: false, cssClass: '', isNegative: true },
            { label: 'Operating Income', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Other Income', isSection: false, isTotal: false, cssClass: '' },
            { label: 'Tax Expense', isSection: false, isTotal: false, cssClass: '', isNegative: true },
            { label: 'Net Income', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' }
        ];
        
        // Define balance sheet structure
        const balanceSheetStructure = [
            { label: 'Assets', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Cash & Equivalents', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Accounts Receivable', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Inventory', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Current Assets', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Property & Equipment', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Intangible Assets', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Assets', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' },
            { label: 'Liabilities & Equity', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Accounts Payable', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Short-term Debt', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Current Liabilities', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Long-term Debt', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Liabilities', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Common Stock', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Retained Earnings', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Total Equity', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Total Liabilities & Equity', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' }
        ];
        
        // Define cash flow structure
        const cashFlowStructure = [
            { label: 'Operating Activities', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Net Income', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Depreciation & Amortization', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Changes in Working Capital', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Net Cash from Operations', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Investing Activities', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Capital Expenditures', isSection: false, isTotal: false, cssClass: 'pl-6', isNegative: true },
            { label: 'Acquisitions', isSection: false, isTotal: false, cssClass: 'pl-6', isNegative: true },
            { label: 'Net Cash from Investing', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750', isNegative: true },
            { label: 'Financing Activities', isSection: true, isTotal: false, cssClass: 'bg-gray-50 dark:bg-gray-750', colspan: true },
            { label: 'Debt Issuance (Repayment)', isSection: false, isTotal: false, cssClass: 'pl-6' },
            { label: 'Dividends Paid', isSection: false, isTotal: false, cssClass: 'pl-6', isNegative: true },
            { label: 'Net Cash from Financing', isSection: false, isTotal: true, cssClass: 'bg-gray-50 dark:bg-gray-750' },
            { label: 'Net Change in Cash', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' },
            { label: 'Beginning Cash Balance', isSection: false, isTotal: false, cssClass: '' },
            { label: 'Ending Cash Balance', isSection: false, isTotal: true, cssClass: 'bg-gray-100 dark:bg-gray-700 font-bold' }
        ];

        // Function to add a message to the chat UI
        function displayMessage(message, type = 'info') {
            const messagesContainer = document.getElementById('messagesContainer');
            
            const messageElement = document.createElement('div');
            messageElement.className = `mb-2 p-2 rounded ${type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' : 
                type === 'success' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 
                'bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200'}`;
            
            // Use marked.js to render Markdown content if available
            if (typeof marked !== 'undefined') {
                messageElement.innerHTML = marked.parse(message);
            } else {
                messageElement.textContent = message;
            }
            
            messagesContainer.appendChild(messageElement);
            
            // Scroll to the bottom of the messages container
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Clear messages button functionality
        document.getElementById('clearMessages').addEventListener('click', function() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
        });

        // Utility function to parse financial numbers from string to actual value
        function parseFinancialNumber(valueStr) {
            if (!valueStr || valueStr === '-') return 0;
            
            // Remove currency symbol, commas, and handle parentheses for negative values
            const isNegative = valueStr.includes('(');
            let numStr = valueStr.replace(/[^0-9.-]/g, '');
            
            // Convert to number
            let value = parseFloat(numStr);
            
            // Apply negative sign if needed
            if (isNegative) value = -value;
            
            return value;
        }
        
        // Utility function to format financial numbers
        function formatFinancialNumber(value, isNegative = false, currencySymbol = '$') {
            if (value === undefined || value === null) return '-';
            
            // Convert to number if it's a string
            const numValue = typeof value === 'string' ? parseFloat(value) : value;
            
            // Determine if the value is negative or if we need to force negative format
            const effectiveIsNegative = numValue < 0 || isNegative;
            
            // Ensure we have a positive number to format
            const absValue = Math.abs(numValue);
            
            // Format with commas for thousands
            const formattedNumber = absValue.toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            // Return with currency symbol and proper negative formatting
            return effectiveIsNegative ? 
                `(${currencySymbol}${formattedNumber})` : 
                `${currencySymbol}${formattedNumber}`;
        }

        // Function to extract URLs from a text
        function extractUrls(text) {
            // This regex looks for URLs that begin with http:// or https://
            const urlRegex = /https?:\/\/[^\s)]+/g;
            const matches = text.match(urlRegex);
            
            // Deduplicate URLs and ensure the array is properly initialized
            return matches ? [...new Set(matches)] : [];
        }
        
        // Function to update the source URLs section
        function updateSourceUrls(urls) {
            if (!urls || urls.length === 0) return;
            
            const sourceUrlsList = document.getElementById('sourceUrlsList');
            if (!sourceUrlsList) return;
            
            // Clear the "no sources available" message if present
            if (sourceUrlsList.innerHTML.includes('No source URLs available yet')) {
                sourceUrlsList.innerHTML = '';
            }
            
            // Add each URL as a clickable link
            urls.forEach(url => {
                // Check if this URL is already in the list
                if (!sourceUrlsList.innerHTML.includes(url)) {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = url;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.className = 'text-primary hover:underline break-all';
                    link.textContent = url;
                    li.appendChild(link);
                    sourceUrlsList.appendChild(li);
                }
            });
        }

        // Function to toggle between table and chart views
        function toggleView(statementType, view = 'table') {
            // Table elements
            const tableViewId = `${statementType}TableView`;
            const tableBtn = document.getElementById(`${statementType}TableBtn`);
            
            // Chart elements
            const chartViewId = `${statementType}ChartView`;
            const chartBtn = document.getElementById(`${statementType}ChartBtn`);
            
            if (view === 'table') {
                // Show table, hide chart
                document.getElementById(tableViewId).classList.remove('hidden');
                document.getElementById(tableViewId).classList.add('block');
                document.getElementById(chartViewId).classList.add('hidden');
                
                // Highlight table button
                tableBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                tableBtn.classList.add('bg-primary', 'text-white');
                
                // Un-highlight chart button
                chartBtn.classList.remove('bg-primary', 'text-white');
                chartBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            } else {
                // Show chart, hide table
                document.getElementById(chartViewId).classList.remove('hidden');
                document.getElementById(tableViewId).classList.remove('block');
                document.getElementById(tableViewId).classList.add('hidden');
                
                // Highlight chart button
                chartBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                chartBtn.classList.add('bg-primary', 'text-white');
                
                // Un-highlight table button
                tableBtn.classList.remove('bg-primary', 'text-white');
                tableBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                
                // Update chart
                if (window.updateChart) {
                    window.updateChart(statementType);
                }
            }
        }
        
        // Function to switch between statement tabs (income, balance, cash flow)
        function switchTab(tabId) {
            document.querySelectorAll('.statement').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
        }
        
        // Function to set active button styles
        function setActiveButton(button) {
            // Remove active class from all buttons in the same group
            const allButtons = button.parentNode.querySelectorAll('button');
            allButtons.forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            });
            
            // Add active class to selected button
            button.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            button.classList.add('bg-primary', 'text-white');
        }

        // Function to show a specific page and hide others
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show the selected page
            document.getElementById(pageId).classList.remove('hidden');
            
            // Update navigation button styles
            document.querySelectorAll('nav button').forEach(button => {
                if (button.id === `nav-${pageId.split('-')[1]}`) {
                    button.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                    button.classList.add('bg-primary', 'text-white');
                } else {
                    button.classList.remove('bg-primary', 'text-white');
                    button.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                }
            });
        }

        // Navigation event listeners
        document.getElementById('nav-overview').addEventListener('click', () => showPage('page-overview'));
        document.getElementById('nav-financials').addEventListener('click', () => showPage('page-financials'));
        document.getElementById('nav-valuation').addEventListener('click', () => showPage('page-valuation'));
        document.getElementById('nav-analyst').addEventListener('click', () => showPage('page-analyst'));
        document.getElementById('nav-stock').addEventListener('click', () => showPage('page-stock'));
        document.getElementById('nav-industry').addEventListener('click', () => showPage('page-industry'));

        // Function to update the company description section
        function updateCompanyDescription(data) {
            try {
                // Check if we have a description
                if (data.description) {
                    const descriptionTextEl = document.getElementById('descriptionText');
                    const companySectorEl = document.getElementById('companySector');
                    const companyIndustryEl = document.getElementById('companyIndustry');
                    const companyFoundedEl = document.getElementById('companyFounded');
                    const companyHQEl = document.getElementById('companyHQ');
                    const companyDescriptionEl = document.getElementById('companyDescription');
                    
                    // Exit if any required element doesn't exist
                    if (!descriptionTextEl || !companySectorEl || !companyIndustryEl || 
                        !companyFoundedEl || !companyHQEl || !companyDescriptionEl) {
                        console.warn('Company description elements not found in DOM');
                        return;
                    }
                    
                    // Update description text
                    descriptionTextEl.textContent = data.description;
                    
                    // Update sector, industry, founded date, and headquarters if available
                    companySectorEl.textContent = data.sector || 'N/A';
                    companyIndustryEl.textContent = data.industry || 'N/A';
                    companyFoundedEl.textContent = data.founded || 'N/A';
                    companyHQEl.textContent = data.headquarters || 'N/A';
                    
                    // Show the description section
                    companyDescriptionEl.classList.remove('hidden');
                    
                    // Initialize revenue breakdown if data exists
                    if (data.revenueBreakdown) {
                        displayRevenueBreakdown(data.revenueBreakdown);
                    } else if (data.name && data.sector && data.industry) {
                        // Only fetch revenue breakdown if we don't already have it
                        // and if we have the necessary data to request it
                        fetchRevenueBreakdown(data.name, data.sector, data.industry);
                    }
                    
                    // Display comparable companies if data exists
                    if (data.comparableCompanies) {
                        // Update the comparable companies section
                        const comparablesList = document.getElementById('comparablesList');
                        if (comparablesList) {
                            comparablesList.innerHTML = '';
                            
                            data.comparableCompanies.forEach(company => {
                                const companyElement = document.createElement('div');
                                companyElement.className = 'p-2 bg-gray-50 dark:bg-gray-750 rounded-md border border-gray-200 dark:border-gray-700';
                                
                                const ticker = document.createElement('div');
                                ticker.className = 'text-xs font-bold text-primary';
                                ticker.textContent = company.ticker;
                                
                                const name = document.createElement('div');
                                name.className = 'text-xs text-gray-700 dark:text-gray-300 truncate';
                                name.textContent = company.name;
                                
                                companyElement.appendChild(ticker);
                                companyElement.appendChild(name);
                                comparablesList.appendChild(companyElement);
                            });
                        }
                        
                        // Hide loading indicator for comparable companies
                        document.getElementById('comparablesLoading').classList.add('hidden');
                    } else if (data.industry && data.sector && data.name) {
                        // Only fetch comparable companies if we don't already have them
                        // and if we have the necessary data to request them
                        fetchComparableCompanies(data.industry, data.sector, data.name);
                    }
                } else {
                    // Hide the description section if no description is available
                    const companyDescriptionEl = document.getElementById('companyDescription');
                    if (companyDescriptionEl) {
                        companyDescriptionEl.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error updating company description:', error);
                displayMessage(`Error displaying company information: ${error.message}`, 'error');
            }
        }

        // Function to display revenue breakdown data
        function displayRevenueBreakdown(data) {
            // Get the required elements
            const segmentTableBody = document.getElementById('segmentTableBody');
            const regionTableBody = document.getElementById('regionTableBody');
            const segmentView = document.getElementById('segmentView');
            const regionView = document.getElementById('regionView');
            const revenueBreakdownNoData = document.getElementById('revenueBreakdownNoData');
            const revenueBreakdownLoading = document.getElementById('revenueBreakdownLoading');
            
            if (!segmentTableBody || !regionTableBody) return;
            
            // Clear existing content
            segmentTableBody.innerHTML = '';
            regionTableBody.innerHTML = '';
            
            // Hide loading and no data message
            revenueBreakdownLoading.classList.add('hidden');
            revenueBreakdownNoData.classList.add('hidden');
            
            // Show segment view by default
            segmentView.classList.remove('hidden');
            
            // Check if we have segment data
            if (data.segments && data.segments.length > 0) {
                // Populate segment table
                data.segments.forEach(segment => {
                    const row = document.createElement('tr');
                    row.className = 'border-t border-gray-200 dark:border-gray-700';
                    
                    // Segment name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200';
                    nameCell.textContent = segment.name;
                    row.appendChild(nameCell);
                    
                    // Revenue cell
                    const revenueCell = document.createElement('td');
                    revenueCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                    revenueCell.textContent = formatFinancialNumber(segment.revenue, false, '$');
                    row.appendChild(revenueCell);
                    
                    // Percentage cell
                    const percentageCell = document.createElement('td');
                    percentageCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                    percentageCell.textContent = `${segment.percentage.toFixed(1)}%`;
                    row.appendChild(percentageCell);
                    
                    segmentTableBody.appendChild(row);
                });
                
                // Create segment pie chart
                createPieChart('segmentChart', data.segments);
            }
            
            // Check if we have region data
            if (data.regions && data.regions.length > 0) {
                // Populate region table
                data.regions.forEach(region => {
                    const row = document.createElement('tr');
                    row.className = 'border-t border-gray-200 dark:border-gray-700';
                    
                    // Region name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200';
                    nameCell.textContent = region.name;
                    row.appendChild(nameCell);
                    
                    // Revenue cell
                    const revenueCell = document.createElement('td');
                    revenueCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                    revenueCell.textContent = formatFinancialNumber(region.revenue, false, '$');
                    row.appendChild(revenueCell);
                    
                    // Percentage cell
                    const percentageCell = document.createElement('td');
                    percentageCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                    percentageCell.textContent = `${region.percentage.toFixed(1)}%`;
                    row.appendChild(percentageCell);
                    
                    regionTableBody.appendChild(row);
                });
                
                // Create region pie chart
                createPieChart('regionChart', data.regions);
            }
        }

        // Function to create a pie chart
        function createPieChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Define some nice colors for the pie chart
            const backgroundColors = [
                'rgba(93, 92, 222, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(199, 199, 199, 0.8)'
            ];
            
            // Prepare data for the chart
            const labels = data.map(item => item.name);
            const values = data.map(item => item.revenue);
            const percentages = data.map(item => item.percentage);
            
            // Create or update the chart
            if (window.charts && window.charts[canvasId]) {
                // Update existing chart
                window.charts[canvasId].data.labels = labels;
                window.charts[canvasId].data.datasets[0].data = values;
                window.charts[canvasId].update();
            } else {
                // Create new chart
                if (!window.charts) window.charts = {};
                
                window.charts[canvasId] = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: backgroundColors.slice(0, data.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 11
                                    },
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.8)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = formatFinancialNumber(context.raw, false, '$');
                                        const percentage = percentages[context.dataIndex].toFixed(1) + '%';
                                        return `${label}: ${value} (${percentage})`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Toggle between segment and region views
        document.getElementById('segmentViewBtn').addEventListener('click', function() {
            document.getElementById('segmentView').classList.remove('hidden');
            document.getElementById('regionView').classList.add('hidden');
            
            // Update button styles
            this.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            this.classList.add('bg-primary', 'text-white');
            
            document.getElementById('regionViewBtn').classList.remove('bg-primary', 'text-white');
            document.getElementById('regionViewBtn').classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            
            // Redraw the chart in case dark mode changed
            if (window.charts && window.charts['segmentChart']) {
                window.charts['segmentChart'].update();
            }
        });
        
        document.getElementById('regionViewBtn').addEventListener('click', function() {
            document.getElementById('regionView').classList.remove('hidden');
            document.getElementById('segmentView').classList.add('hidden');
            
            // Update button styles
            this.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            this.classList.add('bg-primary', 'text-white');
            
            document.getElementById('segmentViewBtn').classList.remove('bg-primary', 'text-white');
            document.getElementById('segmentViewBtn').classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
            
            // Redraw the chart in case dark mode changed
            if (window.charts && window.charts['regionChart']) {
                window.charts['regionChart'].update();
            }
        });

        // Function to update table headers with years and fiscal year end
        function updateTableHeaders(data) {
            const yearEnd = data.fiscalYearEnd;
            const years = data.years;
            
            // Income statement headers
            for (let i = 0; i < Math.min(years.length, 4); i++) {
                const element = document.getElementById(`income-year-${i+1}`);
                if (element) {
                    element.textContent = `${yearEnd}, ${years[i]}`;
                }
            }
            
            // Balance sheet headers
            for (let i = 0; i < Math.min(years.length, 4); i++) {
                const element = document.getElementById(`balance-year-${i+1}`);
                if (element) {
                    element.textContent = `${yearEnd}, ${years[i]}`;
                }
            }
            
            // Cash flow headers
            for (let i = 0; i < Math.min(years.length, 4); i++) {
                const element = document.getElementById(`cashflow-year-${i+1}`);
                if (element) {
                    element.textContent = `${yearEnd}, ${years[i]}`;
                }
            }
            
            // Update year range in headers
            if (years.length > 0) {
                const lastIndex = Math.min(years.length - 1, 3);
                document.getElementById('incomeYearRange').textContent = `(${years[lastIndex]}-${years[0]})`;
                document.getElementById('balanceYearRange').textContent = `(${years[lastIndex]}-${years[0]})`;
                document.getElementById('cashflowYearRange').textContent = `(${years[lastIndex]}-${years[0]})`;
                
                if (document.getElementById('valuationYearRange')) {
                    document.getElementById('valuationYearRange').textContent = `(${years[lastIndex]}-${years[0]})`;
                }
            }
            
            // Format unit display correctly based on currencyUnit
            let unitDisplay = '';
            if (data.currencyUnit.toLowerCase() === 'millions') {
                unitDisplay = '(000,000s)';
            } else if (data.currencyUnit.toLowerCase() === 'billions') {
                unitDisplay = '(000,000,000s)';
            } else if (data.currencyUnit.toLowerCase() === 'thousands') {
                unitDisplay = '(000s)';
            } else {
                unitDisplay = `(${data.currencyUnit})`;
            }

            // Update all currency unit elements
            const currencyUnitElements = [
                document.getElementById('incomeCurrencyUnit'),
                document.getElementById('balanceCurrencyUnit'),
                document.getElementById('cashflowCurrencyUnit')
            ];
            
            if (document.getElementById('valuationCurrencyUnit')) {
                currencyUnitElements.push(document.getElementById('valuationCurrencyUnit'));
            }
            
            currencyUnitElements.forEach(element => {
                if (element) {
                    element.textContent = `All figures in ${data.currencyUnit} ${data.currencySymbol}${unitDisplay}`;
                }
            });
            
            // Set projection years based on the most recent year
            if (years.length > 0 && document.getElementById('proj-year-0')) {
                const baseYear = years[0];
                const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 5;
                
                // Update historical year
                document.getElementById('proj-year-0').textContent = `${yearEnd}, ${baseYear}`;
                
                // Update projection years
                for (let i = 1; i <= forecastPeriod; i++) {
                    const projYear = document.getElementById(`proj-year-${i}`);
                    if (projYear) {
                        projYear.textContent = `${yearEnd}, ${baseYear + i}`;
                    }
                }
            }
        }

        // Function to populate tables with financial data
        function populateFinancialTables(data) {
            // Populate income statement
            const incomeBody = document.getElementById('incomeStatementBody');
            incomeBody.innerHTML = '';
            
            incomeStatementStructure.forEach(item => {
                const row = document.createElement('tr');
                row.className = `border-t border-gray-300 dark:border-gray-700 ${item.cssClass}`;
                
                if (item.isSection && item.colspan) {
                    // Section header row with colspan
                    const cell = document.createElement('td');
                    cell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200 font-medium';
                    cell.colSpan = 5; // Updated to accommodate 4 years
                    cell.textContent = item.label;
                    row.appendChild(cell);
                } else {
                    // Regular row
                    const labelCell = document.createElement('td');
                    labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 font-medium ${item.isTotal ? 'py-3' : ''}`;
                    labelCell.textContent = item.label;
                    row.appendChild(labelCell);
                    
                    // Add up to 4 years of data
                    for (let i = 0; i < Math.min(data.years.length, 4); i++) {
                        const valueCell = document.createElement('td');
                        valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                        
                        const values = data.incomeStatement[item.label];
                        valueCell.textContent = values && values[i] ? values[i] : '-';
                        
                        row.appendChild(valueCell);
                    }
                }
                
                incomeBody.appendChild(row);
            });
            
            // Populate balance sheet
            const balanceBody = document.getElementById('balanceSheetBody');
            balanceBody.innerHTML = '';
            
            balanceSheetStructure.forEach(item => {
                const row = document.createElement('tr');
                row.className = `border-t border-gray-300 dark:border-gray-700 ${item.cssClass}`;
                
                if (item.isSection && item.colspan) {
                    // Section header row with colspan
                    const cell = document.createElement('td');
                    cell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200 font-medium';
                    cell.colSpan = 5; // Updated to accommodate 4 years
                    cell.textContent = item.label;
                    row.appendChild(cell);
                } else {
                    // Regular row
                    const labelCell = document.createElement('td');
                    labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                    labelCell.textContent = item.label;
                    row.appendChild(labelCell);
                    
                    // Add up to 4 years of data
                    for (let i = 0; i < Math.min(data.years.length, 4); i++) {
                        const valueCell = document.createElement('td');
                        valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                        
                        const values = data.balanceSheet[item.label];
                        valueCell.textContent = values && values[i] ? values[i] : '-';
                        
                        row.appendChild(valueCell);
                    }
                }
                
                balanceBody.appendChild(row);
            });
            
            // Populate cash flow
            const cashFlowBody = document.getElementById('cashFlowBody');
            cashFlowBody.innerHTML = '';
            
            cashFlowStructure.forEach(item => {
                const row = document.createElement('tr');
                row.className = `border-t border-gray-300 dark:border-gray-700 ${item.cssClass}`;
                
                if (item.isSection && item.colspan) {
                    // Section header row with colspan
                    const cell = document.createElement('td');
                    cell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200 font-medium';
                    cell.colSpan = 5; // Updated to accommodate 4 years
                    cell.textContent = item.label;
                    row.appendChild(cell);
                } else {
                    // Regular row
                    const labelCell = document.createElement('td');
                    labelCell.className = `py-2 px-4 text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                    labelCell.textContent = item.label;
                    row.appendChild(labelCell);
                    
                    // Add up to 4 years of data
                    for (let i = 0; i < Math.min(data.years.length, 4); i++) {
                        const valueCell = document.createElement('td');
                        valueCell.className = `py-2 px-4 text-right text-gray-800 dark:text-gray-200 ${item.isTotal ? 'font-medium py-3' : ''}`;
                        
                        const values = data.cashFlow[item.label];
                        valueCell.textContent = values && values[i] ? values[i] : '-';
                        
                        row.appendChild(valueCell);
                    }
                }
                
                cashFlowBody.appendChild(row);
            });
            
            // Show data sources note
            const sourceNotes = document.querySelectorAll('#incomeDataSource, #balanceDataSource, #cashFlowDataSource');
            sourceNotes.forEach(note => note.classList.remove('hidden'));
        }

        // Function to analyze financial data using AI
        async function analyzeFinancialData() {
            try {
                // Check if we have financial data to analyze
                if (!dataStore.financials || !dataStore.financials.incomeStatement) {
                    displayMessage("No financial data available to analyze. Please fetch financial data first.", "error");
                    return;
                }
                
                // Show loading indicator
                document.getElementById('aiAnalysisLoading').classList.remove('hidden');
                document.getElementById('aiAnalysisResults').classList.add('hidden');
                
                // Get the selected model from the dropdown
                const modelType = getSelectedModel('financials');
                const modelName = modelType === 'pro' ? 'Gemini-2.5-Pro-Exp' : 'Gemini-2.5-Flash-Preview';
                
                displayMessage(`Analyzing financial data for ${dataStore.currentTicker}...`, "info");
                
                // Register handler for financial analysis
                const handlerId = `financialAnalysis-${Date.now()}`;
                
                // Create a Promise for handling the response
                const responsePromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.responses[0]?.statusText || "Error analyzing financial data"));
                            return;
                        }
                        
                        if (result.status === "complete") {
                            const response = result.responses[0];
                            try {
                                // Parse the JSON data from the model's response
                                const responseText = response.content;
                                let analysisData;
                                
                                // Extract JSON data from the response
                                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                                responseText.match(/```([\s\S]*?)```/);
                                                
                                if (jsonMatch && jsonMatch[1]) {
                                    analysisData = JSON.parse(jsonMatch[1]);
                                } else {
                                    // Try to extract a JSON object without code blocks
                                    const jsonPattern = /\{[\s\S]*\}/;
                                    const match = responseText.match(jsonPattern);
                                    if (match) {
                                        try {
                                            analysisData = JSON.parse(match[0]);
                                        } catch (e) {
                                            // If JSON parsing fails, use the full response as markdown
                                            analysisData = {
                                                revenueTrends: responseText,
                                                profitability: responseText,
                                                balanceSheet: responseText,
                                                cashFlow: responseText,
                                                keyInsights: responseText
                                            };
                                        }
                                    } else {
                                        // If no JSON found, use the full response as markdown
                                        analysisData = {
                                            revenueTrends: responseText,
                                            profitability: responseText,
                                            balanceSheet: responseText,
                                            cashFlow: responseText,
                                            keyInsights: responseText
                                        };
                                    }
                                }
                                
                                resolve(analysisData);
                            } catch (error) {
                                console.error("Error parsing financial analysis:", error);
                                reject(new Error("Failed to parse analysis data: " + error.message));
                            }
                        }
                    });
                });
                
                // Prepare the financial data to send to the AI
                const financialData = dataStore.financials;
                const company = financialData.name || dataStore.currentTicker;
                
                // Create a simplified version of the financial data for the prompt
                const simplifiedData = {
                    name: company,
                    years: financialData.years,
                    incomeStatement: financialData.incomeStatement,
                    balanceSheet: financialData.balanceSheet,
                    cashFlow: financialData.cashFlow
                };
                
                // Construct prompt for AI to analyze financial data
                const botName = modelType === 'pro' ? '@Gemini-2.5-Pro-Exp' : '@Gemini-2.5-Flash-Preview';
                
                const prompt = `${botName} 
        I need a comprehensive financial analysis for ${company} based on the following financial data. Please analyze historical trends, key drivers of performance, and overall financial health. Return your analysis in this JSON format:

        \`\`\`json
        {
        "revenueTrends": "Detailed markdown analysis of revenue trends, growth rates, and potential drivers of revenue changes over the historical period. Include growth rates and potential reasons for fluctuations.",
        
        "profitability": "Markdown analysis of profitability metrics like gross margins, operating margins, and net margins. Identify trends and any notable changes in profitability measures.",
        
        "balanceSheet": "Markdown analysis of balance sheet health including liquidity, leverage ratios, and overall financial stability. Comment on asset growth, debt levels, and equity changes.",
        
        "cashFlow": "Markdown analysis of cash flow from operations, investing, and financing activities. Comment on operating cash flow conversion, capex intensity, and financing decisions.",
        
        "keyInsights": "Markdown summary of key insights, potential red flags, and overall financial assessment. Include 3-5 bullet points of key takeaways and recommendations for further investigation."
        }
        \`\`\`

        Here's the financial data to analyze (all figures in ${financialData.currencyUnit}, ${financialData.currencySymbol}):

        ${JSON.stringify(simplifiedData, null, 2)}

        Focus on identifying clear trends, calculating year-over-year growth rates, and spotting any unusual fluctuations or potential concerns. When appropriate, compare metrics to industry averages or benchmarks. Use bullet points and lists for clarity, and include calculated growth rates, ratios and percentages to support your analysis.`;
                
                // Send prompt to analyze financial data
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    openChat: false
                });
                
                // Wait for the response
                const analysisData = await responsePromise;
                
                // Update the UI with the analysis results
                updateFinancialAnalysis(analysisData);
                
                // Hide loading indicator and show results
                document.getElementById('aiAnalysisLoading').classList.add('hidden');
                document.getElementById('aiAnalysisResults').classList.remove('hidden');
                
                // Show success message
                displayMessage(`Successfully analyzed financial data for ${company}.`, "success");
                
                return analysisData;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('aiAnalysisLoading').classList.add('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to analyze financial data. ${error.message}`, "error");
                
                throw error;
            }
        }

        // Function to update the UI with financial analysis results
        function updateFinancialAnalysis(analysis) {
            // Update revenue trends
            if (analysis.revenueTrends) {
                document.getElementById('revenueTrendsText').innerHTML = marked.parse(analysis.revenueTrends);
            }
            
            // Update profitability analysis
            if (analysis.profitability) {
                document.getElementById('profitabilityText').innerHTML = marked.parse(analysis.profitability);
            }
            
            // Update balance sheet analysis
            if (analysis.balanceSheet) {
                document.getElementById('balanceSheetText').innerHTML = marked.parse(analysis.balanceSheet);
            }
            
            // Update cash flow analysis
            if (analysis.cashFlow) {
                document.getElementById('cashFlowText').innerHTML = marked.parse(analysis.cashFlow);
            }
            
            // Update key insights
            if (analysis.keyInsights) {
                document.getElementById('keyInsightsText').innerHTML = marked.parse(analysis.keyInsights);
            }
        }
        // Helper function to update return values with color coding
        function updateReturnValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (value === "N/A") {
                element.textContent = "N/A";
                element.className = "py-2 text-right font-medium text-gray-500 dark:text-gray-400";
                return;
            }
            
            const numValue = parseFloat(value);
            const isPositive = numValue >= 0;
            element.textContent = `${isPositive ? '+' : ''}${numValue}%`;
            element.className = `py-2 text-right font-medium ${isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`;
        }

        // Function to calculate compound annual growth rate (CAGR)
        function calculateCAGR(startValue, endValue, years) {
            // Handle edge cases
            if (startValue <= 0 || years === 0) return 0;
            
            // Formula: (endValue / startValue) ^ (1 / years) - 1
            return Math.pow(endValue / startValue, 1 / years) - 1;
        }

        // Function to update shares outstanding and net debt info
        function updateCompanyInfo(data) {
            const sharesInfo = document.getElementById('sharesInfo');
            const debtInfo = document.getElementById('debtInfo');
            
            if (!sharesInfo || !debtInfo) return;
            
            // Update shares outstanding - using the actual number (already in millions of shares)
            if (data.sharesOutstanding) {
                // Format with commas and 2 decimal places if it's a small number, otherwise no decimals
                const formattedShares = data.sharesOutstanding < 100 ? 
                    data.sharesOutstanding.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 
                    data.sharesOutstanding.toLocaleString(undefined, {maximumFractionDigits: 0});
                    
                sharesInfo.textContent = `${formattedShares} million shares`;
            } else {
                sharesInfo.textContent = '-';
            }
            
            // Calculate and update net debt
            const shortTermDebt = parseFinancialNumber(data.balanceSheet['Short-term Debt'] ? data.balanceSheet['Short-term Debt'][0] : '0');
            const longTermDebt = parseFinancialNumber(data.balanceSheet['Long-term Debt'] ? data.balanceSheet['Long-term Debt'][0] : '0');
            const cash = parseFinancialNumber(data.balanceSheet['Cash & Equivalents'] ? data.balanceSheet['Cash & Equivalents'][0] : '0');
            const netDebt = shortTermDebt + longTermDebt - cash;
            
            // Create tooltip with the calculation details
            const tooltipText = `Total Debt (${formatFinancialNumber(shortTermDebt + longTermDebt, false, data.currencySymbol)}) - Cash (${formatFinancialNumber(cash, false, data.currencySymbol)})`;
            
            // Format netDebt with appropriate sign
            const formattedNetDebt = formatFinancialNumber(netDebt, netDebt > 0, data.currencySymbol);
            
            // Create a more informative output with the unit
            debtInfo.innerHTML = `<span title="${tooltipText}">${formattedNetDebt} million</span>`;
            
            // Store these values for DCF calculations
            data.netDebt = netDebt;
        }

        // Calculate and display historical metrics
        function displayHistoricalMetrics(data) {
            const revenueCagr = document.getElementById('revenueCagr');
            const avgOperatingMargin = document.getElementById('avgOperatingMargin');
            const avgCapex = document.getElementById('avgCapex');
            const effectiveTaxRate = document.getElementById('effectiveTaxRate');
            
            if (!revenueCagr || !avgOperatingMargin || !avgCapex || !effectiveTaxRate) return;
            
            // Calculate revenue CAGR
            let revenueValues = [];
            for (let i = 0; i < (data.incomeStatement['Revenue'] ? data.incomeStatement['Revenue'].length : 0); i++) {
                revenueValues.push(parseFinancialNumber(data.incomeStatement['Revenue'][i]));
            }
            
            let cagr = 0;
            if (revenueValues.length >= 2) {
                const years = Math.min(revenueValues.length - 1, 3);
                cagr = calculateCAGR(revenueValues[years], revenueValues[0], years);
            }
            revenueCagr.textContent = (cagr * 100).toFixed(2) + '%';
            
            // Calculate average operating margin
            let opMargins = [];
            for (let i = 0; i < (data.incomeStatement['Operating Income'] ? data.incomeStatement['Operating Income'].length : 0); i++) {
                const opIncome = parseFinancialNumber(data.incomeStatement['Operating Income'][i]);
                const revenue = parseFinancialNumber(data.incomeStatement['Revenue'][i]);
                if (revenue !== 0) {
                    opMargins.push(opIncome / revenue);
                }
            }
            
            const avgOpMargin = opMargins.length > 0 ? 
                opMargins.reduce((sum, margin) => sum + margin, 0) / opMargins.length : 0;
            avgOperatingMargin.textContent = (avgOpMargin * 100).toFixed(2) + '%';
            
            // Calculate average CapEx as % of revenue
            let capexRatios = [];
            for (let i = 0; i < (data.cashFlow['Capital Expenditures'] ? data.cashFlow['Capital Expenditures'].length : 0); i++) {
                const capex = Math.abs(parseFinancialNumber(data.cashFlow['Capital Expenditures'][i]));
                const revenue = parseFinancialNumber(data.incomeStatement['Revenue'][i]);
                if (revenue !== 0) {
                    capexRatios.push(capex / revenue);
                }
            }
            
            const avgCapexValue = capexRatios.length > 0 ?
                capexRatios.reduce((sum, ratio) => sum + ratio, 0) / capexRatios.length : 0.05;
            avgCapex.textContent = (avgCapexValue * 100).toFixed(2) + '%';
            
            // Calculate effective tax rate - fixing this to use pretax income instead of operating income
            // Also adding safeguards against unrealistic tax rates
            let taxRates = [];
            const MAX_REASONABLE_TAX_RATE = 0.40; // 40% as a reasonable maximum
            const DEFAULT_TAX_RATE = 0.25; // 25% as a sensible default
            
            for (let i = 0; i < (data.incomeStatement['Tax Expense'] ? data.incomeStatement['Tax Expense'].length : 0); i++) {
                const taxExpense = Math.abs(parseFinancialNumber(data.incomeStatement['Tax Expense'][i]));
                
                // Calculate pretax income (operating income + other income)
                const opIncome = parseFinancialNumber(data.incomeStatement['Operating Income'][i]);
                const otherIncome = data.incomeStatement['Other Income'] ? 
                    parseFinancialNumber(data.incomeStatement['Other Income'][i]) : 0;
                
                // Pretax income
                const pretaxIncome = opIncome + otherIncome;
                
                if (pretaxIncome > 0) {
                    // Cap individual year tax rates at a reasonable maximum
                    const yearTaxRate = Math.min(taxExpense / pretaxIncome, MAX_REASONABLE_TAX_RATE);
                    taxRates.push(yearTaxRate);
                }
            }
            
            // Calculate average tax rate with fallbacks for unusual situations
            let avgTaxRate;
            if (taxRates.length > 0) {
                // First, calculate the simple average
                const simpleAvg = taxRates.reduce((sum, rate) => sum + rate, 0) / taxRates.length;
                
                // Check if the average is reasonable
                if (simpleAvg <= MAX_REASONABLE_TAX_RATE) {
                    avgTaxRate = simpleAvg;
                } else {
                    // If not reasonable, use the median instead of mean to avoid outlier influence
                    const sortedRates = [...taxRates].sort((a, b) => a - b);
                    const medianIdx = Math.floor(sortedRates.length / 2);
                    avgTaxRate = sortedRates.length % 2 === 0 
                        ? (sortedRates[medianIdx - 1] + sortedRates[medianIdx]) / 2 
                        : sortedRates[medianIdx];
                        
                    // If median is still too high, fall back to default
                    if (avgTaxRate > MAX_REASONABLE_TAX_RATE) {
                        avgTaxRate = DEFAULT_TAX_RATE;
                    }
                }
            } else {
                // Default when no valid tax rates are available
                avgTaxRate = DEFAULT_TAX_RATE;
            }
                
            effectiveTaxRate.textContent = (avgTaxRate * 100).toFixed(2) + '%';
            
            // Update input field values based on historical metrics
            document.getElementById('revenueGrowthRate').value = (cagr * 100).toFixed(1);
            document.getElementById('operatingMargin').value = (avgOpMargin * 100).toFixed(1);
            document.getElementById('taxRate').value = (avgTaxRate * 100).toFixed(1);
            document.getElementById('capexRate').value = (avgCapexValue * 100).toFixed(1);
        }

        // Function to calculate DCF valuation
        function calculateValuation() {
            try {
                // Get user inputs
                const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 5;
                const revenueGrowthRateInput = parseFloat(document.getElementById('revenueGrowthRate').value) / 100 || 0.05;
                const marketGrowthRateInput = parseFloat(document.getElementById('marketGrowthRate').value) / 100 || 0.05;
                const operatingMargin = parseFloat(document.getElementById('operatingMargin').value) / 100 || 0.2;
                const taxRate = parseFloat(document.getElementById('taxRate').value) / 100 || 0.25;
                const capexRate = parseFloat(document.getElementById('capexRate').value) / 100 || 0.05;
                const wcRate = parseFloat(document.getElementById('wcRate').value) / 100 || 0.1;
                const terminalGrowthRate = parseFloat(document.getElementById('terminalGrowthRate').value) / 100 || 0.02;
                const discountRate = parseFloat(document.getElementById('discountRate').value) / 100 || 0.1;
                const evMultiple = parseFloat(document.getElementById('evMultiple').value) || 12;
                // blend company and market growth rates (e.g., average or weighted)
                const blendedGrowthRate = (revenueGrowthRateInput + marketGrowthRateInput) / 2;
                
                // Get current financial data from valuation data store
                const data = dataStore.valuation;
                if (!data || !data.incomeStatement || !data.incomeStatement['Revenue']) {
                    displayMessage('No financial data available for valuation. Please fetch company data first.', 'error');
                    return;
                }
                
                // Note: sharesOutstanding is in millions, we need to account for this in the final calculation
                const sharesOutstanding = data.sharesOutstanding || 1000; // Default if not available
                const netDebt = data.netDebt || 0;
                const baseRevenue = parseFinancialNumber(data.incomeStatement['Revenue'][0]);
                
                // Use historical operating margin if available, otherwise use input value
                let historicalOperatingMargin = operatingMargin;
                if (data.incomeStatement['Operating Income'] && data.incomeStatement['Revenue']) {
                    const opIncome = parseFinancialNumber(data.incomeStatement['Operating Income'][0]);
                    const revenue = parseFinancialNumber(data.incomeStatement['Revenue'][0]);
                    if (revenue > 0) {
                        historicalOperatingMargin = opIncome / revenue;
                    }
                }
                
                // Project revenue and free cash flow for the forecast period
                const projections = [];
                
                // Assume depreciation is proportional to CapEx (typically 1.0-1.2x CapEx)
                const depreciationRate = capexRate * 1.1;
                
                // Historical year (most recent)
                const historicalData = {
                    year: 'Historical',
                    revenue: baseRevenue,
                    revenueGrowth: 0, // No growth for historical
                    operatingIncome: baseRevenue * historicalOperatingMargin,
                    operatingMargin: historicalOperatingMargin * 100,
                    depreciation: baseRevenue * depreciationRate,
                    ebitda: baseRevenue * historicalOperatingMargin + (baseRevenue * depreciationRate),
                    ebitdaMargin: (historicalOperatingMargin + depreciationRate) * 100,
                    taxes: baseRevenue * historicalOperatingMargin * taxRate,
                    taxRate: taxRate * 100,
                    nopat: baseRevenue * historicalOperatingMargin * (1 - taxRate),
                    capex: baseRevenue * capexRate,
                    capexRatio: capexRate * 100,
                    workingCapital: baseRevenue * wcRate,
                    workingCapitalChange: 0, // No change for historical
                    workingCapitalRatio: wcRate * 100,
                    // Fixed FCF calculation to include depreciation add-back
                    fcf: baseRevenue * historicalOperatingMargin * (1 - taxRate) + (baseRevenue * depreciationRate) - (baseRevenue * capexRate),
                    fcfMargin: (historicalOperatingMargin * (1 - taxRate) + depreciationRate - capexRate) * 100,
                    discountFactor: 1.0, // No discounting for historical
                    presentValueFCF: 0 // Not relevant for historical
                };
                projections.push(historicalData);
                
                // Projection years
                let previousYearRevenue = baseRevenue;
                let previousYearWC = baseRevenue * wcRate;
                let cumulativePV = 0;
                
                for (let i = 1; i <= forecastPeriod; i++) {
                    const revenue = previousYearRevenue * (1 + blendedGrowthRate);
                    const revenueGrowth = ((revenue / previousYearRevenue) - 1) * 100;
                    const operatingIncome = revenue * operatingMargin;
                    const operatingMarginPct = operatingMargin * 100;
                    const depreciation = revenue * depreciationRate;
                    const ebitda = operatingIncome + depreciation;
                    const ebitdaMargin = (ebitda / revenue) * 100;
                    const taxes = operatingIncome * taxRate;
                    const taxRatePct = taxRate * 100;
                    const nopat = operatingIncome * (1 - taxRate);
                    const capex = revenue * capexRate;
                    const capexRatio = capexRate * 100;
                    const workingCapital = revenue * wcRate;
                    const workingCapitalRatio = wcRate * 100;
                    const workingCapitalChange = workingCapital - previousYearWC;
                    
                    // Free Cash Flow calculation
                    // FCF = NOPAT + D&A - CapEx - Working Capital
                    const fcf = nopat + depreciation - capex - workingCapitalChange;
                    const fcfMargin = (fcf / revenue) * 100;
                    
                    // Discounting calculation
                    const discountFactor = Math.pow(1 + discountRate, i);
                    const presentValueFCF = fcf / discountFactor;
                    cumulativePV += presentValueFCF;
                    
                    projections.push({
                        year: `Year ${i}`,
                        revenue,
                        revenueGrowth,
                        operatingIncome,
                        operatingMargin: operatingMarginPct,
                        depreciation,
                        ebitda,
                        ebitdaMargin,
                        taxes,
                        taxRate: taxRatePct,
                        nopat,
                        capex,
                        capexRatio,
                        workingCapital,
                        workingCapitalRatio,
                        workingCapitalChange,
                        fcf,
                        fcfMargin,
                        discountFactor,
                        presentValueFCF,
                        cumulativePV
                    });
                    
                    previousYearRevenue = revenue;
                    previousYearWC = workingCapital;
                }
                
                // Calculate terminal value - adjust to be more conservative
                const finalYearFcf = projections[forecastPeriod].fcf;
                
                // Fix: Check if discount rate is greater than growth rate to avoid divide by zero
                // or negative denominator in Gordon Growth Model
                let terminalValueDCF = 0;
                if (discountRate > terminalGrowthRate) {
                    terminalValueDCF = finalYearFcf * (1 + terminalGrowthRate) / (discountRate - terminalGrowthRate);
                } else {
                    // If discount rate <= growth rate, use a high multiple as fallback
                    terminalValueDCF = finalYearFcf * 20;
                }
                
                // Calculate terminal value using EBITDA multiple
                const finalYearEBITDA = projections[forecastPeriod].operatingIncome;
                const terminalValueMultiple = finalYearEBITDA * evMultiple;
                
                // Add terminal values to projections
                projections.push({
                    year: 'Terminal',
                    revenue: projections[forecastPeriod].revenue * (1 + terminalGrowthRate),
                    operatingIncome: projections[forecastPeriod].operatingIncome * (1 + terminalGrowthRate),
                    taxes: projections[forecastPeriod].taxes * (1 + terminalGrowthRate),
                    nopat: projections[forecastPeriod].nopat * (1 + terminalGrowthRate),
                    terminalValueDCF,
                    terminalValueMultiple
                });
                
                // Calculate present value of each cash flow
                let enterpriseValueDCF = 0;
                let enterpriseValueMultiple = 0;
                
                // Discount each year's FCF and add to enterprise value
                for (let i = 1; i <= forecastPeriod; i++) {
                    const discountFactor = Math.pow(1 + discountRate, i);
                    enterpriseValueDCF += projections[i].fcf / discountFactor;
                    enterpriseValueMultiple += projections[i].fcf / discountFactor;
                }
                
                // Add discounted terminal values
                const terminalDiscountFactor = Math.pow(1 + discountRate, forecastPeriod);
                enterpriseValueDCF += terminalValueDCF / terminalDiscountFactor;
                enterpriseValueMultiple += terminalValueMultiple / terminalDiscountFactor;
                
                // Calculate equity value and share price
                const equityValueDCF = enterpriseValueDCF - netDebt;
                const equityValueMultiple = enterpriseValueMultiple - netDebt;
                
                // Fix: The sharesOutstanding is in millions, so we don't need to divide by millions again
                // for share price. Simply divide equity value by shares outstanding.
                const sharePriceDCF = equityValueDCF / sharesOutstanding;
                const sharePriceMultiple = equityValueMultiple / sharesOutstanding;
                
                // Update the valuation results in the UI
                document.getElementById('enterpriseValueDCF').textContent = formatFinancialNumber(enterpriseValueDCF, false, data.currencySymbol) + ' million';
                document.getElementById('enterpriseValueMultiple').textContent = formatFinancialNumber(enterpriseValueMultiple, false, data.currencySymbol) + ' million';
                
                document.getElementById('equityValueDCF').textContent = formatFinancialNumber(equityValueDCF, false, data.currencySymbol) + ' million';
                document.getElementById('equityValueMultiple').textContent = formatFinancialNumber(equityValueMultiple, false, data.currencySymbol) + ' million';
                
                document.getElementById('sharePriceDCF').textContent = `${data.currencySymbol}${sharePriceDCF.toFixed(2)}`;
                document.getElementById('sharePriceMultiple').textContent = `${data.currencySymbol}${sharePriceMultiple.toFixed(2)}`;
                
                // Populate projections table
                populateProjectionsTable(projections, data.currencySymbol);
                
                // Display message about the valuation
                displayMessage(`DCF valuation complete. Target price: ${data.currencySymbol}${sharePriceDCF.toFixed(2)} (DCF method) and ${data.currencySymbol}${sharePriceMultiple.toFixed(2)} (Multiple method).`, 'success');
                
                // Return the results for any further processing
                return {
                    enterpriseValueDCF,
                    enterpriseValueMultiple,
                    equityValueDCF,
                    equityValueMultiple,
                    sharePriceDCF,
                    sharePriceMultiple,
                    projections
                };
            } catch (error) {
                console.error('Error calculating valuation:', error);
                displayMessage('Error calculating valuation: ' + error.message, 'error');
            }
        }
        
        // Function to populate projections table
        function populateProjectionsTable(projections, currencySymbol) {
            const projectionBody = document.getElementById('projectionBody');
            const marginMetricsBody = document.getElementById('marginMetricsBody');
            
            // Clear both tables
            projectionBody.innerHTML = '';
            marginMetricsBody.innerHTML = '';
            
            // Add Enterprise Value calculations to the footer
            const projectionSummary = document.getElementById('projectionSummary');
            projectionSummary.innerHTML = '';
            
            // Define the row groups and rows we want to display in the main cash flow table (no percentages)
            const cashFlowRows = [
                {
                    title: 'Revenue & Growth',
                    isSection: true,
                    rows: [
                        { label: 'Revenue', key: 'revenue', isTotal: false }
                    ]
                },
                {
                    title: 'Profitability',
                    isSection: true,
                    rows: [
                        { label: 'EBITDA', key: 'ebitda', isTotal: false },
                        { label: 'Operating Income', key: 'operatingIncome', isTotal: false },
                        { label: 'Taxes', key: 'taxes', isTotal: false, isNegative: true },
                        { label: 'NOPAT', key: 'nopat', isTotal: true }
                    ]
                },
                {
                    title: 'Capital Investments',
                    isSection: true,
                    rows: [
                        { label: 'Depreciation & Amortization', key: 'depreciation', isTotal: false },
                        { label: 'Capital Expenditures', key: 'capex', isTotal: false, isNegative: true },
                        { label: 'Working Capital', key: 'workingCapital', isTotal: false },
                        { label: 'Working Capital Change', key: 'workingCapitalChange', isTotal: false }
                    ]
                },
                {
                    title: 'Free Cash Flow',
                    isSection: true,
                    rows: [
                        { label: 'Free Cash Flow', key: 'fcf', isTotal: true, highlight: true },
                        { label: 'Discount Factor', key: 'discountFactor', isTotal: false },
                        { label: 'Present Value of FCF', key: 'presentValueFCF', isTotal: true },
                        { label: 'Cumulative PV', key: 'cumulativePV', isTotal: true, skipHistorical: true }
                    ]
                },
                {
                    title: 'Terminal Value',
                    isSection: true,
                    rows: [
                        { label: 'Terminal Value (DCF)', key: 'terminalValueDCF', isTotal: true, terminalOnly: true },
                        { label: 'Terminal Value (Multiple)', key: 'terminalValueMultiple', isTotal: true, terminalOnly: true }
                    ]
                }
            ];
            
            // Define rows for the margin metrics table (only percentages)
            const marginRows = [
                { label: 'Revenue Growth Rate (%)', key: 'revenueGrowth', isTotal: false },
                { label: 'EBITDA Margin (%)', key: 'ebitdaMargin', isTotal: false },
                { label: 'Operating Margin (%)', key: 'operatingMargin', isTotal: false },
                { label: 'FCF Margin (%)', key: 'fcfMargin', isTotal: false },
                { label: 'CapEx as % of Revenue', key: 'capexRatio', isTotal: false },
                { label: 'Working Capital as % of Revenue', key: 'workingCapitalRatio', isTotal: false },
                { label: 'Tax Rate (%)', key: 'taxRate', isTotal: false }
            ];
            
            // Create each section and its rows for the main cash flow table
            cashFlowRows.forEach(group => {
                // Add section header
                if (group.isSection) {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-gray-100 dark:bg-gray-700 font-semibold';
                    
                    const th = document.createElement('th');
                    th.className = 'py-2 px-4 text-left text-gray-800 dark:text-gray-200';
                    th.colSpan = projections.length + 1; // +1 for the label column
                    th.textContent = group.title;
                    
                    tr.appendChild(th);
                    projectionBody.appendChild(tr);
                }
                
                // Add each row in the group
                group.rows.forEach(row => {
                    // Skip terminal-only rows if not needed
                    if (row.terminalOnly && !(row.key in projections[projections.length - 1])) {
                        return;
                    }
                    
                    const tr = document.createElement('tr');
                    let rowClass = 'border-t border-gray-300 dark:border-gray-700';
                    
                    if (row.isTotal) {
                        rowClass += ' bg-gray-50 dark:bg-gray-750 font-medium';
                    }
                    
                    if (row.highlight) {
                        rowClass += ' bg-blue-50 dark:bg-blue-900 font-semibold';
                    }
                    
                    tr.className = rowClass;
                    
                    // Add label cell
                    const labelCell = document.createElement('td');
                    labelCell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200';
                    labelCell.textContent = row.label;
                    tr.appendChild(labelCell);
                    
                    // Add value cells for each year
                    projections.forEach((projection, i) => {
                        const cell = document.createElement('td');
                        cell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                        
                        // Skip historical year for some metrics
                        if (row.skipHistorical && i === 0) {
                            cell.textContent = '-';
                        }
                        // Terminal-only values only appear in the last column
                        else if (row.terminalOnly && i < projections.length - 1) {
                            cell.textContent = '-';
                        } 
                        // Handle normal case
                        else if (projection[row.key] !== undefined) {
                            // For the working capital change, we don't have this for historical year
                            if (row.key === 'workingCapitalChange' && i === 0) {
                                cell.textContent = '-';
                            } else {
                                // Format financial values
                                cell.textContent = formatFinancialNumber(projection[row.key], row.isNegative, currencySymbol);
                            }
                        } else {
                            cell.textContent = '-';
                        }
                        
                        tr.appendChild(cell);
                    });
                    
                    projectionBody.appendChild(tr);
                });
            });
            
            // Add Enterprise Value and Equity Value calculations to the footer
            if (projections.length > 0) {
                // Calculate enterprise value as sum of all PV FCF plus terminal value
                const lastIdx = projections.length - 1;
                const terminalValueDCF = projections[lastIdx].terminalValueDCF || 0;
                const terminalValueMultiple = projections[lastIdx].terminalValueMultiple || 0;
                
                // Calculate PV of terminal value
                const lastYearDiscountFactor = projections[lastIdx-1].discountFactor || 1;
                const pvTerminalValueDCF = terminalValueDCF / lastYearDiscountFactor;
                const pvTerminalValueMultiple = terminalValueMultiple / lastYearDiscountFactor;
                
                // Sum of present values (excluding terminal)
                let sumPV = 0;
                for (let i = 1; i < lastIdx; i++) {
                    sumPV += projections[i].presentValueFCF || 0;
                }
                
                // Enterprise Value
                const evDCF = sumPV + pvTerminalValueDCF;
                const evMultiple = sumPV + pvTerminalValueMultiple;
                
                // Add Enterprise Value rows to the footer
                const evRow = document.createElement('tr');
                evRow.className = 'bg-gray-100 dark:bg-gray-700 font-semibold';
                
                // Add label cell
                const evLabelCell = document.createElement('td');
                evLabelCell.className = 'py-3 px-4 text-left text-gray-800 dark:text-gray-200';
                evLabelCell.textContent = 'Enterprise Value (DCF)';
                evRow.appendChild(evLabelCell);
                
                // Add value cell
                const evValueCell = document.createElement('td');
                evValueCell.className = 'py-3 px-4 text-right text-gray-800 dark:text-gray-200';
                evValueCell.colSpan = projections.length;
                evValueCell.textContent = formatFinancialNumber(evDCF, false, currencySymbol);
                evRow.appendChild(evValueCell);
                
                // Add row to footer
                projectionSummary.appendChild(evRow);
                
                // Add Multiple-based Enterprise Value
                const evMultipleRow = document.createElement('tr');
                evMultipleRow.className = 'bg-gray-100 dark:bg-gray-700 font-semibold';
                
                const evMultipleLabelCell = document.createElement('td');
                evMultipleLabelCell.className = 'py-2 px-4 text-left text-gray-800 dark:text-gray-200';
                evMultipleLabelCell.textContent = 'Enterprise Value (Multiple)';
                evMultipleRow.appendChild(evMultipleLabelCell);
                
                const evMultipleValueCell = document.createElement('td');
                evMultipleValueCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                evMultipleValueCell.colSpan = projections.length;
                evMultipleValueCell.textContent = formatFinancialNumber(evMultiple, false, currencySymbol);
                evMultipleRow.appendChild(evMultipleValueCell);
                
                projectionSummary.appendChild(evMultipleRow);
            }
            
            // Populate the margin metrics table
            marginRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-t border-gray-300 dark:border-gray-700';
                
                // Add label cell
                const labelCell = document.createElement('td');
                labelCell.className = 'py-2 px-4 text-gray-800 dark:text-gray-200';
                labelCell.textContent = row.label;
                tr.appendChild(labelCell);
                
                // Add percentage values for each year
                projections.forEach((projection, i) => {
                    const cell = document.createElement('td');
                    cell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                    
                    if (projection[row.key] !== undefined) {
                        // Format as percentage
                        cell.textContent = projection[row.key].toFixed(1) + '%';
                    } else {
                        cell.textContent = '-';
                    }
                    
                    tr.appendChild(cell);
                });
                
                marginMetricsBody.appendChild(tr);
            });
        }

        // Function to update the analyst consensus UI
        function updateAnalystConsensus(data) {
            // Update analyst company name
            document.getElementById('analystCompanyName').textContent = data.ticker;
            
            // Update price target section
            if (data.priceTarget) {
                document.getElementById('priceTargetAvg').textContent = data.priceTarget.currency + data.priceTarget.average;
                document.getElementById('priceTargetLow').textContent = data.priceTarget.currency + data.priceTarget.low;
                document.getElementById('priceTargetHigh').textContent = data.priceTarget.currency + data.priceTarget.high;
                
                // Update upside/downside potential if we have stock data
                if (dataStore.stock && dataStore.stock.price && dataStore.stock.price.current) {
                    const currentPrice = dataStore.stock.price.current;
                    const priceTarget = data.priceTarget.average;
                    const upside = ((priceTarget / currentPrice) - 1) * 100;
                    
                    const upsideSpan = document.getElementById('priceTargetUpside');
                    if (upside >= 0) {
                        upsideSpan.textContent = `+${upside.toFixed(1)}%`;
                        upsideSpan.className = 'font-medium text-green-600 dark:text-green-400';
                    } else {
                        upsideSpan.textContent = `${upside.toFixed(1)}%`;
                        upsideSpan.className = 'font-medium text-red-600 dark:text-red-400';
                    }
                }
                
                // Update consensus date
                if (data.priceTarget.date) {
                    document.getElementById('consensusDate').textContent = `As of ${data.priceTarget.date}`;
                }
            }
            
            // Update recommendations section
            if (data.recommendations) {
                document.getElementById('buyCount').textContent = data.recommendations.buy;
                document.getElementById('holdCount').textContent = data.recommendations.hold;
                document.getElementById('sellCount').textContent = data.recommendations.sell;
                
                // Update overall rating
                const consensusRating = document.getElementById('consensusRating');
                consensusRating.textContent = `Consensus: ${data.recommendations.rating}`;
                
                // Style based on rating
                if (data.recommendations.rating.toLowerCase().includes('buy') || 
                    data.recommendations.rating.toLowerCase().includes('outperform')) {
                    consensusRating.className = 'text-sm font-medium text-green-600 dark:text-green-400';
                } else if (data.recommendations.rating.toLowerCase().includes('sell') || 
                          data.recommendations.rating.toLowerCase().includes('underperform')) {
                    consensusRating.className = 'text-sm font-medium text-red-600 dark:text-red-400';
                } else {
                    consensusRating.className = 'text-sm font-medium text-yellow-600 dark:text-yellow-400';
                }
                
                // Update recommendation chart bars
                const total = data.recommendations.total;
                if (total > 0) {
                    const buyBar = document.getElementById('buyBar');
                    const holdBar = document.getElementById('holdBar');
                    const sellBar = document.getElementById('sellBar');
                    
                    const buyPercent = (data.recommendations.buy / total * 100);
                    const holdPercent = (data.recommendations.hold / total * 100);
                    const sellPercent = (data.recommendations.sell / total * 100);
                    
                    buyBar.style.height = buyPercent + '%';
                    holdBar.style.height = holdPercent + '%';
                    sellBar.style.height = sellPercent + '%';
                }
            }
            
            // Update earnings estimates section
            if (data.earningsEstimates) {
                document.getElementById('earningsNextQuarter').textContent = data.earningsEstimates.nextQuarter;
                document.getElementById('earningsCurrentYear').textContent = data.earningsEstimates.currentYear;
                document.getElementById('earningsNextYear').textContent = data.earningsEstimates.nextYear;
                document.getElementById('earningsGrowth').textContent = data.earningsEstimates.growthRate;
            }
            
            // Update analyst actions table
            if (data.analystActions && data.analystActions.length > 0) {
                const actionsBody = document.getElementById('analystActionsBody');
                actionsBody.innerHTML = '';
                
                data.analystActions.forEach(action => {
                    const row = document.createElement('tr');
                    row.className = 'border-t border-gray-200 dark:border-gray-700';
                    
                    // Date cell
                    const dateCell = document.createElement('td');
                    dateCell.className = 'py-2 px-4 text-xs text-gray-600 dark:text-gray-400';
                    dateCell.textContent = action.date;
                    row.appendChild(dateCell);
                    
                    // Firm cell
                    const firmCell = document.createElement('td');
                    firmCell.className = 'py-2 px-4 text-xs text-gray-800 dark:text-gray-200 font-medium';
                    firmCell.textContent = action.firm;
                    row.appendChild(firmCell);
                    
                    // Action cell
                    const actionCell = document.createElement('td');
                    actionCell.className = 'py-2 px-4 text-xs';
                    
                    // Style based on action type
                    if (action.action.toLowerCase().includes('upgrad')) {
                        actionCell.className += ' text-green-600 dark:text-green-400';
                    } else if (action.action.toLowerCase().includes('downgrad')) {
                        actionCell.className += ' text-red-600 dark:text-red-400';
                    } else {
                        actionCell.className += ' text-gray-600 dark:text-gray-400';
                    }
                    
                    actionCell.textContent = `${action.action} - ${action.rating}`;
                    row.appendChild(actionCell);
                    
                    // Price target cell
                    const priceCell = document.createElement('td');
                    priceCell.className = 'py-2 px-4 text-right text-xs font-medium text-gray-800 dark:text-gray-200';
                    priceCell.textContent = action.priceTarget;
                    row.appendChild(priceCell);
                    
                    actionsBody.appendChild(row);
                });
            }
        }

        // Function to update the stock information UI
        function updateStockInfo(data) {
            // Update company name and ticker
            document.getElementById('stockCompanyName').textContent = data.name;
            document.getElementById('stockTicker').textContent = data.ticker;
            
            // Update price info
            document.getElementById('currentPrice').textContent = data.price.current;
            document.getElementById('priceCurrency').textContent = data.price.currency;
            
            const priceChangeEl = document.getElementById('priceChange');
            if (data.price.change !== "N/A") {
                const isPositive = data.price.change >= 0;
                priceChangeEl.textContent = `${isPositive ? '+' : ''}${data.price.change} (${isPositive ? '+' : ''}${data.price.changePercent}%)`;
                priceChangeEl.className = `text-sm font-semibold ${isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`;
            } else {
                priceChangeEl.textContent = 'N/A';
                priceChangeEl.className = 'text-sm font-semibold text-gray-500 dark:text-gray-400';
            }
            
            // Update key metrics
            document.getElementById('marketCap').textContent = data.marketCap;
            document.getElementById('peRatio').textContent = data.peRatio;
            document.getElementById('revenueTTM').textContent = data.revenue;
            document.getElementById('netProfitTTM').textContent = data.netIncome;
            document.getElementById('tradingVolume').textContent = data.tradingVolume;
            
            // Update additional metrics
            document.getElementById('fiftyTwoWeekRange').textContent = data.fiftyTwoWeekRange;
            document.getElementById('dividendYield').textContent = data.dividendYield;
            document.getElementById('epsTTM').textContent = data.eps;
            document.getElementById('beta').textContent = data.beta;
            
            // Update returns with color coding
            updateReturnValue('oneMonthReturn', data.returns.oneMonth);
            updateReturnValue('threeMonthReturn', data.returns.threeMonth);
            updateReturnValue('ytdReturn', data.returns.ytd);
            updateReturnValue('oneYearReturn', data.returns.oneYear);
            
            // Update timestamp
            document.getElementById('stockDataTimestamp').textContent = `Data as of: ${data.timestamp}`;
        }

        // Add a visual cache indicator
        function addCacheIndicator(section, ticker) {
            const indicator = document.createElement('div');
            indicator.className = 'text-xs py-1 px-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-300 rounded-md inline-flex items-center';
            indicator.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span>Cached data</span>
            `;
            
            // Find the appropriate container based on section
            let container;
            switch(section) {
                case 'overview':
                    container = document.getElementById('comparablesDate');
                    break;
                case 'financials':
                    container = document.getElementById('dataSourcesNote');
                    break;
                case 'valuation':
                    container = document.getElementById('valuationCurrencyUnit');
                    break;
                case 'analyst':
                    container = document.getElementById('consensusDate');
                    break;
                case 'stock':
                    container = document.getElementById('stockDataTimestamp');
                    break;
                case 'industry':
                    container = document.getElementById('industryDataDate');
                    break;
                case 'comparables':
                    container = document.getElementById('comparablesDate');
                    break;
                default:
                    return;
            }
            
            // Add indicator to the container if found
            if (container) {
                // Remove any existing cache indicator
                const existingIndicator = container.querySelector('.cache-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                // Add the new indicator
                indicator.classList.add('cache-indicator', 'ml-2');
                container.appendChild(indicator);
            }
        }

        // Initialize financial charts functionality
        function initializeCharts() {
            // Create chart instances and store them
            window.charts = {
                income: null,
                balance: null,
                cashFlow: null,
                segmentChart: null,
                regionChart: null
            };
            
            // Update charts
            window.updateChart = function(chartType) {
                const data = dataStore.financials;
                if (!data || !data.years || data.years.length === 0) {
                    return;
                }
                
                const years = [...data.years].reverse(); // Display years in chronological order
                
                if (chartType === 'income') {
                    // Get the selected metrics for income statement
                    const primaryMetrics = Array.from(document.querySelectorAll('.income-chart-primary:checked')).map(cb => cb.value);
                    const secondaryMetrics = Array.from(document.querySelectorAll('.income-chart-secondary:checked')).map(cb => cb.value);
                    
                    // Prepare data
                    const datasets = [];
                    
                    // Primary metrics (bar chart)
                    primaryMetrics.forEach((metric, index) => {
                        const values = [];
                        for (let i = data.incomeStatement[metric].length - 1; i >= 0; i--) {
                            values.push(parseFinancialNumber(data.incomeStatement[metric][i]));
                        }
                        
                        datasets.push({
                            label: metric,
                            data: values,
                            backgroundColor: `rgba(93, 92, 222, ${0.8 - (index * 0.2)})`,
                            borderColor: `rgba(93, 92, 222, ${0.9 - (index * 0.1)})`,
                            borderWidth: 1,
                            type: 'bar',
                            yAxisID: 'y'
                        });
                    });
                    
                    // Secondary metrics (line chart - margins)
                    secondaryMetrics.forEach((metric, index) => {
                        const values = [];
                        
                        // Map margin names to their corresponding income statement items
                        let incomeItemKey;
                        if (metric === 'Gross Margin') {
                            incomeItemKey = 'Gross Profit';
                        } else if (metric === 'Operating Margin') {
                            incomeItemKey = 'Operating Income';
                        } else if (metric === 'Net Profit Margin') {
                            incomeItemKey = 'Net Income';
                        }
                        
                        // Make sure the keys exist in the data
                        if (!data.incomeStatement || !data.incomeStatement[incomeItemKey] || !data.incomeStatement['Revenue']) {
                            console.warn(`Missing data for ${metric} calculation`);
                            values.push(0); // Add a placeholder value
                            return; // Skip this metric
                        }
                        
                        // Calculate margins for each year
                        for (let i = data.incomeStatement[incomeItemKey].length - 1; i >= 0; i--) {
                            let denominator = parseFinancialNumber(data.incomeStatement['Revenue'][i]);
                            let numerator = parseFinancialNumber(data.incomeStatement[incomeItemKey][i]);
                            
                            if (denominator !== 0) {
                                values.push((numerator / denominator) * 100); // Convert to percentage
                            } else {
                                values.push(0);
                            }
                        }
                        
                        datasets.push({
                            label: metric,
                            data: values,
                            borderColor: ['rgba(75, 192, 192, 1)', 'rgba(55, 162, 162, 1)', 'rgba(35, 132, 132, 1)'][index],
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            type: 'line',
                            yAxisID: 'y1'
                        });
                    });
                    
                    // Update or create the chart
                    const ctx = document.getElementById('incomeChart').getContext('2d');
                    if (window.charts.income) {
                        window.charts.income.data.labels = years;
                        window.charts.income.data.datasets = datasets;
                        window.charts.income.update();
                    } else {
                        window.charts.income = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: years,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.datasetIndex >= primaryMetrics.length) {
                                                    label += context.raw.toFixed(2) + '%';
                                                } else {
                                                    label += data.currencySymbol + context.raw.toLocaleString();
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        position: 'left',
                                        title: {
                                            display: true,
                                            text: `Values (${data.currencySymbol} Millions)`
                                        }
                                    },
                                    y1: {
                                        beginAtZero: true,
                                        position: 'right',
                                        grid: {
                                            drawOnChartArea: false
                                        },
                                        title: {
                                            display: true,
                                            text: 'Percentage (%)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } else if (chartType === 'balance') {
                    // Get the selected metrics for balance sheet
                    const metrics = Array.from(document.querySelectorAll('.balance-chart-metric:checked')).map(cb => cb.value);
                    
                    // Prepare data
                    const datasets = [];
                    
                    metrics.forEach((metric, index) => {
                        const values = [];
                        for (let i = data.balanceSheet[metric].length - 1; i >= 0; i--) {
                            values.push(parseFinancialNumber(data.balanceSheet[metric][i]));
                        }
                        
                        datasets.push({
                            label: metric,
                            data: values,
                            backgroundColor: [
                                'rgba(93, 92, 222, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(255, 159, 64, 0.7)',
                                'rgba(54, 162, 235, 0.7)'
                            ][index],
                            borderColor: [
                                'rgba(93, 92, 222, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(54, 162, 235, 1)'
                            ][index],
                            borderWidth: 1
                        });
                    });
                    
                    // Update or create the chart
                    const ctx = document.getElementById('balanceChart').getContext('2d');
                    if (window.charts.balance) {
                        window.charts.balance.data.labels = years;
                        window.charts.balance.data.datasets = datasets;
                        window.charts.balance.update();
                    } else {
                        window.charts.balance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: years,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                label += data.currencySymbol + context.raw.toLocaleString();
                                                return label;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: `Values (${data.currencySymbol} Millions)`
                                        }
                                    }
                                }
                            }
                        });
                    }
                } else if (chartType === 'cashFlow') {
                    // Get the selected metrics for cash flow
                    const metrics = Array.from(document.querySelectorAll('.cashflow-chart-metric:checked')).map(cb => cb.value);
                    
                    // Prepare data
                    const datasets = [];
                    
                    metrics.forEach((metric, index) => {
                        const values = [];
                        for (let i = data.cashFlow[metric].length - 1; i >= 0; i--) {
                            values.push(parseFinancialNumber(data.cashFlow[metric][i]));
                        }
                        
                        datasets.push({
                            label: metric,
                            data: values,
                            backgroundColor: [
                                'rgba(93, 92, 222, 0.7)',
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)'
                            ][index],
                            borderColor: [
                                'rgba(93, 92, 222, 1)',
                                'rgba(255, 99, 132, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)'
                            ][index],
                            borderWidth: 1
                        });
                    });
                    
                    // Update or create the chart
                    const ctx = document.getElementById('cashFlowChart').getContext('2d');
                    if (window.charts.cashFlow) {
                        window.charts.cashFlow.data.labels = years;
                        window.charts.cashFlow.data.datasets = datasets;
                        window.charts.cashFlow.update();
                    } else {
                        window.charts.cashFlow = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: years,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                label += data.currencySymbol + context.raw.toLocaleString();
                                                return label;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        title: {
                                            display: true,
                                            text: `Values (${data.currencySymbol} Millions)`
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            };
            
            // Add event listeners for checkboxes to update charts
            document.querySelectorAll('.income-chart-primary, .income-chart-secondary').forEach(checkbox => {
                checkbox.addEventListener('change', () => window.updateChart('income'));
            });
            
            document.querySelectorAll('.balance-chart-metric').forEach(checkbox => {
                checkbox.addEventListener('change', () => window.updateChart('balance'));
            });
            
            document.querySelectorAll('.cashflow-chart-metric').forEach(checkbox => {
                checkbox.addEventListener('change', () => window.updateChart('cashFlow'));
            });
        }

        // Function to fetch revenue breakdown data
        async function fetchRevenueBreakdown(companyName, sector, industry) {
            // Show loading indicator
            document.getElementById('revenueBreakdownLoading').classList.remove('hidden');
            
            try {
                // Register handler for revenue breakdown data
                const handlerId = `revenueBreakdown-${Date.now()}`;
                
                // Create a Promise for handling the response
                const responsePromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.responses[0]?.statusText || "Error fetching revenue breakdown"));
                            return;
                        }
                        
                        if (result.status === "complete") {
                            const response = result.responses[0];
                            try {
                                // Parse the JSON data from the model's response
                                const responseText = response.content;
                                let breakdownData;
                                
                                // Extract JSON data from the response
                                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                                 responseText.match(/```([\s\S]*?)```/);
                                                  
                                if (jsonMatch && jsonMatch[1]) {
                                    breakdownData = JSON.parse(jsonMatch[1]);
                                } else {
                                    // Try to extract a JSON object without code blocks
                                    const jsonPattern = /\{[\s\S]*\}/;
                                    const match = responseText.match(jsonPattern);
                                    if (match) {
                                        breakdownData = JSON.parse(match[0]);
                                    } else {
                                        throw new Error("Unable to parse JSON data from response");
                                    }
                                }
                                
                                resolve(breakdownData);
                            } catch (error) {
                                console.error("Error parsing revenue breakdown data:", error);
                                reject(new Error("Failed to parse revenue breakdown data: " + error.message));
                            }
                        }
                    });
                });
                
                // Construct prompt for AI to get revenue breakdown
                const prompt = `@Claude-3.7-Sonnet 
I need revenue breakdown data for ${companyName} (industry: ${industry}, sector: ${sector}) in a specific JSON format. Please provide ONLY the JSON object with no additional text:

\`\`\`json
{
  "segments": [
    { "name": "Product/Segment Name", "revenue": 5000, "percentage": 50.0 },
    { "name": "Another Segment", "revenue": 3000, "percentage": 30.0 },
    { "name": "Third Segment", "revenue": 2000, "percentage": 20.0 }
  ],
  "regions": [
    { "name": "North America", "revenue": 4000, "percentage": 40.0 },
    { "name": "Europe", "revenue": 3000, "percentage": 30.0 },
    { "name": "Asia Pacific", "revenue": 2000, "percentage": 20.0 },
    { "name": "Other Regions", "revenue": 1000, "percentage": 10.0 }
  ]
}
\`\`\`

Provide the most recent revenue breakdown by business segment and geographic region. Revenue should be in millions of dollars, and percentages should add up to 100% for each category. Use the most accurate data available for this company.`;
                
                // Send prompt to fetch revenue breakdown
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    openChat: false
                });
                
                // Wait for the response
                const revenueBreakdown = await responsePromise;
                
                // Update the data store
                if (!dataStore.overview.revenueBreakdown) {
                    dataStore.overview.revenueBreakdown = revenueBreakdown;
                }
                
                // Update the UI
                displayRevenueBreakdown(revenueBreakdown);
                
                // Hide loading indicator
                document.getElementById('revenueBreakdownLoading').classList.add('hidden');
                
                return revenueBreakdown;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('revenueBreakdownLoading').classList.add('hidden');
                
                // Show no data message
                document.getElementById('revenueBreakdownNoData').classList.remove('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to load revenue breakdown. ${error.message}`, "error");
                
                throw error;
            }
        }
        
        // Function to fetch comparable companies
        async function fetchComparableCompanies(industry, sector, companyName) {
            // Show loading indicator
            document.getElementById('comparablesLoading').classList.remove('hidden');
            
            try {
                // For AAPL, use pre-loaded demo data
                if (companyName === "Apple Inc.") {
                    displayMessage("Using pre-loaded comparable companies data for Apple Inc.", "info");
                    
                    // Update the comparable companies section with the pre-loaded data
                    const comparablesList = document.getElementById('comparablesList');
                    if (comparablesList) {
                        comparablesList.innerHTML = '';
                        
                        // Use the pre-loaded comparable companies from sampleData
                        sampleData.comparableCompanies.forEach(company => {
                            const companyElement = document.createElement('div');
                            companyElement.className = 'p-2 bg-gray-50 dark:bg-gray-750 rounded-md border border-gray-200 dark:border-gray-700';
                            
                            const ticker = document.createElement('div');
                            ticker.className = 'text-xs font-bold text-primary';
                            ticker.textContent = company.ticker;
                            
                            const name = document.createElement('div');
                            name.className = 'text-xs text-gray-700 dark:text-gray-300 truncate';
                            name.textContent = company.name;
                            
                            companyElement.appendChild(ticker);
                            companyElement.appendChild(name);
                            comparablesList.appendChild(companyElement);
                        });
                    }
                    
                    // Hide loading indicator
                    document.getElementById('comparablesLoading').classList.add('hidden');
                    
                    return sampleData.comparableCompanies;
                }
                
                // For other companies, fetch data from AI model
                const handlerId = `comparableCompanies-${Date.now()}`;
                
                // Create a Promise for handling the response
                const responsePromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.responses[0]?.statusText || "Error fetching comparable companies"));
                            return;
                        }
                        
                        if (result.status === "complete") {
                            const response = result.responses[0];
                            try {
                                // Parse the JSON data from the model's response
                                const responseText = response.content;
                                let comparablesData;
                                
                                // Extract JSON data from the response
                                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                                  responseText.match(/```([\s\S]*?)```/);
                                                  
                                if (jsonMatch && jsonMatch[1]) {
                                    comparablesData = JSON.parse(jsonMatch[1]);
                                } else {
                                    // Try to extract a JSON object without code blocks
                                    const jsonPattern = /\[[\s\S]*\]/;
                                    const match = responseText.match(jsonPattern);
                                    if (match) {
                                        comparablesData = JSON.parse(match[0]);
                                    } else {
                                        throw new Error("Unable to parse JSON data from response");
                                    }
                                }
                                
                                resolve(comparablesData);
                            } catch (error) {
                                console.error("Error parsing comparable companies data:", error);
                                reject(new Error("Failed to parse comparable companies data: " + error.message));
                            }
                        }
                    });
                });
                
                // Construct prompt for AI to get comparable companies
                const prompt = `@Claude-3.7-Sonnet 
I need to identify comparable companies for a company in the ${industry} industry, ${sector} sector. The company name is ${companyName}.

Please provide ONLY a JSON array with no additional text:

\`\`\`json
[
  { "ticker": "TICKER1", "name": "Company Name 1" },
  { "ticker": "TICKER2", "name": "Company Name 2" },
  { "ticker": "TICKER3", "name": "Company Name 3" }
]
\`\`\`

Include 5-8 comparable companies that would be typically used in a peer comparison analysis. These should be companies of similar size, business model, and market focus in the same industry.`;
                
                // Send prompt to fetch comparable companies
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    openChat: false
                });
                
                // Wait for the response
                const comparablesData = await responsePromise;
                
                // Update the comparable companies section
                const comparablesList = document.getElementById('comparablesList');
                if (comparablesList) {
                    comparablesList.innerHTML = '';
                    
                    comparablesData.forEach(company => {
                        const companyElement = document.createElement('div');
                        companyElement.className = 'p-2 bg-gray-50 dark:bg-gray-750 rounded-md border border-gray-200 dark:border-gray-700';
                        
                        const ticker = document.createElement('div');
                        ticker.className = 'text-xs font-bold text-primary';
                        ticker.textContent = company.ticker;
                        
                        const name = document.createElement('div');
                        name.className = 'text-xs text-gray-700 dark:text-gray-300 truncate';
                        name.textContent = company.name;
                        
                        companyElement.appendChild(ticker);
                        companyElement.appendChild(name);
                        comparablesList.appendChild(companyElement);
                    });
                }
                
                // Hide loading indicator
                document.getElementById('comparablesLoading').classList.add('hidden');
                
                return comparablesData;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('comparablesLoading').classList.add('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to load comparable companies. ${error.message}`, "error");
                
                throw error;
            }
        }
        
        // Function to get the selected AI model for each section
        function getSelectedModel(section) {
            const selector = document.getElementById(`${section}ModelSelect`);
            return selector ? selector.value : 'claude';
        }

        // Function to update all ticker inputs across pages
        function updateAllTickerInputs(ticker) {
            if (!ticker) return;
            
            // Store the ticker in the global data store
            dataStore.currentTicker = ticker;
            
            // Update all ticker input fields across pages
            document.getElementById('overviewTickerInput').value = ticker;
            document.getElementById('stockTickerInput').value = ticker;
            document.getElementById('financialsTickerInput').value = ticker;
            document.getElementById('valuationTickerInput').value = ticker;
            document.getElementById('analystTickerInput').value = ticker;
        }

        // Function to fetch company overview data
        async function fetchCompanyOverview(ticker) {
            // Update all ticker inputs across pages
            updateAllTickerInputs(ticker);

            // Check cache first
            const cacheKey = `overview_${ticker.toUpperCase()}`;
            const cachedData = cacheManager.get(cacheKey);

            if (cachedData) {
                console.log(`Loading company overview for ${ticker} from cache`);
                displayMessage(`Loading cached company overview data for ${ticker}`, "info");
                
                // Store in the data store
                dataStore.overview = cachedData;
                
                // Update UI
                updateCompanyDescription(cachedData);
                
                // Show success message
                displayMessage("Successfully loaded company overview from cache", "success");
                
                // Add cache indicator
                addCacheIndicator('overview', ticker);
                
                return cachedData;
            }
            
            // If not in cache, proceed with data fetching
            // Show loading indicator
            document.getElementById('overviewLoadingIndicator').classList.remove('hidden');
            document.getElementById('companyDescription').classList.add('hidden');
            
            // For AAPL, use demo data
            if (ticker.toUpperCase() === 'AAPL') {
                displayMessage("Using pre-loaded sample data for Apple Inc.", "info");
                
                // Extract just the company info (not financial statements)
                const companyData = {
                    name: sampleData.name,
                    description: sampleData.description,
                    sector: sampleData.sector,
                    industry: sampleData.industry,
                    founded: sampleData.founded,
                    headquarters: sampleData.headquarters,
                    retrievalDate: sampleData.retrievalDate,
                    sources: sampleData.sources,
                    revenueBreakdown: sampleData.revenueBreakdown,
                    comparableCompanies: sampleData.comparableCompanies
                };
                
                // Store in the data store
                dataStore.overview = companyData;
                
                // Update UI
                updateCompanyDescription(companyData);
                
                // Hide loading indicator
                document.getElementById('overviewLoadingIndicator').classList.add('hidden');
                
                // Show success message
                displayMessage("Successfully loaded company overview for Apple Inc.", "success");
                
                // Store in cache
                cacheManager.set(cacheKey, companyData);

                return companyData;
            }
            
            // For other tickers, get real data from AI model
            try {
                // Get the selected model from the dropdown
                const modelSelect = document.getElementById('aiModelSelect');
                const modelType = modelSelect ? modelSelect.value : 'flash';
                const modelName = modelType === 'pro' ? 'Gemini-2.5-Pro-Exp' : 'Gemini-2.5-Flash-Preview';
                
                displayMessage(`Fetching company overview for ${ticker}... This may take up to one minute.`, "info");
                
                // Register handler for company overview data
                const handlerId = `companyOverview-${Date.now()}`;
                
                // Create a Promise for handling the response
                const responsePromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.responses[0]?.statusText || "Error fetching company overview"));
                            return;
                        }
                        
                        if (result.status === "complete") {
                            const response = result.responses[0];
                            try {
                                // Parse the JSON data from the model's response
                                const responseText = response.content;
                                let companyData;
                                
                                // Extract JSON data from the response
                                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                                  responseText.match(/```([\s\S]*?)```/);
                                                  
                                if (jsonMatch && jsonMatch[1]) {
                                    companyData = JSON.parse(jsonMatch[1]);
                                } else {
                                    // Try to extract a JSON object without code blocks
                                    const jsonPattern = /\{[\s\S]*\}/;
                                    const match = responseText.match(jsonPattern);
                                    if (match) {
                                        companyData = JSON.parse(match[0]);
                                    } else {
                                        throw new Error("Unable to parse JSON data from response");
                                    }
                                }
                                
                                resolve(companyData);
                            } catch (error) {
                                console.error("Error parsing company overview data:", error);
                                reject(new Error("Failed to parse company data: " + error.message));
                            }
                        }
                    });
                });
                
                // Construct a comprehensive prompt that combines company profile, revenue breakdown, and comparable companies
                const botName = modelType === 'pro' ? '@Gemini-2.5-Pro-Exp' : '@Gemini-2.5-Flash-Preview';
                const prompt = `${botName} 
I need comprehensive information about ${ticker} in a specific JSON format. Please provide only a JSON object without any additional text. I need company profile, revenue breakdown, and comparable companies all in one response:

\`\`\`json
{
  "name": "Full company name",
  "description": "Brief company description",
  "sector": "Industry sector",
  "industry": "Specific industry",
  "founded": "Year founded",
  "headquarters": "City, State/Country",
  "retrievalDate": "Current date",
  "sources": ["Source 1", "Source 2"],
  "revenueBreakdown": {
    "segments": [
      { "name": "Product/Segment Name", "revenue": 5000, "percentage": 50.0 },
      { "name": "Another Segment", "revenue": 3000, "percentage": 30.0 }
    ],
    "regions": [
      { "name": "North America", "revenue": 4000, "percentage": 40.0 },
      { "name": "Europe", "revenue": 3000, "percentage": 30.0 }
    ]
  },
  "comparableCompanies": [
    { "ticker": "COMP1", "name": "Comparable Company 1" },
    { "ticker": "COMP2", "name": "Comparable Company 2" }
  ]
}
\`\`\`

For the revenue breakdown, include the most recent data with revenue figures in millions of dollars. The percentages in each category should add up to 100%.

For comparable companies, include 5-8 companies that are similar in size, business model, and industry focus.

Only return a valid JSON object in the above format without any commentary or additional text.`;
                
                // Send prompt to fetch all company data in one request
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    openChat: false
                });
                
                // Wait for the response
                const companyData = await responsePromise;
                companyData.retrievalDate = companyData.retrievalDate || new Date().toISOString().split('T')[0];
                
                // Store in the data store
                dataStore.overview = companyData;
                
                // Update UI with all the retrieved data
                updateCompanyDescription(companyData);
                
                // Display the revenue breakdown if available
                if (companyData.revenueBreakdown) {
                    displayRevenueBreakdown(companyData.revenueBreakdown);
                }
                
                // Display comparable companies if available
                if (companyData.comparableCompanies) {
                    // Update the comparable companies section
                    const comparablesList = document.getElementById('comparablesList');
                    if (comparablesList) {
                        comparablesList.innerHTML = '';
                        
                        companyData.comparableCompanies.forEach(company => {
                            const companyElement = document.createElement('div');
                            companyElement.className = 'p-2 bg-gray-50 dark:bg-gray-750 rounded-md border border-gray-200 dark:border-gray-700';
                            
                            const ticker = document.createElement('div');
                            ticker.className = 'text-xs font-bold text-primary';
                            ticker.textContent = company.ticker;
                            
                            const name = document.createElement('div');
                            name.className = 'text-xs text-gray-700 dark:text-gray-300 truncate';
                            name.textContent = company.name;
                            
                            companyElement.appendChild(ticker);
                            companyElement.appendChild(name);
                            comparablesList.appendChild(companyElement);
                        });
                    }
                    
                    // Hide loading indicator for comparable companies
                    document.getElementById('comparablesLoading').classList.add('hidden');
                }
                
                // Hide loading indicator
                document.getElementById('overviewLoadingIndicator').classList.add('hidden');
                
                // Show success message
                displayMessage(`Successfully loaded company overview for ${ticker}.`, "success");
                
                // Store in cache when data is received successfully
                cacheManager.set(cacheKey, companyData);
                
                return companyData;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('overviewLoadingIndicator').classList.add('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to load company overview. ${error.message}`, "error");
                
                throw error;
            }
        }
        
        // Function to fetch financial statements data
        async function fetchFinancialData(ticker) {
            // Show loading indicator
            document.getElementById('financialsLoadingIndicator').classList.remove('hidden');
            document.getElementById('financialContent').classList.add('hidden');
            
            // For AAPL, use demo data
            if (ticker.toUpperCase() === 'AAPL') {
                displayMessage("Using pre-loaded sample data for Apple Inc.", "info");
                
                // Store in the data store
                dataStore.financials = sampleData;
                
                // Update UI
                updateTableHeaders(sampleData);
                populateFinancialTables(sampleData);
                
                // Hide loading indicator
                document.getElementById('financialsLoadingIndicator').classList.add('hidden');
                
                // Show financial content
                document.getElementById('financialContent').classList.remove('hidden');
                
                // Show success message
                displayMessage("Successfully loaded financial data for Apple Inc.", "success");
                
                return sampleData;
            }
            
            // For other tickers, get real data from AI model
            try {
                const modelType = getSelectedModel('financials');
                const modelName = modelType === 'gemini' ? 'Gemini-2.5-Pro' : 'Gemini-2.5-Flash';
                
                displayMessage(`Fetching financial data for ${ticker}... This may take up to one minute.`, "info");
                
                // Register handler for financial data
                const handlerId = `financials-${Date.now()}`;
                
                // Create a Promise for handling the response
                const responsePromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.responses[0]?.statusText || "Error fetching financial statements"));
                            return;
                        }
                        
                        if (result.status === "complete") {
                            const response = result.responses[0];
                            try {
                                // Parse the JSON data from the model's response
                                const responseText = response.content;
                                let financialData;
                                
                                // Extract JSON data from the response
                                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                                  responseText.match(/```([\s\S]*?)```/);
                                                  
                                if (jsonMatch && jsonMatch[1]) {
                                    financialData = JSON.parse(jsonMatch[1]);
                                } else {
                                    // Try to extract a JSON object without code blocks
                                    const jsonPattern = /\{[\s\S]*\}/;
                                    const match = responseText.match(jsonPattern);
                                    if (match) {
                                        financialData = JSON.parse(match[0]);
                                    } else {
                                        throw new Error("Unable to parse JSON data from response");
                                    }
                                }
                                
                                // Parse any source URLs mentioned in the response
                                const sourceUrls = extractUrls(responseText);
                                if (sourceUrls.length > 0) {
                                    financialData.sourceUrls = sourceUrls;
                                    updateSourceUrls(sourceUrls);
                                }
                                
                                resolve(financialData);
                            } catch (error) {
                                console.error("Error parsing financial data:", error);
                                reject(new Error("Failed to parse financial data: " + error.message));
                            }
                        }
                    });
                });
                
                // Construct prompt for AI to get financial statements
                const botName = modelType === 'pro' ? '@Gemini-2.5-Pro-Exp' : '@Gemini-2.5-Flash-Preview';
                const prompt = `${botName} 
I need comprehensive financial data for ${ticker} in a specific JSON format. Please provide ONLY the JSON object with no additional text:

\`\`\`json
{
  "name": "Company name",
  "fiscalYearEnd": "Month Day",
  "currencyUnit": "Millions",
  "currencySymbol": "$",
  "years": [2024, 2023, 2022, 2021],
  "incomeStatement": {
    "Revenue": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Cost of Revenue": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Gross Profit": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Operating Expenses": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "R&D Expenses": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Operating Income": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Other Income": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Tax Expense": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Net Income": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"]
  },
  "balanceSheet": {
    "Cash & Equivalents": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Accounts Receivable": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Inventory": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Current Assets": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Property & Equipment": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Intangible Assets": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Assets": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Accounts Payable": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Short-term Debt": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Current Liabilities": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Long-term Debt": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Liabilities": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Common Stock": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Retained Earnings": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Equity": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Total Liabilities & Equity": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"]
  },
  "cashFlow": {
    "Net Income": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Depreciation & Amortization": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Changes in Working Capital": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Net Cash from Operations": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Capital Expenditures": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Acquisitions": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Net Cash from Investing": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Debt Issuance (Repayment)": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Dividends Paid": ["($X,XXX)", "($X,XXX)", "($X,XXX)", "($X,XXX)"],
    "Net Cash from Financing": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"],
    "Net Change in Cash": ["$X,XXX", "$X,XXX", "$X,XXX", "$X,XXX"]
  },
  "sharesOutstanding": X.XX
}
\`\`\`

Please ensure all financial figures are formatted with $ and commas, with negative numbers in parentheses. The sharesOutstanding should be in millions (e.g., 15.5 means 15.5 million shares). Cite your sources if possible.`;
                
                // Send prompt to fetch financial statements
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    openChat: false
                });
                
                // Wait for the response
                const financialData = await responsePromise;
                
                // Store in the data store
                dataStore.financials = financialData;
                
                // Update UI
                updateTableHeaders(financialData);
                populateFinancialTables(financialData);
                
                // Hide loading indicator
                document.getElementById('financialsLoadingIndicator').classList.add('hidden');
                
                // Show financial content
                document.getElementById('financialContent').classList.remove('hidden');
                
                // Show success message
                displayMessage(`Successfully loaded financial data for ${ticker}.`, "success");
                
                return financialData;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('financialsLoadingIndicator').classList.add('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to load financial data. ${error.message}`, "error");
                
                throw error;
            }
        }
        
        // Function to fetch valuation data
        async function fetchValuationData(ticker) {
            // Show loading indicator
            document.getElementById('valuationLoadingIndicator').classList.remove('hidden');
            document.getElementById('valuationContent').classList.add('hidden');
            
            // For AAPL, use demo data
            if (ticker.toUpperCase() === 'AAPL') {
                displayMessage("Using pre-loaded sample data for Apple Inc.", "info");
                
                // Clone the sample data to avoid modifying it
                const valuationData = JSON.parse(JSON.stringify(sampleData));
                
                // Calculate shares outstanding and net debt
                updateCompanyInfo(valuationData);
                
                // Store in the data store
                dataStore.valuation = valuationData;
                
                // Update UI
                updateTableHeaders(valuationData);
                displayHistoricalMetrics(valuationData);

                // auto-fill the market growth rate from industry data if available:
                const industryGrowth = dataStore.industry?.growthTrends?.industry;
                if (industryGrowth && industryGrowth.length > 0) {
                    // Use the most recent industry growth rate
                    document.getElementById('marketGrowthRate').value = industryGrowth[industryGrowth.length - 1].growth;
                }
                
                // Hide loading indicator
                document.getElementById('valuationLoadingIndicator').classList.add('hidden');
                
                // Show valuation content
                document.getElementById('valuationContent').classList.remove('hidden');
                
                // Show success message
                displayMessage("Successfully loaded valuation data for Apple Inc.", "success");
                
                // Automatically calculate valuation in demo mode
                setTimeout(() => {
                    calculateValuation();
                }, 100);
                
                return valuationData;
            }
            
            // For other tickers, get real data from API
            try {
                const modelType = getSelectedModel('valuation');
                const modelName = modelType === 'claude' ? 'Claude-3.7-Sonnet' : 'Gemini-2.5-Flash';
                
                displayMessage(`Fetching valuation data for ${ticker}... This may take up to one minute.`, "info");
                
                // For this demo, we'll use the same mock financial data we used for the financial statements page
                // In a real app, you would call window.Poe.sendUserMessage to get real data
                const mockFinancialData = dataStore.financials || {
                    name: `${ticker} Corporation`,
                    fiscalYearEnd: "Dec 31",
                    currencyUnit: "Millions",
                    currencySymbol: "$",
                    years: [2023, 2022, 2021, 2020],
                    sharesOutstanding: 1000,
                    incomeStatement: {
                        "Revenue": ["$50,000", "$45,000", "$40,000", "$35,000"],
                        "Cost of Revenue": ["($30,000)", "($27,000)", "($24,000)", "($21,000)"],
                        "Gross Profit": ["$20,000", "$18,000", "$16,000", "$14,000"],
                        "Operating Expenses": ["($10,000)", "($9,000)", "($8,000)", "($7,000)"],
                        "R&D Expenses": ["($5,000)", "($4,500)", "($4,000)", "($3,500)"],
                        "Operating Income": ["$5,000", "$4,500", "$4,000", "$3,500"],
                        "Other Income": ["$500", "$400", "$300", "$200"],
                        "Tax Expense": ["($1,375)", "($1,225)", "($1,075)", "($925)"],
                        "Net Income": ["$4,125", "$3,675", "$3,225", "$2,775"]
                    },
                    balanceSheet: {
                        "Cash & Equivalents": ["$10,000", "$9,000", "$8,000", "$7,000"],
                        "Accounts Receivable": ["$5,000", "$4,500", "$4,000", "$3,500"],
                        "Inventory": ["$3,000", "$2,700", "$2,400", "$2,100"],
                        "Total Current Assets": ["$18,000", "$16,200", "$14,400", "$12,600"],
                        "Property & Equipment": ["$12,000", "$11,000", "$10,000", "$9,000"],
                        "Intangible Assets": ["$8,000", "$7,500", "$7,000", "$6,500"],
                        "Total Assets": ["$38,000", "$34,700", "$31,400", "$28,100"],
                        "Accounts Payable": ["$4,000", "$3,600", "$3,200", "$2,800"],
                        "Short-term Debt": ["$2,000", "$1,800", "$1,600", "$1,400"],
                        "Total Current Liabilities": ["$6,000", "$5,400", "$4,800", "$4,200"],
                        "Long-term Debt": ["$10,000", "$9,000", "$8,000", "$7,000"],
                        "Total Liabilities": ["$16,000", "$14,400", "$12,800", "$11,200"],
                        "Common Stock": ["$10,000", "$10,000", "$10,000", "$10,000"],
                        "Retained Earnings": ["$12,000", "$10,300", "$8,600", "$6,900"],
                        "Total Equity": ["$22,000", "$20,300", "$18,600", "$16,900"],
                        "Total Liabilities & Equity": ["$38,000", "$34,700", "$31,400", "$28,100"]
                    },
                    cashFlow: {
                        "Net Income": ["$4,125", "$3,675", "$3,225", "$2,775"],
                        "Depreciation & Amortization": ["$2,000", "$1,800", "$1,600", "$1,400"],
                        "Changes in Working Capital": ["($500)", "($400)", "($300)", "($200)"],
                        "Net Cash from Operations": ["$5,625", "$5,075", "$4,525", "$3,975"],
                        "Capital Expenditures": ["($2,500)", "($2,250)", "($2,000)", "($1,750)"],
                        "Acquisitions": ["($1,000)", "($900)", "($800)", "($700)"],
                        "Net Cash from Investing": ["($3,500)", "($3,150)", "($2,800)", "($2,450)"],
                        "Debt Issuance (Repayment)": ["$1,000", "$900", "$800", "$700"],
                        "Dividends Paid": ["($1,000)", "($900)", "($800)", "($700)"],
                        "Net Cash from Financing": ["$0", "$0", "$0", "$0"],
                        "Net Change in Cash": ["$2,125", "$1,925", "$1,725", "$1,525"],
                        "Beginning Cash Balance": ["$7,875", "$7,075", "$6,275", "$5,475"],
                        "Ending Cash Balance": ["$10,000", "$9,000", "$8,000", "$7,000"]
                    }
                };
                
                // Add a slight delay to simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Calculate shares outstanding and net debt
                updateCompanyInfo(mockFinancialData);
                
                // Store in the data store
                dataStore.valuation = mockFinancialData;
                
                // Update UI
                updateTableHeaders(mockFinancialData);
                displayHistoricalMetrics(mockFinancialData);
                
                // Hide loading indicator
                document.getElementById('valuationLoadingIndicator').classList.add('hidden');
                
                // Show valuation content
                document.getElementById('valuationContent').classList.remove('hidden');
                
                // Show success message
                displayMessage(`Successfully loaded valuation data for ${ticker}.`, "success");
                displayMessage("Note: This is mock data. In a real application, this would fetch actual financial data via the Poe API.", "info");
                
                return mockFinancialData;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('valuationLoadingIndicator').classList.add('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to load valuation data. ${error.message}`, "error");
                
                throw error;
            }
        }
        
        // Function to fetch analyst consensus data
        async function fetchAnalystConsensus(ticker) {
            // Show loading indicator
            document.getElementById('analystLoadingIndicator').classList.remove('hidden');
            document.getElementById('analystContent').classList.add('hidden');
            document.getElementById('analystNoData').classList.add('hidden');
            
            // For AAPL, use demo data
            if (ticker.toUpperCase() === 'AAPL') {
                displayMessage("Using pre-loaded sample data for Apple Inc.", "info");
                
                // Store in the data store
                dataStore.analyst = sampleAnalystConsensus;
                
                // Update UI
                updateAnalystConsensus(sampleAnalystConsensus);
                
                // Hide loading indicator
                document.getElementById('analystLoadingIndicator').classList.add('hidden');
                
                // Show analyst content
                document.getElementById('analystContent').classList.remove('hidden');
                
                // Show success message
                displayMessage("Successfully loaded analyst consensus data for Apple Inc.", "success");
                
                return sampleAnalystConsensus;
            }
            
            // For other tickers, get real data from AI model
            try {
                const modelType = getSelectedModel('analyst');
                const modelName = modelType === 'claude' ? 'Claude-3.7-Sonnet' : 'Gemini-2.5-Flash';
                
                displayMessage(`Fetching analyst consensus data for ${ticker}... This may take up to one minute.`, "info");
                
                // Register handler for analyst consensus data
                const handlerId = `analystConsensus-${Date.now()}`;
                
                // Create a Promise for handling the response
                const responsePromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.responses[0]?.statusText || "Error fetching analyst consensus"));
                            return;
                        }
                        
                        if (result.status === "complete") {
                            const response = result.responses[0];
                            try {
                                // Parse the JSON data from the model's response
                                const responseText = response.content;
                                let analystData;
                                
                                // Extract JSON data from the response
                                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                                  responseText.match(/```([\s\S]*?)```/);
                                                  
                                if (jsonMatch && jsonMatch[1]) {
                                    analystData = JSON.parse(jsonMatch[1]);
                                } else {
                                    // Try to extract a JSON object without code blocks
                                    const jsonPattern = /\{[\s\S]*\}/;
                                    const match = responseText.match(jsonPattern);
                                    if (match) {
                                        analystData = JSON.parse(match[0]);
                                    } else {
                                        throw new Error("Unable to parse JSON data from response");
                                    }
                                }
                                
                                resolve(analystData);
                            } catch (error) {
                                console.error("Error parsing analyst consensus data:", error);
                                reject(new Error("Failed to parse analyst data: " + error.message));
                            }
                        }
                    });
                });
                
                // Construct prompt for AI to get analyst consensus data
                const botName = modelType === 'claude' ? '@Claude-3.7-Sonnet' : '@Gemini-2.5-Flash';
                const prompt = `${botName} 
I need analyst consensus data for ${ticker} in a specific JSON format. Please provide ONLY the JSON object with no additional text:

\`\`\`json
{
  "ticker": "${ticker}",
  "priceTarget": {
    "average": 100.00,
    "high": 125.00,
    "low": 85.00,
    "currency": "$",
    "date": "2024-07-10"
  },
  "recommendations": {
    "buy": 15,
    "hold": 10,
    "sell": 5,
    "total": 30,
    "rating": "Buy"
  },
  "earningsEstimates": {
    "nextQuarter": "$0.75",
    "currentYear": "$3.00",
    "nextYear": "$3.45",
    "growthRate": "15.0%"
  },
  "analystActions": [
    {
      "date": "2024-07-01",
      "firm": "Example Securities",
      "action": "Maintained",
      "rating": "Buy",
      "priceTarget": "$105"
    }
  ]
}
\`\`\`

Use the most recent analyst data available. Include at least 4-5 recent analyst actions from major financial firms if available. If a particular company doesn't have analyst coverage, please indicate that in your response.`;
                
                // Send prompt to fetch analyst consensus data
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    openChat: false
                });
                
                // Wait for the response
                const analystData = await responsePromise;
                
                // Check if there's no analyst data or empty structure
                if (!analystData || 
                    !analystData.priceTarget || 
                    !analystData.recommendations ||
                    !analystData.earningsEstimates ||
                    !analystData.analystActions) {
                    throw new Error("Insufficient analyst data available for this company");
                }
                
                // Store in the data store
                dataStore.analyst = analystData;
                
                // Update UI
                updateAnalystConsensus(analystData);
                
                // Hide loading indicator
                document.getElementById('analystLoadingIndicator').classList.add('hidden');
                
                // Show analyst content
                document.getElementById('analystContent').classList.remove('hidden');
                
                // Show success message
                displayMessage(`Successfully loaded analyst consensus data for ${ticker}.`, "success");
                
                return analystData;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('analystLoadingIndicator').classList.add('hidden');
                
                // Show no data message
                document.getElementById('analystNoData').classList.remove('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to load analyst consensus data. ${error.message}`, "error");
                
                throw error;
            }
        }
        
        // Function to fetch stock information data
        async function fetchStockInfo(ticker) {
            // Show loading indicator
            document.getElementById('stockLoadingIndicator').classList.remove('hidden');
            document.getElementById('stockContent').classList.add('hidden');
            
            // For AAPL, use demo data
            if (ticker.toUpperCase() === 'AAPL') {
                displayMessage("Using pre-loaded sample data for Apple Inc.", "info");
                
                // Store in the data store
                dataStore.stock = sampleStockData;
                
                // Update UI
                updateStockInfo(sampleStockData);
                
                // Hide loading indicator
                document.getElementById('stockLoadingIndicator').classList.add('hidden');
                
                // Show stock content
                document.getElementById('stockContent').classList.remove('hidden');
                
                // Show success message
                displayMessage("Successfully loaded stock information for Apple Inc.", "success");
                
                return sampleStockData;
            }
            
            // For other tickers, get real data from AI model
            try {
                const modelType = getSelectedModel('stock');
                const modelName = modelType === 'pro' ? 'Gemini-2.5-Pro-Exp' : 'Gemini-2.5-Flash-Preview';
                
                displayMessage(`Fetching stock information for ${ticker}... This may take up to one minute.`, "info");
                
                // Register handler for stock data
                const handlerId = `stockInfo-${Date.now()}`;
                
                // Create a Promise for handling the response
                const responsePromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.responses[0]?.statusText || "Error fetching stock information"));
                            return;
                        }
                        
                        if (result.status === "complete") {
                            const response = result.responses[0];
                            try {
                                // Parse the JSON data from the model's response
                                const responseText = response.content;
                                let stockData;
                                
                                // Extract JSON data from the response
                                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                                 responseText.match(/```([\s\S]*?)```/);
                                                  
                                if (jsonMatch && jsonMatch[1]) {
                                    stockData = JSON.parse(jsonMatch[1]);
                                } else {
                                    // Try to extract a JSON object without code blocks
                                    const jsonPattern = /\{[\s\S]*\}/;
                                    const match = responseText.match(jsonPattern);
                                    if (match) {
                                        stockData = JSON.parse(match[0]);
                                    } else {
                                        throw new Error("Unable to parse JSON data from response");
                                    }
                                }
                                
                                resolve(stockData);
                            } catch (error) {
                                console.error("Error parsing stock information data:", error);
                                reject(new Error("Failed to parse stock data: " + error.message));
                            }
                        }
                    });
                });
                
                // Construct prompt for AI to get stock information
                const botName = modelType === 'pro' ? '@Gemini-2.5-Pro-Exp' : '@Gemini-2.5-Flash-Preview';
                const prompt = `${botName} 
I need current stock information for ${ticker} in a specific JSON format. Please provide ONLY the JSON object with no additional text:

\`\`\`json
{
  "ticker": "${ticker}",
  "name": "Full company name",
  "price": {
    "current": 100.00,
    "change": 1.50,
    "changePercent": 1.5,
    "currency": "$"
  },
  "marketCap": "100B",
  "peRatio": 20.00,
  "revenue": "50B",
  "netIncome": "5B",
  "tradingVolume": "10M",
  "fiftyTwoWeekRange": "80.00 - 120.00",
  "dividendYield": "2.0%",
  "eps": 5.00,
  "beta": 1.20,
  "returns": {
    "oneMonth": 2.5,
    "threeMonth": 5.0,
    "ytd": 10.0,
    "oneYear": 15.0
  },
  "timestamp": "2024-07-10 16:30 EST"
}
\`\`\`

Provide the most current stock price and financial metrics available. For returns, use positive or negative percentages (without % sign) to indicate performance. Use the current date and approximate time for the timestamp.`;
                
                // Send prompt to fetch stock information
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    openChat: false
                });
                
                // Wait for the response
                const stockData = await responsePromise;
                
                // Add current timestamp if missing
                if (!stockData.timestamp) {
                    stockData.timestamp = new Date().toLocaleString("en-US", {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                }
                
                // Store in the data store
                dataStore.stock = stockData;
                
                // Update UI
                updateStockInfo(stockData);
                
                // Hide loading indicator
                document.getElementById('stockLoadingIndicator').classList.add('hidden');
                
                // Show stock content
                document.getElementById('stockContent').classList.remove('hidden');
                
                // Show success message
                displayMessage(`Successfully loaded stock information for ${ticker}.`, "success");
                
                return stockData;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('stockLoadingIndicator').classList.add('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to load stock information. ${error.message}`, "error");
                
                throw error;
            }
        }

        // Event listeners for financial tables view toggle buttons
        document.getElementById('incomeTableBtn').addEventListener('click', () => toggleView('income', 'table'));
        document.getElementById('incomeChartBtn').addEventListener('click', () => toggleView('income', 'chart'));
        document.getElementById('balanceTableBtn').addEventListener('click', () => toggleView('balance', 'table'));
        document.getElementById('balanceChartBtn').addEventListener('click', () => toggleView('balance', 'chart'));
        document.getElementById('cashFlowTableBtn').addEventListener('click', () => toggleView('cashFlow', 'table'));
        document.getElementById('cashFlowChartBtn').addEventListener('click', () => toggleView('cashFlow', 'chart'));
        
        // Event listeners for financial statement tabs
        document.getElementById('incomeBtn').addEventListener('click', function() {
            switchTab('incomeStatement');
            setActiveButton(this);
        });
        
        document.getElementById('balanceBtn').addEventListener('click', function() {
            switchTab('balanceSheet');
            setActiveButton(this);
        });
        
        document.getElementById('cashFlowBtn').addEventListener('click', function() {
            switchTab('cashFlow');
            setActiveButton(this);
        });

        // Event listener for "Analyze Financials" button
        document.getElementById('analyzeFinancialsBtn').addEventListener('click', function() {
            analyzeFinancialData();
        });

        // Event listeners for analysis tab buttons
        document.querySelectorAll('.analysis-tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const targetContent = document.getElementById(targetId);
                
                // Toggle visibility of the target content
                if (targetContent.classList.contains('hidden')) {
                    // Hide all content divs
                    document.querySelectorAll('.analysis-content').forEach(content => {
                        if (content.id !== targetId) {
                            content.classList.add('hidden');
                        }
                    });
                    
                    // Show the target content
                    targetContent.classList.remove('hidden');
                    
                    // Update the arrow icon
                    this.querySelector('svg').innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                    `;
                } else {
                    // Hide the target content
                    targetContent.classList.add('hidden');
                    
                    // Update the arrow icon
                    this.querySelector('svg').innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    `;
                }
            });
        });


        // Function to export financial data to Excel with pre-formatted values
        function exportToExcel() {
            try {
                // Get the financial data from the dataStore
                const data = dataStore.financials;
                if (!data || !data.incomeStatement || !data.balanceSheet || !data.cashFlow) {
                    displayMessage("No financial data available to export. Please fetch data first.", "error");
                    return;
                }
                
                // Create a new workbook
                const wb = XLSX.utils.book_new();
                
                // Format for Excel: pre-format values for export
                function formatDataForExcel(statementData, structure) {
                    const years = data.years;
                    const rows = [];
                    
                    // Add header row with years in bold (using uppercase for emphasis)
                    const headerRow = ['ITEM'];
                    years.forEach(year => {
                        headerRow.push(`${data.fiscalYearEnd}, ${year}`);
                    });
                    rows.push(headerRow);
                    
                    // Add data rows based on structure
                    structure.forEach(item => {
                        if (item.isSection && item.colspan) {
                            // Section header with uppercase only, no decorative symbols
                            const sectionRow = [item.label.toUpperCase()];
                            // Add empty cells for each year
                            for (let i = 0; i < years.length; i++) {
                                sectionRow.push('');
                            }
                            rows.push(sectionRow);
                        } else if (statementData[item.label]) {
                            // Data row with pre-formatted label
                            let formattedLabel = item.label;
                            
                            // Add indentation for subsidiary items
                            if (item.cssClass && item.cssClass.includes('pl-6')) {
                                formattedLabel = '    ' + formattedLabel;
                            }
                            
                            // Make totals uppercase for emphasis, no decorative symbols
                            if (item.isTotal) {
                                formattedLabel = formattedLabel.toUpperCase();
                            }
                            
                            const row = [formattedLabel];
                            
                            // Add pre-formatted values with accounting style
                            statementData[item.label].forEach(value => {
                                // Clean financial numbers for Excel
                                const numValue = parseFinancialNumber(value);
                                const isNegative = numValue < 0 || (item.isNegative && numValue !== 0);
                                const absValue = Math.abs(numValue);
                                
                                // Format with currency symbol and commas, parentheses for negatives
                                let formattedValue;
                                if (isNegative) {
                                    formattedValue = `(${data.currencySymbol}${absValue.toLocaleString()})`;
                                } else {
                                    formattedValue = `${data.currencySymbol}${absValue.toLocaleString()}`;
                                }
                                
                                row.push(formattedValue);
                            });
                            
                            rows.push(row);
                        }
                    });
                    
                    return rows;
                }
                
                // Create worksheets for each statement
                const incomeData = formatDataForExcel(data.incomeStatement, incomeStatementStructure);
                const balanceData = formatDataForExcel(data.balanceSheet, balanceSheetStructure);
                const cashFlowData = formatDataForExcel(data.cashFlow, cashFlowStructure);
                
                // Add worksheets to workbook with column widths
                const wsIncome = XLSX.utils.aoa_to_sheet(incomeData);
                // Set column widths
                wsIncome['!cols'] = [
                    { wch: 40 }, // Item column - wider for indented items
                    { wch: 18 }, // Year 1
                    { wch: 18 }, // Year 2
                    { wch: 18 }, // Year 3
                    { wch: 18 }  // Year 4
                ];
                XLSX.utils.book_append_sheet(wb, wsIncome, "Income Statement");
                
                const wsBalance = XLSX.utils.aoa_to_sheet(balanceData);
                wsBalance['!cols'] = [
                    { wch: 40 }, // Item column
                    { wch: 18 }, // Year 1
                    { wch: 18 }, // Year 2
                    { wch: 18 }, // Year 3
                    { wch: 18 }  // Year 4
                ];
                XLSX.utils.book_append_sheet(wb, wsBalance, "Balance Sheet");
                
                const wsCashFlow = XLSX.utils.aoa_to_sheet(cashFlowData);
                wsCashFlow['!cols'] = [
                    { wch: 40 }, // Item column
                    { wch: 18 }, // Year 1
                    { wch: 18 }, // Year 2
                    { wch: 18 }, // Year 3
                    { wch: 18 }  // Year 4
                ];
                XLSX.utils.book_append_sheet(wb, wsCashFlow, "Cash Flow");
                
                // Create overview sheet with company info
                const overviewRows = [
                    ["COMPANY INFORMATION"],
                    [""],
                    ["Name", data.name || dataStore.currentTicker],
                    ["Ticker", dataStore.currentTicker || ""],
                    ["Fiscal Year End", data.fiscalYearEnd],
                    ["Currency", data.currencySymbol],
                    ["Data Unit", data.currencyUnit],
                    ["Export Date", new Date().toLocaleDateString()],
                    [""],
                    ["FINANCIAL STATEMENTS"],
                    ["Income Statement", "Revenue, expenses, and profitability"],
                    ["Balance Sheet", "Assets, liabilities, and equity"],
                    ["Cash Flow", "Cash generation and usage"]
                ];
                
                const wsOverview = XLSX.utils.aoa_to_sheet(overviewRows);
                wsOverview['!cols'] = [{ wch: 20 }, { wch: 40 }];
                XLSX.utils.book_append_sheet(wb, wsOverview, "Company Info", true);
                
                // Generate Excel file with a more descriptive filename
                const fileName = `${data.name || dataStore.currentTicker || 'Company'}_Financial_Statements.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                displayMessage(`Successfully exported financial data to ${fileName} with professional formatting`, "success");
            } catch (error) {
                console.error("Error exporting to Excel:", error);
                displayMessage(`Error exporting data: ${error.message}`, "error");
            }
        }
        
        // Export to Excel function for Valuation page
        function exportValuationToExcel() {
            try {
                // Get the financial data and valuation data
                const financialData = dataStore.financials || dataStore.valuation;
                const valuationResults = calculateValuation(); // Recalculate to ensure fresh data
                
                if (!financialData || !valuationResults || !valuationResults.projections) {
                    displayMessage("No valuation data available to export. Please calculate valuation first.", "error");
                    return;
                }
                
                // Create a new workbook
                const wb = XLSX.utils.book_new();
                
                // First, add financial statements - reuse the same function from exportToExcel
                function formatDataForExcel(statementData, structure) {
                    const years = financialData.years;
                    const rows = [];
                    
                    // Add header row with years
                    const headerRow = ['Item'];
                    years.forEach(year => {
                        headerRow.push(`${financialData.fiscalYearEnd}, ${year}`);
                    });
                    rows.push(headerRow);
                    
                    // Add data rows based on structure
                    structure.forEach(item => {
                        if (item.isSection && item.colspan) {
                            // Section header
                            rows.push([item.label, '', '', '', '']);
                        } else if (statementData[item.label]) {
                            // Data row
                            const row = [item.label];
                            statementData[item.label].forEach(value => {
                                // Clean financial strings for Excel (remove currency symbols, parentheses for negatives)
                                const numValue = parseFinancialNumber(value);
                                row.push(numValue);
                            });
                            rows.push(row);
                        }
                    });
                    
                    return rows;
                }
                
                // Add financial statement worksheets
                if (financialData.incomeStatement) {
                    const incomeData = formatDataForExcel(financialData.incomeStatement, incomeStatementStructure);
                    const wsIncome = XLSX.utils.aoa_to_sheet(incomeData);
                    XLSX.utils.book_append_sheet(wb, wsIncome, "Income Statement");
                }
                
                if (financialData.balanceSheet) {
                    const balanceData = formatDataForExcel(financialData.balanceSheet, balanceSheetStructure);
                    const wsBalance = XLSX.utils.aoa_to_sheet(balanceData);
                    XLSX.utils.book_append_sheet(wb, wsBalance, "Balance Sheet");
                }
                
                if (financialData.cashFlow) {
                    const cashFlowData = formatDataForExcel(financialData.cashFlow, cashFlowStructure);
                    const wsCashFlow = XLSX.utils.aoa_to_sheet(cashFlowData);
                    XLSX.utils.book_append_sheet(wb, wsCashFlow, "Cash Flow");
                }
                
                // Format valuation model data
                const projectionRows = [];
                
                // Header row with years
                const projectionHeader = ['Item', 'Historical'];
                const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 5;
                for (let i = 1; i <= forecastPeriod; i++) {
                    projectionHeader.push(`Year ${i}`);
                }
                projectionHeader.push('Terminal');
                projectionRows.push(projectionHeader);
                
                // Revenue & Growth
                projectionRows.push(['Revenue & Growth', '', '', '', '', '', '', '']);
                projectionRows.push(['Revenue', 
                    valuationResults.projections[0].revenue,
                    valuationResults.projections[1].revenue,
                    valuationResults.projections[2].revenue,
                    valuationResults.projections[3].revenue,
                    valuationResults.projections[4].revenue,
                    valuationResults.projections[5].revenue,
                    valuationResults.projections[6].revenue
                ]);
                projectionRows.push(['Revenue Growth (%)', 
                    0, // Historical is always 0
                    valuationResults.projections[1].revenueGrowth,
                    valuationResults.projections[2].revenueGrowth,
                    valuationResults.projections[3].revenueGrowth,
                    valuationResults.projections[4].revenueGrowth,
                    valuationResults.projections[5].revenueGrowth,
                    '' // Terminal year doesn't show growth rate
                ]);
                
                // Profitability
                projectionRows.push(['Profitability', '', '', '', '', '', '', '']);
                projectionRows.push(['Operating Income', 
                    valuationResults.projections[0].operatingIncome,
                    valuationResults.projections[1].operatingIncome,
                    valuationResults.projections[2].operatingIncome,
                    valuationResults.projections[3].operatingIncome,
                    valuationResults.projections[4].operatingIncome,
                    valuationResults.projections[5].operatingIncome,
                    valuationResults.projections[6].operatingIncome
                ]);
                projectionRows.push(['Operating Margin (%)', 
                    valuationResults.projections[0].operatingMargin,
                    valuationResults.projections[1].operatingMargin,
                    valuationResults.projections[2].operatingMargin,
                    valuationResults.projections[3].operatingMargin,
                    valuationResults.projections[4].operatingMargin,
                    valuationResults.projections[5].operatingMargin,
                    '' // Terminal year doesn't show margin
                ]);
                
                // Free Cash Flow
                projectionRows.push(['Free Cash Flow', '', '', '', '', '', '', '']);
                projectionRows.push(['FCF', 
                    valuationResults.projections[0].fcf || '',
                    valuationResults.projections[1].fcf,
                    valuationResults.projections[2].fcf,
                    valuationResults.projections[3].fcf,
                    valuationResults.projections[4].fcf,
                    valuationResults.projections[5].fcf,
                    '' // Terminal
                ]);
                projectionRows.push(['PV of FCF',
                    '',
                    valuationResults.projections[1].presentValueFCF,
                    valuationResults.projections[2].presentValueFCF,
                    valuationResults.projections[3].presentValueFCF,
                    valuationResults.projections[4].presentValueFCF,
                    valuationResults.projections[5].presentValueFCF,
                    ''
                ]);
                
                // Terminal Value
                projectionRows.push(['Terminal Value', '', '', '', '', '', '', '']);
                projectionRows.push(['Terminal Value (DCF)', '', '', '', '', '', '', 
                    valuationResults.projections[6].terminalValueDCF || '']);
                projectionRows.push(['Terminal Value (Multiple)', '', '', '', '', '', '', 
                    valuationResults.projections[6].terminalValueMultiple || '']);
                
                // Final Valuation Results
                projectionRows.push(['Valuation Results', '', '', '', '', '', '', '']);
                projectionRows.push(['Enterprise Value (DCF)', valuationResults.enterpriseValueDCF]);
                projectionRows.push(['Enterprise Value (Multiple)', valuationResults.enterpriseValueMultiple]);
                projectionRows.push(['Equity Value (DCF)', valuationResults.equityValueDCF]);
                projectionRows.push(['Equity Value (Multiple)', valuationResults.equityValueMultiple]);
                projectionRows.push(['Share Price (DCF)', valuationResults.sharePriceDCF]);
                projectionRows.push(['Share Price (Multiple)', valuationResults.sharePriceMultiple]);
                
                // Add model parameters
                projectionRows.push(['Model Parameters', '', '', '', '', '', '', '']);
                projectionRows.push(['Forecast Period (Years)', forecastPeriod]);
                projectionRows.push(['Revenue Growth Rate (%)', parseFloat(document.getElementById('revenueGrowthRate').value)]);
                projectionRows.push(['Operating Margin (%)', parseFloat(document.getElementById('operatingMargin').value)]);
                projectionRows.push(['Tax Rate (%)', parseFloat(document.getElementById('taxRate').value)]);
                projectionRows.push(['Discount Rate (WACC) (%)', parseFloat(document.getElementById('discountRate').value)]);
                projectionRows.push(['Terminal Growth Rate (%)', parseFloat(document.getElementById('terminalGrowthRate').value)]);
                
                // Create DCF model worksheet
                const wsDCF = XLSX.utils.aoa_to_sheet(projectionRows);
                XLSX.utils.book_append_sheet(wb, wsDCF, "DCF Valuation Model");
                
                // Generate Excel file
                const fileName = `${financialData.name || dataStore.currentTicker || 'Company'}_Valuation_Model.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                displayMessage(`Successfully exported valuation model to ${fileName}`, "success");
            } catch (error) {
                console.error("Error exporting valuation to Excel:", error);
                displayMessage(`Error exporting valuation data: ${error.message}`, "error");
            }
        }
        
        // Event listener for Export to Excel buttons
        document.getElementById('exportExcel').addEventListener('click', exportToExcel);
        document.getElementById('exportValuationExcel').addEventListener('click', exportDynamicExcel);
        
        // Event listener for valuation calculation
        document.getElementById('calculateValuation').addEventListener('click', calculateValuation);
        
        // Function to export dynamic Excel with formulas
        function exportDynamicExcel() {
            try {
                // Get the financial data and valuation data
                const financialData = dataStore.financials || dataStore.valuation;
                const valuationResults = calculateValuation(); // Recalculate to ensure fresh data
                
                if (!financialData || !valuationResults || !valuationResults.projections) {
                    displayMessage("No valuation data available to export. Please calculate valuation first.", "error");
                    return;
                }
                
                // Create a new workbook
                const wb = XLSX.utils.book_new();
                
                // Add financial statement worksheets - reuse code from exportToExcel
                function formatDataForExcel(statementData, structure) {
                    const years = financialData.years;
                    const rows = [];
                    
                    // Add header row with years
                    const headerRow = ['Item'];
                    years.forEach(year => {
                        headerRow.push(`${financialData.fiscalYearEnd}, ${year}`);
                    });
                    rows.push(headerRow);
                    
                    // Add data rows based on structure
                    structure.forEach(item => {
                        if (item.isSection && item.colspan) {
                            // Section header - use uppercase without decorative symbols
                            rows.push([item.label.toUpperCase(), '', '', '', '']);
                        } else if (statementData[item.label]) {
                            // Data row
                            let formattedLabel = item.label;
                            
                            // Add indentation for subsidiary items
                            if (item.cssClass && item.cssClass.includes('pl-6')) {
                                formattedLabel = '    ' + formattedLabel;
                            }
                            
                            // Make totals uppercase for emphasis, no decorative symbols
                            if (item.isTotal) {
                                formattedLabel = formattedLabel.toUpperCase();
                            }
                            
                            const row = [formattedLabel];
                            statementData[item.label].forEach(value => {
                                // Clean financial strings for Excel (remove currency symbols, parentheses for negatives)
                                const numValue = parseFinancialNumber(value);
                                row.push(numValue);
                            });
                            rows.push(row);
                        }
                    });
                    
                    return rows;
                }
                
                // Add financial statement worksheets
                if (financialData.incomeStatement) {
                    const incomeData = formatDataForExcel(financialData.incomeStatement, incomeStatementStructure);
                    const wsIncome = XLSX.utils.aoa_to_sheet(incomeData);
                    XLSX.utils.book_append_sheet(wb, wsIncome, "Income Statement");
                }
                
                if (financialData.balanceSheet) {
                    const balanceData = formatDataForExcel(financialData.balanceSheet, balanceSheetStructure);
                    const wsBalance = XLSX.utils.aoa_to_sheet(balanceData);
                    XLSX.utils.book_append_sheet(wb, wsBalance, "Balance Sheet");
                }
                
                if (financialData.cashFlow) {
                    const cashFlowData = formatDataForExcel(financialData.cashFlow, cashFlowStructure);
                    const wsCashFlow = XLSX.utils.aoa_to_sheet(cashFlowData);
                    XLSX.utils.book_append_sheet(wb, wsCashFlow, "Cash Flow");
                }
                
                // Create a Parameters worksheet for model inputs
                const paramsData = [
                    ['DCF MODEL PARAMETERS', ''],
                    ['Parameter', 'Value'],
                    ['Base Revenue', valuationResults.projections[0].revenue],
                    ['Revenue Growth Rate (%)', parseFloat(document.getElementById('revenueGrowthRate').value)],
                    ['Operating Margin (%)', parseFloat(document.getElementById('operatingMargin').value)],
                    ['Tax Rate (%)', parseFloat(document.getElementById('taxRate').value)],
                    ['Capital Expenditure (% of Revenue)', parseFloat(document.getElementById('capexRate').value)],
                    ['Working Capital (% of Revenue)', parseFloat(document.getElementById('wcRate').value)],
                    ['Depreciation Rate (% of Revenue)', valuationResults.projections[0].depreciation / valuationResults.projections[0].revenue * 100],
                    ['Discount Rate (WACC) (%)', parseFloat(document.getElementById('discountRate').value)],
                    ['Terminal Growth Rate (%)', parseFloat(document.getElementById('terminalGrowthRate').value)],
                    ['EV/EBITDA Multiple', parseFloat(document.getElementById('evMultiple').value)],
                    ['Forecast Period (Years)', parseInt(document.getElementById('forecastPeriod').value)],
                    ['Shares Outstanding (millions)', financialData.sharesOutstanding],
                    ['Net Debt (millions)', financialData.netDebt]
                ];
                
                const wsParams = XLSX.utils.aoa_to_sheet(paramsData);
                XLSX.utils.book_append_sheet(wb, wsParams, "Parameters");
                
                // Create DCF Model worksheet with formulas
                const dcfData = [];
                const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 5;
                
                // Header row with years
                const headerRow = ['ITEM', 'Historical'];
                for (let i = 1; i <= forecastPeriod; i++) {
                    headerRow.push(`Year ${i}`);
                }
                headerRow.push('Terminal');
                dcfData.push(headerRow);
                
                // Add revenue row with growth formulas - no empty row after header
                dcfData.push(['MODEL INPUTS', '', '', '', '', '', '', '']);
                
                // Add revenue row with growth formulas
                dcfData.push(['Revenue', 
                    { f: "Parameters!B3" }, // Historical: base revenue
                    { f: "B3*(1+Parameters!B4/100)" }, // Year 1: Historical * (1 + growth rate)
                    { f: "C3*(1+Parameters!B4/100)" }, // Year 2: Year 1 * (1 + growth rate)
                    { f: "D3*(1+Parameters!B4/100)" }, // Year 3
                    { f: "E3*(1+Parameters!B4/100)" }, // Year 4
                    { f: "F3*(1+Parameters!B4/100)" }, // Year 5
                    { f: "G3*(1+Parameters!B11/100)" } // Terminal: Year 5 * (1 + terminal growth)
                ]);
                
                // Revenue growth row
                dcfData.push(['Revenue Growth (%)', 
                    0, // Historical is always 0
                    { f: "Parameters!B4" }, // Year 1: input growth rate
                    { f: "Parameters!B4" }, // Year 2: input growth rate
                    { f: "Parameters!B4" }, // Year 3
                    { f: "Parameters!B4" }, // Year 4
                    { f: "Parameters!B4" }, // Year 5
                    { f: "Parameters!B11" } // Terminal: terminal growth rate
                ]);
                
                // Profitability section - no empty row before section header
                dcfData.push(['PROFITABILITY', '', '', '', '', '', '', '']);
                
                // Operating income formulas
                dcfData.push(['Operating Income', 
                    { f: "B3*Parameters!B5/100" }, // Historical: revenue * operating margin
                    { f: "C3*Parameters!B5/100" }, // Year 1
                    { f: "D3*Parameters!B5/100" }, // Year 2
                    { f: "E3*Parameters!B5/100" }, // Year 3
                    { f: "F3*Parameters!B5/100" }, // Year 4
                    { f: "G3*Parameters!B5/100" }, // Year 5
                    { f: "H3*Parameters!B5/100" }  // Terminal
                ]);
                
                // Operating margin row
                dcfData.push(['Operating Margin (%)', 
                    { f: "Parameters!B5" }, // Historical
                    { f: "Parameters!B5" }, // Year 1
                    { f: "Parameters!B5" }, // Year 2
                    { f: "Parameters!B5" }, // Year 3
                    { f: "Parameters!B5" }, // Year 4
                    { f: "Parameters!B5" }, // Year 5
                    { f: "Parameters!B5" }  // Terminal
                ]);
                
                // Depreciation & Amortization
                dcfData.push(['Depreciation & Amortization', 
                    { f: "B3*Parameters!B9/100" }, // Historical: revenue * depreciation rate
                    { f: "C3*Parameters!B9/100" }, // Year 1
                    { f: "D3*Parameters!B9/100" }, // Year 2
                    { f: "E3*Parameters!B9/100" }, // Year 3
                    { f: "F3*Parameters!B9/100" }, // Year 4
                    { f: "G3*Parameters!B9/100" }, // Year 5
                    { f: "H3*Parameters!B9/100" }  // Terminal
                ]);
                
                // EBITDA
                dcfData.push(['EBITDA', 
                    { f: "B6+B8" }, // Historical: Operating Income + D&A
                    { f: "C6+C8" }, // Year 1
                    { f: "D6+D8" }, // Year 2
                    { f: "E6+E8" }, // Year 3
                    { f: "F6+F8" }, // Year 4
                    { f: "G6+G8" }, // Year 5
                    { f: "H6+H8" }  // Terminal
                ]);
                
                // Taxes
                dcfData.push(['Taxes', 
                    { f: "B6*Parameters!B6/100" }, // Historical: Operating Income * Tax Rate
                    { f: "C6*Parameters!B6/100" }, // Year 1
                    { f: "D6*Parameters!B6/100" }, // Year 2
                    { f: "E6*Parameters!B6/100" }, // Year 3
                    { f: "F6*Parameters!B6/100" }, // Year 4
                    { f: "G6*Parameters!B6/100" }, // Year 5
                    { f: "H6*Parameters!B6/100" }  // Terminal
                ]);
                
                // NOPAT (Net Operating Profit After Tax)
                dcfData.push(['NOPAT', 
                    { f: "B6-B10" }, // Historical: Operating Income - Taxes
                    { f: "C6-C10" }, // Year 1
                    { f: "D6-D10" }, // Year 2
                    { f: "E6-E10" }, // Year 3
                    { f: "F6-F10" }, // Year 4
                    { f: "G6-G10" }, // Year 5
                    { f: "H6-H10" }  // Terminal
                ]);
                
                // Capital Investments section - no empty row
                dcfData.push(['CAPITAL INVESTMENTS', '', '', '', '', '', '', '']);
                
                // CapEx
                dcfData.push(['Capital Expenditures', 
                    { f: "B3*Parameters!B7/100" }, // Historical: Revenue * CapEx Rate
                    { f: "C3*Parameters!B7/100" }, // Year 1
                    { f: "D3*Parameters!B7/100" }, // Year 2
                    { f: "E3*Parameters!B7/100" }, // Year 3
                    { f: "F3*Parameters!B7/100" }, // Year 4
                    { f: "G3*Parameters!B7/100" }, // Year 5
                    { f: "H3*Parameters!B7/100" }  // Terminal
                ]);
                
                // Working Capital
                dcfData.push(['Working Capital', 
                    { f: "B3*Parameters!B8/100" }, // Historical: Revenue * WC Rate
                    { f: "C3*Parameters!B8/100" }, // Year 1
                    { f: "D3*Parameters!B8/100" }, // Year 2
                    { f: "E3*Parameters!B8/100" }, // Year 3
                    { f: "F3*Parameters!B8/100" }, // Year 4
                    { f: "G3*Parameters!B8/100" }, // Year 5
                    { f: "H3*Parameters!B8/100" }  // Terminal
                ]);
                
                // Working Capital Change
                dcfData.push(['Working Capital Change', 
                    0, // Historical: no change in first year
                    { f: "C14-B14" }, // Year 1: Year 1 WC - Historical WC
                    { f: "D14-C14" }, // Year 2: Year 2 WC - Year 1 WC
                    { f: "E14-D14" }, // Year 3
                    { f: "F14-E14" }, // Year 4
                    { f: "G14-F14" }, // Year 5
                    { f: "H14-G14" }  // Terminal
                ]);
                
                // Free Cash Flow section - no empty row
                dcfData.push(['FREE CASH FLOW', '', '', '', '', '', '', '']);
                
                // FCF calculation: NOPAT + D&A - CapEx - WC
                dcfData.push(['Free Cash Flow', 
                    { f: "B11+B8-B13-B15" }, // Historical
                    { f: "C11+C8-C13-C15" }, // Year 1
                    { f: "D11+D8-D13-D15" }, // Year 2
                    { f: "E11+E8-E13-E15" }, // Year 3
                    { f: "F11+F8-F13-F15" }, // Year 4
                    { f: "G11+G8-G13-G15" }, // Year 5
                    { f: "H11+H8-H13-H15" }  // Terminal
                ]);
                
                // Discount Factor
                dcfData.push(['Discount Factor', 
                    1, // Historical: No discounting
                    { f: "POWER(1+Parameters!B10/100,1)" }, // Year 1
                    { f: "POWER(1+Parameters!B10/100,2)" }, // Year 2
                    { f: "POWER(1+Parameters!B10/100,3)" }, // Year 3
                    { f: "POWER(1+Parameters!B10/100,4)" }, // Year 4
                    { f: "POWER(1+Parameters!B10/100,5)" }, // Year 5
                    { f: "POWER(1+Parameters!B10/100,5)" }  // Terminal: same as Year 5
                ]);
                
                // Present Value of FCF
                dcfData.push(['Present Value of FCF', 
                    0, // Historical: Not relevant
                    { f: "C17/C18" }, // Year 1: FCF / Discount Factor
                    { f: "D17/D18" }, // Year 2
                    { f: "E17/E18" }, // Year 3
                    { f: "F17/F18" }, // Year 4
                    { f: "G17/G18" }, // Year 5
                    0  // Terminal: Calculated separately below
                ]);
                
                // Sum of Present Values
                dcfData.push(['Sum of Present Values', 
                    { f: "SUM(C19:G19)" }, // Sum of all years excluding Historical and Terminal
                    '', '', '', '', '', ''
                ]);
                
                // Terminal Value section - no empty row
                dcfData.push(['TERMINAL VALUE', '', '', '', '', '', '', '']);
                
                // Terminal Value (Gordon Growth Method)
                dcfData.push(['Terminal Value (DCF)', '', '', '', '', '', '', 
                    { f: "G17*(1+Parameters!B11/100)/(Parameters!B10/100-Parameters!B11/100)" }
                ]);
                
                // Terminal Value (Multiple Method)
                dcfData.push(['Terminal Value (Multiple)', '', '', '', '', '', '', 
                    { f: "G9*Parameters!B12" } // Year 5 EBITDA * EV/EBITDA Multiple
                ]);
                
                // Present Value of Terminal Values
                dcfData.push(['PV of Terminal Value (DCF)', 
                    { f: "H22/G18" }, // Terminal Value DCF / Year 5 Discount Factor
                    '', '', '', '', '', ''
                ]);
                
                dcfData.push(['PV of Terminal Value (Multiple)', 
                    { f: "H23/G18" }, // Terminal Value Multiple / Year 5 Discount Factor
                    '', '', '', '', '', ''
                ]);
                
                // Valuation Results section - no empty row
                dcfData.push(['VALUATION RESULTS', '', '', '', '', '', '', '']);
                
                // Enterprise Value (DCF Method)
                dcfData.push(['Enterprise Value (DCF)', 
                    { f: "B20+B24" }, // Sum of PVs + PV of Terminal Value (DCF)
                    '', '', '', '', '', ''
                ]);
                
                // Enterprise Value (Multiple Method)
                dcfData.push(['Enterprise Value (Multiple)', 
                    { f: "B20+B25" }, // Sum of PVs + PV of Terminal Value (Multiple)
                    '', '', '', '', '', ''
                ]);
                
                // Equity Value (DCF)
                dcfData.push(['Equity Value (DCF)', 
                    { f: "B27-Parameters!B14" }, // Enterprise Value - Net Debt
                    '', '', '', '', '', ''
                ]);
                
                // Equity Value (Multiple)
                dcfData.push(['Equity Value (Multiple)', 
                    { f: "B28-Parameters!B14" }, // Enterprise Value - Net Debt
                    '', '', '', '', '', ''
                ]);
                
                // Share Price (DCF)
                dcfData.push(['Share Price (DCF)', 
                    { f: "B29/Parameters!B13" }, // Equity Value / Shares Outstanding
                    '', '', '', '', '', ''
                ]);
                
                // Share Price (Multiple)
                dcfData.push(['Share Price (Multiple)', 
                    { f: "B30/Parameters!B13" }, // Equity Value / Shares Outstanding
                    '', '', '', '', '', ''
                ]);
                
                // Create the DCF model worksheet
                const wsDCF = XLSX.utils.aoa_to_sheet(dcfData);
                
                // Set column widths for DCF model
                wsDCF['!cols'] = [
                    { wch: 25 }, // Item column
                    { wch: 12 }, // Historical
                    { wch: 12 }, // Year 1
                    { wch: 12 }, // Year 2
                    { wch: 12 }, // Year 3
                    { wch: 12 }, // Year 4
                    { wch: 12 }, // Year 5
                    { wch: 12 }  // Terminal
                ];
                
                XLSX.utils.book_append_sheet(wb, wsDCF, "DCF Model");
                
                // Generate Excel file
                const fileName = `${financialData.name || dataStore.currentTicker || 'Company'}_Valuation_Model.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                displayMessage(`Successfully exported valuation model to ${fileName} with dynamic formulas`, "success");
            } catch (error) {
                console.error("Error exporting dynamic Excel:", error);
                displayMessage(`Error exporting data: ${error.message}`, "error");
            }
        }

        // Event listeners for demo buttons and "Fetch" buttons in each page
        // Company Overview page
        document.getElementById('fetchOverviewBtn').addEventListener('click', function() {
            const ticker = document.getElementById('overviewTickerInput').value.trim();
            if (!ticker) {
                displayMessage("Please enter a stock ticker.", "error");
                return;
            }
            fetchCompanyOverview(ticker);
        });
        
        // Listen for input changes on the ticker input to update other inputs
        document.getElementById('overviewTickerInput').addEventListener('input', function() {
            updateAllTickerInputs(this.value.trim());
        });
        
        document.querySelector('.overview-quick-btn').addEventListener('click', function() {
            document.getElementById('overviewTickerInput').value = "AAPL";
            fetchCompanyOverview("AAPL");
        });
        
        // Financial Statements page
        document.getElementById('fetchFinancialsBtn').addEventListener('click', function() {
            const ticker = document.getElementById('financialsTickerInput').value.trim();
            if (!ticker) {
                displayMessage("Please enter a stock ticker.", "error");
                return;
            }
            fetchFinancialData(ticker);
        });
        
        // Listen for input changes on the financials ticker input
        document.getElementById('financialsTickerInput').addEventListener('input', function() {
            updateAllTickerInputs(this.value.trim());
        });
        
        document.querySelector('.financials-quick-btn').addEventListener('click', function() {
            document.getElementById('financialsTickerInput').value = "AAPL";
            fetchFinancialData("AAPL");
        });
        
        // Valuation Model page
        document.getElementById('fetchValuationBtn').addEventListener('click', function() {
            const ticker = document.getElementById('valuationTickerInput').value.trim();
            if (!ticker) {
                displayMessage("Please enter a stock ticker.", "error");
                return;
            }
            fetchValuationData(ticker);
        });
        
        // Listen for input changes on the valuation ticker input
        document.getElementById('valuationTickerInput').addEventListener('input', function() {
            updateAllTickerInputs(this.value.trim());
        });
        
        document.querySelector('.valuation-quick-btn').addEventListener('click', function() {
            document.getElementById('valuationTickerInput').value = "AAPL";
            fetchValuationData("AAPL");
        });
        
        // Analyst Consensus page
        document.getElementById('fetchAnalystBtn').addEventListener('click', function() {
            const ticker = document.getElementById('analystTickerInput').value.trim();
            if (!ticker) {
                displayMessage("Please enter a stock ticker.", "error");
                return;
            }
            fetchAnalystConsensus(ticker);
        });
        
        // Listen for input changes on the analyst ticker input
        document.getElementById('analystTickerInput').addEventListener('input', function() {
            updateAllTickerInputs(this.value.trim());
        });
        
        document.querySelector('.analyst-quick-btn').addEventListener('click', function() {
            document.getElementById('analystTickerInput').value = "AAPL";
            fetchAnalystConsensus("AAPL");
        });
        
        // Stock Information page
        document.getElementById('fetchStockDataBtn').addEventListener('click', function() {
            const ticker = document.getElementById('stockTickerInput').value.trim();
            if (!ticker) {
                displayMessage("Please enter a stock ticker.", "error");
                return;
            }
            fetchStockInfo(ticker);
        });
        
        // Listen for input changes on the stock ticker input
        document.getElementById('stockTickerInput').addEventListener('input', function() {
            updateAllTickerInputs(this.value.trim());
        });
        
        document.querySelector('.stock-quick-btn').addEventListener('click', function() {
            document.getElementById('stockTickerInput').value = "AAPL";
            fetchStockInfo("AAPL");
        });
        
        // Industry Analysis page
        document.getElementById('fetchIndustryBtn').addEventListener('click', function() {
            const ticker = document.getElementById('industryTickerInput').value.trim();
            if (!ticker) {
                displayMessage("Please enter a stock ticker.", "error");
                return;
            }
            fetchIndustryData(ticker);
        });
        
        // Listen for input changes on the industry ticker input
        document.getElementById('industryTickerInput').addEventListener('input', function() {
            updateAllTickerInputs(this.value.trim());
        });
        
        document.querySelector('.industry-quick-btn').addEventListener('click', function() {
            document.getElementById('industryTickerInput').value = "AAPL";
            fetchIndustryData("AAPL");
        });
        
        // Function to fetch industry analysis data
        async function fetchIndustryData(ticker) {
            // Update all ticker inputs across pages
            updateAllTickerInputs(ticker);
            
            // Show loading indicator
            document.getElementById('industryLoadingIndicator').classList.remove('hidden');
            document.getElementById('industryContent').classList.add('hidden');
            
            // For AAPL, use demo data
            if (ticker.toUpperCase() === 'AAPL') {
                displayMessage("Using pre-loaded sample data for Apple Inc. industry analysis", "info");
                
                // Sample industry data for Apple (Technology/Consumer Electronics)
                const industryData = {
                    companyName: "Apple Inc.",
                    ticker: "AAPL",
                    industry: "Consumer Electronics",
                    sector: "Technology",
                    dataDate: "June 2024",
                    overview: "The consumer electronics industry is dominated by large tech companies focused on mobile devices, personal computers, and wearable technology. The industry is characterized by rapid innovation cycles, strong brand loyalty, and increasing integration with software services. Key trends include AI integration, sustainability initiatives, and expansion of ecosystem-based business models.",
                    marketShare: {
                        data: [
                            { company: "Apple", share: 24.5 },
                            { company: "Samsung", share: 21.8 },
                            { company: "Xiaomi", share: 12.6 },
                            { company: "OPPO", share: 8.2 },
                            { company: "Vivo", share: 7.9 },
                            { company: "Others", share: 25.0 }
                        ],
                        position: "Market leader in premium segment with 24.5% overall market share"
                    },
                    growthTrends: {
                        industry: [
                            { year: 2020, growth: 5.2 },
                            { year: 2021, growth: 8.7 },
                            { year: 2022, growth: 6.3 },
                            { year: 2023, growth: 7.1 },
                            { year: 2024, growth: 7.8 }
                        ],
                        company: [
                            { year: 2020, growth: 5.5 },
                            { year: 2021, growth: 12.3 },
                            { year: 2022, growth: 7.8 },
                            { year: 2023, growth: 8.2 },
                            { year: 2024, growth: 9.5 }
                        ],
                        cagr: "7.0%",
                        comparison: "Outperforming industry by 2.3 percentage points"
                    },
                    competitors: [
                        { company: "Apple", marketShare: "24.5%", revenueGrowth: "8.2%", operatingMargin: "30.1%", peRatio: "28.9", marketCap: "$2.71T" },
                        { company: "Samsung", marketShare: "21.8%", revenueGrowth: "6.3%", operatingMargin: "15.2%", peRatio: "16.3", marketCap: "$342B" },
                        { company: "Xiaomi", marketShare: "12.6%", revenueGrowth: "9.7%", operatingMargin: "4.8%", peRatio: "23.7", marketCap: "$48B" },
                        { company: "OPPO", marketShare: "8.2%", revenueGrowth: "5.1%", operatingMargin: "5.4%", peRatio: "18.2", marketCap: "$32B" },
                        { company: "Vivo", marketShare: "7.9%", revenueGrowth: "6.8%", operatingMargin: "4.9%", peRatio: "15.8", marketCap: "$31B" }
                    ],
                    trends: [
                        { title: "AI Integration", description: "Incorporating AI capabilities across product lines for enhanced features and performance. Apple's AI strategy focuses on on-device intelligence and privacy." },
                        { title: "Services Expansion", description: "Growth of subscription-based services to complement hardware offerings. Apple's services segment continues to grow rapidly, contributing significantly to margin expansion." },
                        { title: "Sustainability Initiatives", description: "Focus on carbon neutrality, recyclable materials, and energy efficiency. Apple aims to be 100% carbon neutral across its entire business by 2030." },
                        { title: "Ecosystem Integration", description: "Creating seamless experiences across multiple devices and platforms. Apple's ecosystem remains a key competitive advantage, driving customer retention." },
                        { title: "Supply Chain Resilience", description: "Diversification of manufacturing locations and suppliers to reduce risk. Apple is gradually shifting some production away from China to India and Vietnam." }
                    ],
                    swot: {
                        strengths: [
                            "Strong brand loyalty and premium positioning",
                            "Vertical integration of hardware, software, and services",
                            "Industry-leading profit margins",
                            "Robust ecosystem creating switching costs",
                            "Substantial cash reserves for R&D and acquisitions"
                        ],
                        weaknesses: [
                            "High dependence on iPhone for revenue",
                            "Premium pricing limiting market share in developing regions",
                            "Supply chain concentration in certain regions",
                            "Limited market share in emerging markets",
                            "Regulatory scrutiny over App Store policies"
                        ],
                        opportunities: [
                            "Expansion into new product categories (AR/VR, automotive)",
                            "Growth in services revenue stream",
                            "Emerging markets penetration with tailored offerings",
                            "Health technology integration and expansion",
                            "Enterprise market growth"
                        ],
                        threats: [
                            "Intense competition in all product categories",
                            "Slowing smartphone replacement cycles",
                            "Regulatory challenges in multiple markets",
                            "Economic downturns affecting premium purchases",
                            "Supply chain disruptions and component shortages"
                        ]
                    }
                };
                
                // Update UI with the industry data
                updateIndustryAnalysis(industryData);
                
                // Hide loading indicator
                document.getElementById('industryLoadingIndicator').classList.add('hidden');
                
                // Show industry content
                document.getElementById('industryContent').classList.remove('hidden');
                
                // Show success message
                displayMessage("Successfully loaded industry analysis for Apple Inc.", "success");
                
                return industryData;
            }
            
            // For other tickers, get real data from AI model
            try {
                const modelType = getSelectedModel('industry');
                const modelName = modelType === 'pro' ? 'Gemini-2.5-Pro-Exp' : 'Gemini-2.5-Flash-Preview';
                
                displayMessage(`Fetching industry analysis for ${ticker}... This may take up to one minute.`, "info");
                
                // Register handler for industry data
                const handlerId = `industry-${Date.now()}`;
                
                // Create a Promise for handling the response
                const responsePromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.responses[0]?.statusText || "Error fetching industry analysis"));
                            return;
                        }
                        
                        if (result.status === "complete") {
                            const response = result.responses[0];
                            try {
                                // Parse the JSON data from the model's response
                                const responseText = response.content;
                                let industryData;
                                
                                // Extract JSON data from the response
                                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                                  responseText.match(/```([\s\S]*?)```/);
                                                  
                                try {
                                    if (jsonMatch && jsonMatch[1]) {
                                        // Try to parse JSON from code block
                                        industryData = JSON.parse(jsonMatch[1]);
                                    } else {
                                        // Try to extract a JSON object without code blocks
                                        const jsonPattern = /\{[\s\S]*\}/;
                                        const match = responseText.match(jsonPattern);
                                        if (match) {
                                            industryData = JSON.parse(match[0]);
                                        } else {
                                            throw new Error("Unable to extract JSON data from response");
                                        }
                                    }
                                } catch (jsonError) {
                                    console.error("JSON parsing error:", jsonError);
                                    
                                    // Log a sample of the problematic text for debugging
                                    console.log("Response text sample:", responseText.substring(0, 200) + "...");
                                    
                                    // Attempt to fix common JSON parsing issues
                                    let cleanedText = "";
                                    
                                    if (jsonMatch && jsonMatch[1]) {
                                        cleanedText = jsonMatch[1];
                                    } else {
                                        const jsonPattern = /\{[\s\S]*\}/;
                                        const match = responseText.match(jsonPattern);
                                        if (match) {
                                            cleanedText = match[0];
                                        } else {
                                            throw new Error("Unable to extract JSON data from response after cleanup attempts");
                                        }
                                    }
                                    
                                    // Remove any trailing commas before closing brackets
                                    cleanedText = cleanedText.replace(/,(\s*[\]}])/g, "$1");
                                    
                                    // Ensure property names are properly quoted
                                    cleanedText = cleanedText.replace(/(\{|\,)\s*(\w+)\s*\:/g, '$1"$2":');
                                    
                                    // Try to parse the cleaned text
                                    try {
                                        industryData = JSON.parse(cleanedText);
                                        console.log("Successfully parsed JSON after cleanup");
                                    } catch (cleanupError) {
                                        console.error("Failed to parse even after cleanup:", cleanupError);
                                        
                                        // Last resort: Use a fallback structure with demo data
                                        displayMessage("Failed to parse industry data. Using basic demo data instead.", "warning");
                                        
                                        // Create a minimal industry data structure with basic information
                                        industryData = {
                                            companyName: ticker,
                                            ticker: ticker,
                                            industry: "Industry information unavailable",
                                            sector: "Sector information unavailable",
                                            dataDate: new Date().toISOString().split('T')[0],
                                            overview: "The AI model returned information that couldn't be properly parsed. Please try again or use the AAPL demo data to see a complete example.",
                                            marketShare: {
                                                data: [
                                                    { company: ticker, share: 20 },
                                                    { company: "Competitor 1", share: 15 },
                                                    { company: "Competitor 2", share: 15 },
                                                    { company: "Others", share: 50 }
                                                ],
                                                position: "Market position information unavailable"
                                            },
                                            growthTrends: {
                                                industry: [
                                                    { year: new Date().getFullYear()-4, growth: 5 },
                                                    { year: new Date().getFullYear()-3, growth: 5 },
                                                    { year: new Date().getFullYear()-2, growth: 5 },
                                                    { year: new Date().getFullYear()-1, growth: 5 },
                                                    { year: new Date().getFullYear(), growth: 5 }
                                                ],
                                                company: [
                                                    { year: new Date().getFullYear()-4, growth: 6 },
                                                    { year: new Date().getFullYear()-3, growth: 6 },
                                                    { year: new Date().getFullYear()-2, growth: 6 },
                                                    { year: new Date().getFullYear()-1, growth: 6 },
                                                    { year: new Date().getFullYear(), growth: 6 }
                                                ],
                                                cagr: "5.0%",
                                                comparison: "Data unavailable"
                                            },
                                            competitors: [
                                                { company: ticker, marketShare: "20%", revenueGrowth: "6%", operatingMargin: "15%", peRatio: "20", marketCap: "$1B" },
                                                { company: "Competitor 1", marketShare: "15%", revenueGrowth: "5%", operatingMargin: "12%", peRatio: "18", marketCap: "$900M" },
                                                { company: "Competitor 2", marketShare: "15%", revenueGrowth: "4%", operatingMargin: "10%", peRatio: "15", marketCap: "$800M" }
                                            ],
                                            trends: [
                                                { title: "Industry Trend 1", description: "Information unavailable" },
                                                { title: "Industry Trend 2", description: "Information unavailable" }
                                            ],
                                            swot: {
                                                strengths: ["Information unavailable"],
                                                weaknesses: ["Information unavailable"],
                                                opportunities: ["Information unavailable"],
                                                threats: ["Information unavailable"]
                                            }
                                        };
                                    }
                                }
                                
                                resolve(industryData);
                            } catch (error) {
                                console.error("Error parsing industry data:", error);
                                reject(new Error("Failed to parse industry data: " + error.message));
                            }
                        }
                    });
                });
                
                // Construct prompt for AI to get industry analysis
                const botName = modelType === 'pro' ? '@Gemini-2.5-Pro-Exp' : '@Gemini-2.5-Flash-Preview';
                const prompt = `${botName} 
I need a comprehensive industry analysis for ${ticker} in a specific JSON format. Please provide ONLY the JSON object with no additional text:

\`\`\`json
{
  "companyName": "Full company name",
  "ticker": "${ticker}",
  "industry": "Specific industry",
  "sector": "Broader sector",
  "dataDate": "Current date",
  "overview": "Detailed overview of the industry that ${ticker} operates in (3-4 sentences). Focus on the industry characteristics, trends, and competitive landscape, NOT on the company itself.",
  "marketShare": {
    "data": [
      { "company": "Company 1", "share": 25.5 },
      { "company": "Company 2", "share": 20.3 },
      { "company": "Company 3", "share": 15.2 },
      { "company": "Company 4", "share": 10.8 },
      { "company": "Company 5", "share": 8.5 },
      { "company": "Others", "share": 19.7 }
    ],
    "position": "Company's position in the market"
  },
  "growthTrends": {
    "industry": [
      { "year": 2020, "growth": 5.2 },
      { "year": 2021, "growth": 6.3 },
      { "year": 2022, "growth": 7.1 },
      { "year": 2023, "growth": 6.8 },
      { "year": 2024, "growth": 7.5 }
    ],
    "company": [
      { "year": 2020, "growth": 6.1 },
      { "year": 2021, "growth": 8.2 },
      { "year": 2022, "growth": 7.9 },
      { "year": 2023, "growth": 8.5 },
      { "year": 2024, "growth": 9.2 }
    ],
    "cagr": "6.5%",
    "comparison": "Outperforming industry by 1.8 percentage points"
  },
  "competitors": [
    { "company": "Company 1", "marketShare": "25.5%", "revenueGrowth": "8.5%", "operatingMargin": "18.3%", "peRatio": "22.4", "marketCap": "$500B" },
    { "company": "Company 2", "marketShare": "20.3%", "revenueGrowth": "6.2%", "operatingMargin": "15.7%", "peRatio": "18.9", "marketCap": "$350B" }
  ],
  "trends": [
    { "title": "Trend 1", "description": "Description of trend 1" },
    { "title": "Trend 2", "description": "Description of trend 2" }
  ],
  "swot": {
    "strengths": [
      "Strength 1",
      "Strength 2"
    ],
    "weaknesses": [
      "Weakness 1",
      "Weakness 2"
    ],
    "opportunities": [
      "Opportunity 1",
      "Opportunity 2"
    ],
    "threats": [
      "Threat 1",
      "Threat 2"
    ]
  }
}
\`\`\`

Provide accurate, up-to-date information about the company's industry, its market position, key competitors, and important trends. For the SWOT analysis, focus on industry-specific factors rather than company-specific ones.`;
                
                // Send prompt to fetch industry analysis
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    openChat: false
                });
                
                // Wait for the response
                const industryData = await responsePromise;
                
                // Update UI with the industry data
                updateIndustryAnalysis(industryData);
                
                // Hide loading indicator
                document.getElementById('industryLoadingIndicator').classList.add('hidden');
                
                // Show industry content
                document.getElementById('industryContent').classList.remove('hidden');
                
                // Show success message
                displayMessage(`Successfully loaded industry analysis for ${ticker}.`, "success");
                
                return industryData;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('industryLoadingIndicator').classList.add('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to load industry analysis. ${error.message}`, "error");
                
                throw error;
            }
        }
        
        // Function to update the industry analysis UI
        function updateIndustryAnalysis(data) {
            try {
                // Update basic information
                document.getElementById('industryCompanyName').textContent = data.companyName;
                document.getElementById('industryName').textContent = data.industry;
                document.getElementById('sectorName').textContent = data.sector;
                document.getElementById('industryDataDate').textContent = `Data as of: ${data.dataDate}`;
                
                // Update industry overview
                document.getElementById('industryOverview').textContent = data.overview;
                
                // Update market position
                document.getElementById('marketPosition').textContent = data.marketShare.position;
                
                // Update industry CAGR and growth comparison
                document.getElementById('industryCagr').textContent = data.growthTrends.cagr;
                document.getElementById('growthComparison').textContent = data.growthTrends.comparison;
                
                // Create market share chart
                createMarketShareChart(data.marketShare.data);
                
                // Create growth trends chart
                createGrowthTrendsChart(data.growthTrends);
                
                // Update competitors table
                updateCompetitorsTable(data.competitors);
                
                // Update industry trends
                updateIndustryTrends(data.trends);
                
                // Update SWOT analysis
                updateSwotAnalysis(data.swot);

                if (data.growthTrends && Array.isArray(data.growthTrends.industry) && data.growthTrends.industry.length > 0) {
                    // Use the most recent industry growth rate
                    document.getElementById('marketGrowthRate').value = data.growthTrends.industry[data.growthTrends.industry.length - 1].growth;
                }
            } catch (error) {
                console.error('Error updating industry analysis:', error);
                displayMessage(`Error displaying industry analysis information: ${error.message}`, 'error');
            }
        }
        
        // Function to create the market share chart
        function createMarketShareChart(data) {
            const ctx = document.getElementById('marketShareChart').getContext('2d');
            
            // Define colors for the pie chart
            const backgroundColors = [
                'rgba(93, 92, 222, 0.8)',  // Primary color
                'rgba(54, 162, 235, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(255, 206, 86, 0.8)'
            ];
            
            // Prepare data for the chart
            const labels = data.map(item => item.company);
            const values = data.map(item => item.share);
            
            // Create or update the chart
            if (window.charts && window.charts.marketShare) {
                // Update existing chart
                window.charts.marketShare.data.labels = labels;
                window.charts.marketShare.data.datasets[0].data = values;
                window.charts.marketShare.update();
            } else {
                // Create new chart
                if (!window.charts) window.charts = {};
                
                window.charts.marketShare = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: backgroundColors.slice(0, data.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 11
                                    },
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.8)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw.toFixed(1) + '%';
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Function to create the growth trends chart
        function createGrowthTrendsChart(data) {
            const ctx = document.getElementById('growthTrendsChart').getContext('2d');
            
            // Prepare data for the chart
            const labels = data.industry.map(item => item.year);
            const industryData = data.industry.map(item => item.growth);
            const companyData = data.company.map(item => item.growth);
            
            // Create or update the chart
            if (window.charts && window.charts.growthTrends) {
                // Update existing chart
                window.charts.growthTrends.data.labels = labels;
                window.charts.growthTrends.data.datasets[0].data = industryData;
                window.charts.growthTrends.data.datasets[1].data = companyData;
                window.charts.growthTrends.update();
            } else {
                // Create new chart
                if (!window.charts) window.charts = {};
                
                window.charts.growthTrends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Industry Growth',
                                data: industryData,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                tension: 0.3
                            },
                            {
                                label: 'Company Growth',
                                data: companyData,
                                backgroundColor: 'rgba(93, 92, 222, 0.2)',
                                borderColor: 'rgba(93, 92, 222, 1)',
                                borderWidth: 2,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.8)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw.toFixed(1) + '%';
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)'
                                },
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)'
                                },
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Function to update the competitors table
        function updateCompetitorsTable(competitors) {
            const tableBody = document.getElementById('competitorsTableBody');
            tableBody.innerHTML = '';
            
            competitors.forEach(competitor => {
                const row = document.createElement('tr');
                row.className = 'border-t border-gray-200 dark:border-gray-700';
                
                // Company name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'py-2 px-4 text-left text-gray-800 dark:text-gray-200 font-medium';
                nameCell.textContent = competitor.company;
                row.appendChild(nameCell);
                
                // Market share cell
                const marketShareCell = document.createElement('td');
                marketShareCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                marketShareCell.textContent = competitor.marketShare;
                row.appendChild(marketShareCell);
                
                // Revenue growth cell
                const growthCell = document.createElement('td');
                growthCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                growthCell.textContent = competitor.revenueGrowth;
                row.appendChild(growthCell);
                
                // Operating margin cell
                const marginCell = document.createElement('td');
                marginCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                marginCell.textContent = competitor.operatingMargin;
                row.appendChild(marginCell);
                
                // P/E ratio cell
                const peCell = document.createElement('td');
                peCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                peCell.textContent = competitor.peRatio;
                row.appendChild(peCell);
                
                // Market cap cell
                const marketCapCell = document.createElement('td');
                marketCapCell.className = 'py-2 px-4 text-right text-gray-800 dark:text-gray-200';
                marketCapCell.textContent = competitor.marketCap;
                row.appendChild(marketCapCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // Function to update the industry trends section
        function updateIndustryTrends(trends) {
            const trendsContainer = document.getElementById('industryTrends');
            trendsContainer.innerHTML = '';
            
            trends.forEach(trend => {
                const trendElement = document.createElement('div');
                trendElement.className = 'mb-4 last:mb-0';
                
                const title = document.createElement('h5');
                title.className = 'font-semibold text-gray-800 dark:text-white mb-1';
                title.textContent = trend.title;
                
                const description = document.createElement('p');
                description.className = 'text-gray-600 dark:text-gray-400 text-sm';
                description.textContent = trend.description;
                
                trendElement.appendChild(title);
                trendElement.appendChild(description);
                trendsContainer.appendChild(trendElement);
            });
        }
        
        // Function to update the SWOT analysis
        function updateSwotAnalysis(swot) {
            // Update strengths
            const strengthsList = document.getElementById('strengthsList');
            strengthsList.innerHTML = '';
            swot.strengths.forEach(strength => {
                const li = document.createElement('li');
                li.className = 'text-gray-700 dark:text-gray-300';
                li.textContent = strength;
                strengthsList.appendChild(li);
            });
            
            // Update weaknesses
            const weaknessesList = document.getElementById('weaknessesList');
            weaknessesList.innerHTML = '';
            swot.weaknesses.forEach(weakness => {
                const li = document.createElement('li');
                li.className = 'text-gray-700 dark:text-gray-300';
                li.textContent = weakness;
                weaknessesList.appendChild(li);
            });
            
            // Update opportunities
            const opportunitiesList = document.getElementById('opportunitiesList');
            opportunitiesList.innerHTML = '';
            swot.opportunities.forEach(opportunity => {
                const li = document.createElement('li');
                li.className = 'text-gray-700 dark:text-gray-300';
                li.textContent = opportunity;
                opportunitiesList.appendChild(li);
            });
            
            // Update threats
            const threatsList = document.getElementById('threatsList');
            threatsList.innerHTML = '';
            swot.threats.forEach(threat => {
                const li = document.createElement('li');
                li.className = 'text-gray-700 dark:text-gray-300';
                li.textContent = threat;
                threatsList.appendChild(li);
            });
        }
        
        // Function to fetch comparable companies data
        async function fetchComparablesData(ticker) {
            // Update all ticker inputs across pages
            updateAllTickerInputs(ticker);
            
            // Show loading indicator
            document.getElementById('comparablesLoadingIndicator').classList.remove('hidden');
            document.getElementById('comparablesContent').classList.add('hidden');
            
            // For AAPL, use demo data
            if (ticker.toUpperCase() === 'AAPL') {
                displayMessage("Using pre-loaded sample comparable companies data for Apple Inc.", "info");
                
                // Sample comparable companies data for Apple
                const comparablesData = {
                    "companyName": "Apple Inc.",
                    "ticker": "AAPL",
                    "industry": "Consumer Electronics",
                    "sector": "Technology",
                    "dataDate": "July 2025",
                    "companies": [
                        {
                            "name": "Apple Inc.",
                            "ticker": "AAPL",
                            "description": "Designs, manufactures, and markets smartphones, personal computers, tablets, wearables, and accessories worldwide.",
                            "marketCap": "3.2T",
                            "revenue": "394.3B",
                            "revenueGrowth": "7.8%",
                            "grossMargin": "43.2%",
                            "operatingMargin": "30.1%",
                            "netMargin": "25.3%",
                            "pe": 32.4,
                            "ps": 8.1,
                            "pb": 48.3,
                            "evEbitda": 24.6,
                            "roe": "165.3%",
                            "isSubject": true
                        },
                        {
                            "name": "Microsoft Corporation",
                            "ticker": "MSFT",
                            "description": "Develops, licenses, and sells software, services, devices, and solutions worldwide with focus on cloud computing and software.",
                            "marketCap": "2.9T",
                            "revenue": "211.9B",
                            "revenueGrowth": "15.6%",
                            "grossMargin": "68.3%",
                            "operatingMargin": "42.9%",
                            "netMargin": "35.7%",
                            "pe": 36.2,
                            "ps": 13.7,
                            "pb": 15.8,
                            "evEbitda": 25.1,
                            "roe": "43.2%",
                            "isSubject": false
                        },
                        {
                            "name": "Alphabet Inc.",
                            "ticker": "GOOGL",
                            "description": "Provides online advertising services, search engine, cloud computing, software and hardware products.",
                            "marketCap": "1.9T",
                            "revenue": "307.4B",
                            "revenueGrowth": "13.2%",
                            "grossMargin": "56.1%",
                            "operatingMargin": "27.5%",
                            "netMargin": "23.7%",
                            "pe": 25.9,
                            "ps": 6.2,
                            "pb": 8.4,
                            "evEbitda": 16.7,
                            "roe": "29.8%",
                            "isSubject": false
                        },
                        {
                            "name": "Amazon.com Inc.",
                            "ticker": "AMZN",
                            "description": "Engages in e-commerce retail, digital streaming, cloud computing services, and artificial intelligence.",
                            "marketCap": "1.8T",
                            "revenue": "574.8B",
                            "revenueGrowth": "11.7%",
                            "grossMargin": "46.9%",
                            "operatingMargin": "7.8%",
                            "netMargin": "5.2%",
                            "pe": 60.1,
                            "ps": 3.1,
                            "pb": 11.2,
                            "evEbitda": 23.8,
                            "roe": "17.5%",
                            "isSubject": false
                        },
                        {
                            "name": "Meta Platforms Inc.",
                            "ticker": "META",
                            "description": "Develops social media applications and virtual/augmented reality technology.",
                            "marketCap": "1.2T",
                            "revenue": "134.9B",
                            "revenueGrowth": "16.4%",
                            "grossMargin": "80.9%",
                            "operatingMargin": "38.3%",
                            "netMargin": "32.6%",
                            "pe": 27.5,
                            "ps": 8.9,
                            "pb": 9.3,
                            "evEbitda": 18.2,
                            "roe": "31.2%",
                            "isSubject": false
                        },
                        {
                            "name": "NVIDIA Corporation",
                            "ticker": "NVDA",
                            "description": "Designs graphics processing units and system on chip units for gaming, crypto mining, and AI applications.",
                            "marketCap": "2.4T",
                            "revenue": "60.9B",
                            "revenueGrowth": "125.3%",
                            "grossMargin": "73.2%",
                            "operatingMargin": "53.6%",
                            "netMargin": "48.9%",
                            "pe": 65.3,
                            "ps": 39.4,
                            "pb": 54.1,
                            "evEbitda": 56.7,
                            "roe": "83.7%",
                            "isSubject": false
                        },
                        {
                            "name": "Samsung Electronics Co.",
                            "ticker": "SSNLF",
                            "description": "Manufactures consumer electronics including smartphones, televisions, and memory chips.",
                            "marketCap": "378.2B",
                            "revenue": "234.5B",
                            "revenueGrowth": "2.5%",
                            "grossMargin": "36.4%",
                            "operatingMargin": "14.2%",
                            "netMargin": "11.8%",
                            "pe": 16.3,
                            "ps": 1.6,
                            "pb": 1.8,
                            "evEbitda": 8.4,
                            "roe": "11.2%",
                            "isSubject": false
                        }
                    ]
                };
                
                // Store in the data store
                dataStore.comparables = comparablesData;
                
                // Update UI
                updateComparablesUI(comparablesData);
                
                // Hide loading indicator
                document.getElementById('comparablesLoadingIndicator').classList.add('hidden');
                
                // Show comparables content
                document.getElementById('comparablesContent').classList.remove('hidden');
                
                // Show success message
                displayMessage("Successfully loaded comparable companies data for Apple Inc.", "success");
                
                return comparablesData;
            }
            
            // For other tickers, get real data from AI model
            try {
                const modelType = getSelectedModel('comparables');
                const modelName = modelType === 'pro' ? 'Gemini-2.5-Pro-Exp' : 'Gemini-2.5-Flash-Preview';
                
                displayMessage(`Fetching comparable companies data for ${ticker}... This may take up to one minute.`, "info");
                
                // Register handler for comparables data
                const handlerId = `comparables-${Date.now()}`;
                
                // Create a Promise for handling the response
                const responsePromise = new Promise((resolve, reject) => {
                    window.Poe.registerHandler(handlerId, (result, context) => {
                        if (result.status === "error") {
                            reject(new Error(result.responses[0]?.statusText || "Error fetching comparable companies data"));
                            return;
                        }
                        
                        if (result.status === "complete") {
                            const response = result.responses[0];
                            try {
                                // Parse the JSON data from the model's response
                                const responseText = response.content;
                                let comparablesData;
                                
                                // Extract JSON data from the response
                                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || 
                                                responseText.match(/```([\s\S]*?)```/);
                                                
                                if (jsonMatch && jsonMatch[1]) {
                                    comparablesData = JSON.parse(jsonMatch[1]);
                                } else {
                                    // Try to extract a JSON object without code blocks
                                    const jsonPattern = /\{[\s\S]*\}/;
                                    const match = responseText.match(jsonPattern);
                                    if (match) {
                                        comparablesData = JSON.parse(match[0]);
                                    } else {
                                        throw new Error("Unable to parse JSON data from response");
                                    }
                                }
                                
                                resolve(comparablesData);
                            } catch (error) {
                                console.error("Error parsing comparable companies data:", error);
                                reject(new Error("Failed to parse comparable companies data: " + error.message));
                            }
                        }
                    });
                });
                
                // Construct prompt for AI to get comparable companies data
                const botName = modelType === 'pro' ? '@Gemini-2.5-Pro-Exp' : '@Gemini-2.5-Flash-Preview';
                const prompt = `${botName} 
        I need detailed comparable companies data for ${ticker} in a specific JSON format. Please provide ONLY the JSON object with no additional text:

        \`\`\`json
        {
        "companyName": "Full company name",
        "ticker": "${ticker}",
        "industry": "Specific industry",
        "sector": "Broader sector",
        "dataDate": "Current date",
        "companies": [
            {
            "name": "Subject Company Name",
            "ticker": "${ticker}",
            "description": "Brief business description",
            "marketCap": "100B",
            "revenue": "50B",
            "revenueGrowth": "10.5%",
            "grossMargin": "45.0%",
            "operatingMargin": "25.0%",
            "netMargin": "20.0%",
            "pe": 20.5,
            "ps": 4.2,
            "pb": 8.7,
            "evEbitda": 15.3,
            "roe": "18.5%",
            "isSubject": true
            },
            {
            "name": "Comparable Company 1",
            "ticker": "COMP1",
            "description": "Brief business description",
            "marketCap": "80B",
            "revenue": "40B",
            "revenueGrowth": "8.2%",
            "grossMargin": "42.0%",
            "operatingMargin": "22.0%",
            "netMargin": "18.0%",
            "pe": 18.4,
            "ps": 3.8,
            "pb": 7.2,
            "evEbitda": 14.1,
            "roe": "16.3%",
            "isSubject": false
            }
        ]
        }
        \`\`\`

        Please include 6-8 of the most relevant comparable companies in the same industry with similar business models or market positions. For the subject company (${ticker}) itself, provide a flag "isSubject": true. For each company, include a brief business description, key financial metrics, and valuation multiples. Use the most current financial data available.`;
                
                // Send prompt to fetch comparable companies data
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    openChat: false
                });
                
                // Wait for the response
                const comparablesData = await responsePromise;
                
                // Store in the data store
                dataStore.comparables = comparablesData;
                
                // Update UI
                updateComparablesUI(comparablesData);
                
                // Hide loading indicator
                document.getElementById('comparablesLoadingIndicator').classList.add('hidden');
                
                // Show comparables content
                document.getElementById('comparablesContent').classList.remove('hidden');
                
                // Show success message
                displayMessage(`Successfully loaded comparable companies data for ${ticker}.`, "success");
                
                return comparablesData;
            } catch (error) {
                // Hide loading indicator
                document.getElementById('comparablesLoadingIndicator').classList.add('hidden');
                
                // Show error message
                displayMessage(`Error: Failed to load comparable companies data. ${error.message}`, "error");
                
                throw error;
            }
        }

        // Function to update the comparable companies UI
        function updateComparablesUI(data) {
            // Update basic information
            document.getElementById('comparablesCompanyName').textContent = data.companyName + " (" + data.ticker + ")";
            document.getElementById('comparablesIndustry').textContent = data.industry;
            document.getElementById('comparablesSector').textContent = data.sector;
            document.getElementById('comparablesDate').textContent = `Data as of: ${data.dataDate}`;
            
            // Update the comparables table
            updateComparablesTable(data.companies);
            
            // Create valuation multiples chart
            createValuationMultiplesChart(data.companies);
            
            // Create profitability metrics chart
            createProfitabilityMetricsChart(data.companies);
            
            // Update company details cards
            updateCompanyDetailsCards(data.companies);
        }

        // Function to update the comparables table
        function updateComparablesTable(companies) {
            const tableBody = document.getElementById('comparablesTableBody');
            tableBody.innerHTML = '';
            
            companies.forEach(company => {
                const row = document.createElement('tr');
                row.className = company.isSubject ? 
                    'bg-blue-50 dark:bg-blue-900/20 border-t border-gray-200 dark:border-gray-700' : 
                    'border-t border-gray-200 dark:border-gray-700';
                
                // Company name and ticker cell
                const nameCell = document.createElement('td');
                nameCell.className = 'py-3 px-4 text-left text-gray-800 dark:text-gray-200 sticky left-0 ' + 
                                (company.isSubject ? 'bg-blue-50 dark:bg-blue-900/20 font-medium' : 'bg-white dark:bg-gray-800');
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'font-medium';
                nameDiv.textContent = company.name;
                
                const tickerDiv = document.createElement('div');
                tickerDiv.className = 'text-xs text-gray-500 dark:text-gray-400';
                tickerDiv.textContent = company.ticker;
                
                nameCell.appendChild(nameDiv);
                nameCell.appendChild(tickerDiv);
                row.appendChild(nameCell);
                
                // Market Cap cell
                const mcapCell = document.createElement('td');
                mcapCell.className = 'py-3 px-4 text-right text-gray-800 dark:text-gray-200';
                mcapCell.textContent = company.marketCap;
                row.appendChild(mcapCell);
                
                // Revenue cell
                const revenueCell = document.createElement('td');
                revenueCell.className = 'py-3 px-4 text-right text-gray-800 dark:text-gray-200';
                revenueCell.textContent = company.revenue;
                row.appendChild(revenueCell);
                
                // Revenue Growth cell
                const revGrowthCell = document.createElement('td');
                revGrowthCell.className = 'py-3 px-4 text-right';
                const revGrowthVal = parseFloat(company.revenueGrowth);
                revGrowthCell.textContent = company.revenueGrowth;
                revGrowthCell.className += revGrowthVal >= 0 ? 
                    ' text-green-600 dark:text-green-400' : 
                    ' text-red-600 dark:text-red-400';
                row.appendChild(revGrowthCell);
                
                // P/E Ratio cell
                const peCell = createMetricCell(company.pe, 'pe');
                row.appendChild(peCell);
                
                // P/S Ratio cell
                const psCell = createMetricCell(company.ps, 'ps');
                row.appendChild(psCell);
                
                // P/B Ratio cell
                const pbCell = createMetricCell(company.pb, 'pb');
                row.appendChild(pbCell);
                
                // EV/EBITDA cell
                const evEbitdaCell = createMetricCell(company.evEbitda, 'evebitda');
                row.appendChild(evEbitdaCell);
                
                // Gross Margin cell
                const gmCell = createMetricCell(company.grossMargin, 'gpm', true);
                row.appendChild(gmCell);
                
                // Operating Margin cell
                const omCell = createMetricCell(company.operatingMargin, 'opm', true);
                row.appendChild(omCell);
                
                // Net Margin cell
                const nmCell = createMetricCell(company.netMargin, 'npm', true);
                row.appendChild(nmCell);
                
                // ROE cell
                const roeCell = createMetricCell(company.roe, 'roe', true);
                row.appendChild(roeCell);
                
                tableBody.appendChild(row);
            });
        }

        // Helper function to create a metric cell
        function createMetricCell(value, metricClass, isPercentage = false) {
            const cell = document.createElement('td');
            cell.className = `py-3 px-4 text-right text-gray-800 dark:text-gray-200 metric-col ${metricClass}`;
            
            if (isPercentage) {
                cell.textContent = value;
            } else {
                cell.textContent = typeof value === 'number' ? value.toFixed(1) : value;
            }
            
            return cell;
        }

        // Function to create valuation multiples chart
        function createValuationMultiplesChart(companies) {
            const ctx = document.getElementById('valuationMultiplesChart').getContext('2d');
            
            // Prepare data for the chart
            const labels = companies.map(company => company.ticker);
            
            // Valuation metrics to display
            const peData = companies.map(company => typeof company.pe === 'number' ? company.pe : parseFloat(company.pe));
            const psData = companies.map(company => typeof company.ps === 'number' ? company.ps : parseFloat(company.ps));
            const pbData = companies.map(company => typeof company.pb === 'number' ? company.pb : parseFloat(company.pb));
            const evEbitdaData = companies.map(company => typeof company.evEbitda === 'number' ? company.evEbitda : parseFloat(company.evEbitda));
            
            // Background colors - use special color for subject company
            const backgroundColors = companies.map(company => 
                company.isSubject ? 'rgba(93, 92, 222, 0.8)' : 'rgba(75, 192, 192, 0.6)'
            );
            
            // Create or update the chart
            if (window.charts && window.charts.valuationMultiples) {
                // Update existing chart
                window.charts.valuationMultiples.data.labels = labels;
                window.charts.valuationMultiples.data.datasets[0].data = peData;
                window.charts.valuationMultiples.data.datasets[0].backgroundColor = backgroundColors;
                window.charts.valuationMultiples.data.datasets[1].data = psData;
                window.charts.valuationMultiples.data.datasets[1].backgroundColor = backgroundColors;
                window.charts.valuationMultiples.data.datasets[2].data = pbData;
                window.charts.valuationMultiples.data.datasets[2].backgroundColor = backgroundColors;
                window.charts.valuationMultiples.data.datasets[3].data = evEbitdaData;
                window.charts.valuationMultiples.data.datasets[3].backgroundColor = backgroundColors;
                window.charts.valuationMultiples.update();
            } else {
                // Create new chart
                if (!window.charts) window.charts = {};
                
                window.charts.valuationMultiples = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'P/E Ratio',
                                data: peData,
                                backgroundColor: backgroundColors,
                                borderWidth: 1,
                                borderColor: 'rgba(93, 92, 222, 0.8)',
                                hidden: false
                            },
                            {
                                label: 'P/S Ratio',
                                data: psData,
                                backgroundColor: backgroundColors,
                                borderWidth: 1,
                                borderColor: 'rgba(54, 162, 235, 0.8)',
                                hidden: true
                            },
                            {
                                label: 'P/B Ratio',
                                data: pbData,
                                backgroundColor: backgroundColors,
                                borderWidth: 1,
                                borderColor: 'rgba(255, 159, 64, 0.8)',
                                hidden: true
                            },
                            {
                                label: 'EV/EBITDA',
                                data: evEbitdaData,
                                backgroundColor: backgroundColors,
                                borderWidth: 1,
                                borderColor: 'rgba(75, 192, 192, 0.8)',
                                hidden: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                onClick: function(e, legendItem, legend) {
                                    const index = legendItem.datasetIndex;
                                    const ci = legend.chart;
                                    
                                    // Hide all datasets first
                                    ci.data.datasets.forEach((dataset, i) => {
                                        dataset.hidden = true;
                                    });
                                    
                                    // Then show only the clicked one
                                    ci.data.datasets[index].hidden = false;
                                    ci.update();
                                },
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw.toFixed(1);
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Value'
                                },
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Function to create profitability metrics chart
        function createProfitabilityMetricsChart(companies) {
            const ctx = document.getElementById('profitabilityMetricsChart').getContext('2d');
            
            // Prepare data for the chart
            const labels = companies.map(company => company.ticker);
            
            // Convert percentage strings to numbers
            function parsePercentage(value) {
                if (typeof value === 'string') {
                    return parseFloat(value.replace('%', ''));
                }
                return value;
            }
            
            // Profitability metrics to display
            const grossMarginData = companies.map(company => parsePercentage(company.grossMargin));
            const operatingMarginData = companies.map(company => parsePercentage(company.operatingMargin));
            const netMarginData = companies.map(company => parsePercentage(company.netMargin));
            const roeData = companies.map(company => parsePercentage(company.roe));
            
            // Background colors - use special color for subject company
            const backgroundColors = companies.map(company => 
                company.isSubject ? 'rgba(93, 92, 222, 0.8)' : 'rgba(54, 162, 235, 0.6)'
            );
            
            // Create or update the chart
            if (window.charts && window.charts.profitabilityMetrics) {
                // Update existing chart
                window.charts.profitabilityMetrics.data.labels = labels;
                window.charts.profitabilityMetrics.data.datasets[0].data = grossMarginData;
                window.charts.profitabilityMetrics.data.datasets[0].backgroundColor = backgroundColors;
                window.charts.profitabilityMetrics.data.datasets[1].data = operatingMarginData;
                window.charts.profitabilityMetrics.data.datasets[1].backgroundColor = backgroundColors;
                window.charts.profitabilityMetrics.data.datasets[2].data = netMarginData;
                window.charts.profitabilityMetrics.data.datasets[2].backgroundColor = backgroundColors;
                window.charts.profitabilityMetrics.data.datasets[3].data = roeData;
                window.charts.profitabilityMetrics.data.datasets[3].backgroundColor = backgroundColors;
                window.charts.profitabilityMetrics.update();
            } else {
                // Create new chart
                if (!window.charts) window.charts = {};
                
                window.charts.profitabilityMetrics = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Gross Margin (%)',
                                data: grossMarginData,
                                backgroundColor: backgroundColors,
                                borderWidth: 1,
                                borderColor: 'rgba(93, 92, 222, 0.8)',
                                hidden: false
                            },
                            {
                                label: 'Operating Margin (%)',
                                data: operatingMarginData,
                                backgroundColor: backgroundColors,
                                borderWidth: 1,
                                borderColor: 'rgba(54, 162, 235, 0.8)',
                                hidden: true
                            },
                            {
                                label: 'Net Margin (%)',
                                data: netMarginData,
                                backgroundColor: backgroundColors,
                                borderWidth: 1,
                                borderColor: 'rgba(255, 159, 64, 0.8)',
                                hidden: true
                            },
                            {
                                label: 'ROE (%)',
                                data: roeData,
                                backgroundColor: backgroundColors,
                                borderWidth: 1,
                                borderColor: 'rgba(75, 192, 192, 0.8)',
                                hidden: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                onClick: function(e, legendItem, legend) {
                                    const index = legendItem.datasetIndex;
                                    const ci = legend.chart;
                                    
                                    // Hide all datasets first
                                    ci.data.datasets.forEach((dataset, i) => {
                                        dataset.hidden = true;
                                    });
                                    
                                    // Then show only the clicked one
                                    ci.data.datasets[index].hidden = false;
                                    ci.update();
                                },
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw.toFixed(1) + '%';
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Percentage (%)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Function to update company details cards
        function updateCompanyDetailsCards(companies) {
            const cardsContainer = document.getElementById('companyDetailsCards');
            cardsContainer.innerHTML = '';
            
            companies.forEach(company => {
                const card = document.createElement('div');
                card.className = company.isSubject ? 
                    'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-900 rounded-lg p-4 shadow-sm' : 
                    'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm';
                
                // Company header
                const header = document.createElement('div');
                header.className = 'mb-2 pb-2 border-b border-gray-200 dark:border-gray-700';
                
                const title = document.createElement('h5');
                title.className = 'font-semibold text-gray-800 dark:text-white flex justify-between items-center';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = company.name;
                
                const tickerSpan = document.createElement('span');
                tickerSpan.className = 'text-sm text-primary bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded';
                tickerSpan.textContent = company.ticker;
                
                title.appendChild(nameSpan);
                title.appendChild(tickerSpan);
                header.appendChild(title);
                
                // Company description
                const description = document.createElement('p');
                description.className = 'text-sm text-gray-600 dark:text-gray-400 mt-2';
                description.textContent = company.description;
                
                // Key metrics
                const metricsDiv = document.createElement('div');
                metricsDiv.className = 'mt-3 grid grid-cols-2 gap-2 text-sm';
                
                // Create metric items
                const metricItems = [
                    { label: 'Market Cap', value: company.marketCap },
                    { label: 'Revenue', value: company.revenue },
                    { label: 'Revenue Growth', value: company.revenueGrowth },
                    { label: 'Operating Margin', value: company.operatingMargin },
                    { label: 'P/E Ratio', value: typeof company.pe === 'number' ? company.pe.toFixed(1) : company.pe },
                    { label: 'EV/EBITDA', value: typeof company.evEbitda === 'number' ? company.evEbitda.toFixed(1) : company.evEbitda }
                ];
                
                metricItems.forEach(item => {
                    const metricDiv = document.createElement('div');
                    metricDiv.className = 'border-t border-gray-100 dark:border-gray-700 pt-1';
                    
                    const label = document.createElement('span');
                    label.className = 'block text-xs text-gray-500 dark:text-gray-400';
                    label.textContent = item.label;
                    
                    const value = document.createElement('span');
                    value.className = 'font-medium text-gray-800 dark:text-gray-200';
                    value.textContent = item.value;
                    
                    metricDiv.appendChild(label);
                    metricDiv.appendChild(value);
                    metricsDiv.appendChild(metricDiv);
                });
                
                // Assemble the card
                card.appendChild(header);
                card.appendChild(description);
                card.appendChild(metricsDiv);
                
                cardsContainer.appendChild(card);
            });
        }

        // Function to toggle visibility of columns based on checkbox selections
        function updateColumnVisibility() {
            // Get all metric checkboxes
            const checkboxes = document.querySelectorAll('.metric-checkbox');
            
            // Toggle column visibility based on checkbox state
            checkboxes.forEach(checkbox => {
                const metricClass = checkbox.value;
                const columns = document.querySelectorAll(`.metric-col.${metricClass}`);
                
                columns.forEach(column => {
                    if (checkbox.checked) {
                        column.classList.remove('hidden');
                    } else {
                        column.classList.add('hidden');
                    }
                });
            });
        }

        // Event listeners for Comparable Companies page
        document.getElementById('nav-comparables').addEventListener('click', () => showPage('page-comparables'));

        document.getElementById('fetchComparablesBtn').addEventListener('click', function() {
            const ticker = document.getElementById('comparablesTickerInput').value.trim();
            if (!ticker) {
                displayMessage("Please enter a stock ticker.", "error");
                return;
            }
            fetchComparablesData(ticker);
        });

        document.getElementById('comparablesTickerInput').addEventListener('input', function() {
            updateAllTickerInputs(this.value.trim());
        });

        document.querySelector('.comparables-quick-btn').addEventListener('click', function() {
            document.getElementById('comparablesTickerInput').value = "AAPL";
            fetchComparablesData("AAPL");
        });

        document.getElementById('updateComparablesTable').addEventListener('click', function() {
            updateColumnVisibility();
        });
        
        // Initialize column visibility based on default checkbox states
        document.addEventListener('DOMContentLoaded', function() {
            // Add this to the existing DOMContentLoaded listener
            // Initialize metric column visibility
            updateColumnVisibility();
        });

        // Add cache controls to the UI
        function addCacheControls() {
            // Create a "Clear Cache" button in the header
            const header = document.querySelector('header');
            
            const cacheControlDiv = document.createElement('div');
            cacheControlDiv.className = 'flex justify-end items-center mb-2';
            
            const cacheClearBtn = document.createElement('button');
            cacheClearBtn.className = 'text-xs bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300';
            cacheClearBtn.textContent = 'Clear Data Cache';
            cacheClearBtn.title = 'Clear all cached financial data';
            cacheClearBtn.onclick = function() {
                cacheManager.clear();
                displayMessage("Data cache cleared. New data will be fetched on next request.", "info");
            };
            
            cacheControlDiv.appendChild(cacheClearBtn);
            header.appendChild(cacheControlDiv);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts
            initializeCharts();
     
            // Add cache controls
            addCacheControls();
            
            // Show welcome message
            displayMessage("**Welcome to the Financial Analysis Suite**\n\nThis multi-page application allows you to analyze different aspects of a company:\n\n **Company Overview** - Basic company information and revenue breakdown\n **Financial Statements** - Income statement, balance sheet, and cash flow\n **Valuation Model** - DCF valuation with adjustable parameters\n **Analyst Consensus** - Ratings, price targets, and recommendations\n **Stock Information** - Current price and performance metrics\n\nChoose a page from the navigation bar above and enter a stock ticker to begin, or use the 'AAPL Demo Mode' button on any page for a quick demonstration.", "info");
        });
    </script>
</body>
</html>